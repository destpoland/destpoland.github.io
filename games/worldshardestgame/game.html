<!DOCTYPE html>
<html lang="en-us">

<head>
  <title>World's Hardest Game Unblocked</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1, maximum-scale=1, user-scalable=no">

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    /* D-pad and Space button styles */
    .dpad,
    .space-button {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .dpad {
      bottom: 20px;
      left: 20px;
    }

    .space-button {
      bottom: 20px;
      right: 20px;
    }

    .dpad button,
    .space-button button {
      width: 60px;
      height: 60px;
      font-size: 18px;
      color: #fff;
      background-color: #404040;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .space-button button {
      width: 100px;
    }

    .pressed {
      background-color: #606060;
    }
  </style>

  <!-- game scripts -->
  <script src="jquery.min.js"></script>
  <script src="jquery.hotkeys.js"></script>
  <script src="key_status.js"></script>
  <script src="vars.js"></script>
  <script src="sounds.js"></script>
  <script src="colors.js"></script>
  <script src="canvas.js"></script>
  <script src="timer.js"></script>
  <script src="border.js"></script>
  <script src="mobile_controls.js"></script>
  <script src="walls.js"></script>
  <script src="enemy.js"></script>
  <script src="checkpoint.js"></script>
  <script src="coins.js"></script>
  <script src="player.js"></script>
  <script src="instructions.js"></script>
  <script src="intermission.js"></script>
  <script src="buttons.js"></script>
  <script src="mouse.js"></script>
  <script src="bars.js"></script>
  <script src="main_menu.js"></script>
  <script src="level_select.js"></script>
  <script src="finish.js"></script>
  <script src="ingame_menu.js"></script>
  <script src="preloader.js"></script>
  <script src="hotkeys.js"></script>
</head>

<body>
  <div class="dpad">
    <button id="up_mobile_btn">▲</button>
    <div class="dpad-controls">
      <button id="left_mobile_btn">◀</button>
      <button id="down_mobile_btn">▼</button>
      <button id="right_mobile_btn">▶</button>
    </div>
  </div>

  <div class="space-button">
    <button id="space_mobile_btn">Shift</button>
  </div>

  <script src="main.js"></script>
  <script src="js/analytics_ubg_v1_4.js"></script>
  <script src="js/ubg235_client_v1_1.js"></script>

  <script>
    function dispatchKey(type, keyCode, keyName, codeName) {
      const canvas = currentCanvas;
      const targets = [window, document, player];
      if (canvas) targets.push(canvas);

      const evt = new KeyboardEvent(type, {
        key: keyName,
        code: codeName,
        keyCode: keyCode,
        which: keyCode,
        bubbles: true
      });

      targets.forEach(t => {
        try {
          t.dispatchEvent(evt);
        } catch (e) {}
      });
    }

    /* ---- mapping and control handlers ---- */
    const map = {
      left: { code: 37, key: 'ArrowLeft', codeName: 'ArrowLeft' },
      right: { code: 39, key: 'ArrowRight', codeName: 'ArrowRight' },
      up: { code: 38, key: 'ArrowUp', codeName: 'ArrowUp' },
      down: { code: 40, key: 'ArrowDown', codeName: 'ArrowDown' },
      space: { code: 16, key: 'Shift', codeName: 'ShiftLeft' }
    };

    let currentCanvas = null;

    waitForCanvas(player).then((canvas) => {
      console.log('Canvas found:', canvas);
      currentCanvas = canvas;
      player.focus();

      ['pointerdown', 'pointerup', 'pointermove', 'mousedown', 'mouseup'].forEach(evtName => {
        canvas.addEventListener(evtName, (ev) => { }, { passive: true });
      });

    }).catch((err) => {
      console.warn("Could not find canvas:", err);
    });

    function bindControlElement(el, mapEntry) {
      if (!el) return;
      const press = (ev) => {
        if (ev && ev.preventDefault) ev.preventDefault();
        el.classList.add('pressed');
        try { player.focus(); } catch (e) { }
        dispatchKey('keydown', mapEntry.code, mapEntry.key, mapEntry.codeName);
      };
      const release = (ev) => {
        if (ev && ev.preventDefault) ev.preventDefault();
        el.classList.remove('pressed');
        dispatchKey('keyup', mapEntry.code, mapEntry.key, mapEntry.codeName);
      };

      el.addEventListener('touchstart', press, { passive: false });
      el.addEventListener('touchend', release, { passive: false });
      el.addEventListener('touchcancel', release, { passive: false });

      el.addEventListener('pointerdown', press, { passive: false });
      el.addEventListener('pointerup', release, { passive: false });

      el.addEventListener('mousedown', press);
      el.addEventListener('mouseup', release);

      el.addEventListener('focus', (e) => { try { player.focus(); } catch (e) { } });
    }

    // map DOM controls to actions
    bindControlElement(document.getElementById('left_mobile_btn'), map.left);
    bindControlElement(document.getElementById('right_mobile_btn'), map.right);
    bindControlElement(document.getElementById('up_mobile_btn'), map.up);
    bindControlElement(document.getElementById('down_mobile_btn'), map.down);
    bindControlElement(document.getElementById('space_mobile_btn'), map.space);

    document.addEventListener('keydown', (e) => {
      // fallback for physical keyboard
    }, false);

    window._debug_controls = {
      player: player,
      getCanvas: () => currentCanvas,
      sendKey: (type, code) => {
        for (const k in map) {
          if (map[k].code === code) {
            dispatchKey(type, map[k].code, map[k].key, map[k].codeName);
            return;
          }
        }
        console.warn("Unknown code:", code);
      }
    };
  </script>
</body>
</html>
