/** @license_
* CivHero, Copyright 2015-2024 Steve Taylor.  All Rights Reserved.
* Rat Engine Copyright 2012-2024 Wahoo Studios, Inc. and Steve Taylor.  All Rights Reserved.
* Contact stay at wahoo.com for more info
 */
!function(){"use strict";window.BUILD_INFO={version:{version:"15558",localMods:"+m",date:"2024/12/15 20:34:00"},package:"bundled"};const e={showForCiv:0,world:{V_SCALE:.7071,TILE_SIDE_PIXELS:96},mainFont:"acmeregular",titleFont:"acmeregular",graphics:{heroSize:135,petSize:128,worldPetSize:122,creatureSize:120,creatureHurtSize:88,resourceSize:50,resourceRegenFullRadius:50,resourceRegenSize:50,resourceRegenBarRadius:56,resourceRegenBarOuterWidth:20,resourceRegenBarInnerWidth:12,buildingSize:170},extraElementScale:1,aiDifficultyMods:[{cost:1,cap:1},{cost:2.5,cap:1},{cost:1.5,cap:1},{cost:1,cap:1},{cost:.9,cap:1.2},{cost:.75,cap:1.5},{cost:.75,cap:1.8}],buttonTipTime:.8,hexTipTime:1,touchTipTime:.8,unknownStyle:"#404040",unknownStroke:"#D6D6D6",unknownStrokeDark:"#000000"},t=!1,n="${JSCORE_VERSION}",r=function(e,t){if(!e)throw i(t)},i=function(e){return new Error("Firebase Database ("+n+") INTERNAL ASSERT FAILED: "+e)},o=function(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:i<2048?(t[n++]=i>>6|192,t[n++]=63&i|128):55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128,t[n++]=i>>6&63|128,t[n++]=63&i|128):(t[n++]=i>>12|224,t[n++]=i>>6&63|128,t[n++]=63&i|128)}return t},s={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let t=0;t<e.length;t+=3){const i=e[t],o=t+1<e.length,s=o?e[t+1]:0,a=t+2<e.length,l=a?e[t+2]:0,c=i>>2,u=(3&i)<<4|s>>4;let h=(15&s)<<2|l>>6,d=63&l;a||(d=64,o||(h=64)),r.push(n[c],n[u],n[h],n[d])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(o(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){const i=e[n++];if(i<128)t[r++]=String.fromCharCode(i);else if(i>191&&i<224){const o=e[n++];t[r++]=String.fromCharCode((31&i)<<6|63&o)}else if(i>239&&i<365){const o=((7&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536;t[r++]=String.fromCharCode(55296+(o>>10)),t[r++]=String.fromCharCode(56320+(1023&o))}else{const o=e[n++],s=e[n++];t[r++]=String.fromCharCode((15&i)<<12|(63&o)<<6|63&s)}}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();const n=t?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let t=0;t<e.length;){const i=n[e.charAt(t++)],o=t<e.length?n[e.charAt(t)]:0;++t;const s=t<e.length?n[e.charAt(t)]:64;++t;const l=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==o||null==s||null==l)throw new a;const c=i<<2|o>>4;if(r.push(c),64!==s){const e=o<<4&240|s>>2;if(r.push(e),64!==l){const e=s<<6&192|l;r.push(e)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class a extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const l=function(e){const t=o(e);return s.encodeByteArray(t,!0)},c=function(e){return l(e).replace(/\./g,"")},u=function(e){try{return s.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};function h(e){return d(void 0,e)}function d(e,t){if(!(t instanceof Object))return t;switch(t.constructor){case Date:return new Date(t.getTime());case Object:void 0===e&&(e={});break;case Array:e=[];break;default:return t}for(const n in t)t.hasOwnProperty(n)&&"__proto__"!==n&&(e[n]=d(e[n],t[n]));return e}const p=()=>function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__,g=()=>{try{return p()||(()=>{if("undefined"==typeof process||void 0===process.env)return;const e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0})()||(()=>{if("undefined"==typeof document)return;let e;try{e=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}const t=e&&u(e[1]);return t&&JSON.parse(t)})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}},m=e=>{const t=(e=>{var t,n;return null===(n=null===(t=g())||void 0===t?void 0:t.emulatorHosts)||void 0===n?void 0:n[e]})(e);if(!t)return;const n=t.lastIndexOf(":");if(n<=0||n+1===t.length)throw new Error(`Invalid host ${t} with no separate hostname and port!`);const r=parseInt(t.substring(n+1),10);return"["===t[0]?[t.substring(1,n-1),r]:[t.substring(0,n),r]},f=()=>{var e;return null===(e=g())||void 0===e?void 0:e.config};class v{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}wrapCallback(e){return(t,n)=>{t?this.reject(t):this.resolve(n),"function"==typeof e&&(this.promise.catch((()=>{})),1===e.length?e(t):e(t,n))}}}function y(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function w(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(y())}function C(){return"object"==typeof navigator&&"ReactNative"===navigator.product}function S(){return!0===t}class b extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,b.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,_.prototype.create)}}class _{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){const n=t[0]||{},r=`${this.service}/${e}`,i=this.errors[e],o=i?function(e,t){return e.replace(x,((e,n)=>{const r=t[n];return null!=r?String(r):`<${n}?>`}))}(i,n):"Error",s=`${this.serviceName}: ${o} (${r}).`;return new b(r,s,n)}}const x=/\{\$([^}]+)}/g;function T(e){return JSON.parse(e)}function k(e){return JSON.stringify(e)}const I=function(e){let t={},n={},r={},i="";try{const o=e.split(".");t=T(u(o[0])||""),n=T(u(o[1])||""),i=o[2],r=n.d||{},delete n.d}catch(e){}return{header:t,claims:n,data:r,signature:i}};function P(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function E(e,t){return Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0}function A(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}function D(e,t,n){const r={};for(const i in e)Object.prototype.hasOwnProperty.call(e,i)&&(r[i]=t.call(n,e[i],i,e));return r}function B(e,t){if(e===t)return!0;const n=Object.keys(e),r=Object.keys(t);for(const i of n){if(!r.includes(i))return!1;const n=e[i],o=t[i];if(R(n)&&R(o)){if(!B(n,o))return!1}else if(n!==o)return!1}for(const e of r)if(!n.includes(e))return!1;return!0}function R(e){return null!==e&&"object"==typeof e}function F(e){const t=[];for(const[n,r]of Object.entries(e))Array.isArray(r)?r.forEach((e=>{t.push(encodeURIComponent(n)+"="+encodeURIComponent(e))})):t.push(encodeURIComponent(n)+"="+encodeURIComponent(r));return t.length?"&"+t.join("&"):""}class N{constructor(){this.chain_=[],this.buf_=[],this.W_=[],this.pad_=[],this.inbuf_=0,this.total_=0,this.blockSize=64,this.pad_[0]=128;for(let e=1;e<this.blockSize;++e)this.pad_[e]=0;this.reset()}reset(){this.chain_[0]=1732584193,this.chain_[1]=4023233417,this.chain_[2]=2562383102,this.chain_[3]=271733878,this.chain_[4]=3285377520,this.inbuf_=0,this.total_=0}compress_(e,t){t||(t=0);const n=this.W_;if("string"==typeof e)for(let r=0;r<16;r++)n[r]=e.charCodeAt(t)<<24|e.charCodeAt(t+1)<<16|e.charCodeAt(t+2)<<8|e.charCodeAt(t+3),t+=4;else for(let r=0;r<16;r++)n[r]=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],t+=4;for(let e=16;e<80;e++){const t=n[e-3]^n[e-8]^n[e-14]^n[e-16];n[e]=4294967295&(t<<1|t>>>31)}let r,i,o=this.chain_[0],s=this.chain_[1],a=this.chain_[2],l=this.chain_[3],c=this.chain_[4];for(let e=0;e<80;e++){e<40?e<20?(r=l^s&(a^l),i=1518500249):(r=s^a^l,i=1859775393):e<60?(r=s&a|l&(s|a),i=2400959708):(r=s^a^l,i=3395469782);const t=(o<<5|o>>>27)+r+c+i+n[e]&4294967295;c=l,l=a,a=4294967295&(s<<30|s>>>2),s=o,o=t}this.chain_[0]=this.chain_[0]+o&4294967295,this.chain_[1]=this.chain_[1]+s&4294967295,this.chain_[2]=this.chain_[2]+a&4294967295,this.chain_[3]=this.chain_[3]+l&4294967295,this.chain_[4]=this.chain_[4]+c&4294967295}update(e,t){if(null==e)return;void 0===t&&(t=e.length);const n=t-this.blockSize;let r=0;const i=this.buf_;let o=this.inbuf_;for(;r<t;){if(0===o)for(;r<=n;)this.compress_(e,r),r+=this.blockSize;if("string"==typeof e){for(;r<t;)if(i[o]=e.charCodeAt(r),++o,++r,o===this.blockSize){this.compress_(i),o=0;break}}else for(;r<t;)if(i[o]=e[r],++o,++r,o===this.blockSize){this.compress_(i),o=0;break}}this.inbuf_=o,this.total_+=t}digest(){const e=[];let t=8*this.total_;this.inbuf_<56?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(let e=this.blockSize-1;e>=56;e--)this.buf_[e]=255&t,t/=256;this.compress_(this.buf_);let n=0;for(let t=0;t<5;t++)for(let r=24;r>=0;r-=8)e[n]=this.chain_[t]>>r&255,++n;return e}}class M{constructor(e,t){this.observers=[],this.unsubscribes=[],this.observerCount=0,this.task=Promise.resolve(),this.finalized=!1,this.onNoObservers=t,this.task.then((()=>{e(this)})).catch((e=>{this.error(e)}))}next(e){this.forEachObserver((t=>{t.next(e)}))}error(e){this.forEachObserver((t=>{t.error(e)})),this.close(e)}complete(){this.forEachObserver((e=>{e.complete()})),this.close()}subscribe(e,t,n){let r;if(void 0===e&&void 0===t&&void 0===n)throw new Error("Missing Observer.");r=function(e,t){if("object"!=typeof e||null===e)return!1;for(const n of t)if(n in e&&"function"==typeof e[n])return!0;return!1}(e,["next","error","complete"])?e:{next:e,error:t,complete:n},void 0===r.next&&(r.next=L),void 0===r.error&&(r.error=L),void 0===r.complete&&(r.complete=L);const i=this.unsubscribeOne.bind(this,this.observers.length);return this.finalized&&this.task.then((()=>{try{this.finalError?r.error(this.finalError):r.complete()}catch(e){}})),this.observers.push(r),i}unsubscribeOne(e){void 0!==this.observers&&void 0!==this.observers[e]&&(delete this.observers[e],this.observerCount-=1,0===this.observerCount&&void 0!==this.onNoObservers&&this.onNoObservers(this))}forEachObserver(e){if(!this.finalized)for(let t=0;t<this.observers.length;t++)this.sendOne(t,e)}sendOne(e,t){this.task.then((()=>{if(void 0!==this.observers&&void 0!==this.observers[e])try{t(this.observers[e])}catch(e){"undefined"!=typeof console&&console.error&&console.error(e)}}))}close(e){this.finalized||(this.finalized=!0,void 0!==e&&(this.finalError=e),this.task.then((()=>{this.observers=void 0,this.onNoObservers=void 0})))}}function L(){}function O(e,t){return`${e} failed: ${t} argument `}const H=function(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);r<128?t++:r<2048?t+=2:r>=55296&&r<=56319?(t+=4,n++):t+=3}return t};function z(e){return e&&e._delegate?e._delegate:e}class q{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}const V="[DEFAULT]";class W{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const e=new v;if(this.instancesDeferred.set(t,e),this.isInitialized(t)||this.shouldAutoInitialize())try{const n=this.getOrInitializeService({instanceIdentifier:t});n&&e.resolve(n)}catch(e){}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const n=this.normalizeInstanceIdentifier(null==e?void 0:e.identifier),r=null!==(t=null==e?void 0:e.optional)&&void 0!==t&&t;if(!this.isInitialized(n)&&!this.shouldAutoInitialize()){if(r)return null;throw Error(`Service ${this.name} is not available`)}try{return this.getOrInitializeService({instanceIdentifier:n})}catch(e){if(r)return null;throw e}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,this.shouldAutoInitialize()){if(function(e){return"EAGER"===e.instantiationMode}(e))try{this.getOrInitializeService({instanceIdentifier:V})}catch(e){}for(const[e,t]of this.instancesDeferred.entries()){const n=this.normalizeInstanceIdentifier(e);try{const e=this.getOrInitializeService({instanceIdentifier:n});t.resolve(e)}catch(e){}}}}clearInstance(e=V){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter((e=>"INTERNAL"in e)).map((e=>e.INTERNAL.delete())),...e.filter((e=>"_delete"in e)).map((e=>e._delete()))])}isComponentSet(){return null!=this.component}isInitialized(e=V){return this.instances.has(e)}getOptions(e=V){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,n=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(n))throw Error(`${this.name}(${n}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const r=this.getOrInitializeService({instanceIdentifier:n,options:t});for(const[e,t]of this.instancesDeferred.entries()){n===this.normalizeInstanceIdentifier(e)&&t.resolve(r)}return r}onInit(e,t){var n;const r=this.normalizeInstanceIdentifier(t),i=null!==(n=this.onInitCallbacks.get(r))&&void 0!==n?n:new Set;i.add(e),this.onInitCallbacks.set(r,i);const o=this.instances.get(r);return o&&e(o,r),()=>{i.delete(e)}}invokeOnInitCallbacks(e,t){const n=this.onInitCallbacks.get(t);if(n)for(const r of n)try{r(e,t)}catch(e){}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let n=this.instances.get(e);if(!n&&this.component&&(n=this.component.instanceFactory(this.container,{instanceIdentifier:(r=e,r===V?void 0:r),options:t}),this.instances.set(e,n),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(n,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,n)}catch(e){}var r;return n||null}normalizeInstanceIdentifier(e=V){return this.component?this.component.multipleInstances?e:V:e}shouldAutoInitialize(){return!!this.component&&"EXPLICIT"!==this.component.instantiationMode}}class G{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new W(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}var U;!function(e){e[e.DEBUG=0]="DEBUG",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(U||(U={}));const j={debug:U.DEBUG,verbose:U.VERBOSE,info:U.INFO,warn:U.WARN,error:U.ERROR,silent:U.SILENT},K=U.INFO,Y={[U.DEBUG]:"log",[U.VERBOSE]:"log",[U.INFO]:"info",[U.WARN]:"warn",[U.ERROR]:"error"},X=(e,t,...n)=>{if(t<e.logLevel)return;const r=(new Date).toISOString(),i=Y[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)};class ${constructor(e){this.name=e,this._logLevel=K,this._logHandler=X,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in U))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?j[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,U.DEBUG,...e),this._logHandler(this,U.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,U.VERBOSE,...e),this._logHandler(this,U.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,U.INFO,...e),this._logHandler(this,U.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,U.WARN,...e),this._logHandler(this,U.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,U.ERROR,...e),this._logHandler(this,U.ERROR,...e)}}const J=(e,t)=>t.some((t=>e instanceof t));let Q,Z;const ee=new WeakMap,te=new WeakMap,ne=new WeakMap,re=new WeakMap,ie=new WeakMap;let oe={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return te.get(e);if("objectStoreNames"===t)return e.objectStoreNames||ne.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return le(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function se(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(Z||(Z=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(ce(this),t),le(ee.get(this))}:function(...t){return le(e.apply(ce(this),t))}:function(t,...n){const r=e.call(ce(this),t,...n);return ne.set(r,t.sort?t.sort():[t]),le(r)}}function ae(e){return"function"==typeof e?se(e):(e instanceof IDBTransaction&&function(e){if(te.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),r()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)}));te.set(e,t)}(e),J(e,Q||(Q=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,oe):e)}function le(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(le(e.result)),r()},o=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)}));return t.then((t=>{t instanceof IDBCursor&&ee.set(t,e)})).catch((()=>{})),ie.set(t,e),t}(e);if(re.has(e))return re.get(e);const t=ae(e);return t!==e&&(re.set(e,t),ie.set(t,e)),t}const ce=e=>ie.get(e);const ue=["get","getKey","getAll","getAllKeys","count"],he=["put","add","delete","clear"],de=new Map;function pe(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(de.get(t))return de.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=he.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!ue.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let s=o.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),i&&o.done]))[0]};return de.set(t,o),o}oe=(e=>({...e,get:(t,n,r)=>pe(t,n)||e.get(t,n,r),has:(t,n)=>!!pe(t,n)||e.has(t,n)}))(oe);class ge{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map((e=>{if(function(e){const t=e.getComponent();return"VERSION"===(null==t?void 0:t.type)}(e)){const t=e.getImmediate();return`${t.library}/${t.version}`}return null})).filter((e=>e)).join(" ")}}const me="@firebase/app",fe="0.10.7",ve=new $("@firebase/app"),ye="@firebase/app-compat",we="@firebase/analytics-compat",Ce="@firebase/analytics",Se="@firebase/app-check-compat",be="@firebase/app-check",_e="@firebase/auth",xe="@firebase/auth-compat",Te="@firebase/database",ke="@firebase/database-compat",Ie="@firebase/functions",Pe="@firebase/functions-compat",Ee="@firebase/installations",Ae="@firebase/installations-compat",De="@firebase/messaging",Be="@firebase/messaging-compat",Re="@firebase/performance",Fe="@firebase/performance-compat",Ne="@firebase/remote-config",Me="@firebase/remote-config-compat",Le="@firebase/storage",Oe="@firebase/storage-compat",He="@firebase/firestore",ze="@firebase/vertexai-preview",qe="@firebase/firestore-compat",Ve="firebase",We="[DEFAULT]",Ge={[me]:"fire-core",[ye]:"fire-core-compat",[Ce]:"fire-analytics",[we]:"fire-analytics-compat",[be]:"fire-app-check",[Se]:"fire-app-check-compat",[_e]:"fire-auth",[xe]:"fire-auth-compat",[Te]:"fire-rtdb",[ke]:"fire-rtdb-compat",[Ie]:"fire-fn",[Pe]:"fire-fn-compat",[Ee]:"fire-iid",[Ae]:"fire-iid-compat",[De]:"fire-fcm",[Be]:"fire-fcm-compat",[Re]:"fire-perf",[Fe]:"fire-perf-compat",[Ne]:"fire-rc",[Me]:"fire-rc-compat",[Le]:"fire-gcs",[Oe]:"fire-gcs-compat",[He]:"fire-fst",[qe]:"fire-fst-compat",[ze]:"fire-vertex","fire-js":"fire-js",[Ve]:"fire-js-all"},Ue=new Map,je=new Map,Ke=new Map;function Ye(e,t){try{e.container.addComponent(t)}catch(n){ve.debug(`Component ${t.name} failed to register with FirebaseApp ${e.name}`,n)}}function Xe(e){const t=e.name;if(Ke.has(t))return ve.debug(`There were multiple attempts to register component ${t}.`),!1;Ke.set(t,e);for(const t of Ue.values())Ye(t,e);for(const t of je.values())Ye(t,e);return!0}function $e(e,t){const n=e.container.getProvider("heartbeat").getImmediate({optional:!0});return n&&n.triggerHeartbeat(),e.container.getProvider(t)}function Je(e){return void 0!==e.settings}const Qe=new _("app","Firebase",{"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."});class Ze{constructor(e,t,n){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=n,this.container.addComponent(new q("app",(()=>this),"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw Qe.create("app-deleted",{appName:this._name})}}const et="10.12.4";function tt(e,t={}){let n=e;if("object"!=typeof t){t={name:t}}const r=Object.assign({name:We,automaticDataCollectionEnabled:!1},t),i=r.name;if("string"!=typeof i||!i)throw Qe.create("bad-app-name",{appName:String(i)});if(n||(n=f()),!n)throw Qe.create("no-options");const o=Ue.get(i);if(o){if(B(n,o.options)&&B(r,o.config))return o;throw Qe.create("duplicate-app",{appName:i})}const s=new G(i);for(const e of Ke.values())s.addComponent(e);const a=new Ze(n,r,s);return Ue.set(i,a),a}function nt(e,t,n){var r;let i=null!==(r=Ge[e])&&void 0!==r?r:e;n&&(i+=`-${n}`);const o=i.match(/\s|\//),s=t.match(/\s|\//);if(o||s){const e=[`Unable to register library "${i}" with version "${t}":`];return o&&e.push(`library name "${i}" contains illegal characters (whitespace or "/")`),o&&s&&e.push("and"),s&&e.push(`version name "${t}" contains illegal characters (whitespace or "/")`),void ve.warn(e.join(" "))}Xe(new q(`${i}-version`,(()=>({library:i,version:t})),"VERSION"))}const rt="firebase-heartbeat-database",it=1,ot="firebase-heartbeat-store";let st=null;function at(){return st||(st=function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const s=indexedDB.open(e,t),a=le(s);return r&&s.addEventListener("upgradeneeded",(e=>{r(le(s.result),e.oldVersion,e.newVersion,le(s.transaction),e)})),n&&s.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{o&&e.addEventListener("close",(()=>o())),i&&e.addEventListener("versionchange",(e=>i(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(rt,it,{upgrade:(e,t)=>{if(0===t)try{e.createObjectStore(ot)}catch(e){console.warn(e)}}}).catch((e=>{throw Qe.create("idb-open",{originalErrorMessage:e.message})}))),st}async function lt(e,t){try{const n=(await at()).transaction(ot,"readwrite"),r=n.objectStore(ot);await r.put(t,ct(e)),await n.done}catch(e){if(e instanceof b)ve.warn(e.message);else{const t=Qe.create("idb-set",{originalErrorMessage:null==e?void 0:e.message});ve.warn(t.message)}}}function ct(e){return`${e.name}!${e.options.appId}`}class ut{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new dt(t),this._heartbeatsCachePromise=this._storage.read().then((e=>(this._heartbeatsCache=e,e)))}async triggerHeartbeat(){var e,t;const n=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),r=ht();if((null!=(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||(this._heartbeatsCache=await this._heartbeatsCachePromise,null!=(null===(t=this._heartbeatsCache)||void 0===t?void 0:t.heartbeats)))&&this._heartbeatsCache.lastSentHeartbeatDate!==r&&!this._heartbeatsCache.heartbeats.some((e=>e.date===r)))return this._heartbeatsCache.heartbeats.push({date:r,agent:n}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter((e=>{const t=new Date(e.date).valueOf();return Date.now()-t<=2592e6})),this._storage.overwrite(this._heartbeatsCache)}async getHeartbeatsHeader(){var e;if(null===this._heartbeatsCache&&await this._heartbeatsCachePromise,null==(null===(e=this._heartbeatsCache)||void 0===e?void 0:e.heartbeats)||0===this._heartbeatsCache.heartbeats.length)return"";const t=ht(),{heartbeatsToSend:n,unsentEntries:r}=function(e,t=1024){const n=[];let r=e.slice();for(const i of e){const e=n.find((e=>e.agent===i.agent));if(e){if(e.dates.push(i.date),pt(n)>t){e.dates.pop();break}}else if(n.push({agent:i.agent,dates:[i.date]}),pt(n)>t){n.pop();break}r=r.slice(1)}return{heartbeatsToSend:n,unsentEntries:r}}(this._heartbeatsCache.heartbeats),i=c(JSON.stringify({version:2,heartbeats:n}));return this._heartbeatsCache.lastSentHeartbeatDate=t,r.length>0?(this._heartbeatsCache.heartbeats=r,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),i}}function ht(){return(new Date).toISOString().substring(0,10)}class dt{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return!!function(){try{return"object"==typeof indexedDB}catch(e){return!1}}()&&new Promise(((e,t)=>{try{let n=!0;const r="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(r);i.onsuccess=()=>{i.result.close(),n||self.indexedDB.deleteDatabase(r),e(!0)},i.onupgradeneeded=()=>{n=!1},i.onerror=()=>{var e;t((null===(e=i.error)||void 0===e?void 0:e.message)||"")}}catch(e){t(e)}})).then((()=>!0)).catch((()=>!1))}async read(){if(await this._canUseIndexedDBPromise){const e=await async function(e){try{const t=(await at()).transaction(ot),n=await t.objectStore(ot).get(ct(e));return await t.done,n}catch(e){if(e instanceof b)ve.warn(e.message);else{const t=Qe.create("idb-get",{originalErrorMessage:null==e?void 0:e.message});ve.warn(t.message)}}}(this.app);return(null==e?void 0:e.heartbeats)?e:{heartbeats:[]}}return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return lt(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:e.heartbeats})}}async add(e){var t;if(await this._canUseIndexedDBPromise){const n=await this.read();return lt(this.app,{lastSentHeartbeatDate:null!==(t=e.lastSentHeartbeatDate)&&void 0!==t?t:n.lastSentHeartbeatDate,heartbeats:[...n.heartbeats,...e.heartbeats]})}}}function pt(e){return c(JSON.stringify({version:2,heartbeats:e})).length}var gt;gt="",Xe(new q("platform-logger",(e=>new ge(e)),"PRIVATE")),Xe(new q("heartbeat",(e=>new ut(e)),"PRIVATE")),nt(me,fe,gt),nt(me,fe,"esm2017"),nt("fire-js","");nt("firebase","10.12.4","app");const mt="@firebase/database",ft="1.0.6";let vt="";class yt{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),k(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:T(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class wt{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t}get(e){return P(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const Ct=function(e){try{if("undefined"!=typeof window&&void 0!==window[e]){const t=window[e];return t.setItem("firebase:sentinel","cache"),t.removeItem("firebase:sentinel"),new yt(t)}}catch(e){}return new wt},St=Ct("localStorage"),bt=Ct("sessionStorage"),_t=new $("@firebase/database"),xt=function(){let e=1;return function(){return e++}}(),Tt=function(e){const t=function(e){const t=[];let n=0;for(let i=0;i<e.length;i++){let o=e.charCodeAt(i);if(o>=55296&&o<=56319){const t=o-55296;i++,r(i<e.length,"Surrogate pair missing trail surrogate."),o=65536+(t<<10)+(e.charCodeAt(i)-56320)}o<128?t[n++]=o:o<2048?(t[n++]=o>>6|192,t[n++]=63&o|128):o<65536?(t[n++]=o>>12|224,t[n++]=o>>6&63|128,t[n++]=63&o|128):(t[n++]=o>>18|240,t[n++]=o>>12&63|128,t[n++]=o>>6&63|128,t[n++]=63&o|128)}return t}(e),n=new N;n.update(t);const i=n.digest();return s.encodeByteArray(i)},kt=function(...e){let t="";for(let n=0;n<e.length;n++){const r=e[n];Array.isArray(r)||r&&"object"==typeof r&&"number"==typeof r.length?t+=kt.apply(null,r):t+="object"==typeof r?k(r):r,t+=" "}return t};let It=null,Pt=!0;const Et=function(...e){var t;if(!0===Pt&&(Pt=!1,null===It&&!0===bt.get("logging_enabled")&&(r(!t,"Can't turn on custom loggers persistently."),_t.logLevel=U.VERBOSE,It=_t.log.bind(_t))),It){const t=kt.apply(null,e);It(t)}},At=function(e){return function(...t){Et(e,...t)}},Dt=function(...e){const t="FIREBASE INTERNAL ERROR: "+kt(...e);_t.error(t)},Bt=function(...e){const t=`FIREBASE FATAL ERROR: ${kt(...e)}`;throw _t.error(t),new Error(t)},Rt=function(...e){const t="FIREBASE WARNING: "+kt(...e);_t.warn(t)},Ft=function(e){return"number"==typeof e&&(e!=e||e===Number.POSITIVE_INFINITY||e===Number.NEGATIVE_INFINITY)},Nt="[MIN_NAME]",Mt="[MAX_NAME]",Lt=function(e,t){if(e===t)return 0;if(e===Nt||t===Mt)return-1;if(t===Nt||e===Mt)return 1;{const n=Ut(e),r=Ut(t);return null!==n?null!==r?n-r==0?e.length-t.length:n-r:-1:null!==r?1:e<t?-1:1}},Ot=function(e,t){return e===t?0:e<t?-1:1},Ht=function(e,t){if(t&&e in t)return t[e];throw new Error("Missing required key ("+e+") in object: "+k(t))},zt=function(e){if("object"!=typeof e||null===e)return k(e);const t=[];for(const n in e)t.push(n);t.sort();let n="{";for(let r=0;r<t.length;r++)0!==r&&(n+=","),n+=k(t[r]),n+=":",n+=zt(e[t[r]]);return n+="}",n},qt=function(e,t){const n=e.length;if(n<=t)return[e];const r=[];for(let i=0;i<n;i+=t)i+t>n?r.push(e.substring(i,n)):r.push(e.substring(i,i+t));return r};function Vt(e,t){for(const n in e)e.hasOwnProperty(n)&&t(n,e[n])}const Wt=function(e){r(!Ft(e),"Invalid JSON number");const t=1023;let n,i,o,s,a;0===e?(i=0,o=0,n=1/e==-1/0?1:0):(n=e<0,(e=Math.abs(e))>=Math.pow(2,-1022)?(s=Math.min(Math.floor(Math.log(e)/Math.LN2),t),i=s+t,o=Math.round(e*Math.pow(2,52-s)-Math.pow(2,52))):(i=0,o=Math.round(e/Math.pow(2,-1074))));const l=[];for(a=52;a;a-=1)l.push(o%2?1:0),o=Math.floor(o/2);for(a=11;a;a-=1)l.push(i%2?1:0),i=Math.floor(i/2);l.push(n?1:0),l.reverse();const c=l.join("");let u="";for(a=0;a<64;a+=8){let e=parseInt(c.substr(a,8),2).toString(16);1===e.length&&(e="0"+e),u+=e}return u.toLowerCase()},Gt=new RegExp("^-?(0*)\\d{1,10}$"),Ut=function(e){if(Gt.test(e)){const t=Number(e);if(t>=-2147483648&&t<=2147483647)return t}return null},jt=function(e){try{e()}catch(e){setTimeout((()=>{const t=e.stack||"";throw Rt("Exception was thrown by user callback.",t),e}),Math.floor(0))}},Kt=function(e,t){const n=setTimeout(e,t);return"number"==typeof n&&"undefined"!=typeof Deno&&Deno.unrefTimer?Deno.unrefTimer(n):"object"==typeof n&&n.unref&&n.unref(),n};class Yt{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=null==t?void 0:t.getImmediate({optional:!0}),this.appCheck||null==t||t.get().then((e=>this.appCheck=e))}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise(((t,n)=>{setTimeout((()=>{this.appCheck?this.getToken(e).then(t,n):t(null)}),0)}))}addTokenChangeListener(e){var t;null===(t=this.appCheckProvider)||void 0===t||t.get().then((t=>t.addTokenListener(e)))}notifyForInvalidToken(){Rt(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class Xt{constructor(e,t,n){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=n,this.auth_=null,this.auth_=n.getImmediate({optional:!0}),this.auth_||n.onInit((e=>this.auth_=e))}getToken(e){return this.auth_?this.auth_.getToken(e).catch((e=>e&&"auth/token-not-initialized"===e.code?(Et("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(e))):new Promise(((t,n)=>{setTimeout((()=>{this.auth_?this.getToken(e).then(t,n):t(null)}),0)}))}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then((t=>t.addAuthTokenListener(e)))}removeTokenChangeListener(e){this.authProvider_.get().then((t=>t.removeAuthTokenListener(e)))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';"credential"in this.firebaseOptions_?e+='Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?e+='Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':e+='Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',Rt(e)}}class $t{constructor(e){this.accessToken=e}getToken(e){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(e){e(this.accessToken)}removeTokenChangeListener(e){}notifyForInvalidToken(){}}$t.OWNER="owner";const Jt=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Qt="ac",Zt="websocket",en="long_polling";class tn{constructor(e,t,n,r,i=!1,o="",s=!1,a=!1){this.secure=t,this.namespace=n,this.webSocketOnly=r,this.nodeAdmin=i,this.persistenceKey=o,this.includeNamespaceInQueryParams=s,this.isUsingEmulator=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=St.get("host:"+e)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&St.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){const e=this.secure?"https://":"http://",t=this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:"";return`${e}${this.host}/${t}`}}function nn(e,t,n){let i;if(r("string"==typeof t,"typeof type must == string"),r("object"==typeof n,"typeof params must == object"),t===Zt)i=(e.secure?"wss://":"ws://")+e.internalHost+"/.ws?";else{if(t!==en)throw new Error("Unknown connection type: "+t);i=(e.secure?"https://":"http://")+e.internalHost+"/.lp?"}(function(e){return e.host!==e.internalHost||e.isCustomHost()||e.includeNamespaceInQueryParams})(e)&&(n.ns=e.namespace);const o=[];return Vt(n,((e,t)=>{o.push(e+"="+t)})),i+o.join("&")}class rn{constructor(){this.counters_={}}incrementCounter(e,t=1){P(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return h(this.counters_)}}const on={},sn={};function an(e){const t=e.toString();return on[t]||(on[t]=new rn),on[t]}class ln{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const e=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let t=0;t<e.length;++t)e[t]&&jt((()=>{this.onMessage_(e[t])}));if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}const cn="start";class un{constructor(e,t,n,r,i,o,s){this.connId=e,this.repoInfo=t,this.applicationId=n,this.appCheckToken=r,this.authToken=i,this.transportSessionId=o,this.lastSessionId=s,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=At(e),this.stats_=an(t),this.urlFn=e=>(this.appCheckToken&&(e[Qt]=this.appCheckToken),nn(t,en,e))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new ln(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout((()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null}),Math.floor(3e4)),function(e){if("complete"===document.readyState)e();else{let t=!1;const n=function(){document.body?t||(t=!0,e()):setTimeout(n,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",n,!1),window.addEventListener("load",n,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",(()=>{"complete"===document.readyState&&n()})),window.attachEvent("onload",n))}}((()=>{if(this.isClosed_)return;this.scriptTagHolder=new hn(((...e)=>{const[t,n,r,i,o]=e;if(this.incrementIncomingBytes_(e),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,t===cn)this.id=n,this.password=r;else{if("close"!==t)throw new Error("Unrecognized command received: "+t);n?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(n,(()=>{this.onClosed_()}))):this.onClosed_()}}),((...e)=>{const[t,n]=e;this.incrementIncomingBytes_(e),this.myPacketOrderer.handleResponse(t,n)}),(()=>{this.onClosed_()}),this.urlFn);const e={};e[cn]="t",e.ser=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(e.cb=this.scriptTagHolder.uniqueCallbackIdentifier),e.v="5",this.transportSessionId&&(e.s=this.transportSessionId),this.lastSessionId&&(e.ls=this.lastSessionId),this.applicationId&&(e.p=this.applicationId),this.appCheckToken&&(e[Qt]=this.appCheckToken),"undefined"!=typeof location&&location.hostname&&Jt.test(location.hostname)&&(e.r="f");const t=this.urlFn(e);this.log_("Connecting via long-poll to "+t),this.scriptTagHolder.addTag(t,(()=>{}))}))}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){un.forceAllow_=!0}static forceDisallow(){un.forceDisallow_=!0}static isAvailable(){return!!un.forceAllow_||!(un.forceDisallow_||"undefined"==typeof document||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI)}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=k(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const n=l(t),r=qt(n,1840);for(let e=0;e<r.length;e++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,r.length,r[e]),this.curSegmentNum++}addDisconnectPingFrame(e,t){this.myDisconnFrame=document.createElement("iframe");const n={dframe:"t"};n.id=e,n.pw=t,this.myDisconnFrame.src=this.urlFn(n),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=k(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class hn{constructor(e,t,n,r){this.onDisconnect=n,this.urlFn=r,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0;{this.uniqueCallbackIdentifier=xt(),window["pLPCommand"+this.uniqueCallbackIdentifier]=e,window["pRTLPCB"+this.uniqueCallbackIdentifier]=t,this.myIFrame=hn.createIFrame_();let n="";if(this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)){n='<script>document.domain="'+document.domain+'";<\/script>'}const r="<html><body>"+n+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(r),this.myIFrame.doc.close()}catch(e){Et("frame writing exception"),e.stack&&Et(e.stack),Et(e)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{e.contentWindow.document||Et("No IE domain setting required")}catch(t){const n=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+n+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout((()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)}),Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e.id=this.myID,e.pw=this.myPW,e.ser=this.currentSerial;let t=this.urlFn(e),n="",r=0;for(;this.pendingSegs.length>0;){if(!(this.pendingSegs[0].d.length+30+n.length<=1870))break;{const e=this.pendingSegs.shift();n=n+"&seg"+r+"="+e.seg+"&ts"+r+"="+e.ts+"&d"+r+"="+e.d,r++}}return t+=n,this.addLongPollTag_(t,this.currentSerial),!0}return!1}enqueueSegment(e,t,n){this.pendingSegs.push({seg:e,ts:t,d:n}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const n=()=>{this.outstandingRequests.delete(t),this.newRequest_()},r=setTimeout(n,Math.floor(25e3));this.addTag(e,(()=>{clearTimeout(r),n()}))}addTag(e,t){setTimeout((()=>{try{if(!this.sendNewPolls)return;const n=this.myIFrame.doc.createElement("script");n.type="text/javascript",n.async=!0,n.src=e,n.onload=n.onreadystatechange=function(){const e=n.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,n.parentNode&&n.parentNode.removeChild(n),t())},n.onerror=()=>{Et("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(n)}catch(e){}}),Math.floor(1))}}let dn=null;"undefined"!=typeof MozWebSocket?dn=MozWebSocket:"undefined"!=typeof WebSocket&&(dn=WebSocket);class pn{constructor(e,t,n,r,i,o,s){this.connId=e,this.applicationId=n,this.appCheckToken=r,this.authToken=i,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=At(this.connId),this.stats_=an(t),this.connURL=pn.connectionURL_(t,o,s,r,n),this.nodeAdmin=t.nodeAdmin}static connectionURL_(e,t,n,r,i){const o={v:"5"};return"undefined"!=typeof location&&location.hostname&&Jt.test(location.hostname)&&(o.r="f"),t&&(o.s=t),n&&(o.ls=n),r&&(o[Qt]=r),i&&(o.p=i),nn(e,Zt,o)}open(e,t){this.onDisconnect=t,this.onMessage=e,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,St.set("previous_websocket_failure",!0);try{let e;S(),this.mySock=new dn(this.connURL,[],e)}catch(e){this.log_("Error instantiating WebSocket.");const t=e.message||e.data;return t&&this.log_(t),void this.onClosed_()}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=e=>{this.handleIncomingFrame(e)},this.mySock.onerror=e=>{this.log_("WebSocket error.  Closing connection.");const t=e.message||e.data;t&&this.log_(t),this.onClosed_()}}start(){}static forceDisallow(){pn.forceDisallow_=!0}static isAvailable(){let e=!1;if("undefined"!=typeof navigator&&navigator.userAgent){const t=/Android ([0-9]{0,}\.[0-9]{0,})/,n=navigator.userAgent.match(t);n&&n.length>1&&parseFloat(n[1])<4.4&&(e=!0)}return!e&&null!==dn&&!pn.forceDisallow_}static previouslyFailed(){return St.isInMemoryStorage||!0===St.get("previous_websocket_failure")}markConnectionHealthy(){St.remove("previous_websocket_failure")}appendFrame_(e){if(this.frames.push(e),this.frames.length===this.totalFrames){const e=this.frames.join("");this.frames=null;const t=T(e);this.onMessage(t)}}handleNewFrameCount_(e){this.totalFrames=e,this.frames=[]}extractFrameCount_(e){if(r(null===this.frames,"We already have a frame buffer"),e.length<=6){const t=Number(e);if(!isNaN(t))return this.handleNewFrameCount_(t),null}return this.handleNewFrameCount_(1),e}handleIncomingFrame(e){if(null===this.mySock)return;const t=e.data;if(this.bytesReceived+=t.length,this.stats_.incrementCounter("bytes_received",t.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(t);else{const e=this.extractFrameCount_(t);null!==e&&this.appendFrame_(e)}}send(e){this.resetKeepAlive();const t=k(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const n=qt(t,16384);n.length>1&&this.sendString_(String(n.length));for(let e=0;e<n.length;e++)this.sendString_(n[e])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval((()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()}),Math.floor(45e3))}sendString_(e){try{this.mySock.send(e)}catch(e){this.log_("Exception thrown from WebSocket.send():",e.message||e.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}pn.responsesRequiredToBeHealthy=2,pn.healthyTimeout=3e4;class gn{constructor(e){this.initTransports_(e)}static get ALL_TRANSPORTS(){return[un,pn]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(e){const t=pn&&pn.isAvailable();let n=t&&!pn.previouslyFailed();if(e.webSocketOnly&&(t||Rt("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),n=!0),n)this.transports_=[pn];else{const e=this.transports_=[];for(const t of gn.ALL_TRANSPORTS)t&&t.isAvailable()&&e.push(t);gn.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}gn.globalTransportInitialized_=!1;class mn{constructor(e,t,n,r,i,o,s,a,l,c){this.id=e,this.repoInfo_=t,this.applicationId_=n,this.appCheckToken_=r,this.authToken_=i,this.onMessage_=o,this.onReady_=s,this.onDisconnect_=a,this.onKill_=l,this.lastSessionId=c,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=At("c:"+this.id+":"),this.transportManager_=new gn(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),n=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout((()=>{this.conn_&&this.conn_.open(t,n)}),Math.floor(0));const r=e.healthyTimeout||0;r>0&&(this.healthyTimeout_=Kt((()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))}),Math.floor(r)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{2!==this.state_&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){const t={t:"d",d:e};this.sendData_(t)}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if("t"in e){const t=e.t;"a"===t?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),this.tx_!==this.secondaryConn_&&this.rx_!==this.secondaryConn_||this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Ht("t",e),n=Ht("d",e);if("c"===t)this.onSecondaryControl_(n);else{if("d"!==t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(n)}}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Ht("t",e),n=Ht("d",e);"c"===t?this.onControl_(n):"d"===t&&this.onDataMessage_(n)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Ht("t",e);if("d"in e){const n=e.d;if("h"===t){const e=Object.assign({},n);this.repoInfo_.isUsingEmulator&&(e.h=this.repoInfo_.host),this.onHandshake_(e)}else if("n"===t){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let e=0;e<this.pendingDataMessages.length;++e)this.onDataMessage_(this.pendingDataMessages[e]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===t?this.onConnectionShutdown_(n):"r"===t?this.onReset_(n):"e"===t?Dt("Server Error: "+n):"o"===t?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):Dt("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,n=e.v,r=e.h;this.sessionId=e.s,this.repoInfo_.host=r,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),"5"!==n&&Rt("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),n=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,n),Kt((()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())}),Math.floor(6e4))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Kt((()=>{this.sendPingOnPrimaryIfNecessary_()}),Math.floor(5e3))}sendPingOnPrimaryIfNecessary_(){this.isHealthy_||1!==this.state_||(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,this.tx_!==e&&this.rx_!==e||this.close()}onConnectionLost_(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(St.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class fn{put(e,t,n,r){}merge(e,t,n,r){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,n){}onDisconnectMerge(e,t,n){}onDisconnectCancel(e,t){}reportStats(e){}}class vn{constructor(e){this.allowedEvents_=e,this.listeners_={},r(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const n=[...this.listeners_[e]];for(let e=0;e<n.length;e++)n[e].callback.apply(n[e].context,t)}}on(e,t,n){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:n});const r=this.getInitialEvent(e);r&&t.apply(n,r)}off(e,t,n){this.validateEventType_(e);const r=this.listeners_[e]||[];for(let e=0;e<r.length;e++)if(r[e].callback===t&&(!n||n===r[e].context))return void r.splice(e,1)}validateEventType_(e){r(this.allowedEvents_.find((t=>t===e)),"Unknown event: "+e)}}class yn extends vn{constructor(){super(["online"]),this.online_=!0,"undefined"==typeof window||void 0===window.addEventListener||w()||(window.addEventListener("online",(()=>{this.online_||(this.online_=!0,this.trigger("online",!0))}),!1),window.addEventListener("offline",(()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))}),!1))}static getInstance(){return new yn}getInitialEvent(e){return r("online"===e,"Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}const wn=32,Cn=768;class Sn{constructor(e,t){if(void 0===t){this.pieces_=e.split("/");let t=0;for(let e=0;e<this.pieces_.length;e++)this.pieces_[e].length>0&&(this.pieces_[t]=this.pieces_[e],t++);this.pieces_.length=t,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"}}function bn(){return new Sn("")}function _n(e){return e.pieceNum_>=e.pieces_.length?null:e.pieces_[e.pieceNum_]}function xn(e){return e.pieces_.length-e.pieceNum_}function Tn(e){let t=e.pieceNum_;return t<e.pieces_.length&&t++,new Sn(e.pieces_,t)}function kn(e){return e.pieceNum_<e.pieces_.length?e.pieces_[e.pieces_.length-1]:null}function In(e,t=0){return e.pieces_.slice(e.pieceNum_+t)}function Pn(e){if(e.pieceNum_>=e.pieces_.length)return null;const t=[];for(let n=e.pieceNum_;n<e.pieces_.length-1;n++)t.push(e.pieces_[n]);return new Sn(t,0)}function En(e,t){const n=[];for(let t=e.pieceNum_;t<e.pieces_.length;t++)n.push(e.pieces_[t]);if(t instanceof Sn)for(let e=t.pieceNum_;e<t.pieces_.length;e++)n.push(t.pieces_[e]);else{const e=t.split("/");for(let t=0;t<e.length;t++)e[t].length>0&&n.push(e[t])}return new Sn(n,0)}function An(e){return e.pieceNum_>=e.pieces_.length}function Dn(e,t){const n=_n(e),r=_n(t);if(null===n)return t;if(n===r)return Dn(Tn(e),Tn(t));throw new Error("INTERNAL ERROR: innerPath ("+t+") is not within outerPath ("+e+")")}function Bn(e,t){if(xn(e)!==xn(t))return!1;for(let n=e.pieceNum_,r=t.pieceNum_;n<=e.pieces_.length;n++,r++)if(e.pieces_[n]!==t.pieces_[r])return!1;return!0}function Rn(e,t){let n=e.pieceNum_,r=t.pieceNum_;if(xn(e)>xn(t))return!1;for(;n<e.pieces_.length;){if(e.pieces_[n]!==t.pieces_[r])return!1;++n,++r}return!0}class Fn{constructor(e,t){this.errorPrefix_=t,this.parts_=In(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let e=0;e<this.parts_.length;e++)this.byteLength_+=H(this.parts_[e]);Nn(this)}}function Nn(e){if(e.byteLength_>Cn)throw new Error(e.errorPrefix_+"has a key path longer than "+Cn+" bytes ("+e.byteLength_+").");if(e.parts_.length>wn)throw new Error(e.errorPrefix_+"path specified exceeds the maximum depth that can be written ("+wn+") or object contains a cycle "+Mn(e))}function Mn(e){return 0===e.parts_.length?"":"in property '"+e.parts_.join(".")+"'"}class Ln extends vn{constructor(){let e,t;super(["visible"]),"undefined"!=typeof document&&void 0!==document.addEventListener&&(void 0!==document.hidden?(t="visibilitychange",e="hidden"):void 0!==document.mozHidden?(t="mozvisibilitychange",e="mozHidden"):void 0!==document.msHidden?(t="msvisibilitychange",e="msHidden"):void 0!==document.webkitHidden&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,(()=>{const t=!document[e];t!==this.visible_&&(this.visible_=t,this.trigger("visible",t))}),!1)}static getInstance(){return new Ln}getInitialEvent(e){return r("visible"===e,"Unknown event type: "+e),[this.visible_]}}const On=1e3;class Hn extends fn{constructor(e,t,n,r,i,o,s,a){if(super(),this.repoInfo_=e,this.applicationId_=t,this.onDataUpdate_=n,this.onConnectStatus_=r,this.onServerInfoUpdate_=i,this.authTokenProvider_=o,this.appCheckTokenProvider_=s,this.authOverride_=a,this.id=Hn.nextPersistentConnectionId_++,this.log_=At("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=On,this.maxReconnectDelay_=3e5,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,a&&!S())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");Ln.getInstance().on("visible",this.onVisible_,this),-1===e.host.indexOf("fblocal")&&yn.getInstance().on("online",this.onOnline_,this)}sendRequest(e,t,n){const i=++this.requestNumber_,o={r:i,a:e,b:t};this.log_(k(o)),r(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),n&&(this.requestCBHash_[i]=n)}get(e){this.initConnection_();const t=new v,n={action:"g",request:{p:e._path.toString(),q:e._queryObject},onComplete:e=>{const n=e.d;"ok"===e.s?t.resolve(n):t.reject(n)}};this.outstandingGets_.push(n),this.outstandingGetCount_++;const r=this.outstandingGets_.length-1;return this.connected_&&this.sendGet_(r),t.promise}listen(e,t,n,i){this.initConnection_();const o=e._queryIdentifier,s=e._path.toString();this.log_("Listen called for "+s+" "+o),this.listens.has(s)||this.listens.set(s,new Map),r(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"listen() called for non-default but complete query"),r(!this.listens.get(s).has(o),"listen() called twice for same path/queryId.");const a={onComplete:i,hashFn:t,query:e,tag:n};this.listens.get(s).set(o,a),this.connected_&&this.sendListen_(a)}sendGet_(e){const t=this.outstandingGets_[e];this.sendRequest("g",t.request,(n=>{delete this.outstandingGets_[e],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),t.onComplete&&t.onComplete(n)}))}sendListen_(e){const t=e.query,n=t._path.toString(),r=t._queryIdentifier;this.log_("Listen on "+n+" for "+r);const i={p:n};e.tag&&(i.q=t._queryObject,i.t=e.tag),i.h=e.hashFn(),this.sendRequest("q",i,(i=>{const o=i.d,s=i.s;Hn.warnOnListenWarnings_(o,t);(this.listens.get(n)&&this.listens.get(n).get(r))===e&&(this.log_("listen response",i),"ok"!==s&&this.removeListen_(n,r),e.onComplete&&e.onComplete(s,o))}))}static warnOnListenWarnings_(e,t){if(e&&"object"==typeof e&&P(e,"w")){const n=E(e,"w");if(Array.isArray(n)&&~n.indexOf("no_index")){const e='".indexOn": "'+t._queryParams.getIndex().toString()+'"',n=t._path.toString();Rt(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${e} at ${n} to your security rules for better performance.`)}}}refreshAuthToken(e){this.authToken_=e,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},(()=>{})),this.reduceReconnectDelayIfAdminCredential_(e)}reduceReconnectDelayIfAdminCredential_(e){(e&&40===e.length||function(e){const t=I(e).claims;return"object"==typeof t&&!0===t.admin}(e))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)}refreshAppCheckToken(e){this.appCheckToken_=e,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},(()=>{}))}tryAuth(){if(this.connected_&&this.authToken_){const e=this.authToken_,t=function(e){const t=I(e).claims;return!!t&&"object"==typeof t&&t.hasOwnProperty("iat")}(e)?"auth":"gauth",n={cred:e};null===this.authOverride_?n.noauth=!0:"object"==typeof this.authOverride_&&(n.authvar=this.authOverride_),this.sendRequest(t,n,(t=>{const n=t.s,r=t.d||"error";this.authToken_===e&&("ok"===n?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(n,r))}))}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},(e=>{const t=e.s,n=e.d||"error";"ok"===t?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(t,n)}))}unlisten(e,t){const n=e._path.toString(),i=e._queryIdentifier;this.log_("Unlisten called for "+n+" "+i),r(e._queryParams.isDefault()||!e._queryParams.loadsAllData(),"unlisten() called for non-default but complete query");this.removeListen_(n,i)&&this.connected_&&this.sendUnlisten_(n,i,e._queryObject,t)}sendUnlisten_(e,t,n,r){this.log_("Unlisten on "+e+" for "+t);const i={p:e};r&&(i.q=n,i.t=r),this.sendRequest("n",i)}onDisconnectPut(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"o",data:t,onComplete:n})}onDisconnectMerge(e,t,n){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",e,t,n):this.onDisconnectRequestQueue_.push({pathString:e,action:"om",data:t,onComplete:n})}onDisconnectCancel(e,t){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",e,null,t):this.onDisconnectRequestQueue_.push({pathString:e,action:"oc",data:null,onComplete:t})}sendOnDisconnect_(e,t,n,r){const i={p:t,d:n};this.log_("onDisconnect "+e,i),this.sendRequest(e,i,(e=>{r&&setTimeout((()=>{r(e.s,e.d)}),Math.floor(0))}))}put(e,t,n,r){this.putInternal("p",e,t,n,r)}merge(e,t,n,r){this.putInternal("m",e,t,n,r)}putInternal(e,t,n,r,i){this.initConnection_();const o={p:t,d:n};void 0!==i&&(o.h=i),this.outstandingPuts_.push({action:e,request:o,onComplete:r}),this.outstandingPutCount_++;const s=this.outstandingPuts_.length-1;this.connected_?this.sendPut_(s):this.log_("Buffering put: "+t)}sendPut_(e){const t=this.outstandingPuts_[e].action,n=this.outstandingPuts_[e].request,r=this.outstandingPuts_[e].onComplete;this.outstandingPuts_[e].queued=this.connected_,this.sendRequest(t,n,(n=>{this.log_(t+" response",n),delete this.outstandingPuts_[e],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),r&&r(n.s,n.d)}))}reportStats(e){if(this.connected_){const t={c:e};this.log_("reportStats",t),this.sendRequest("s",t,(e=>{if("ok"!==e.s){const t=e.d;this.log_("reportStats","Error sending stats: "+t)}}))}}onDataMessage_(e){if("r"in e){this.log_("from server: "+k(e));const t=e.r,n=this.requestCBHash_[t];n&&(delete this.requestCBHash_[t],n(e.b))}else{if("error"in e)throw"A server-side error has occurred: "+e.error;"a"in e&&this.onDataPush_(e.a,e.b)}}onDataPush_(e,t){this.log_("handleServerMessage",e,t),"d"===e?this.onDataUpdate_(t.p,t.d,!1,t.t):"m"===e?this.onDataUpdate_(t.p,t.d,!0,t.t):"c"===e?this.onListenRevoked_(t.p,t.q):"ac"===e?this.onAuthRevoked_(t.s,t.d):"apc"===e?this.onAppCheckRevoked_(t.s,t.d):"sd"===e?this.onSecurityDebugPacket_(t):Dt("Unrecognized action received from server: "+k(e)+"\nAre you using the latest client?")}onReady_(e,t){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(e),this.lastSessionId=t,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(e){r(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout((()=>{this.establishConnectionTimer_=null,this.establishConnection_()}),Math.floor(e))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(e){e&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=On,this.realtime_||this.scheduleConnect_(0)),this.visible_=e}onOnline_(e){e?(this.log_("Browser went online."),this.reconnectDelay_=On,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){if(this.visible_){if(this.lastConnectionEstablishedTime_){(new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=On),this.lastConnectionEstablishedTime_=null}}else this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime();const e=(new Date).getTime()-this.lastConnectionAttemptTime_;let t=Math.max(0,this.reconnectDelay_-e);t=Math.random()*t,this.log_("Trying to reconnect in "+t+"ms"),this.scheduleConnect_(t),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}async establishConnection_(){if(this.shouldReconnect_()){this.log_("Making a connection attempt"),this.lastConnectionAttemptTime_=(new Date).getTime(),this.lastConnectionEstablishedTime_=null;const e=this.onDataMessage_.bind(this),t=this.onReady_.bind(this),n=this.onRealtimeDisconnect_.bind(this),i=this.id+":"+Hn.nextConnectionId_++,o=this.lastSessionId;let s=!1,a=null;const l=function(){a?a.close():(s=!0,n())},c=function(e){r(a,"sendRequest call when we're not connected not allowed."),a.sendRequest(e)};this.realtime_={close:l,sendRequest:c};const u=this.forceTokenRefresh_;this.forceTokenRefresh_=!1;try{const[r,l]=await Promise.all([this.authTokenProvider_.getToken(u),this.appCheckTokenProvider_.getToken(u)]);s?Et("getToken() completed but was canceled"):(Et("getToken() completed. Creating connection."),this.authToken_=r&&r.accessToken,this.appCheckToken_=l&&l.token,a=new mn(i,this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,e,t,n,(e=>{Rt(e+" ("+this.repoInfo_.toString()+")"),this.interrupt("server_kill")}),o))}catch(e){this.log_("Failed to get token: "+e),s||(this.repoInfo_.nodeAdmin&&Rt(e),l())}}}interrupt(e){Et("Interrupting connection for reason: "+e),this.interruptReasons_[e]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(e){Et("Resuming connection for reason: "+e),delete this.interruptReasons_[e],A(this.interruptReasons_)&&(this.reconnectDelay_=On,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(e){const t=e-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:t})}cancelSentTransactions_(){for(let e=0;e<this.outstandingPuts_.length;e++){const t=this.outstandingPuts_[e];t&&"h"in t.request&&t.queued&&(t.onComplete&&t.onComplete("disconnect"),delete this.outstandingPuts_[e],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(e,t){let n;n=t?t.map((e=>zt(e))).join("$"):"default";const r=this.removeListen_(e,n);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(e,t){const n=new Sn(e).toString();let r;if(this.listens.has(n)){const e=this.listens.get(n);r=e.get(t),e.delete(t),0===e.size&&this.listens.delete(n)}else r=void 0;return r}onAuthRevoked_(e,t){Et("Auth token revoked: "+e+"/"+t),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(e,t){Et("App check token revoked: "+e+"/"+t),this.appCheckToken_=null,this.forceTokenRefresh_=!0,"invalid_token"!==e&&"permission_denied"!==e||(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(e){this.securityDebugCallback_?this.securityDebugCallback_(e):"msg"in e&&console.log("FIREBASE: "+e.msg.replace("\n","\nFIREBASE: "))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const e of this.listens.values())for(const t of e.values())this.sendListen_(t);for(let e=0;e<this.outstandingPuts_.length;e++)this.outstandingPuts_[e]&&this.sendPut_(e);for(;this.onDisconnectRequestQueue_.length;){const e=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(e.action,e.pathString,e.data,e.onComplete)}for(let e=0;e<this.outstandingGets_.length;e++)this.outstandingGets_[e]&&this.sendGet_(e)}sendConnectStats_(){const e={};e["sdk.js."+vt.replace(/\./g,"-")]=1,w()?e["framework.cordova"]=1:C()&&(e["framework.reactnative"]=1),this.reportStats(e)}shouldReconnect_(){const e=yn.getInstance().currentlyOnline();return A(this.interruptReasons_)&&e}}Hn.nextPersistentConnectionId_=0,Hn.nextConnectionId_=0;class zn{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new zn(e,t)}}class qn{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const n=new zn(Nt,e),r=new zn(Nt,t);return 0!==this.compare(n,r)}minPost(){return zn.MIN}}let Vn;class Wn extends qn{static get __EMPTY_NODE(){return Vn}static set __EMPTY_NODE(e){Vn=e}compare(e,t){return Lt(e.name,t.name)}isDefinedOn(e){throw i("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return zn.MIN}maxPost(){return new zn(Mt,Vn)}makePost(e,t){return r("string"==typeof e,"KeyIndex indexValue must always be a string."),new zn(e,Vn)}toString(){return".key"}}const Gn=new Wn;class Un{constructor(e,t,n,r,i=null){this.isReverse_=r,this.resultGenerator_=i,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(o=t?n(e.key,t):1,r&&(o*=-1),o<0)e=this.isReverse_?e.left:e.right;else{if(0===o){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}getNext(){if(0===this.nodeStack_.length)return null;let e,t=this.nodeStack_.pop();if(e=this.resultGenerator_?this.resultGenerator_(t.key,t.value):{key:t.key,value:t.value},this.isReverse_)for(t=t.left;!t.isEmpty();)this.nodeStack_.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack_.push(t),t=t.left;return e}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}class jn{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:jn.RED,this.left=null!=r?r:Kn.EMPTY_NODE,this.right=null!=i?i:Kn.EMPTY_NODE}copy(e,t,n,r,i){return new jn(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||!!e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return Kn.EMPTY_NODE;let e=this;return e.left.isRed_()||e.left.left.isRed_()||(e=e.moveRedLeft_()),e=e.copy(null,null,null,e.left.removeMin_(),null),e.fixUp_()}remove(e,t){let n,r;if(n=this,t(e,n.key)<0)n.left.isEmpty()||n.left.isRed_()||n.left.left.isRed_()||(n=n.moveRedLeft_()),n=n.copy(null,null,null,n.left.remove(e,t),null);else{if(n.left.isRed_()&&(n=n.rotateRight_()),n.right.isEmpty()||n.right.isRed_()||n.right.left.isRed_()||(n=n.moveRedRight_()),0===t(e,n.key)){if(n.right.isEmpty())return Kn.EMPTY_NODE;r=n.right.min_(),n=n.copy(r.key,r.value,null,null,n.right.removeMin_())}n=n.copy(null,null,null,null,n.right.remove(e,t))}return n.fixUp_()}isRed_(){return this.color}fixUp_(){let e=this;return e.right.isRed_()&&!e.left.isRed_()&&(e=e.rotateLeft_()),e.left.isRed_()&&e.left.left.isRed_()&&(e=e.rotateRight_()),e.left.isRed_()&&e.right.isRed_()&&(e=e.colorFlip_()),e}moveRedLeft_(){let e=this.colorFlip_();return e.right.left.isRed_()&&(e=e.copy(null,null,null,null,e.right.rotateRight_()),e=e.rotateLeft_(),e=e.colorFlip_()),e}moveRedRight_(){let e=this.colorFlip_();return e.left.left.isRed_()&&(e=e.rotateRight_(),e=e.colorFlip_()),e}rotateLeft_(){const e=this.copy(null,null,jn.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight_(){const e=this.copy(null,null,jn.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip_(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth_(){const e=this.check_();return Math.pow(2,e)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const e=this.left.check_();if(e!==this.right.check_())throw new Error("Black depths differ");return e+(this.isRed_()?0:1)}}jn.RED=!0,jn.BLACK=!1;class Kn{constructor(e,t=Kn.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new Kn(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,jn.BLACK,null,null))}remove(e){return new Kn(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,jn.BLACK,null,null))}get(e){let t,n=this.root_;for(;!n.isEmpty();){if(t=this.comparator_(e,n.key),0===t)return n.value;t<0?n=n.left:t>0&&(n=n.right)}return null}getPredecessorKey(e){let t,n=this.root_,r=null;for(;!n.isEmpty();){if(t=this.comparator_(e,n.key),0===t){if(n.left.isEmpty())return r?r.key:null;for(n=n.left;!n.right.isEmpty();)n=n.right;return n.key}t<0?n=n.left:t>0&&(r=n,n=n.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new Un(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new Un(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new Un(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new Un(this.root_,null,this.comparator_,!0,e)}}function Yn(e,t){return Lt(e.name,t.name)}function Xn(e,t){return Lt(e,t)}let $n;Kn.EMPTY_NODE=new class{copy(e,t,n,r,i){return this}insert(e,t,n){return new jn(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}};const Jn=function(e){return"number"==typeof e?"number:"+Wt(e):"string:"+e},Qn=function(e){if(e.isLeafNode()){const t=e.val();r("string"==typeof t||"number"==typeof t||"object"==typeof t&&P(t,".sv"),"Priority must be a string or number.")}else r(e===$n||e.isEmpty(),"priority of unexpected type.");r(e===$n||e.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let Zn,er,tr;class nr{constructor(e,t=nr.__childrenNodeConstructor.EMPTY_NODE){this.value_=e,this.priorityNode_=t,this.lazyHash_=null,r(void 0!==this.value_&&null!==this.value_,"LeafNode shouldn't be created with null/undefined value."),Qn(this.priorityNode_)}static set __childrenNodeConstructor(e){Zn=e}static get __childrenNodeConstructor(){return Zn}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(e){return new nr(this.value_,e)}getImmediateChild(e){return".priority"===e?this.priorityNode_:nr.__childrenNodeConstructor.EMPTY_NODE}getChild(e){return An(e)?this:".priority"===_n(e)?this.priorityNode_:nr.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(e,t){return null}updateImmediateChild(e,t){return".priority"===e?this.updatePriority(t):t.isEmpty()&&".priority"!==e?this:nr.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(e,t).updatePriority(this.priorityNode_)}updateChild(e,t){const n=_n(e);return null===n?t:t.isEmpty()&&".priority"!==n?this:(r(".priority"!==n||1===xn(e),".priority must be the last token in a path"),this.updateImmediateChild(n,nr.__childrenNodeConstructor.EMPTY_NODE.updateChild(Tn(e),t)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(e,t){return!1}val(e){return e&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let e="";this.priorityNode_.isEmpty()||(e+="priority:"+Jn(this.priorityNode_.val())+":");const t=typeof this.value_;e+=t+":",e+="number"===t?Wt(this.value_):this.value_,this.lazyHash_=Tt(e)}return this.lazyHash_}getValue(){return this.value_}compareTo(e){return e===nr.__childrenNodeConstructor.EMPTY_NODE?1:e instanceof nr.__childrenNodeConstructor?-1:(r(e.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(e))}compareToLeafNode_(e){const t=typeof e.value_,n=typeof this.value_,i=nr.VALUE_TYPE_ORDER.indexOf(t),o=nr.VALUE_TYPE_ORDER.indexOf(n);return r(i>=0,"Unknown leaf type: "+t),r(o>=0,"Unknown leaf type: "+n),i===o?"object"===n?0:this.value_<e.value_?-1:this.value_===e.value_?0:1:o-i}withIndex(){return this}isIndexed(){return!0}equals(e){if(e===this)return!0;if(e.isLeafNode()){const t=e;return this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_)}return!1}}nr.VALUE_TYPE_ORDER=["object","boolean","number","string"];const rr=new class extends qn{compare(e,t){const n=e.node.getPriority(),r=t.node.getPriority(),i=n.compareTo(r);return 0===i?Lt(e.name,t.name):i}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return zn.MIN}maxPost(){return new zn(Mt,new nr("[PRIORITY-POST]",tr))}makePost(e,t){const n=er(e);return new zn(t,new nr("[PRIORITY-POST]",n))}toString(){return".priority"}},ir=Math.log(2);class or{constructor(e){var t;this.count=(t=e+1,parseInt(Math.log(t)/ir,10)),this.current_=this.count-1;const n=(r=this.count,parseInt(Array(r+1).join("1"),2));var r;this.bits_=e+1&n}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const sr=function(e,t,n,r){e.sort(t);const i=function(t,r){const o=r-t;let s,a;if(0===o)return null;if(1===o)return s=e[t],a=n?n(s):s,new jn(a,s.node,jn.BLACK,null,null);{const l=parseInt(o/2,10)+t,c=i(t,l),u=i(l+1,r);return s=e[l],a=n?n(s):s,new jn(a,s.node,jn.BLACK,c,u)}},o=function(t){let r=null,o=null,s=e.length;const a=function(t,r){const o=s-t,a=s;s-=t;const c=i(o+1,a),u=e[o],h=n?n(u):u;l(new jn(h,u.node,r,null,c))},l=function(e){r?(r.left=e,r=e):(o=e,r=e)};for(let e=0;e<t.count;++e){const n=t.nextBitIsOne(),r=Math.pow(2,t.count-(e+1));n?a(r,jn.BLACK):(a(r,jn.BLACK),a(r,jn.RED))}return o}(new or(e.length));return new Kn(r||t,o)};let ar;const lr={};class cr{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return r(lr&&rr,"ChildrenNode.ts has not been loaded"),ar=ar||new cr({".priority":lr},{".priority":rr}),ar}get(e){const t=E(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof Kn?t:null}hasIndex(e){return P(this.indexSet_,e.toString())}addIndex(e,t){r(e!==Gn,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const n=[];let i=!1;const o=t.getIterator(zn.Wrap);let s,a=o.getNext();for(;a;)i=i||e.isDefinedOn(a.node),n.push(a),a=o.getNext();s=i?sr(n,e.getCompare()):lr;const l=e.toString(),c=Object.assign({},this.indexSet_);c[l]=e;const u=Object.assign({},this.indexes_);return u[l]=s,new cr(u,c)}addToIndexes(e,t){const n=D(this.indexes_,((n,i)=>{const o=E(this.indexSet_,i);if(r(o,"Missing index implementation for "+i),n===lr){if(o.isDefinedOn(e.node)){const n=[],r=t.getIterator(zn.Wrap);let i=r.getNext();for(;i;)i.name!==e.name&&n.push(i),i=r.getNext();return n.push(e),sr(n,o.getCompare())}return lr}{const r=t.get(e.name);let i=n;return r&&(i=i.remove(new zn(e.name,r))),i.insert(e,e.node)}}));return new cr(n,this.indexSet_)}removeFromIndexes(e,t){const n=D(this.indexes_,(n=>{if(n===lr)return n;{const r=t.get(e.name);return r?n.remove(new zn(e.name,r)):n}}));return new cr(n,this.indexSet_)}}let ur;class hr{constructor(e,t,n){this.children_=e,this.priorityNode_=t,this.indexMap_=n,this.lazyHash_=null,this.priorityNode_&&Qn(this.priorityNode_),this.children_.isEmpty()&&r(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return ur||(ur=new hr(new Kn(Xn),null,cr.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||ur}updatePriority(e){return this.children_.isEmpty()?this:new hr(this.children_,e,this.indexMap_)}getImmediateChild(e){if(".priority"===e)return this.getPriority();{const t=this.children_.get(e);return null===t?ur:t}}getChild(e){const t=_n(e);return null===t?this:this.getImmediateChild(t).getChild(Tn(e))}hasChild(e){return null!==this.children_.get(e)}updateImmediateChild(e,t){if(r(t,"We should always be passing snapshot nodes"),".priority"===e)return this.updatePriority(t);{const n=new zn(e,t);let r,i;t.isEmpty()?(r=this.children_.remove(e),i=this.indexMap_.removeFromIndexes(n,this.children_)):(r=this.children_.insert(e,t),i=this.indexMap_.addToIndexes(n,this.children_));const o=r.isEmpty()?ur:this.priorityNode_;return new hr(r,o,i)}}updateChild(e,t){const n=_n(e);if(null===n)return t;{r(".priority"!==_n(e)||1===xn(e),".priority must be the last token in a path");const i=this.getImmediateChild(n).updateChild(Tn(e),t);return this.updateImmediateChild(n,i)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(e){if(this.isEmpty())return null;const t={};let n=0,r=0,i=!0;if(this.forEachChild(rr,((o,s)=>{t[o]=s.val(e),n++,i&&hr.INTEGER_REGEXP_.test(o)?r=Math.max(r,Number(o)):i=!1})),!e&&i&&r<2*n){const e=[];for(const n in t)e[n]=t[n];return e}return e&&!this.getPriority().isEmpty()&&(t[".priority"]=this.getPriority().val()),t}hash(){if(null===this.lazyHash_){let e="";this.getPriority().isEmpty()||(e+="priority:"+Jn(this.getPriority().val())+":"),this.forEachChild(rr,((t,n)=>{const r=n.hash();""!==r&&(e+=":"+t+":"+r)})),this.lazyHash_=""===e?"":Tt(e)}return this.lazyHash_}getPredecessorChildName(e,t,n){const r=this.resolveIndex_(n);if(r){const n=r.getPredecessorKey(new zn(e,t));return n?n.name:null}return this.children_.getPredecessorKey(e)}getFirstChildName(e){const t=this.resolveIndex_(e);if(t){const e=t.minKey();return e&&e.name}return this.children_.minKey()}getFirstChild(e){const t=this.getFirstChildName(e);return t?new zn(t,this.children_.get(t)):null}getLastChildName(e){const t=this.resolveIndex_(e);if(t){const e=t.maxKey();return e&&e.name}return this.children_.maxKey()}getLastChild(e){const t=this.getLastChildName(e);return t?new zn(t,this.children_.get(t)):null}forEachChild(e,t){const n=this.resolveIndex_(e);return n?n.inorderTraversal((e=>t(e.name,e.node))):this.children_.inorderTraversal(t)}getIterator(e){return this.getIteratorFrom(e.minPost(),e)}getIteratorFrom(e,t){const n=this.resolveIndex_(t);if(n)return n.getIteratorFrom(e,(e=>e));{const n=this.children_.getIteratorFrom(e.name,zn.Wrap);let r=n.peek();for(;null!=r&&t.compare(r,e)<0;)n.getNext(),r=n.peek();return n}}getReverseIterator(e){return this.getReverseIteratorFrom(e.maxPost(),e)}getReverseIteratorFrom(e,t){const n=this.resolveIndex_(t);if(n)return n.getReverseIteratorFrom(e,(e=>e));{const n=this.children_.getReverseIteratorFrom(e.name,zn.Wrap);let r=n.peek();for(;null!=r&&t.compare(r,e)>0;)n.getNext(),r=n.peek();return n}}compareTo(e){return this.isEmpty()?e.isEmpty()?0:-1:e.isLeafNode()||e.isEmpty()?1:e===dr?-1:0}withIndex(e){if(e===Gn||this.indexMap_.hasIndex(e))return this;{const t=this.indexMap_.addIndex(e,this.children_);return new hr(this.children_,this.priorityNode_,t)}}isIndexed(e){return e===Gn||this.indexMap_.hasIndex(e)}equals(e){if(e===this)return!0;if(e.isLeafNode())return!1;{const t=e;if(this.getPriority().equals(t.getPriority())){if(this.children_.count()===t.children_.count()){const e=this.getIterator(rr),n=t.getIterator(rr);let r=e.getNext(),i=n.getNext();for(;r&&i;){if(r.name!==i.name||!r.node.equals(i.node))return!1;r=e.getNext(),i=n.getNext()}return null===r&&null===i}return!1}return!1}}resolveIndex_(e){return e===Gn?null:this.indexMap_.get(e.toString())}}hr.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/;const dr=new class extends hr{constructor(){super(new Kn(Xn),hr.EMPTY_NODE,cr.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return hr.EMPTY_NODE}isEmpty(){return!1}};Object.defineProperties(zn,{MIN:{value:new zn(Nt,hr.EMPTY_NODE)},MAX:{value:new zn(Mt,dr)}}),Wn.__EMPTY_NODE=hr.EMPTY_NODE,nr.__childrenNodeConstructor=hr,$n=dr,function(e){tr=e}(dr);const pr=!0;function gr(e,t=null){if(null===e)return hr.EMPTY_NODE;if("object"==typeof e&&".priority"in e&&(t=e[".priority"]),r(null===t||"string"==typeof t||"number"==typeof t||"object"==typeof t&&".sv"in t,"Invalid priority type found: "+typeof t),"object"==typeof e&&".value"in e&&null!==e[".value"]&&(e=e[".value"]),"object"!=typeof e||".sv"in e){return new nr(e,gr(t))}if(e instanceof Array||!pr){let n=hr.EMPTY_NODE;return Vt(e,((t,r)=>{if(P(e,t)&&"."!==t.substring(0,1)){const e=gr(r);!e.isLeafNode()&&e.isEmpty()||(n=n.updateImmediateChild(t,e))}})),n.updatePriority(gr(t))}{const n=[];let r=!1;if(Vt(e,((e,t)=>{if("."!==e.substring(0,1)){const i=gr(t);i.isEmpty()||(r=r||!i.getPriority().isEmpty(),n.push(new zn(e,i)))}})),0===n.length)return hr.EMPTY_NODE;const i=sr(n,Yn,(e=>e.name),Xn);if(r){const e=sr(n,rr.getCompare());return new hr(i,gr(t),new cr({".priority":e},{".priority":rr}))}return new hr(i,gr(t),cr.Default)}}!function(e){er=e}(gr);class mr extends qn{constructor(e){super(),this.indexPath_=e,r(!An(e)&&".priority"!==_n(e),"Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const n=this.extractChild(e.node),r=this.extractChild(t.node),i=n.compareTo(r);return 0===i?Lt(e.name,t.name):i}makePost(e,t){const n=gr(e),r=hr.EMPTY_NODE.updateChild(this.indexPath_,n);return new zn(t,r)}maxPost(){const e=hr.EMPTY_NODE.updateChild(this.indexPath_,dr);return new zn(Mt,e)}toString(){return In(this.indexPath_,0).join("/")}}const fr=new class extends qn{compare(e,t){const n=e.node.compareTo(t.node);return 0===n?Lt(e.name,t.name):n}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return zn.MIN}maxPost(){return zn.MAX}makePost(e,t){const n=gr(e);return new zn(t,n)}toString(){return".value"}};function vr(e,t,n){return{type:"child_changed",snapshotNode:t,childName:e,oldSnap:n}}class yr{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=rr}hasStart(){return this.startSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return r(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return r(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:Nt}hasEnd(){return this.endSet_}getIndexEndValue(){return r(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return r(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:Mt}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return r(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===rr}copy(){const e=new yr;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function wr(e){const t={};if(e.isDefault())return t;let n;if(e.index_===rr?n="$priority":e.index_===fr?n="$value":e.index_===Gn?n="$key":(r(e.index_ instanceof mr,"Unrecognized index type!"),n=e.index_.toString()),t.orderBy=k(n),e.startSet_){const n=e.startAfterSet_?"startAfter":"startAt";t[n]=k(e.indexStartValue_),e.startNameSet_&&(t[n]+=","+k(e.indexStartName_))}if(e.endSet_){const n=e.endBeforeSet_?"endBefore":"endAt";t[n]=k(e.indexEndValue_),e.endNameSet_&&(t[n]+=","+k(e.indexEndName_))}return e.limitSet_&&(e.isViewFromLeft()?t.limitToFirst=e.limit_:t.limitToLast=e.limit_),t}function Cr(e){const t={};if(e.startSet_&&(t.sp=e.indexStartValue_,e.startNameSet_&&(t.sn=e.indexStartName_),t.sin=!e.startAfterSet_),e.endSet_&&(t.ep=e.indexEndValue_,e.endNameSet_&&(t.en=e.indexEndName_),t.ein=!e.endBeforeSet_),e.limitSet_){t.l=e.limit_;let n=e.viewFrom_;""===n&&(n=e.isViewFromLeft()?"l":"r"),t.vf=n}return e.index_!==rr&&(t.i=e.index_.toString()),t}class Sr extends fn{constructor(e,t,n,r){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=n,this.appCheckTokenProvider_=r,this.log_=At("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return void 0!==t?"tag$"+t:(r(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,n,r){const i=e._path.toString();this.log_("Listen called for "+i+" "+e._queryIdentifier);const o=Sr.getListenId_(e,n),s={};this.listens_[o]=s;const a=wr(e._queryParams);this.restRequest_(i+".json",a,((e,t)=>{let a=t;if(404===e&&(a=null,e=null),null===e&&this.onDataUpdate_(i,a,!1,n),E(this.listens_,o)===s){let t;t=e?401===e?"permission_denied":"rest_error:"+e:"ok",r(t,null)}}))}unlisten(e,t){const n=Sr.getListenId_(e,t);delete this.listens_[n]}get(e){const t=wr(e._queryParams),n=e._path.toString(),r=new v;return this.restRequest_(n+".json",t,((e,t)=>{let i=t;404===e&&(i=null,e=null),null===e?(this.onDataUpdate_(n,i,!1,null),r.resolve(i)):r.reject(new Error(i))})),r.promise}refreshAuthToken(e){}restRequest_(e,t={},n){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then((([r,i])=>{r&&r.accessToken&&(t.auth=r.accessToken),i&&i.token&&(t.ac=i.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+F(t);this.log_("Sending REST request for "+o);const s=new XMLHttpRequest;s.onreadystatechange=()=>{if(n&&4===s.readyState){this.log_("REST Response for "+o+" received. status:",s.status,"response:",s.responseText);let e=null;if(s.status>=200&&s.status<300){try{e=T(s.responseText)}catch(e){Rt("Failed to parse JSON response for "+o+": "+s.responseText)}n(null,e)}else 401!==s.status&&404!==s.status&&Rt("Got unsuccessful REST response for "+o+" Status: "+s.status),n(s.status);n=null}},s.open("GET",o,!0),s.send()}))}}class br{constructor(){this.rootNode_=hr.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function _r(){return{value:null,children:new Map}}function xr(e,t,n){if(An(t))e.value=n,e.children.clear();else if(null!==e.value)e.value=e.value.updateChild(t,n);else{const r=_n(t);e.children.has(r)||e.children.set(r,_r());xr(e.children.get(r),t=Tn(t),n)}}function Tr(e,t,n){null!==e.value?n(t,e.value):function(e,t){e.children.forEach(((e,n)=>{t(n,e)}))}(e,((e,r)=>{Tr(r,new Sn(t.toString()+"/"+e),n)}))}class kr{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t=Object.assign({},e);return this.last_&&Vt(this.last_,((e,n)=>{t[e]=t[e]-n})),this.last_=e,t}}class Ir{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new kr(e);const n=1e4+2e4*Math.random();Kt(this.reportStats_.bind(this),Math.floor(n))}reportStats_(){const e=this.statsListener_.get(),t={};let n=!1;Vt(e,((e,r)=>{r>0&&P(this.statsToReport_,e)&&(t[e]=r,n=!0)})),n&&this.server_.reportStats(t),Kt(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))}}var Pr;function Er(e){return{fromUser:!1,fromServer:!0,queryId:e,tagged:!0}}!function(e){e[e.OVERWRITE=0]="OVERWRITE",e[e.MERGE=1]="MERGE",e[e.ACK_USER_WRITE=2]="ACK_USER_WRITE",e[e.LISTEN_COMPLETE=3]="LISTEN_COMPLETE"}(Pr||(Pr={}));class Ar{constructor(e,t,n){this.path=e,this.affectedTree=t,this.revert=n,this.type=Pr.ACK_USER_WRITE,this.source={fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}operationForChild(e){if(An(this.path)){if(null!=this.affectedTree.value)return r(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new Sn(e));return new Ar(bn(),t,this.revert)}}return r(_n(this.path)===e,"operationForChild called for unrelated child."),new Ar(Tn(this.path),this.affectedTree,this.revert)}}class Dr{constructor(e,t,n){this.source=e,this.path=t,this.snap=n,this.type=Pr.OVERWRITE}operationForChild(e){return An(this.path)?new Dr(this.source,bn(),this.snap.getImmediateChild(e)):new Dr(this.source,Tn(this.path),this.snap)}}class Br{constructor(e,t,n){this.source=e,this.path=t,this.children=n,this.type=Pr.MERGE}operationForChild(e){if(An(this.path)){const t=this.children.subtree(new Sn(e));return t.isEmpty()?null:t.value?new Dr(this.source,bn(),t.value):new Br(this.source,bn(),t)}return r(_n(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new Br(this.source,Tn(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class Rr{constructor(e,t,n){this.node_=e,this.fullyInitialized_=t,this.filtered_=n}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(An(e))return this.isFullyInitialized()&&!this.filtered_;const t=_n(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}function Fr(e,t,n,r,o,s){const a=r.filter((e=>e.type===n));a.sort(((t,n)=>function(e,t,n){if(null==t.childName||null==n.childName)throw i("Should only compare child_ events.");const r=new zn(t.childName,t.snapshotNode),o=new zn(n.childName,n.snapshotNode);return e.index_.compare(r,o)}(e,t,n))),a.forEach((n=>{const r=function(e,t,n){return"value"===t.type||"child_removed"===t.type||(t.prevName=n.getPredecessorChildName(t.childName,t.snapshotNode,e.index_)),t}(e,n,s);o.forEach((i=>{i.respondsTo(n.type)&&t.push(i.createEvent(r,e.query_))}))}))}function Nr(e,t){return{eventCache:e,serverCache:t}}function Mr(e,t,n,r){return Nr(new Rr(t,n,r),e.serverCache)}function Lr(e,t,n,r){return Nr(e.eventCache,new Rr(t,n,r))}function Or(e){return e.eventCache.isFullyInitialized()?e.eventCache.getNode():null}function Hr(e){return e.serverCache.isFullyInitialized()?e.serverCache.getNode():null}let zr;class qr{constructor(e,t=(()=>(zr||(zr=new Kn(Ot)),zr))()){this.value=e,this.children=t}static fromObject(e){let t=new qr(null);return Vt(e,((e,n)=>{t=t.set(new Sn(e),n)})),t}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(null!=this.value&&t(this.value))return{path:bn(),value:this.value};if(An(e))return null;{const n=_n(e),r=this.children.get(n);if(null!==r){const i=r.findRootMostMatchingPathAndValue(Tn(e),t);if(null!=i){return{path:En(new Sn(n),i.path),value:i.value}}return null}return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,(()=>!0))}subtree(e){if(An(e))return this;{const t=_n(e),n=this.children.get(t);return null!==n?n.subtree(Tn(e)):new qr(null)}}set(e,t){if(An(e))return new qr(t,this.children);{const n=_n(e),r=(this.children.get(n)||new qr(null)).set(Tn(e),t),i=this.children.insert(n,r);return new qr(this.value,i)}}remove(e){if(An(e))return this.children.isEmpty()?new qr(null):new qr(null,this.children);{const t=_n(e),n=this.children.get(t);if(n){const r=n.remove(Tn(e));let i;return i=r.isEmpty()?this.children.remove(t):this.children.insert(t,r),null===this.value&&i.isEmpty()?new qr(null):new qr(this.value,i)}return this}}get(e){if(An(e))return this.value;{const t=_n(e),n=this.children.get(t);return n?n.get(Tn(e)):null}}setTree(e,t){if(An(e))return t;{const n=_n(e),r=(this.children.get(n)||new qr(null)).setTree(Tn(e),t);let i;return i=r.isEmpty()?this.children.remove(n):this.children.insert(n,r),new qr(this.value,i)}}fold(e){return this.fold_(bn(),e)}fold_(e,t){const n={};return this.children.inorderTraversal(((r,i)=>{n[r]=i.fold_(En(e,r),t)})),t(e,this.value,n)}findOnPath(e,t){return this.findOnPath_(e,bn(),t)}findOnPath_(e,t,n){const r=!!this.value&&n(t,this.value);if(r)return r;if(An(e))return null;{const r=_n(e),i=this.children.get(r);return i?i.findOnPath_(Tn(e),En(t,r),n):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,bn(),t)}foreachOnPath_(e,t,n){if(An(e))return this;{this.value&&n(t,this.value);const r=_n(e),i=this.children.get(r);return i?i.foreachOnPath_(Tn(e),En(t,r),n):new qr(null)}}foreach(e){this.foreach_(bn(),e)}foreach_(e,t){this.children.inorderTraversal(((n,r)=>{r.foreach_(En(e,n),t)})),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal(((t,n)=>{n.value&&e(t,n.value)}))}}class Vr{constructor(e){this.writeTree_=e}static empty(){return new Vr(new qr(null))}}function Wr(e,t,n){if(An(t))return new Vr(new qr(n));{const r=e.writeTree_.findRootMostValueAndPath(t);if(null!=r){const i=r.path;let o=r.value;const s=Dn(i,t);return o=o.updateChild(s,n),new Vr(e.writeTree_.set(i,o))}{const r=new qr(n),i=e.writeTree_.setTree(t,r);return new Vr(i)}}}function Gr(e,t,n){let r=e;return Vt(n,((e,n)=>{r=Wr(r,En(t,e),n)})),r}function Ur(e,t){if(An(t))return Vr.empty();{const n=e.writeTree_.setTree(t,new qr(null));return new Vr(n)}}function jr(e,t){return null!=Kr(e,t)}function Kr(e,t){const n=e.writeTree_.findRootMostValueAndPath(t);return null!=n?e.writeTree_.get(n.path).getChild(Dn(n.path,t)):null}function Yr(e){const t=[],n=e.writeTree_.value;return null!=n?n.isLeafNode()||n.forEachChild(rr,((e,n)=>{t.push(new zn(e,n))})):e.writeTree_.children.inorderTraversal(((e,n)=>{null!=n.value&&t.push(new zn(e,n.value))})),t}function Xr(e,t){if(An(t))return e;{const n=Kr(e,t);return new Vr(null!=n?new qr(n):e.writeTree_.subtree(t))}}function $r(e){return e.writeTree_.isEmpty()}function Jr(e,t){return Qr(bn(),e.writeTree_,t)}function Qr(e,t,n){if(null!=t.value)return n.updateChild(e,t.value);{let i=null;return t.children.inorderTraversal(((t,o)=>{".priority"===t?(r(null!==o.value,"Priority writes must always be leaf nodes"),i=o.value):n=Qr(En(e,t),o,n)})),n.getChild(e).isEmpty()||null===i||(n=n.updateChild(En(e,".priority"),i)),n}}function Zr(e,t){return di(t,e)}function ei(e,t){const n=e.allWrites.findIndex((e=>e.writeId===t));r(n>=0,"removeWrite called with nonexistent writeId.");const i=e.allWrites[n];e.allWrites.splice(n,1);let o=i.visible,s=!1,a=e.allWrites.length-1;for(;o&&a>=0;){const t=e.allWrites[a];t.visible&&(a>=n&&ti(t,i.path)?o=!1:Rn(i.path,t.path)&&(s=!0)),a--}if(o){if(s)return function(e){e.visibleWrites=ri(e.allWrites,ni,bn()),e.allWrites.length>0?e.lastWriteId=e.allWrites[e.allWrites.length-1].writeId:e.lastWriteId=-1}(e),!0;if(i.snap)e.visibleWrites=Ur(e.visibleWrites,i.path);else{Vt(i.children,(t=>{e.visibleWrites=Ur(e.visibleWrites,En(i.path,t))}))}return!0}return!1}function ti(e,t){if(e.snap)return Rn(e.path,t);for(const n in e.children)if(e.children.hasOwnProperty(n)&&Rn(En(e.path,n),t))return!0;return!1}function ni(e){return e.visible}function ri(e,t,n){let r=Vr.empty();for(let o=0;o<e.length;++o){const s=e[o];if(t(s)){const e=s.path;let t;if(s.snap)Rn(n,e)?(t=Dn(n,e),r=Wr(r,t,s.snap)):Rn(e,n)&&(t=Dn(e,n),r=Wr(r,bn(),s.snap.getChild(t)));else{if(!s.children)throw i("WriteRecord should have .snap or .children");if(Rn(n,e))t=Dn(n,e),r=Gr(r,t,s.children);else if(Rn(e,n))if(t=Dn(e,n),An(t))r=Gr(r,bn(),s.children);else{const e=E(s.children,_n(t));if(e){const n=e.getChild(Tn(t));r=Wr(r,bn(),n)}}}}}return r}function ii(e,t,n,r,i){if(r||i){const o=Xr(e.visibleWrites,t);if(!i&&$r(o))return n;if(i||null!=n||jr(o,bn())){const o=function(e){return(e.visible||i)&&(!r||!~r.indexOf(e.writeId))&&(Rn(e.path,t)||Rn(t,e.path))};return Jr(ri(e.allWrites,o,t),n||hr.EMPTY_NODE)}return null}{const r=Kr(e.visibleWrites,t);if(null!=r)return r;{const r=Xr(e.visibleWrites,t);if($r(r))return n;if(null!=n||jr(r,bn())){return Jr(r,n||hr.EMPTY_NODE)}return null}}}function oi(e,t,n,r){return ii(e.writeTree,e.treePath,t,n,r)}function si(e,t){return function(e,t,n){let r=hr.EMPTY_NODE;const i=Kr(e.visibleWrites,t);if(i)return i.isLeafNode()||i.forEachChild(rr,((e,t)=>{r=r.updateImmediateChild(e,t)})),r;if(n){const i=Xr(e.visibleWrites,t);return n.forEachChild(rr,((e,t)=>{const n=Jr(Xr(i,new Sn(e)),t);r=r.updateImmediateChild(e,n)})),Yr(i).forEach((e=>{r=r.updateImmediateChild(e.name,e.node)})),r}return Yr(Xr(e.visibleWrites,t)).forEach((e=>{r=r.updateImmediateChild(e.name,e.node)})),r}(e.writeTree,e.treePath,t)}function ai(e,t,n,i){return function(e,t,n,i,o){r(i||o,"Either existingEventSnap or existingServerSnap must exist");const s=En(t,n);if(jr(e.visibleWrites,s))return null;{const t=Xr(e.visibleWrites,s);return $r(t)?o.getChild(n):Jr(t,o.getChild(n))}}(e.writeTree,e.treePath,t,n,i)}function li(e,t){return function(e,t){return Kr(e.visibleWrites,t)}(e.writeTree,En(e.treePath,t))}function ci(e,t,n,r,i,o){return function(e,t,n,r,i,o,s){let a;const l=Xr(e.visibleWrites,t),c=Kr(l,bn());if(null!=c)a=c;else{if(null==n)return[];a=Jr(l,n)}if(a=a.withIndex(s),a.isEmpty()||a.isLeafNode())return[];{const e=[],t=s.getCompare(),n=o?a.getReverseIteratorFrom(r,s):a.getIteratorFrom(r,s);let l=n.getNext();for(;l&&e.length<i;)0!==t(l,r)&&e.push(l),l=n.getNext();return e}}(e.writeTree,e.treePath,t,n,r,i,o)}function ui(e,t,n){return function(e,t,n,r){const i=En(t,n),o=Kr(e.visibleWrites,i);if(null!=o)return o;if(r.isCompleteForChild(n))return Jr(Xr(e.visibleWrites,i),r.getNode().getImmediateChild(n));return null}(e.writeTree,e.treePath,t,n)}function hi(e,t){return di(En(e.treePath,t),e.writeTree)}function di(e,t){return{treePath:e,writeTree:t}}class pi{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,n=e.childName;r("child_added"===t||"child_changed"===t||"child_removed"===t,"Only child changes supported for tracking"),r(".priority"!==n,"Only non-priority child changes can be tracked.");const o=this.changeMap.get(n);if(o){const r=o.type;if("child_added"===t&&"child_removed"===r)this.changeMap.set(n,vr(n,e.snapshotNode,o.snapshotNode));else if("child_removed"===t&&"child_added"===r)this.changeMap.delete(n);else if("child_removed"===t&&"child_changed"===r)this.changeMap.set(n,(s=n,{type:"child_removed",snapshotNode:o.oldSnap,childName:s}));else if("child_changed"===t&&"child_added"===r)this.changeMap.set(n,function(e,t){return{type:"child_added",snapshotNode:t,childName:e}}(n,e.snapshotNode));else{if("child_changed"!==t||"child_changed"!==r)throw i("Illegal combination of changes: "+e+" occurred after "+o);this.changeMap.set(n,vr(n,e.snapshotNode,o.oldSnap))}}else this.changeMap.set(n,e);var s}getChanges(){return Array.from(this.changeMap.values())}}const gi=new class{getCompleteChild(e){return null}getChildAfterChild(e,t,n){return null}};class mi{constructor(e,t,n=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=n}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const t=null!=this.optCompleteServerCache_?new Rr(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return ui(this.writes_,e,t)}}getChildAfterChild(e,t,n){const r=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:Hr(this.viewCache_),i=ci(this.writes_,r,t,1,n,e);return 0===i.length?null:i[0]}}function fi(e,t,n,o,s){const a=new pi;let l,c;if(n.type===Pr.OVERWRITE){const i=n;i.source.fromUser?l=wi(e,t,i.path,i.snap,o,s,a):(r(i.source.fromServer,"Unknown source."),c=i.source.tagged||t.serverCache.isFiltered()&&!An(i.path),l=yi(e,t,i.path,i.snap,o,s,c,a))}else if(n.type===Pr.MERGE){const i=n;i.source.fromUser?l=function(e,t,n,r,i,o,s){let a=t;return r.foreach(((r,l)=>{const c=En(n,r);Ci(t,_n(c))&&(a=wi(e,a,c,l,i,o,s))})),r.foreach(((r,l)=>{const c=En(n,r);Ci(t,_n(c))||(a=wi(e,a,c,l,i,o,s))})),a}(e,t,i.path,i.children,o,s,a):(r(i.source.fromServer,"Unknown source."),c=i.source.tagged||t.serverCache.isFiltered(),l=bi(e,t,i.path,i.children,o,s,c,a))}else if(n.type===Pr.ACK_USER_WRITE){const i=n;l=i.revert?function(e,t,n,i,o,s){let a;if(null!=li(i,n))return t;{const l=new mi(i,t,o),c=t.eventCache.getNode();let u;if(An(n)||".priority"===_n(n)){let n;if(t.serverCache.isFullyInitialized())n=oi(i,Hr(t));else{const e=t.serverCache.getNode();r(e instanceof hr,"serverChildren would be complete if leaf node"),n=si(i,e)}u=e.filter.updateFullNode(c,n,s)}else{const r=_n(n);let o=ui(i,r,t.serverCache);null==o&&t.serverCache.isCompleteForChild(r)&&(o=c.getImmediateChild(r)),u=null!=o?e.filter.updateChild(c,r,o,Tn(n),l,s):t.eventCache.getNode().hasChild(r)?e.filter.updateChild(c,r,hr.EMPTY_NODE,Tn(n),l,s):c,u.isEmpty()&&t.serverCache.isFullyInitialized()&&(a=oi(i,Hr(t)),a.isLeafNode()&&(u=e.filter.updateFullNode(u,a,s)))}return a=t.serverCache.isFullyInitialized()||null!=li(i,bn()),Mr(t,u,a,e.filter.filtersNodes())}}(e,t,i.path,o,s,a):function(e,t,n,r,i,o,s){if(null!=li(i,n))return t;const a=t.serverCache.isFiltered(),l=t.serverCache;if(null!=r.value){if(An(n)&&l.isFullyInitialized()||l.isCompleteForPath(n))return yi(e,t,n,l.getNode().getChild(n),i,o,a,s);if(An(n)){let r=new qr(null);return l.getNode().forEachChild(Gn,((e,t)=>{r=r.set(new Sn(e),t)})),bi(e,t,n,r,i,o,a,s)}return t}{let c=new qr(null);return r.foreach(((e,t)=>{const r=En(n,e);l.isCompleteForPath(r)&&(c=c.set(e,l.getNode().getChild(r)))})),bi(e,t,n,c,i,o,a,s)}}(e,t,i.path,i.affectedTree,o,s,a)}else{if(n.type!==Pr.LISTEN_COMPLETE)throw i("Unknown operation type: "+n.type);l=function(e,t,n,r,i){const o=t.serverCache,s=Lr(t,o.getNode(),o.isFullyInitialized()||An(n),o.isFiltered());return vi(e,s,n,r,gi,i)}(e,t,n.path,o,a)}const u=a.getChanges();return function(e,t,n){const r=t.eventCache;if(r.isFullyInitialized()){const i=r.getNode().isLeafNode()||r.getNode().isEmpty(),o=Or(e);(n.length>0||!e.eventCache.isFullyInitialized()||i&&!r.getNode().equals(o)||!r.getNode().getPriority().equals(o.getPriority()))&&n.push({type:"value",snapshotNode:Or(t)})}}(t,l,u),{viewCache:l,changes:u}}function vi(e,t,n,i,o,s){const a=t.eventCache;if(null!=li(i,n))return t;{let l,c;if(An(n))if(r(t.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),t.serverCache.isFiltered()){const n=Hr(t),r=si(i,n instanceof hr?n:hr.EMPTY_NODE);l=e.filter.updateFullNode(t.eventCache.getNode(),r,s)}else{const n=oi(i,Hr(t));l=e.filter.updateFullNode(t.eventCache.getNode(),n,s)}else{const u=_n(n);if(".priority"===u){r(1===xn(n),"Can't have a priority with additional path components");const o=a.getNode();c=t.serverCache.getNode();const s=ai(i,n,o,c);l=null!=s?e.filter.updatePriority(o,s):a.getNode()}else{const r=Tn(n);let h;if(a.isCompleteForChild(u)){c=t.serverCache.getNode();const e=ai(i,n,a.getNode(),c);h=null!=e?a.getNode().getImmediateChild(u).updateChild(r,e):a.getNode().getImmediateChild(u)}else h=ui(i,u,t.serverCache);l=null!=h?e.filter.updateChild(a.getNode(),u,h,r,o,s):a.getNode()}}return Mr(t,l,a.isFullyInitialized()||An(n),e.filter.filtersNodes())}}function yi(e,t,n,r,i,o,s,a){const l=t.serverCache;let c;const u=s?e.filter:e.filter.getIndexedFilter();if(An(n))c=u.updateFullNode(l.getNode(),r,null);else if(u.filtersNodes()&&!l.isFiltered()){const e=l.getNode().updateChild(n,r);c=u.updateFullNode(l.getNode(),e,null)}else{const e=_n(n);if(!l.isCompleteForPath(n)&&xn(n)>1)return t;const i=Tn(n),o=l.getNode().getImmediateChild(e).updateChild(i,r);c=".priority"===e?u.updatePriority(l.getNode(),o):u.updateChild(l.getNode(),e,o,i,gi,null)}const h=Lr(t,c,l.isFullyInitialized()||An(n),u.filtersNodes());return vi(e,h,n,i,new mi(i,h,o),a)}function wi(e,t,n,r,i,o,s){const a=t.eventCache;let l,c;const u=new mi(i,t,o);if(An(n))c=e.filter.updateFullNode(t.eventCache.getNode(),r,s),l=Mr(t,c,!0,e.filter.filtersNodes());else{const i=_n(n);if(".priority"===i)c=e.filter.updatePriority(t.eventCache.getNode(),r),l=Mr(t,c,a.isFullyInitialized(),a.isFiltered());else{const o=Tn(n),c=a.getNode().getImmediateChild(i);let h;if(An(o))h=r;else{const e=u.getCompleteChild(i);h=null!=e?".priority"===kn(o)&&e.getChild(Pn(o)).isEmpty()?e:e.updateChild(o,r):hr.EMPTY_NODE}if(c.equals(h))l=t;else{l=Mr(t,e.filter.updateChild(a.getNode(),i,h,o,u,s),a.isFullyInitialized(),e.filter.filtersNodes())}}}return l}function Ci(e,t){return e.eventCache.isCompleteForChild(t)}function Si(e,t,n){return n.foreach(((e,n)=>{t=t.updateChild(e,n)})),t}function bi(e,t,n,r,i,o,s,a){if(t.serverCache.getNode().isEmpty()&&!t.serverCache.isFullyInitialized())return t;let l,c=t;l=An(n)?r:new qr(null).setTree(n,r);const u=t.serverCache.getNode();return l.children.inorderTraversal(((n,r)=>{if(u.hasChild(n)){const l=Si(0,t.serverCache.getNode().getImmediateChild(n),r);c=yi(e,c,new Sn(n),l,i,o,s,a)}})),l.children.inorderTraversal(((n,r)=>{const l=!t.serverCache.isCompleteForChild(n)&&null===r.value;if(!u.hasChild(n)&&!l){const l=Si(0,t.serverCache.getNode().getImmediateChild(n),r);c=yi(e,c,new Sn(n),l,i,o,s,a)}})),c}function _i(e,t){const n=Hr(e.viewCache_);return n&&(e.query._queryParams.loadsAllData()||!An(t)&&!n.getImmediateChild(_n(t)).isEmpty())?n.getChild(t):null}function xi(e,t,n,i){t.type===Pr.MERGE&&null!==t.source.queryId&&(r(Hr(e.viewCache_),"We should always have a full cache before handling merges"),r(Or(e.viewCache_),"Missing event cache, even though we have a server cache"));const o=e.viewCache_,s=fi(e.processor_,o,t,n,i);var a,l;return a=e.processor_,l=s.viewCache,r(l.eventCache.getNode().isIndexed(a.filter.getIndex()),"Event snap not indexed"),r(l.serverCache.getNode().isIndexed(a.filter.getIndex()),"Server snap not indexed"),r(s.viewCache.serverCache.isFullyInitialized()||!o.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),e.viewCache_=s.viewCache,function(e,t,n){const r=e.eventRegistrations_;return function(e,t,n,r){const i=[],o=[];return t.forEach((t=>{var n;"child_changed"===t.type&&e.index_.indexedValueChanged(t.oldSnap,t.snapshotNode)&&o.push((n=t.childName,{type:"child_moved",snapshotNode:t.snapshotNode,childName:n}))})),Fr(e,i,"child_removed",t,r,n),Fr(e,i,"child_added",t,r,n),Fr(e,i,"child_moved",o,r,n),Fr(e,i,"child_changed",t,r,n),Fr(e,i,"value",t,r,n),i}(e.eventGenerator_,t,n,r)}(e,s.changes,s.viewCache.eventCache.getNode())}let Ti,ki;function Ii(e,t,n,i){const o=t.source.queryId;if(null!==o){const s=e.views.get(o);return r(null!=s,"SyncTree gave us an op for an invalid query."),xi(s,t,n,i)}{let r=[];for(const o of e.views.values())r=r.concat(xi(o,t,n,i));return r}}function Pi(e,t){let n=null;for(const r of e.views.values())n=n||_i(r,t);return n}class Ei{constructor(e){this.listenProvider_=e,this.syncPointTree_=new qr(null),this.pendingWriteTree_={visibleWrites:Vr.empty(),allWrites:[],lastWriteId:-1},this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Ai(e,t,n,i,o){return function(e,t,n,i,o){r(i>e.lastWriteId,"Stacking an older write on top of newer ones"),void 0===o&&(o=!0),e.allWrites.push({path:t,snap:n,writeId:i,visible:o}),o&&(e.visibleWrites=Wr(e.visibleWrites,t,n)),e.lastWriteId=i}(e.pendingWriteTree_,t,n,i,o),o?Fi(e,new Dr({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},t,n)):[]}function Di(e,t,n=!1){const r=function(e,t){for(let n=0;n<e.allWrites.length;n++){const r=e.allWrites[n];if(r.writeId===t)return r}return null}(e.pendingWriteTree_,t);if(ei(e.pendingWriteTree_,t)){let t=new qr(null);return null!=r.snap?t=t.set(bn(),!0):Vt(r.children,(e=>{t=t.set(new Sn(e),!0)})),Fi(e,new Ar(r.path,t,n))}return[]}function Bi(e,t,n){return Fi(e,new Dr({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},t,n))}function Ri(e,t,n){const r=e.pendingWriteTree_,i=e.syncPointTree_.findOnPath(t,((e,n)=>{const r=Pi(n,Dn(e,t));if(r)return r}));return ii(r,t,i,n,!0)}function Fi(e,t){return Ni(t,e.syncPointTree_,null,Zr(e.pendingWriteTree_,bn()))}function Ni(e,t,n,r){if(An(e.path))return Mi(e,t,n,r);{const i=t.get(bn());null==n&&null!=i&&(n=Pi(i,bn()));let o=[];const s=_n(e.path),a=e.operationForChild(s),l=t.children.get(s);if(l&&a){const e=n?n.getImmediateChild(s):null,t=hi(r,s);o=o.concat(Ni(a,l,e,t))}return i&&(o=o.concat(Ii(i,e,r,n))),o}}function Mi(e,t,n,r){const i=t.get(bn());null==n&&null!=i&&(n=Pi(i,bn()));let o=[];return t.children.inorderTraversal(((t,i)=>{const s=n?n.getImmediateChild(t):null,a=hi(r,t),l=e.operationForChild(t);l&&(o=o.concat(Mi(l,i,s,a)))})),i&&(o=o.concat(Ii(i,e,r,n))),o}function Li(e,t){return e.tagToQueryMap.get(t)}function Oi(e){const t=e.indexOf("$");return r(-1!==t&&t<e.length-1,"Bad queryKey."),{queryId:e.substr(t+1),path:new Sn(e.substr(0,t))}}function Hi(e,t,n){const i=e.syncPointTree_.get(t);r(i,"Missing sync point for query tag that we're tracking");return Ii(i,n,Zr(e.pendingWriteTree_,t),null)}class zi{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new zi(t)}node(){return this.node_}}class qi{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=En(this.path_,e);return new qi(this.syncTree_,t)}node(){return Ri(this.syncTree_,this.path_)}}const Vi=function(e){return(e=e||{}).timestamp=e.timestamp||(new Date).getTime(),e},Wi=function(e,t,n){return e&&"object"==typeof e?(r(".sv"in e,"Unexpected leaf node or priority contents"),"string"==typeof e[".sv"]?Gi(e[".sv"],t,n):"object"==typeof e[".sv"]?Ui(e[".sv"],t):void r(!1,"Unexpected server value: "+JSON.stringify(e,null,2))):e},Gi=function(e,t,n){if("timestamp"===e)return n.timestamp;r(!1,"Unexpected server value: "+e)},Ui=function(e,t,n){e.hasOwnProperty("increment")||r(!1,"Unexpected server value: "+JSON.stringify(e,null,2));const i=e.increment;"number"!=typeof i&&r(!1,"Unexpected increment value: "+i);const o=t.node();if(r(null!=o,"Expected ChildrenNode.EMPTY_NODE for nulls"),!o.isLeafNode())return i;const s=o.getValue();return"number"!=typeof s?i:s+i},ji=function(e,t,n,r){return Yi(t,new qi(n,e),r)},Ki=function(e,t,n){return Yi(e,new zi(t),n)};function Yi(e,t,n){const r=e.getPriority().val(),i=Wi(r,t.getImmediateChild(".priority"),n);let o;if(e.isLeafNode()){const r=e,o=Wi(r.getValue(),t,n);return o!==r.getValue()||i!==r.getPriority().val()?new nr(o,gr(i)):e}{const r=e;return o=r,i!==r.getPriority().val()&&(o=o.updatePriority(new nr(i))),r.forEachChild(rr,((e,r)=>{const i=Yi(r,t.getImmediateChild(e),n);i!==r&&(o=o.updateImmediateChild(e,i))})),o}}class Xi{constructor(e="",t=null,n={children:{},childCount:0}){this.name=e,this.parent=t,this.node=n}}function $i(e,t){let n=t instanceof Sn?t:new Sn(t),r=e,i=_n(n);for(;null!==i;){const e=E(r.node.children,i)||{children:{},childCount:0};r=new Xi(i,r,e),n=Tn(n),i=_n(n)}return r}function Ji(e){return e.node.value}function Qi(e,t){e.node.value=t,ro(e)}function Zi(e){return e.node.childCount>0}function eo(e,t){Vt(e.node.children,((n,r)=>{t(new Xi(n,e,r))}))}function to(e,t,n,r){n&&!r&&t(e),eo(e,(e=>{to(e,t,!0,r)})),n&&r&&t(e)}function no(e){return new Sn(null===e.parent?e.name:no(e.parent)+"/"+e.name)}function ro(e){null!==e.parent&&function(e,t,n){const r=function(e){return void 0===Ji(e)&&!Zi(e)}(n),i=P(e.node.children,t);r&&i?(delete e.node.children[t],e.node.childCount--,ro(e)):r||i||(e.node.children[t]=n.node,e.node.childCount++,ro(e))}(e.parent,e.name,e)}const io=/[\[\].#$\/\u0000-\u001F\u007F]/,oo=/[\[\].#$\u0000-\u001F\u007F]/,so=10485760,ao=function(e){return"string"==typeof e&&0!==e.length&&!io.test(e)},lo=function(e){return"string"==typeof e&&0!==e.length&&!oo.test(e)},co=function(e,t,n,r){r&&void 0===t||uo(O(e,"value"),t,n)},uo=function(e,t,n){const r=n instanceof Sn?new Fn(n,e):n;if(void 0===t)throw new Error(e+"contains undefined "+Mn(r));if("function"==typeof t)throw new Error(e+"contains a function "+Mn(r)+" with contents = "+t.toString());if(Ft(t))throw new Error(e+"contains "+t.toString()+" "+Mn(r));if("string"==typeof t&&t.length>so/3&&H(t)>so)throw new Error(e+"contains a string greater than "+so+" utf8 bytes "+Mn(r)+" ('"+t.substring(0,50)+"...')");if(t&&"object"==typeof t){let n=!1,i=!1;if(Vt(t,((t,o)=>{if(".value"===t)n=!0;else if(".priority"!==t&&".sv"!==t&&(i=!0,!ao(t)))throw new Error(e+" contains an invalid key ("+t+") "+Mn(r)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');!function(e,t){e.parts_.length>0&&(e.byteLength_+=1),e.parts_.push(t),e.byteLength_+=H(t),Nn(e)}(r,t),uo(e,o,r),function(e){const t=e.parts_.pop();e.byteLength_-=H(t),e.parts_.length>0&&(e.byteLength_-=1)}(r)})),n&&i)throw new Error(e+' contains ".value" child '+Mn(r)+" in addition to actual children.")}},ho=function(e,t,n,r){if(!lo(n))throw new Error(O(e,t)+'was an invalid path = "'+n+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},po=function(e,t,n,r){n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),ho(e,t,n)},go=function(e,t){if(".info"===_n(t))throw new Error(e+" failed = Can't modify data under /.info/")},mo=function(e,t){const n=t.path.toString();if("string"!=typeof t.repoInfo.host||0===t.repoInfo.host.length||!ao(t.repoInfo.namespace)&&"localhost"!==t.repoInfo.host.split(":")[0]||0!==n.length&&!function(e){return e&&(e=e.replace(/^\/*\.info(\/|$)/,"/")),lo(e)}(n))throw new Error(O(e,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};class fo{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function vo(e,t){let n=null;for(let r=0;r<t.length;r++){const i=t[r],o=i.getPath();null===n||Bn(o,n.path)||(e.eventLists_.push(n),n=null),null===n&&(n={events:[],path:o}),n.events.push(i)}n&&e.eventLists_.push(n)}function yo(e,t,n){vo(e,n),function(e,t){e.recursionDepth_++;let n=!0;for(let r=0;r<e.eventLists_.length;r++){const i=e.eventLists_[r];if(i){t(i.path)?(wo(e.eventLists_[r]),e.eventLists_[r]=null):n=!1}}n&&(e.eventLists_=[]);e.recursionDepth_--}(e,(e=>Rn(e,t)||Rn(t,e)))}function wo(e){for(let t=0;t<e.events.length;t++){const n=e.events[t];if(null!==n){e.events[t]=null;const r=n.getEventRunner();It&&Et("event: "+n.toString()),jt(r)}}}const Co="repo_interrupt",So=25;class bo{constructor(e,t,n,r){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=n,this.appCheckProvider_=r,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new fo,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=_r(),this.transactionQueueTree_=new Xi,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function _o(e,t,n){if(e.stats_=an(e.repoInfo_),e.forceRestClient_||("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)e.server_=new Sr(e.repoInfo_,((t,n,r,i)=>{ko(e,t,n,r,i)}),e.authTokenProvider_,e.appCheckProvider_),setTimeout((()=>Io(e,!0)),0);else{if(null!=n){if("object"!=typeof n)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{k(n)}catch(e){throw new Error("Invalid authOverride provided: "+e)}}e.persistentConnection_=new Hn(e.repoInfo_,t,((t,n,r,i)=>{ko(e,t,n,r,i)}),(t=>{Io(e,t)}),(t=>{!function(e,t){Vt(t,((t,n)=>{Po(e,t,n)}))}(e,t)}),e.authTokenProvider_,e.appCheckProvider_,n),e.server_=e.persistentConnection_}e.authTokenProvider_.addTokenChangeListener((t=>{e.server_.refreshAuthToken(t)})),e.appCheckProvider_.addTokenChangeListener((t=>{e.server_.refreshAppCheckToken(t.token)})),e.statsReporter_=function(e,t){const n=e.toString();return sn[n]||(sn[n]=t()),sn[n]}(e.repoInfo_,(()=>new Ir(e.stats_,e.server_))),e.infoData_=new br,e.infoSyncTree_=new Ei({startListening:(t,n,r,i)=>{let o=[];const s=e.infoData_.getNode(t._path);return s.isEmpty()||(o=Bi(e.infoSyncTree_,t._path,s),setTimeout((()=>{i("ok")}),0)),o},stopListening:()=>{}}),Po(e,"connected",!1),e.serverSyncTree_=new Ei({startListening:(t,n,r,i)=>(e.server_.listen(t,r,n,((n,r)=>{const o=i(n,r);yo(e.eventQueue_,t._path,o)})),[]),stopListening:(t,n)=>{e.server_.unlisten(t,n)}})}function xo(e){const t=e.infoData_.getNode(new Sn(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t}function To(e){return Vi({timestamp:xo(e)})}function ko(e,t,n,r,i){e.dataUpdateCount++;const o=new Sn(t);n=e.interceptServerDataCallback_?e.interceptServerDataCallback_(t,n):n;let s=[];if(i)if(r){const t=D(n,(e=>gr(e)));s=function(e,t,n,r){const i=Li(e,r);if(i){const r=Oi(i),o=r.path,s=r.queryId,a=Dn(o,t),l=qr.fromObject(n);return Hi(e,o,new Br(Er(s),a,l))}return[]}(e.serverSyncTree_,o,t,i)}else{const t=gr(n);s=function(e,t,n,r){const i=Li(e,r);if(null!=i){const r=Oi(i),o=r.path,s=r.queryId,a=Dn(o,t);return Hi(e,o,new Dr(Er(s),a,n))}return[]}(e.serverSyncTree_,o,t,i)}else if(r){const t=D(n,(e=>gr(e)));s=function(e,t,n){const r=qr.fromObject(n);return Fi(e,new Br({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},t,r))}(e.serverSyncTree_,o,t)}else{const t=gr(n);s=Bi(e.serverSyncTree_,o,t)}let a=o;s.length>0&&(a=Fo(e,o)),yo(e.eventQueue_,a,s)}function Io(e,t){Po(e,"connected",t),!1===t&&function(e){Do(e,"onDisconnectEvents");const t=To(e),n=_r();Tr(e.onDisconnect_,bn(),((r,i)=>{const o=ji(r,i,e.serverSyncTree_,t);xr(n,r,o)}));let r=[];Tr(n,bn(),((t,n)=>{r=r.concat(Bi(e.serverSyncTree_,t,n));const i=Ho(e,t);Fo(e,i)})),e.onDisconnect_=_r(),yo(e.eventQueue_,bn(),r)}(e)}function Po(e,t,n){const r=new Sn("/.info/"+t),i=gr(n);e.infoData_.updateSnapshot(r,i);const o=Bi(e.infoSyncTree_,r,i);yo(e.eventQueue_,r,o)}function Eo(e){return e.nextWriteId_++}function Ao(e,t,n,r,i){Do(e,"set",{path:t.toString(),value:n,priority:r});const o=To(e),s=gr(n,r),a=Ri(e.serverSyncTree_,t),l=Ki(s,a,o),c=Eo(e),u=Ai(e.serverSyncTree_,t,l,c,!0);vo(e.eventQueue_,u),e.server_.put(t.toString(),s.val(!0),((n,r)=>{const o="ok"===n;o||Rt("set at "+t+" failed: "+n);const s=Di(e.serverSyncTree_,c,!o);yo(e.eventQueue_,t,s),function(e,t,n,r){t&&jt((()=>{if("ok"===n)t(null);else{const e=(n||"error").toUpperCase();let i=e;r&&(i+=": "+r);const o=new Error(i);o.code=e,t(o)}}))}(0,i,n,r)}));const h=Ho(e,t);Fo(e,h),yo(e.eventQueue_,h,[])}function Do(e,...t){let n="";e.persistentConnection_&&(n=e.persistentConnection_.id+":"),Et(n,...t)}function Bo(e,t,n){return Ri(e.serverSyncTree_,t,n)||hr.EMPTY_NODE}function Ro(e,t=e.transactionQueueTree_){if(t||Oo(e,t),Ji(t)){const n=Mo(e,t);r(n.length>0,"Sending zero length transaction queue");n.every((e=>0===e.status))&&function(e,t,n){const i=n.map((e=>e.currentWriteId)),o=Bo(e,t,i);let s=o;const a=o.hash();for(let e=0;e<n.length;e++){const i=n[e];r(0===i.status,"tryToSendTransactionQueue_: items in queue should all be run."),i.status=1,i.retryCount++;const o=Dn(t,i.path);s=s.updateChild(o,i.currentOutputSnapshotRaw)}const l=s.val(!0),c=t;e.server_.put(c.toString(),l,(r=>{Do(e,"transaction put response",{path:c.toString(),status:r});let i=[];if("ok"===r){const r=[];for(let t=0;t<n.length;t++)n[t].status=2,i=i.concat(Di(e.serverSyncTree_,n[t].currentWriteId)),n[t].onComplete&&r.push((()=>n[t].onComplete(null,!0,n[t].currentOutputSnapshotResolved))),n[t].unwatcher();Oo(e,$i(e.transactionQueueTree_,t)),Ro(e,e.transactionQueueTree_),yo(e.eventQueue_,t,i);for(let e=0;e<r.length;e++)jt(r[e])}else{if("datastale"===r)for(let e=0;e<n.length;e++)3===n[e].status?n[e].status=4:n[e].status=0;else{Rt("transaction at "+c.toString()+" failed: "+r);for(let e=0;e<n.length;e++)n[e].status=4,n[e].abortReason=r}Fo(e,t)}}),a)}(e,no(t),n)}else Zi(t)&&eo(t,(t=>{Ro(e,t)}))}function Fo(e,t){const n=No(e,t),i=no(n);return function(e,t,n){if(0===t.length)return;const i=[];let o=[];const s=t.filter((e=>0===e.status)),a=s.map((e=>e.currentWriteId));for(let s=0;s<t.length;s++){const c=t[s],u=Dn(n,c.path);let h,d=!1;if(r(null!==u,"rerunTransactionsUnderNode_: relativePath should not be null."),4===c.status)d=!0,h=c.abortReason,o=o.concat(Di(e.serverSyncTree_,c.currentWriteId,!0));else if(0===c.status)if(c.retryCount>=So)d=!0,h="maxretry",o=o.concat(Di(e.serverSyncTree_,c.currentWriteId,!0));else{const n=Bo(e,c.path,a);c.currentInputSnapshot=n;const r=t[s].update(n.val());if(void 0!==r){uo("transaction failed: Data returned ",r,c.path);let t=gr(r);"object"==typeof r&&null!=r&&P(r,".priority")||(t=t.updatePriority(n.getPriority()));const i=c.currentWriteId,s=To(e),l=Ki(t,n,s);c.currentOutputSnapshotRaw=t,c.currentOutputSnapshotResolved=l,c.currentWriteId=Eo(e),a.splice(a.indexOf(i),1),o=o.concat(Ai(e.serverSyncTree_,c.path,l,c.currentWriteId,c.applyLocally)),o=o.concat(Di(e.serverSyncTree_,i,!0))}else d=!0,h="nodata",o=o.concat(Di(e.serverSyncTree_,c.currentWriteId,!0))}yo(e.eventQueue_,n,o),o=[],d&&(t[s].status=2,l=t[s].unwatcher,setTimeout(l,Math.floor(0)),t[s].onComplete&&("nodata"===h?i.push((()=>t[s].onComplete(null,!1,t[s].currentInputSnapshot))):i.push((()=>t[s].onComplete(new Error(h),!1,null)))))}var l;Oo(e,e.transactionQueueTree_);for(let e=0;e<i.length;e++)jt(i[e]);Ro(e,e.transactionQueueTree_)}(e,Mo(e,n),i),i}function No(e,t){let n,r=e.transactionQueueTree_;for(n=_n(t);null!==n&&void 0===Ji(r);)r=$i(r,n),n=_n(t=Tn(t));return r}function Mo(e,t){const n=[];return Lo(e,t,n),n.sort(((e,t)=>e.order-t.order)),n}function Lo(e,t,n){const r=Ji(t);if(r)for(let e=0;e<r.length;e++)n.push(r[e]);eo(t,(t=>{Lo(e,t,n)}))}function Oo(e,t){const n=Ji(t);if(n){let e=0;for(let t=0;t<n.length;t++)2!==n[t].status&&(n[e]=n[t],e++);n.length=e,Qi(t,n.length>0?n:void 0)}eo(t,(t=>{Oo(e,t)}))}function Ho(e,t){const n=no(No(e,t)),r=$i(e.transactionQueueTree_,t);return function(e,t){let n=e.parent;for(;null!==n;){if(t(n))return!0;n=n.parent}}(r,(t=>{zo(e,t)})),zo(e,r),to(r,(t=>{zo(e,t)})),n}function zo(e,t){const n=Ji(t);if(n){const i=[];let o=[],s=-1;for(let t=0;t<n.length;t++)3===n[t].status||(1===n[t].status?(r(s===t-1,"All SENT items should be at beginning of queue."),s=t,n[t].status=3,n[t].abortReason="set"):(r(0===n[t].status,"Unexpected transaction status in abort"),n[t].unwatcher(),o=o.concat(Di(e.serverSyncTree_,n[t].currentWriteId,!0)),n[t].onComplete&&i.push(n[t].onComplete.bind(null,new Error("set"),!1,null))));-1===s?Qi(t,void 0):n.length=s+1,yo(e.eventQueue_,no(t),o);for(let e=0;e<i.length;e++)jt(i[e])}}const qo=function(e,t){const n=Vo(e),r=n.namespace;"firebase.com"===n.domain&&Bt(n.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),r&&"undefined"!==r||"localhost"===n.domain||Bt("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),n.secure||"undefined"!=typeof window&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&Rt("Insecure Firebase access from a secure page. Please use https in calls to new Firebase().");const i="ws"===n.scheme||"wss"===n.scheme;return{repoInfo:new tn(n.host,n.secure,r,i,t,"",r!==n.subdomain),path:new Sn(n.pathString)}},Vo=function(e){let t="",n="",r="",i="",o="",s=!0,a="https",l=443;if("string"==typeof e){let c=e.indexOf("//");c>=0&&(a=e.substring(0,c-1),e=e.substring(c+2));let u=e.indexOf("/");-1===u&&(u=e.length);let h=e.indexOf("?");-1===h&&(h=e.length),t=e.substring(0,Math.min(u,h)),u<h&&(i=function(e){let t="";const n=e.split("/");for(let e=0;e<n.length;e++)if(n[e].length>0){let r=n[e];try{r=decodeURIComponent(r.replace(/\+/g," "))}catch(e){}t+="/"+r}return t}(e.substring(u,h)));const d=function(e){const t={};"?"===e.charAt(0)&&(e=e.substring(1));for(const n of e.split("&")){if(0===n.length)continue;const r=n.split("=");2===r.length?t[decodeURIComponent(r[0])]=decodeURIComponent(r[1]):Rt(`Invalid query segment '${n}' in query '${e}'`)}return t}(e.substring(Math.min(e.length,h)));c=t.indexOf(":"),c>=0?(s="https"===a||"wss"===a,l=parseInt(t.substring(c+1),10)):c=t.length;const p=t.slice(0,c);if("localhost"===p.toLowerCase())n="localhost";else if(p.split(".").length<=2)n=p;else{const e=t.indexOf(".");r=t.substring(0,e).toLowerCase(),n=t.substring(e+1),o=r}"ns"in d&&(o=d.ns)}return{host:t,port:l,domain:n,subdomain:r,secure:s,scheme:a,pathString:i,namespace:o}},Wo="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",Go=function(){let e=0;const t=[];return function(n){const i=n===e;let o;e=n;const s=new Array(8);for(o=7;o>=0;o--)s[o]=Wo.charAt(n%64),n=Math.floor(n/64);r(0===n,"Cannot push at time == 0");let a=s.join("");if(i){for(o=11;o>=0&&63===t[o];o--)t[o]=0;t[o]++}else for(o=0;o<12;o++)t[o]=Math.floor(64*Math.random());for(o=0;o<12;o++)a+=Wo.charAt(t[o]);return r(20===a.length,"nextPushId: Length should be 20."),a}}();class Uo{constructor(e,t,n,r){this._repo=e,this._path=t,this._queryParams=n,this._orderByCalled=r}get key(){return An(this._path)?null:kn(this._path)}get ref(){return new jo(this._repo,this._path)}get _queryIdentifier(){const e=Cr(this._queryParams),t=zt(e);return"{}"===t?"default":t}get _queryObject(){return Cr(this._queryParams)}isEqual(e){if(!((e=z(e))instanceof Uo))return!1;const t=this._repo===e._repo,n=Bn(this._path,e._path),r=this._queryIdentifier===e._queryIdentifier;return t&&n&&r}toJSON(){return this.toString()}toString(){return this._repo.toString()+function(e){let t="";for(let n=e.pieceNum_;n<e.pieces_.length;n++)""!==e.pieces_[n]&&(t+="/"+encodeURIComponent(String(e.pieces_[n])));return t||"/"}(this._path)}}class jo extends Uo{constructor(e,t){super(e,t,new yr,!1)}get parent(){const e=Pn(this._path);return null===e?null:new jo(this._repo,e)}get root(){let e=this;for(;null!==e.parent;)e=e.parent;return e}}function Ko(e,t){return(e=z(e))._checkNotDeleted("ref"),void 0!==t?Yo(e._root,t):e._root}function Yo(e,t){return null===_n((e=z(e))._path)?po("child","path",t):ho("child","path",t),new jo(e._repo,En(e._path,t))}function Xo(e,t){e=z(e),go("push",e._path),co("push",t,e._path,!0);const n=xo(e._repo),r=Go(n),i=Yo(e,r),o=Yo(e,r);let s;return s=Promise.resolve(o),i.then=s.then.bind(s),i.catch=s.then.bind(s,void 0),i}function $o(e,t){e=z(e),go("set",e._path),co("set",t,e._path,!1);const n=new v;return Ao(e._repo,e._path,t,null,n.wrapCallback((()=>{}))),n.promise}!function(e){r(!Ti,"__referenceConstructor has already been defined"),Ti=e}(jo),function(e){r(!ki,"__referenceConstructor has already been defined"),ki=e}(jo);const Jo="FIREBASE_DATABASE_EMULATOR_HOST",Qo={};let Zo=!1;function es(e,t,n,r,i){let o=r||e.options.databaseURL;void 0===o&&(e.options.projectId||Bt("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),Et("Using default host for project ",e.options.projectId),o=`${e.options.projectId}-default-rtdb.firebaseio.com`);let s,a=qo(o,i),l=a.repoInfo;"undefined"!=typeof process&&process.env&&(s=process.env[Jo]),s?(o=`http://${s}?ns=${l.namespace}`,a=qo(o,i),l=a.repoInfo):a.repoInfo.secure;const c=new Xt(e.name,e.options,t);mo("Invalid Firebase Database URL",a),An(a.path)||Bt("Database URL must point to the root of a Firebase Database (not including a child path).");const u=function(e,t,n,r){let i=Qo[t.name];i||(i={},Qo[t.name]=i);let o=i[e.toURLString()];o&&Bt("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call.");return o=new bo(e,Zo,n,r),i[e.toURLString()]=o,o}(l,e,c,new Yt(e.name,n));return new ns(u,e)}function ts(e,t){const n=Qo[t];n&&n[e.key]===e||Bt(`Database ${t}(${e.repoInfo_}) has already been deleted.`),function(e){e.persistentConnection_&&e.persistentConnection_.interrupt(Co)}(e),delete n[e.key]}class ns{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(_o(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new jo(this._repo,bn())),this._rootInternal}_delete(){return null!==this._rootInternal&&(ts(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){null===this._rootInternal&&Bt("Cannot call "+e+" on a deleted database.")}}function rs(e=function(e=We){const t=Ue.get(e);if(!t&&e===We&&f())return tt();if(!t)throw Qe.create("no-app",{appName:e});return t}(),t){const n=$e(e,"database").getImmediate({identifier:t});if(!n._instanceStarted){const e=m("database");e&&function(e,t,n,r={}){e=z(e),e._checkNotDeleted("useEmulator"),e._instanceStarted&&Bt("Cannot call useEmulator() after instance has already been initialized.");const i=e._repoInternal;let o;if(i.repoInfo_.nodeAdmin)r.mockUserToken&&Bt('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),o=new $t($t.OWNER);else if(r.mockUserToken){const t="string"==typeof r.mockUserToken?r.mockUserToken:function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const o=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e);return[c(JSON.stringify({alg:"none",type:"JWT"})),c(JSON.stringify(o)),""].join(".")}(r.mockUserToken,e.app.options.projectId);o=new $t(t)}!function(e,t,n,r){e.repoInfo_=new tn(`${t}:${n}`,!1,e.repoInfo_.namespace,e.repoInfo_.webSocketOnly,e.repoInfo_.nodeAdmin,e.repoInfo_.persistenceKey,e.repoInfo_.includeNamespaceInQueryParams,!0),r&&(e.authTokenProvider_=r)}(i,t,n,o)}(n,...e)}return n}Hn.prototype.simpleListen=function(e,t){this.sendRequest("q",{p:e},t)},Hn.prototype.echo=function(e,t){this.sendRequest("echo",{d:e},t)},function(e){!function(e){vt=e}(et),Xe(new q("database",((e,{instanceIdentifier:t})=>es(e.getProvider("app").getImmediate(),e.getProvider("auth-internal"),e.getProvider("app-check-internal"),t)),"PUBLIC").setMultipleInstances(!0)),nt(mt,ft,e),nt(mt,ft,"esm2017")}();const is={apiKey:"AIzaSyBuoAQ6E3uYsOHna-zfKx135p0YYbjwZOo",authDomain:"whalebunny-civhero.firebaseapp.com",databaseURL:"https://whalebunny-civhero-default-rtdb.firebaseio.com",projectId:"whalebunny-civhero",storageBucket:"whalebunny-civhero.appspot.com",messagingSenderId:"503088590460",appId:"1:503088590460:web:58428ea27d65c6e446a3f9",measurementId:"G-NHWNW6SWES"},os={firebaseConfig:is,app:null};function ss(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}function as(){return{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}}os.oneTimeInit=function(){console.log("servicesFirebase.oneTimeInit()"),os.app=tt(is)},os.postToWins=function(e){if(!e.message||!e.threadName)return;const t=rat.utils.copyObject(e,!0);$o(Xo(Ko(rs(os.app),"posts/wins")),t)},os.postToMilestones=function(e){const t=rat.utils.copyObject(e,!0);$o(Xo(Ko(rs(os.app),"posts/milestones")),t)},"function"==typeof SuppressedError&&SuppressedError;const ls=as,cs=new _("auth","Firebase",{"dependent-sdk-initialized-before-auth":"Another Firebase SDK was initialized and is trying to use Auth before Auth is initialized. Please be sure to call `initializeAuth` or `getAuth` before starting any other Firebase SDK."}),us=new $("@firebase/auth");function hs(e,...t){us.logLevel<=U.ERROR&&us.error(`Auth (${et}): ${e}`,...t)}function ds(e,...t){throw fs(e,...t)}function ps(e,...t){return fs(e,...t)}function gs(e,t,n){const r=Object.assign(Object.assign({},ls()),{[t]:n});return new _("auth","Firebase",r).create(t,{appName:e.name})}function ms(e){return gs(e,"operation-not-supported-in-this-environment","Operations that alter the current user are not supported in conjunction with FirebaseServerApp")}function fs(e,...t){if("string"!=typeof e){const n=t[0],r=[...t.slice(1)];return r[0]&&(r[0].appName=e.name),e._errorFactory.create(n,...r)}return cs.create(e,...t)}function vs(e,t,...n){if(!e)throw fs(t,...n)}function ys(e){const t="INTERNAL ASSERTION FAILED: "+e;throw hs(t),new Error(t)}function ws(e,t){e||ys(t)}function Cs(){var e;return"undefined"!=typeof self&&(null===(e=self.location)||void 0===e?void 0:e.protocol)||null}function Ss(){return"undefined"==typeof navigator||!navigator||!("onLine"in navigator)||"boolean"!=typeof navigator.onLine||"http:"!==Cs()&&"https:"!==Cs()&&!function(){const e="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof e&&void 0!==e.id}()&&!("connection"in navigator)||navigator.onLine}class bs{constructor(e,t){this.shortDelay=e,this.longDelay=t,ws(t>e,"Short delay should be less than long delay!"),this.isMobile=w()||C()}get(){return Ss()?this.isMobile?this.longDelay:this.shortDelay:Math.min(5e3,this.shortDelay)}}class _s{static initialize(e,t,n){this.fetchImpl=e,t&&(this.headersImpl=t),n&&(this.responseImpl=n)}static fetch(){return this.fetchImpl?this.fetchImpl:"undefined"!=typeof self&&"fetch"in self?self.fetch:"undefined"!=typeof globalThis&&globalThis.fetch?globalThis.fetch:"undefined"!=typeof fetch?fetch:void ys("Could not find fetch implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static headers(){return this.headersImpl?this.headersImpl:"undefined"!=typeof self&&"Headers"in self?self.Headers:"undefined"!=typeof globalThis&&globalThis.Headers?globalThis.Headers:"undefined"!=typeof Headers?Headers:void ys("Could not find Headers implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}static response(){return this.responseImpl?this.responseImpl:"undefined"!=typeof self&&"Response"in self?self.Response:"undefined"!=typeof globalThis&&globalThis.Response?globalThis.Response:"undefined"!=typeof Response?Response:void ys("Could not find Response implementation, make sure you call FetchProvider.initialize() with an appropriate polyfill")}}const xs={CREDENTIAL_MISMATCH:"custom-token-mismatch",MISSING_CUSTOM_TOKEN:"internal-error",INVALID_IDENTIFIER:"invalid-email",MISSING_CONTINUE_URI:"internal-error",INVALID_PASSWORD:"wrong-password",MISSING_PASSWORD:"missing-password",INVALID_LOGIN_CREDENTIALS:"invalid-credential",EMAIL_EXISTS:"email-already-in-use",PASSWORD_LOGIN_DISABLED:"operation-not-allowed",INVALID_IDP_RESPONSE:"invalid-credential",INVALID_PENDING_TOKEN:"invalid-credential",FEDERATED_USER_ID_ALREADY_LINKED:"credential-already-in-use",MISSING_REQ_TYPE:"internal-error",EMAIL_NOT_FOUND:"user-not-found",RESET_PASSWORD_EXCEED_LIMIT:"too-many-requests",EXPIRED_OOB_CODE:"expired-action-code",INVALID_OOB_CODE:"invalid-action-code",MISSING_OOB_CODE:"internal-error",CREDENTIAL_TOO_OLD_LOGIN_AGAIN:"requires-recent-login",INVALID_ID_TOKEN:"invalid-user-token",TOKEN_EXPIRED:"user-token-expired",USER_NOT_FOUND:"user-token-expired",TOO_MANY_ATTEMPTS_TRY_LATER:"too-many-requests",PASSWORD_DOES_NOT_MEET_REQUIREMENTS:"password-does-not-meet-requirements",INVALID_CODE:"invalid-verification-code",INVALID_SESSION_INFO:"invalid-verification-id",INVALID_TEMPORARY_PROOF:"invalid-credential",MISSING_SESSION_INFO:"missing-verification-id",SESSION_EXPIRED:"code-expired",MISSING_ANDROID_PACKAGE_NAME:"missing-android-pkg-name",UNAUTHORIZED_DOMAIN:"unauthorized-continue-uri",INVALID_OAUTH_CLIENT_ID:"invalid-oauth-client-id",ADMIN_ONLY_OPERATION:"admin-restricted-operation",INVALID_MFA_PENDING_CREDENTIAL:"invalid-multi-factor-session",MFA_ENROLLMENT_NOT_FOUND:"multi-factor-info-not-found",MISSING_MFA_ENROLLMENT_ID:"missing-multi-factor-info",MISSING_MFA_PENDING_CREDENTIAL:"missing-multi-factor-session",SECOND_FACTOR_EXISTS:"second-factor-already-in-use",SECOND_FACTOR_LIMIT_EXCEEDED:"maximum-second-factor-count-exceeded",BLOCKING_FUNCTION_ERROR_RESPONSE:"internal-error",RECAPTCHA_NOT_ENABLED:"recaptcha-not-enabled",MISSING_RECAPTCHA_TOKEN:"missing-recaptcha-token",INVALID_RECAPTCHA_TOKEN:"invalid-recaptcha-token",INVALID_RECAPTCHA_ACTION:"invalid-recaptcha-action",MISSING_CLIENT_TYPE:"missing-client-type",MISSING_RECAPTCHA_VERSION:"missing-recaptcha-version",INVALID_RECAPTCHA_VERSION:"invalid-recaptcha-version",INVALID_REQ_TYPE:"invalid-req-type"},Ts=new bs(3e4,6e4);function ks(e,t){return e.tenantId&&!t.tenantId?Object.assign(Object.assign({},t),{tenantId:e.tenantId}):t}async function Is(e,t,n,r,i={}){return Ps(e,i,(async()=>{let i={},o={};r&&("GET"===t?o=r:i={body:JSON.stringify(r)});const s=F(Object.assign({key:e.config.apiKey},o)).slice(1),a=await e._getAdditionalHeaders();return a["Content-Type"]="application/json",e.languageCode&&(a["X-Firebase-Locale"]=e.languageCode),_s.fetch()(Es(e,e.config.apiHost,n,s),Object.assign({method:t,headers:a,referrerPolicy:"no-referrer"},i))}))}async function Ps(e,t,n){e._canInitEmulator=!1;const r=Object.assign(Object.assign({},xs),t);try{const t=new As(e),i=await Promise.race([n(),t.promise]);t.clearNetworkTimeout();const o=await i.json();if("needConfirmation"in o)throw Ds(e,"account-exists-with-different-credential",o);if(i.ok&&!("errorMessage"in o))return o;{const t=i.ok?o.errorMessage:o.error.message,[n,s]=t.split(" : ");if("FEDERATED_USER_ID_ALREADY_LINKED"===n)throw Ds(e,"credential-already-in-use",o);if("EMAIL_EXISTS"===n)throw Ds(e,"email-already-in-use",o);if("USER_DISABLED"===n)throw Ds(e,"user-disabled",o);const a=r[n]||n.toLowerCase().replace(/[_\s]+/g,"-");if(s)throw gs(e,a,s);ds(e,a)}}catch(t){if(t instanceof b)throw t;ds(e,"network-request-failed",{message:String(t)})}}function Es(e,t,n,r){const i=`${t}${n}?${r}`;return e.config.emulator?function(e,t){ws(e.emulator,"Emulator should always be set here");const{url:n}=e.emulator;return t?`${n}${t.startsWith("/")?t.slice(1):t}`:n}(e.config,i):`${e.config.apiScheme}://${i}`}class As{constructor(e){this.auth=e,this.timer=null,this.promise=new Promise(((e,t)=>{this.timer=setTimeout((()=>t(ps(this.auth,"network-request-failed"))),Ts.get())}))}clearNetworkTimeout(){clearTimeout(this.timer)}}function Ds(e,t,n){const r={appName:e.name};n.email&&(r.email=n.email),n.phoneNumber&&(r.phoneNumber=n.phoneNumber);const i=ps(e,t,r);return i.customData._tokenResponse=n,i}async function Bs(e,t){return Is(e,"POST","/v1/accounts:lookup",t)}function Rs(e){if(e)try{const t=new Date(Number(e));if(!isNaN(t.getTime()))return t.toUTCString()}catch(e){}}function Fs(e){return 1e3*Number(e)}function Ns(e){const[t,n,r]=e.split(".");if(void 0===t||void 0===n||void 0===r)return hs("JWT malformed, contained fewer than 3 sections"),null;try{const e=u(n);return e?JSON.parse(e):(hs("Failed to decode base64 JWT payload"),null)}catch(e){return hs("Caught error parsing JWT payload as JSON",null==e?void 0:e.toString()),null}}function Ms(e){const t=Ns(e);return vs(t,"internal-error"),vs(void 0!==t.exp,"internal-error"),vs(void 0!==t.iat,"internal-error"),Number(t.exp)-Number(t.iat)}async function Ls(e,t,n=!1){if(n)return t;try{return await t}catch(t){throw t instanceof b&&function({code:e}){return"auth/user-disabled"===e||"auth/user-token-expired"===e}(t)&&e.auth.currentUser===e&&await e.auth.signOut(),t}}class Os{constructor(e){this.user=e,this.isRunning=!1,this.timerId=null,this.errorBackoff=3e4}_start(){this.isRunning||(this.isRunning=!0,this.schedule())}_stop(){this.isRunning&&(this.isRunning=!1,null!==this.timerId&&clearTimeout(this.timerId))}getInterval(e){var t;if(e){const e=this.errorBackoff;return this.errorBackoff=Math.min(2*this.errorBackoff,96e4),e}{this.errorBackoff=3e4;const e=(null!==(t=this.user.stsTokenManager.expirationTime)&&void 0!==t?t:0)-Date.now()-3e5;return Math.max(0,e)}}schedule(e=!1){if(!this.isRunning)return;const t=this.getInterval(e);this.timerId=setTimeout((async()=>{await this.iteration()}),t)}async iteration(){try{await this.user.getIdToken(!0)}catch(e){return void("auth/network-request-failed"===(null==e?void 0:e.code)&&this.schedule(!0))}this.schedule()}}class Hs{constructor(e,t){this.createdAt=e,this.lastLoginAt=t,this._initializeTime()}_initializeTime(){this.lastSignInTime=Rs(this.lastLoginAt),this.creationTime=Rs(this.createdAt)}_copy(e){this.createdAt=e.createdAt,this.lastLoginAt=e.lastLoginAt,this._initializeTime()}toJSON(){return{createdAt:this.createdAt,lastLoginAt:this.lastLoginAt}}}async function zs(e){var t;const n=e.auth,r=await e.getIdToken(),i=await Ls(e,Bs(n,{idToken:r}));vs(null==i?void 0:i.users.length,n,"internal-error");const o=i.users[0];e._notifyReloadListener(o);const s=(null===(t=o.providerUserInfo)||void 0===t?void 0:t.length)?qs(o.providerUserInfo):[],a=(l=e.providerData,c=s,[...l.filter((e=>!c.some((t=>t.providerId===e.providerId)))),...c]);var l,c;const u=e.isAnonymous,h=!(e.email&&o.passwordHash||(null==a?void 0:a.length)),d=!!u&&h,p={uid:o.localId,displayName:o.displayName||null,photoURL:o.photoUrl||null,email:o.email||null,emailVerified:o.emailVerified||!1,phoneNumber:o.phoneNumber||null,tenantId:o.tenantId||null,providerData:a,metadata:new Hs(o.createdAt,o.lastLoginAt),isAnonymous:d};Object.assign(e,p)}function qs(e){return e.map((e=>{var{providerId:t}=e,n=ss(e,["providerId"]);return{providerId:t,uid:n.rawId||"",displayName:n.displayName||null,email:n.email||null,phoneNumber:n.phoneNumber||null,photoURL:n.photoUrl||null}}))}class Vs{constructor(){this.refreshToken=null,this.accessToken=null,this.expirationTime=null}get isExpired(){return!this.expirationTime||Date.now()>this.expirationTime-3e4}updateFromServerResponse(e){vs(e.idToken,"internal-error"),vs(void 0!==e.idToken,"internal-error"),vs(void 0!==e.refreshToken,"internal-error");const t="expiresIn"in e&&void 0!==e.expiresIn?Number(e.expiresIn):Ms(e.idToken);this.updateTokensAndExpiration(e.idToken,e.refreshToken,t)}updateFromIdToken(e){vs(0!==e.length,"internal-error");const t=Ms(e);this.updateTokensAndExpiration(e,null,t)}async getToken(e,t=!1){return t||!this.accessToken||this.isExpired?(vs(this.refreshToken,e,"user-token-expired"),this.refreshToken?(await this.refresh(e,this.refreshToken),this.accessToken):null):this.accessToken}clearRefreshToken(){this.refreshToken=null}async refresh(e,t){const{accessToken:n,refreshToken:r,expiresIn:i}=await async function(e,t){const n=await Ps(e,{},(async()=>{const n=F({grant_type:"refresh_token",refresh_token:t}).slice(1),{tokenApiHost:r,apiKey:i}=e.config,o=Es(e,r,"/v1/token",`key=${i}`),s=await e._getAdditionalHeaders();return s["Content-Type"]="application/x-www-form-urlencoded",_s.fetch()(o,{method:"POST",headers:s,body:n})}));return{accessToken:n.access_token,expiresIn:n.expires_in,refreshToken:n.refresh_token}}(e,t);this.updateTokensAndExpiration(n,r,Number(i))}updateTokensAndExpiration(e,t,n){this.refreshToken=t||null,this.accessToken=e||null,this.expirationTime=Date.now()+1e3*n}static fromJSON(e,t){const{refreshToken:n,accessToken:r,expirationTime:i}=t,o=new Vs;return n&&(vs("string"==typeof n,"internal-error",{appName:e}),o.refreshToken=n),r&&(vs("string"==typeof r,"internal-error",{appName:e}),o.accessToken=r),i&&(vs("number"==typeof i,"internal-error",{appName:e}),o.expirationTime=i),o}toJSON(){return{refreshToken:this.refreshToken,accessToken:this.accessToken,expirationTime:this.expirationTime}}_assign(e){this.accessToken=e.accessToken,this.refreshToken=e.refreshToken,this.expirationTime=e.expirationTime}_clone(){return Object.assign(new Vs,this.toJSON())}_performRefresh(){return ys("not implemented")}}function Ws(e,t){vs("string"==typeof e||void 0===e,"internal-error",{appName:t})}class Gs{constructor(e){var{uid:t,auth:n,stsTokenManager:r}=e,i=ss(e,["uid","auth","stsTokenManager"]);this.providerId="firebase",this.proactiveRefresh=new Os(this),this.reloadUserInfo=null,this.reloadListener=null,this.uid=t,this.auth=n,this.stsTokenManager=r,this.accessToken=r.accessToken,this.displayName=i.displayName||null,this.email=i.email||null,this.emailVerified=i.emailVerified||!1,this.phoneNumber=i.phoneNumber||null,this.photoURL=i.photoURL||null,this.isAnonymous=i.isAnonymous||!1,this.tenantId=i.tenantId||null,this.providerData=i.providerData?[...i.providerData]:[],this.metadata=new Hs(i.createdAt||void 0,i.lastLoginAt||void 0)}async getIdToken(e){const t=await Ls(this,this.stsTokenManager.getToken(this.auth,e));return vs(t,this.auth,"internal-error"),this.accessToken!==t&&(this.accessToken=t,await this.auth._persistUserIfCurrent(this),this.auth._notifyListenersIfCurrent(this)),t}getIdTokenResult(e){return async function(e,t=!1){const n=z(e),r=await n.getIdToken(t),i=Ns(r);vs(i&&i.exp&&i.auth_time&&i.iat,n.auth,"internal-error");const o="object"==typeof i.firebase?i.firebase:void 0,s=null==o?void 0:o.sign_in_provider;return{claims:i,token:r,authTime:Rs(Fs(i.auth_time)),issuedAtTime:Rs(Fs(i.iat)),expirationTime:Rs(Fs(i.exp)),signInProvider:s||null,signInSecondFactor:(null==o?void 0:o.sign_in_second_factor)||null}}(this,e)}reload(){return async function(e){const t=z(e);await zs(t),await t.auth._persistUserIfCurrent(t),t.auth._notifyListenersIfCurrent(t)}(this)}_assign(e){this!==e&&(vs(this.uid===e.uid,this.auth,"internal-error"),this.displayName=e.displayName,this.photoURL=e.photoURL,this.email=e.email,this.emailVerified=e.emailVerified,this.phoneNumber=e.phoneNumber,this.isAnonymous=e.isAnonymous,this.tenantId=e.tenantId,this.providerData=e.providerData.map((e=>Object.assign({},e))),this.metadata._copy(e.metadata),this.stsTokenManager._assign(e.stsTokenManager))}_clone(e){const t=new Gs(Object.assign(Object.assign({},this),{auth:e,stsTokenManager:this.stsTokenManager._clone()}));return t.metadata._copy(this.metadata),t}_onReload(e){vs(!this.reloadListener,this.auth,"internal-error"),this.reloadListener=e,this.reloadUserInfo&&(this._notifyReloadListener(this.reloadUserInfo),this.reloadUserInfo=null)}_notifyReloadListener(e){this.reloadListener?this.reloadListener(e):this.reloadUserInfo=e}_startProactiveRefresh(){this.proactiveRefresh._start()}_stopProactiveRefresh(){this.proactiveRefresh._stop()}async _updateTokensIfNecessary(e,t=!1){let n=!1;e.idToken&&e.idToken!==this.stsTokenManager.accessToken&&(this.stsTokenManager.updateFromServerResponse(e),n=!0),t&&await zs(this),await this.auth._persistUserIfCurrent(this),n&&this.auth._notifyListenersIfCurrent(this)}async delete(){if(Je(this.auth.app))return Promise.reject(ms(this.auth));const e=await this.getIdToken();return await Ls(this,async function(e,t){return Is(e,"POST","/v1/accounts:delete",t)}(this.auth,{idToken:e})),this.stsTokenManager.clearRefreshToken(),this.auth.signOut()}toJSON(){return Object.assign(Object.assign({uid:this.uid,email:this.email||void 0,emailVerified:this.emailVerified,displayName:this.displayName||void 0,isAnonymous:this.isAnonymous,photoURL:this.photoURL||void 0,phoneNumber:this.phoneNumber||void 0,tenantId:this.tenantId||void 0,providerData:this.providerData.map((e=>Object.assign({},e))),stsTokenManager:this.stsTokenManager.toJSON(),_redirectEventId:this._redirectEventId},this.metadata.toJSON()),{apiKey:this.auth.config.apiKey,appName:this.auth.name})}get refreshToken(){return this.stsTokenManager.refreshToken||""}static _fromJSON(e,t){var n,r,i,o,s,a,l,c;const u=null!==(n=t.displayName)&&void 0!==n?n:void 0,h=null!==(r=t.email)&&void 0!==r?r:void 0,d=null!==(i=t.phoneNumber)&&void 0!==i?i:void 0,p=null!==(o=t.photoURL)&&void 0!==o?o:void 0,g=null!==(s=t.tenantId)&&void 0!==s?s:void 0,m=null!==(a=t._redirectEventId)&&void 0!==a?a:void 0,f=null!==(l=t.createdAt)&&void 0!==l?l:void 0,v=null!==(c=t.lastLoginAt)&&void 0!==c?c:void 0,{uid:y,emailVerified:w,isAnonymous:C,providerData:S,stsTokenManager:b}=t;vs(y&&b,e,"internal-error");const _=Vs.fromJSON(this.name,b);vs("string"==typeof y,e,"internal-error"),Ws(u,e.name),Ws(h,e.name),vs("boolean"==typeof w,e,"internal-error"),vs("boolean"==typeof C,e,"internal-error"),Ws(d,e.name),Ws(p,e.name),Ws(g,e.name),Ws(m,e.name),Ws(f,e.name),Ws(v,e.name);const x=new Gs({uid:y,auth:e,email:h,emailVerified:w,displayName:u,isAnonymous:C,photoURL:p,phoneNumber:d,tenantId:g,stsTokenManager:_,createdAt:f,lastLoginAt:v});return S&&Array.isArray(S)&&(x.providerData=S.map((e=>Object.assign({},e)))),m&&(x._redirectEventId=m),x}static async _fromIdTokenResponse(e,t,n=!1){const r=new Vs;r.updateFromServerResponse(t);const i=new Gs({uid:t.localId,auth:e,stsTokenManager:r,isAnonymous:n});return await zs(i),i}static async _fromGetAccountInfoResponse(e,t,n){const r=t.users[0];vs(void 0!==r.localId,"internal-error");const i=void 0!==r.providerUserInfo?qs(r.providerUserInfo):[],o=!(r.email&&r.passwordHash||(null==i?void 0:i.length)),s=new Vs;s.updateFromIdToken(n);const a=new Gs({uid:r.localId,auth:e,stsTokenManager:s,isAnonymous:o}),l={uid:r.localId,displayName:r.displayName||null,photoURL:r.photoUrl||null,email:r.email||null,emailVerified:r.emailVerified||!1,phoneNumber:r.phoneNumber||null,tenantId:r.tenantId||null,providerData:i,metadata:new Hs(r.createdAt,r.lastLoginAt),isAnonymous:!(r.email&&r.passwordHash||(null==i?void 0:i.length))};return Object.assign(a,l),a}}const Us=new Map;function js(e){ws(e instanceof Function,"Expected a class definition");let t=Us.get(e);return t?(ws(t instanceof e,"Instance stored in cache mismatched with class"),t):(t=new e,Us.set(e,t),t)}class Ks{constructor(){this.type="NONE",this.storage={}}async _isAvailable(){return!0}async _set(e,t){this.storage[e]=t}async _get(e){const t=this.storage[e];return void 0===t?null:t}async _remove(e){delete this.storage[e]}_addListener(e,t){}_removeListener(e,t){}}Ks.type="NONE";const Ys=Ks;function Xs(e,t,n){return`firebase:${e}:${t}:${n}`}class $s{constructor(e,t,n){this.persistence=e,this.auth=t,this.userKey=n;const{config:r,name:i}=this.auth;this.fullUserKey=Xs(this.userKey,r.apiKey,i),this.fullPersistenceKey=Xs("persistence",r.apiKey,i),this.boundEventHandler=t._onStorageEvent.bind(t),this.persistence._addListener(this.fullUserKey,this.boundEventHandler)}setCurrentUser(e){return this.persistence._set(this.fullUserKey,e.toJSON())}async getCurrentUser(){const e=await this.persistence._get(this.fullUserKey);return e?Gs._fromJSON(this.auth,e):null}removeCurrentUser(){return this.persistence._remove(this.fullUserKey)}savePersistenceForRedirect(){return this.persistence._set(this.fullPersistenceKey,this.persistence.type)}async setPersistence(e){if(this.persistence===e)return;const t=await this.getCurrentUser();return await this.removeCurrentUser(),this.persistence=e,t?this.setCurrentUser(t):void 0}delete(){this.persistence._removeListener(this.fullUserKey,this.boundEventHandler)}static async create(e,t,n="authUser"){if(!t.length)return new $s(js(Ys),e,n);const r=(await Promise.all(t.map((async e=>{if(await e._isAvailable())return e})))).filter((e=>e));let i=r[0]||js(Ys);const o=Xs(n,e.config.apiKey,e.name);let s=null;for(const n of t)try{const t=await n._get(o);if(t){const r=Gs._fromJSON(e,t);n!==i&&(s=r),i=n;break}}catch(e){}const a=r.filter((e=>e._shouldAllowMigration));return i._shouldAllowMigration&&a.length?(i=a[0],s&&await i._set(o,s.toJSON()),await Promise.all(t.map((async e=>{if(e!==i)try{await e._remove(o)}catch(e){}}))),new $s(i,e,n)):new $s(i,e,n)}}function Js(e){const t=e.toLowerCase();if(t.includes("opera/")||t.includes("opr/")||t.includes("opios/"))return"Opera";if(Zs(t))return"IEMobile";if(t.includes("msie")||t.includes("trident/"))return"IE";if(t.includes("edge/"))return"Edge";if(function(e=y()){return/firefox\//i.test(e)}(t))return"Firefox";if(t.includes("silk/"))return"Silk";if(ta(t))return"Blackberry";if(na(t))return"Webos";if(Qs(t))return"Safari";if((t.includes("chrome/")||function(e=y()){return/crios\//i.test(e)}(t))&&!t.includes("edge/"))return"Chrome";if(ea(t))return"Android";{const t=/([a-zA-Z\d\.]+)\/[a-zA-Z\d\.]*$/,n=e.match(t);if(2===(null==n?void 0:n.length))return n[1]}return"Other"}function Qs(e=y()){const t=e.toLowerCase();return t.includes("safari/")&&!t.includes("chrome/")&&!t.includes("crios/")&&!t.includes("android")}function Zs(e=y()){return/iemobile/i.test(e)}function ea(e=y()){return/android/i.test(e)}function ta(e=y()){return/blackberry/i.test(e)}function na(e=y()){return/webos/i.test(e)}function ra(e=y()){return/iphone|ipad|ipod/i.test(e)||/macintosh/i.test(e)&&/mobile/i.test(e)}function ia(){return function(){const e=y();return e.indexOf("MSIE ")>=0||e.indexOf("Trident/")>=0}()&&10===document.documentMode}function oa(e,t=[]){let n;switch(e){case"Browser":n=Js(y());break;case"Worker":n=`${Js(y())}-${e}`;break;default:n=e}const r=t.length?t.join(","):"FirebaseCore-web";return`${n}/JsCore/${et}/${r}`}class sa{constructor(e){this.auth=e,this.queue=[]}pushCallback(e,t){const n=t=>new Promise(((n,r)=>{try{n(e(t))}catch(e){r(e)}}));n.onAbort=t,this.queue.push(n);const r=this.queue.length-1;return()=>{this.queue[r]=()=>Promise.resolve()}}async runMiddleware(e){if(this.auth.currentUser===e)return;const t=[];try{for(const n of this.queue)await n(e),n.onAbort&&t.push(n.onAbort)}catch(e){t.reverse();for(const e of t)try{e()}catch(e){}throw this.auth._errorFactory.create("login-blocked",{originalMessage:null==e?void 0:e.message})}}}class aa{constructor(e){var t,n,r,i;const o=e.customStrengthOptions;this.customStrengthOptions={},this.customStrengthOptions.minPasswordLength=null!==(t=o.minPasswordLength)&&void 0!==t?t:6,o.maxPasswordLength&&(this.customStrengthOptions.maxPasswordLength=o.maxPasswordLength),void 0!==o.containsLowercaseCharacter&&(this.customStrengthOptions.containsLowercaseLetter=o.containsLowercaseCharacter),void 0!==o.containsUppercaseCharacter&&(this.customStrengthOptions.containsUppercaseLetter=o.containsUppercaseCharacter),void 0!==o.containsNumericCharacter&&(this.customStrengthOptions.containsNumericCharacter=o.containsNumericCharacter),void 0!==o.containsNonAlphanumericCharacter&&(this.customStrengthOptions.containsNonAlphanumericCharacter=o.containsNonAlphanumericCharacter),this.enforcementState=e.enforcementState,"ENFORCEMENT_STATE_UNSPECIFIED"===this.enforcementState&&(this.enforcementState="OFF"),this.allowedNonAlphanumericCharacters=null!==(r=null===(n=e.allowedNonAlphanumericCharacters)||void 0===n?void 0:n.join(""))&&void 0!==r?r:"",this.forceUpgradeOnSignin=null!==(i=e.forceUpgradeOnSignin)&&void 0!==i&&i,this.schemaVersion=e.schemaVersion}validatePassword(e){var t,n,r,i,o,s;const a={isValid:!0,passwordPolicy:this};return this.validatePasswordLengthOptions(e,a),this.validatePasswordCharacterOptions(e,a),a.isValid&&(a.isValid=null===(t=a.meetsMinPasswordLength)||void 0===t||t),a.isValid&&(a.isValid=null===(n=a.meetsMaxPasswordLength)||void 0===n||n),a.isValid&&(a.isValid=null===(r=a.containsLowercaseLetter)||void 0===r||r),a.isValid&&(a.isValid=null===(i=a.containsUppercaseLetter)||void 0===i||i),a.isValid&&(a.isValid=null===(o=a.containsNumericCharacter)||void 0===o||o),a.isValid&&(a.isValid=null===(s=a.containsNonAlphanumericCharacter)||void 0===s||s),a}validatePasswordLengthOptions(e,t){const n=this.customStrengthOptions.minPasswordLength,r=this.customStrengthOptions.maxPasswordLength;n&&(t.meetsMinPasswordLength=e.length>=n),r&&(t.meetsMaxPasswordLength=e.length<=r)}validatePasswordCharacterOptions(e,t){let n;this.updatePasswordCharacterOptionsStatuses(t,!1,!1,!1,!1);for(let r=0;r<e.length;r++)n=e.charAt(r),this.updatePasswordCharacterOptionsStatuses(t,n>="a"&&n<="z",n>="A"&&n<="Z",n>="0"&&n<="9",this.allowedNonAlphanumericCharacters.includes(n))}updatePasswordCharacterOptionsStatuses(e,t,n,r,i){this.customStrengthOptions.containsLowercaseLetter&&(e.containsLowercaseLetter||(e.containsLowercaseLetter=t)),this.customStrengthOptions.containsUppercaseLetter&&(e.containsUppercaseLetter||(e.containsUppercaseLetter=n)),this.customStrengthOptions.containsNumericCharacter&&(e.containsNumericCharacter||(e.containsNumericCharacter=r)),this.customStrengthOptions.containsNonAlphanumericCharacter&&(e.containsNonAlphanumericCharacter||(e.containsNonAlphanumericCharacter=i))}}class la{constructor(e,t,n,r){this.app=e,this.heartbeatServiceProvider=t,this.appCheckServiceProvider=n,this.config=r,this.currentUser=null,this.emulatorConfig=null,this.operations=Promise.resolve(),this.authStateSubscription=new ua(this),this.idTokenSubscription=new ua(this),this.beforeStateQueue=new sa(this),this.redirectUser=null,this.isProactiveRefreshEnabled=!1,this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION=1,this._canInitEmulator=!0,this._isInitialized=!1,this._deleted=!1,this._initializationPromise=null,this._popupRedirectResolver=null,this._errorFactory=cs,this._agentRecaptchaConfig=null,this._tenantRecaptchaConfigs={},this._projectPasswordPolicy=null,this._tenantPasswordPolicies={},this.lastNotifiedUid=void 0,this.languageCode=null,this.tenantId=null,this.settings={appVerificationDisabledForTesting:!1},this.frameworks=[],this.name=e.name,this.clientVersion=r.sdkClientVersion}_initializeWithPersistence(e,t){return t&&(this._popupRedirectResolver=js(t)),this._initializationPromise=this.queue((async()=>{var n,r;if(!this._deleted&&(this.persistenceManager=await $s.create(this,e),!this._deleted)){if(null===(n=this._popupRedirectResolver)||void 0===n?void 0:n._shouldInitProactively)try{await this._popupRedirectResolver._initialize(this)}catch(e){}await this.initializeCurrentUser(t),this.lastNotifiedUid=(null===(r=this.currentUser)||void 0===r?void 0:r.uid)||null,this._deleted||(this._isInitialized=!0)}})),this._initializationPromise}async _onStorageEvent(){if(this._deleted)return;const e=await this.assertedPersistence.getCurrentUser();return this.currentUser||e?this.currentUser&&e&&this.currentUser.uid===e.uid?(this._currentUser._assign(e),void await this.currentUser.getIdToken()):void await this._updateCurrentUser(e,!0):void 0}async initializeCurrentUserFromIdToken(e){try{const t=await Bs(this,{idToken:e}),n=await Gs._fromGetAccountInfoResponse(this,t,e);await this.directlySetCurrentUser(n)}catch(e){console.warn("FirebaseServerApp could not login user with provided authIdToken: ",e),await this.directlySetCurrentUser(null)}}async initializeCurrentUser(e){var t;if(Je(this.app)){const e=this.app.settings.authIdToken;return e?new Promise((t=>{setTimeout((()=>this.initializeCurrentUserFromIdToken(e).then(t,t)))})):this.directlySetCurrentUser(null)}const n=await this.assertedPersistence.getCurrentUser();let r=n,i=!1;if(e&&this.config.authDomain){await this.getOrInitRedirectPersistenceManager();const n=null===(t=this.redirectUser)||void 0===t?void 0:t._redirectEventId,o=null==r?void 0:r._redirectEventId,s=await this.tryRedirectSignIn(e);n&&n!==o||!(null==s?void 0:s.user)||(r=s.user,i=!0)}if(!r)return this.directlySetCurrentUser(null);if(!r._redirectEventId){if(i)try{await this.beforeStateQueue.runMiddleware(r)}catch(e){r=n,this._popupRedirectResolver._overrideRedirectResult(this,(()=>Promise.reject(e)))}return r?this.reloadAndSetCurrentUserOrClear(r):this.directlySetCurrentUser(null)}return vs(this._popupRedirectResolver,this,"argument-error"),await this.getOrInitRedirectPersistenceManager(),this.redirectUser&&this.redirectUser._redirectEventId===r._redirectEventId?this.directlySetCurrentUser(r):this.reloadAndSetCurrentUserOrClear(r)}async tryRedirectSignIn(e){let t=null;try{t=await this._popupRedirectResolver._completeRedirectFn(this,e,!0)}catch(e){await this._setRedirectUser(null)}return t}async reloadAndSetCurrentUserOrClear(e){try{await zs(e)}catch(e){if("auth/network-request-failed"!==(null==e?void 0:e.code))return this.directlySetCurrentUser(null)}return this.directlySetCurrentUser(e)}useDeviceLanguage(){this.languageCode=function(){if("undefined"==typeof navigator)return null;const e=navigator;return e.languages&&e.languages[0]||e.language||null}()}async _delete(){this._deleted=!0}async updateCurrentUser(e){if(Je(this.app))return Promise.reject(ms(this));const t=e?z(e):null;return t&&vs(t.auth.config.apiKey===this.config.apiKey,this,"invalid-user-token"),this._updateCurrentUser(t&&t._clone(this))}async _updateCurrentUser(e,t=!1){if(!this._deleted)return e&&vs(this.tenantId===e.tenantId,this,"tenant-id-mismatch"),t||await this.beforeStateQueue.runMiddleware(e),this.queue((async()=>{await this.directlySetCurrentUser(e),this.notifyAuthListeners()}))}async signOut(){return Je(this.app)?Promise.reject(ms(this)):(await this.beforeStateQueue.runMiddleware(null),(this.redirectPersistenceManager||this._popupRedirectResolver)&&await this._setRedirectUser(null),this._updateCurrentUser(null,!0))}setPersistence(e){return Je(this.app)?Promise.reject(ms(this)):this.queue((async()=>{await this.assertedPersistence.setPersistence(js(e))}))}_getRecaptchaConfig(){return null==this.tenantId?this._agentRecaptchaConfig:this._tenantRecaptchaConfigs[this.tenantId]}async validatePassword(e){this._getPasswordPolicyInternal()||await this._updatePasswordPolicy();const t=this._getPasswordPolicyInternal();return t.schemaVersion!==this.EXPECTED_PASSWORD_POLICY_SCHEMA_VERSION?Promise.reject(this._errorFactory.create("unsupported-password-policy-schema-version",{})):t.validatePassword(e)}_getPasswordPolicyInternal(){return null===this.tenantId?this._projectPasswordPolicy:this._tenantPasswordPolicies[this.tenantId]}async _updatePasswordPolicy(){const e=await async function(e,t={}){return Is(e,"GET","/v2/passwordPolicy",ks(e,t))}(this),t=new aa(e);null===this.tenantId?this._projectPasswordPolicy=t:this._tenantPasswordPolicies[this.tenantId]=t}_getPersistence(){return this.assertedPersistence.persistence.type}_updateErrorMap(e){this._errorFactory=new _("auth","Firebase",e())}onAuthStateChanged(e,t,n){return this.registerStateListener(this.authStateSubscription,e,t,n)}beforeAuthStateChanged(e,t){return this.beforeStateQueue.pushCallback(e,t)}onIdTokenChanged(e,t,n){return this.registerStateListener(this.idTokenSubscription,e,t,n)}authStateReady(){return new Promise(((e,t)=>{if(this.currentUser)e();else{const n=this.onAuthStateChanged((()=>{n(),e()}),t)}}))}async revokeAccessToken(e){if(this.currentUser){const t={providerId:"apple.com",tokenType:"ACCESS_TOKEN",token:e,idToken:await this.currentUser.getIdToken()};null!=this.tenantId&&(t.tenantId=this.tenantId),await async function(e,t){return Is(e,"POST","/v2/accounts:revokeToken",ks(e,t))}(this,t)}}toJSON(){var e;return{apiKey:this.config.apiKey,authDomain:this.config.authDomain,appName:this.name,currentUser:null===(e=this._currentUser)||void 0===e?void 0:e.toJSON()}}async _setRedirectUser(e,t){const n=await this.getOrInitRedirectPersistenceManager(t);return null===e?n.removeCurrentUser():n.setCurrentUser(e)}async getOrInitRedirectPersistenceManager(e){if(!this.redirectPersistenceManager){const t=e&&js(e)||this._popupRedirectResolver;vs(t,this,"argument-error"),this.redirectPersistenceManager=await $s.create(this,[js(t._redirectPersistence)],"redirectUser"),this.redirectUser=await this.redirectPersistenceManager.getCurrentUser()}return this.redirectPersistenceManager}async _redirectUserForId(e){var t,n;return this._isInitialized&&await this.queue((async()=>{})),(null===(t=this._currentUser)||void 0===t?void 0:t._redirectEventId)===e?this._currentUser:(null===(n=this.redirectUser)||void 0===n?void 0:n._redirectEventId)===e?this.redirectUser:null}async _persistUserIfCurrent(e){if(e===this.currentUser)return this.queue((async()=>this.directlySetCurrentUser(e)))}_notifyListenersIfCurrent(e){e===this.currentUser&&this.notifyAuthListeners()}_key(){return`${this.config.authDomain}:${this.config.apiKey}:${this.name}`}_startProactiveRefresh(){this.isProactiveRefreshEnabled=!0,this.currentUser&&this._currentUser._startProactiveRefresh()}_stopProactiveRefresh(){this.isProactiveRefreshEnabled=!1,this.currentUser&&this._currentUser._stopProactiveRefresh()}get _currentUser(){return this.currentUser}notifyAuthListeners(){var e,t;if(!this._isInitialized)return;this.idTokenSubscription.next(this.currentUser);const n=null!==(t=null===(e=this.currentUser)||void 0===e?void 0:e.uid)&&void 0!==t?t:null;this.lastNotifiedUid!==n&&(this.lastNotifiedUid=n,this.authStateSubscription.next(this.currentUser))}registerStateListener(e,t,n,r){if(this._deleted)return()=>{};const i="function"==typeof t?t:t.next.bind(t);let o=!1;const s=this._isInitialized?Promise.resolve():this._initializationPromise;if(vs(s,this,"internal-error"),s.then((()=>{o||i(this.currentUser)})),"function"==typeof t){const i=e.addObserver(t,n,r);return()=>{o=!0,i()}}{const n=e.addObserver(t);return()=>{o=!0,n()}}}async directlySetCurrentUser(e){this.currentUser&&this.currentUser!==e&&this._currentUser._stopProactiveRefresh(),e&&this.isProactiveRefreshEnabled&&e._startProactiveRefresh(),this.currentUser=e,e?await this.assertedPersistence.setCurrentUser(e):await this.assertedPersistence.removeCurrentUser()}queue(e){return this.operations=this.operations.then(e,e),this.operations}get assertedPersistence(){return vs(this.persistenceManager,this,"internal-error"),this.persistenceManager}_logFramework(e){e&&!this.frameworks.includes(e)&&(this.frameworks.push(e),this.frameworks.sort(),this.clientVersion=oa(this.config.clientPlatform,this._getFrameworks()))}_getFrameworks(){return this.frameworks}async _getAdditionalHeaders(){var e;const t={"X-Client-Version":this.clientVersion};this.app.options.appId&&(t["X-Firebase-gmpid"]=this.app.options.appId);const n=await(null===(e=this.heartbeatServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getHeartbeatsHeader());n&&(t["X-Firebase-Client"]=n);const r=await this._getAppCheckToken();return r&&(t["X-Firebase-AppCheck"]=r),t}async _getAppCheckToken(){var e;const t=await(null===(e=this.appCheckServiceProvider.getImmediate({optional:!0}))||void 0===e?void 0:e.getToken());return(null==t?void 0:t.error)&&function(e,...t){us.logLevel<=U.WARN&&us.warn(`Auth (${et}): ${e}`,...t)}(`Error while retrieving App Check token: ${t.error}`),null==t?void 0:t.token}}function ca(e){return z(e)}class ua{constructor(e){this.auth=e,this.observer=null,this.addObserver=function(e,t){const n=new M(e,t);return n.subscribe.bind(n)}((e=>this.observer=e))}get next(){return vs(this.observer,this.auth,"internal-error"),this.observer.next.bind(this.observer)}}class ha{constructor(e){this.user=e.user,this.providerId=e.providerId,this._tokenResponse=e._tokenResponse,this.operationType=e.operationType}static async _fromIdTokenResponse(e,t,n,r=!1){const i=await Gs._fromIdTokenResponse(e,n,r),o=da(n);return new ha({user:i,providerId:o,_tokenResponse:n,operationType:t})}static async _forOperation(e,t,n){await e._updateTokensIfNecessary(n,!0);const r=da(n);return new ha({user:e,providerId:r,_tokenResponse:n,operationType:t})}}function da(e){return e.providerId?e.providerId:"phoneNumber"in e?"phone":null}async function pa(e,t){return async function(e,t,n,r,i={}){const o=await Is(e,t,n,r,i);return"mfaPendingCredential"in o&&ds(e,"multi-factor-auth-required",{_serverResponse:o}),o}(e,"POST","/v1/accounts:signInWithCustomToken",ks(e,t))}const ga="__sak";class ma{constructor(e,t){this.storageRetriever=e,this.type=t}_isAvailable(){try{return this.storage?(this.storage.setItem(ga,"1"),this.storage.removeItem(ga),Promise.resolve(!0)):Promise.resolve(!1)}catch(e){return Promise.resolve(!1)}}_set(e,t){return this.storage.setItem(e,JSON.stringify(t)),Promise.resolve()}_get(e){const t=this.storage.getItem(e);return Promise.resolve(t?JSON.parse(t):null)}_remove(e){return this.storage.removeItem(e),Promise.resolve()}get storage(){return this.storageRetriever()}}class fa extends ma{constructor(){super((()=>window.localStorage),"LOCAL"),this.boundEventHandler=(e,t)=>this.onStorageEvent(e,t),this.listeners={},this.localCache={},this.pollTimer=null,this.safariLocalStorageNotSynced=function(){const e=y();return Qs(e)||ra(e)}()&&function(){try{return!(!window||window===window.top)}catch(e){return!1}}(),this.fallbackToPolling=function(e=y()){return ra(e)||ea(e)||na(e)||ta(e)||/windows phone/i.test(e)||Zs(e)}(),this._shouldAllowMigration=!0}forAllChangedKeys(e){for(const t of Object.keys(this.listeners)){const n=this.storage.getItem(t),r=this.localCache[t];n!==r&&e(t,r,n)}}onStorageEvent(e,t=!1){if(!e.key)return void this.forAllChangedKeys(((e,t,n)=>{this.notifyListeners(e,n)}));const n=e.key;if(t?this.detachListener():this.stopPolling(),this.safariLocalStorageNotSynced){const r=this.storage.getItem(n);if(e.newValue!==r)null!==e.newValue?this.storage.setItem(n,e.newValue):this.storage.removeItem(n);else if(this.localCache[n]===e.newValue&&!t)return}const r=()=>{const e=this.storage.getItem(n);(t||this.localCache[n]!==e)&&this.notifyListeners(n,e)},i=this.storage.getItem(n);ia()&&i!==e.newValue&&e.newValue!==e.oldValue?setTimeout(r,10):r()}notifyListeners(e,t){this.localCache[e]=t;const n=this.listeners[e];if(n)for(const e of Array.from(n))e(t?JSON.parse(t):t)}startPolling(){this.stopPolling(),this.pollTimer=setInterval((()=>{this.forAllChangedKeys(((e,t,n)=>{this.onStorageEvent(new StorageEvent("storage",{key:e,oldValue:t,newValue:n}),!0)}))}),1e3)}stopPolling(){this.pollTimer&&(clearInterval(this.pollTimer),this.pollTimer=null)}attachListener(){window.addEventListener("storage",this.boundEventHandler)}detachListener(){window.removeEventListener("storage",this.boundEventHandler)}_addListener(e,t){0===Object.keys(this.listeners).length&&(this.fallbackToPolling?this.startPolling():this.attachListener()),this.listeners[e]||(this.listeners[e]=new Set,this.localCache[e]=this.storage.getItem(e)),this.listeners[e].add(t)}_removeListener(e,t){this.listeners[e]&&(this.listeners[e].delete(t),0===this.listeners[e].size&&delete this.listeners[e]),0===Object.keys(this.listeners).length&&(this.detachListener(),this.stopPolling())}async _set(e,t){await super._set(e,t),this.localCache[e]=JSON.stringify(t)}async _get(e){const t=await super._get(e);return this.localCache[e]=JSON.stringify(t),t}async _remove(e){await super._remove(e),delete this.localCache[e]}}fa.type="LOCAL";const va=fa;(class extends ma{constructor(){super((()=>window.sessionStorage),"SESSION")}_addListener(e,t){}_removeListener(e,t){}}).type="SESSION",new bs(3e4,6e4),new bs(2e3,1e4),new bs(3e4,6e4),new bs(5e3,15e3);var ya="@firebase/auth",wa="1.7.5";class Ca{constructor(e){this.auth=e,this.internalListeners=new Map}getUid(){var e;return this.assertAuthConfigured(),(null===(e=this.auth.currentUser)||void 0===e?void 0:e.uid)||null}async getToken(e){if(this.assertAuthConfigured(),await this.auth._initializationPromise,!this.auth.currentUser)return null;return{accessToken:await this.auth.currentUser.getIdToken(e)}}addAuthTokenListener(e){if(this.assertAuthConfigured(),this.internalListeners.has(e))return;const t=this.auth.onIdTokenChanged((t=>{e((null==t?void 0:t.stsTokenManager.accessToken)||null)}));this.internalListeners.set(e,t),this.updateProactiveRefresh()}removeAuthTokenListener(e){this.assertAuthConfigured();const t=this.internalListeners.get(e);t&&(this.internalListeners.delete(e),t(),this.updateProactiveRefresh())}assertAuthConfigured(){vs(this.auth._initializationPromise,"dependent-sdk-initialized-before-auth")}updateProactiveRefresh(){this.internalListeners.size>0?this.auth._startProactiveRefresh():this.auth._stopProactiveRefresh()}}var Sa;(e=>{var t;null===(t=g())||void 0===t||t[`_${e}`]})("authIdTokenMaxAge"),Sa="Browser",Xe(new q("auth",((e,{options:t})=>{const n=e.getProvider("app").getImmediate(),r=e.getProvider("heartbeat"),i=e.getProvider("app-check-internal"),{apiKey:o,authDomain:s}=n.options;vs(o&&!o.includes(":"),"invalid-api-key",{appName:n.name});const a={apiKey:o,authDomain:s,clientPlatform:Sa,apiHost:"identitytoolkit.googleapis.com",tokenApiHost:"securetoken.googleapis.com",apiScheme:"https",sdkClientVersion:oa(Sa)},l=new la(n,r,i,a);return function(e,t){const n=(null==t?void 0:t.persistence)||[],r=(Array.isArray(n)?n:[n]).map(js);(null==t?void 0:t.errorMap)&&e._updateErrorMap(t.errorMap),e._initializeWithPersistence(r,null==t?void 0:t.popupRedirectResolver)}(l,t),l}),"PUBLIC").setInstantiationMode("EXPLICIT").setInstanceCreatedCallback(((e,t,n)=>{e.getProvider("auth-internal").initialize()}))),Xe(new q("auth-internal",(e=>(e=>new Ca(e))(ca(e.getProvider("auth").getImmediate()))),"PRIVATE").setInstantiationMode("EXPLICIT")),nt(ya,wa,function(e){switch(e){case"Node":return"node";case"ReactNative":return"rn";case"Worker":return"webworker";case"Cordova":return"cordova";case"WebExtension":return"web-extension";default:return}}(Sa)),nt(ya,wa,"esm2017");const ba={auth:null,signInState:"pending",user:null};rat.eventEmitter.eventify(ba),ba.oneTimeInit=function(){const e=function(e,t){const n=$e(e,"auth");if(n.isInitialized()){const e=n.getImmediate();if(B(n.getOptions(),null!=t?t:{}))return e;ds(e,"already-initialized")}return n.initialize({options:t})}(os.app,{persistence:va});ba.auth=e,function(e,t,n,r){z(e).onAuthStateChanged(t,n,r)}(e,(e=>{if(e){const t=e.uid;ba.user=e,console.log("FB auth user is signed in "+t+", "+e.displayName+", "+e.email),ba.signInState="signed_in",ba.emit("signed_in",e)}else console.log("FB auth user is signed out"),ba.user&&console.log("auth user was "+ba.user.displayName),ba.signInState="signed_out",ba.emit("signed_out",e)}))},ba.signInWithCustom=function(e){console.log("firebase sign in with custom token");(async function(e,t){if(Je(e.app))return Promise.reject(ms(e));const n=ca(e),r=await pa(n,{token:t,returnSecureToken:!0}),i=await ha._fromIdTokenResponse(n,"signIn",r);return await n._updateCurrentUser(i.user),i})(ba.auth,e).then((e=>{const t=e.user;ba.user=t;const n=t.uid;console.log("FB custom token signin OK: "+n+", "+t.displayName+", "+t.email)})).catch((e=>{console.error("Error signing in with FB custom token:",e)}))},ba.isSignedIn=function(){return"signed_in"===ba.signInState},ba.getDisplayName=function(){return"signed_in"===ba.signInState&&ba.user?ba.user.displayName:null},ba.signOut=function(){console.log("firebase sign out"),ba.signInState="signed_out";(function(e){return z(e).signOut()})(ba.auth).then((()=>{console.log("firebase sign out success")})).catch((e=>{console.log("firebase sign out error")}))},ba.signInOut=function(){"signed_in"===ba.signInState?ba.signOut():ba.signIn()};var _a={assets:{food:{res:"res/images/resources/food.png",image:null},money:{res:"res/images/resources/money.png",image:null},production:{res:"res/images/resources/production.png",image:null},science:{res:"res/images/resources/science.png",image:null},war:{res:"res/images/resources/war.png",image:null},food_embed:{res:"res/images/resources/food.png",image:null,textEmbeddable:!0,center:!1},money_embed:{res:"res/images/resources/money.png",image:null,textEmbeddable:!0,center:!1},production_embed:{res:"res/images/resources/production.png",image:null,textEmbeddable:!0,center:!1},science_embed:{res:"res/images/resources/science.png",image:null,textEmbeddable:!0,center:!1},war_embed:{res:"res/images/resources/war.png",image:null,textEmbeddable:!0,center:!1},food_low:{res:"res/images/resources/food.png",image:null},money_low:{res:"res/images/resources/money_low.png",image:null},production_low:{res:"res/images/resources/production_low.png",image:null},science_low:{res:"res/images/resources/science_low.png",image:null},war_low:{res:"res/images/resources/war_low.png",image:null},points:{res:"res/images/resources/point.png",image:null},points_low:{res:"res/images/resources/point_low.png",image:null},points_med:{res:"res/images/resources/point_med.png",image:null},points_full:{res:"res/images/resources/point_full.png",image:null},points_empty:{res:"res/images/resources/point_empty.png",image:null},points_empty_counter:{res:"res/images/resources/point_empty_counter.png",image:null},points_5:{res:"res/images/resources/point_5.png",image:null},point_embed:{res:"res/images/resources/point.png",image:null,textEmbeddable:!0,center:!1},treasure:{res:"res/images/objects/treasure.png",image:null},tombstone:{res:"res/images/objects/tombstone.png",image:null},blank_avatar:{res:"res/images/avatars/avatar_shaded.png",image:null},unknown_hero:{res:"res/images/avatars/unknown.png",image:null},unknown_hero_embed:{res:"res/images/avatars/unknown.png",image:null,textEmbeddable:!0,center:!1},unknown_hero_w_embed:{res:"res/images/avatars/unknown_w.png",image:null,textEmbeddable:!0,center:!1},tile_flat:{res:"res/images/tiles/tile_flat.png"},tile_fog:{res:"res/images/tiles/tile_fog.png"},tile_hill:{res:"res/images/tiles/tile_hill.png"},tile_lake:{res:"res/images/tiles/tile_lake.png"},tile_mountain:{res:"res/images/tiles/tile_mountain.png"},tile_ocean:{res:"res/images/tiles/tile_ocean.png"},tile_sand:{res:"res/images/tiles/tile_sand.png"},tile_trees:{res:"res/images/tiles/tile_trees.png"},slime:{res:"res/images/creatures/slime.png",image:null},skull:{res:"res/images/creatures/skull.png",image:null},spider:{res:"res/images/creatures/spider.png",image:null},spider_close:{res:"res/images/creatures/spider_close.png",image:null},spider_portrait:{res:"res/images/creatures/spider_portrait.png",image:null},dragon:{res:"res/images/creatures/dragon.png",image:null},pet_icon:{res:"res/images/ui/animals/pet_icon.png",image:null},health_minus:{res:"res/images/effects/health_minus.png",image:null},defense_minus:{res:"res/images/effects/defense_minus.png",image:null},monster_notice:{res:"res/images/effects/monster_notice.png",image:null},trade_action:{res:"res/images/effects/trade_action.png",image:null},sci_action:{res:"res/images/effects/sci_action.png",image:null},search_action:{res:"res/images/effects/search_action.png",image:null},unlock_victory_action:{res:"res/images/effects/unlock_victory_action.png",image:null},tile_glow:{res:["res/images/effects/tile_glow.png","res/images/effects/tile_glow_01.png"],image:null,animSpeed:15},event_notice:{res:"res/images/effects/monster_notice.png",image:null},civ_notice:{res:"res/images/effects/monster_notice.png",image:null},dizzy:{res:["res/images/effects/dizzy_01.png","res/images/effects/dizzy_02.png","res/images/effects/dizzy_03.png"],image:null,animSpeed:5},unknown_card:{res:"res/images/ui/menus/unknown_card.png"},new_card:{res:"res/images/ui/menus/new_card.png"},card_plus:{res:"res/images/ui/menus/card_plus.png"},card_plus_button_normal:{res:"res/images/ui/menus/card_plus_button_normal.png"},card_plus_button_high:{res:"res/images/ui/menus/card_plus_button_high.png"},card_plus_button_pressed:{res:"res/images/ui/menus/card_plus_button_pressed.png"},card_front:{res:"res/images/ui/cards/card_front.png"},card_front_pressed:{res:"res/images/ui/cards/card_front_pressed.png"},card_front_high:{res:"res/images/ui/cards/card_front_high.png"},card_back:{res:"res/images/ui/cards/card_back.png"},card_back_pressed:{res:"res/images/ui/cards/card_back_pressed.png"},card_back_high:{res:"res/images/ui/cards/card_back_high.png"},menu_empty:{res:"res/images/ui/menus/menu_placeholder.png",image:null},menu_icon:{res:"res/images/ui/menus/menu.png",image:null},menu_play:{res:"res/images/ui/menus/menu_play.png",image:null},menu_civs:{res:"res/images/ui/menus/menu_civs.png",image:null},menu_cards:{res:"res/images/ui/menus/menu_cards.png",image:null},menu_help:{res:"res/images/ui/menus/menu_info.png",image:null},menu_account:{res:"res/images/ui/menus/menu_account.png",image:null},menu_account_embed:{res:"res/images/ui/menus/account_icon.png",image:null,textEmbeddable:!0,center:!1},menu_about:{res:"res/images/ui/menus/menu_about.png",image:null},menu_options:{res:"res/images/ui/menus/menu_options.png",image:null},menu_records:{res:"res/images/ui/menus/menu_stats.png",image:null},menu_dailies:{res:"res/images/ui/menus/menu_dailies.png",image:null},menu_unlock_all:{res:"res/images/ui/menus/menu_unlock_all.png",image:null},menu_map:{res:"res/images/ui/menus/menu_map.png",image:null},menu_next:{res:"res/images/ui/menus/next.png",image:null},menu_restart:{res:"res/images/ui/menus/restart.png",image:null},menu_left:{res:"res/images/ui/menus/menu_left.png",image:null},menu_right:{res:"res/images/ui/menus/menu_right.png",image:null},menu_back:{res:"res/images/ui/menus/menu_back.png",image:null},vol_down:{res:"res/images/ui/menus/vol_down.png",image:null},vol_up:{res:"res/images/ui/menus/vol_up.png",image:null},arrow_bottom:{res:"res/images/ui/arrow_bottom.png",image:null},arrow_top:{res:"res/images/ui/arrow_top.png",image:null},menu_checkmark:{res:"res/images/ui/menus/check.png",image:null},menu_checkmark_empty:{res:"res/images/ui/menus/check_empty.png",image:null},menu_checkmark_empty_box:{res:"res/images/ui/menus/check_empty_box3.png",image:null},menu_checkmark_empty_dot:{res:"res/images/ui/menus/check_empty_dot.png",image:null},checkmark_small:{res:"res/images/ui/menus/check_small.png",image:null},checkmark_small_empty:{res:"res/images/ui/menus/check_small_empty.png",image:null},mini_ui_arrow:{res:"res/images/ui/mini_ui_arrow.png",image:null,textEmbeddable:!0,center:!1},content_indicator_down:{res:"res/images/ui/menus/content_indicator_down.png",image:null},content_indicator_up:{res:"res/images/ui/menus/content_indicator_up.png",image:null},menu_favorite:{res:"res/images/ui/menus/menu_heart_full.png",image:null},menu_notfavorite:{res:"res/images/ui/menus/menu_heart_empty.png",image:null},menu_favorite_red:{res:"res/images/ui/menus/heart_red.png",image:null},wb_logo_small:{res:"res/images/ui/logos/company_logo_small.png",image:null,center:!1},title:{res:"res/images/ui/logos/title.png",image:null,center:!1},menu_background:{res:"res/images/ui/menus/menu_background2.png",image:null,center:!1},action_sub_menu_normal:{res:"res/images/ui/menus/action_sub_menu_normal.png",image:null},action_sub_menu_hi:{res:"res/images/ui/menus/action_sub_menu_hi.png",image:null},action_sub_menu_pressed:{res:"res/images/ui/menus/action_sub_menu_pressed.png",image:null},puff_gray:{res:"res/images/effects/puff_gray.png",image:null,center:!0},puff_brown:{res:"res/images/effects/puff_brown.png",image:null,center:!0},intro_move:{res:"res/images/ui/advice/intro_move.png",image:null,center:!1},intro_arrow:{res:"res/images/ui/advice/intro_arrow.png",image:null,center:!1},intro_card:{res:"res/images/ui/advice/intro_card.png",image:null,center:!1},intro_dotdotdot:{res:"res/images/ui/advice/intro_dotdotdot.png",image:null}},animals:{},styles:{star:"#dbb222"},civImages:[],civPartRenderInfo:{town:{scale:1,dx:0,dy:0},city:{},road:{},civ_arrow:{}},oneTimeInit:function(){_a.textImageMap={},rat.ui.TextBox.setSpecialImageMap(_a.textImageMap),this.preloader=new rat.utils.Preloader({atlases:[{atlas:"res/images/civ_images.png",json:"res/images/civ_images.json"}]}),console.log("gfx preload"),this.preloader.startLoad((function(){for(var e in console.log("image preload done"),_a.assets){var t=_a.assets[e];if(t.res){rat.graphics.spritesheet.findInSpriteSheet(t.res)||rat.graphics.imageCache.preLoadImages(t.res);var n=new rat.graphics.ImageRef(t.res);if(void 0!==t.center&&!0!==t.center||n.setCentered(!0,!0),t.image=n,void 0!==t.animSpeed&&t.image.setAnimSpeed(t.animSpeed),t.textEmbeddable){var r=t.useTextCode||e;_a.textImageMap[r]=t.image}}}_a.doneProcessing=!0}))},loadCivImages:function(e){function t(e,t,n){rat.graphics.imageFilter.apply(e,"colorize",{color:new rat.graphics.Color(t)},n);var r=_a.assets[n]={};r.image=new rat.graphics.ImageRef(n),r.image.setCentered(!0);var i=n+"_embed",o=_a.assets[i]={};o.image=new rat.graphics.ImageRef(n),o.image.setCentered(!1),_a.textImageMap[i]=o.image}var n=_a.assets.blank_avatar.res,r=new rat.graphics.ImageRef(n);r.setOnLoad((function(){var n=r.getImageFrame(0);n||console.log("ERROR: blank avatar not loaded.");for(var i=0;i<e.length;i++){var o=e[i];t(n,o.style,o.avatarAsset)}t(n,"#000000","unknownciv")}))},loadAnimalImages:function(e,t){for(var n=0,r=0;r<e.length;r++){var i=e[r];_a.animals[i]={},rat.utils.loadXMLAsync("res/images/ui/animals/"+i+".svg",(function(r,i,o){_a.animals[o].svgText=i,++n===e.length&&t()}),i)}},colorAnimalImage:function(e,t){t||(t=["red","green","blue","yellow"]);var n=_a.animals[e].svgText;new rat.graphics.Color(t[1]).luminancePerceived()<.17&&(n=n.replace(/"#010101"/g,'"lightgray"')),t[3]||(t[3]=t[0]),n=(n=(n=(n=n.replace(/"#f00"/g,'"'+t[0]+'"')).replace(/"#0f0"/g,'"'+t[1]+'"')).replace(/"#00f"/g,'"'+t[2]+'"')).replace(/"#ff0"/g,'"'+t[3]+'"');var r="data:image/svg+xml;base64,"+btoa(n),i=new Image;return i.src=r,i},isDoneLoading:function(){return _a.doneProcessing&&rat.graphics.imageCache.isCacheLoaded()},initAfterLoad:function(){},prepForGame:function(e){_a.civImages=[];for(var t=function(e,t,n){for(var r=rat.graphics.Color.getHSVFromColor(t.color),i=e.data,o=0;o<e.data.length;o+=4)if(!(i[o+3]<=0)){var s=i[o],a=i[o+1],l=i[o+2];if(s>1.3*a&&l>1.1*a){var c=rat.graphics.Color.RGBToSV(s,a,l),u=rat.graphics.Color.HSVToRGB(r.h,r.s,c.v*r.v);i[o]=0|u.r,i[o+1]=0|u.g,i[o+2]=0|u.b}else t.darkenOthers&&(i[o]=s/4|0,i[o+1]=a/4|0,i[o+2]=l/4|0)}return e},n=function(e,n,i){var o={},s="res/images/civ_images.png",a="res/images/civ_images_"+r+".png";rat.graphics.spritesheet.getSpriteSheetIndexByImage(a)>0&&rat.graphics.spritesheet.unregisterSpriteSheet(a),rat.graphics.imageFilter.apply(s,t,{sourceName:s,color:n,darkenOthers:i},a);var l=rat.graphics.spritesheet.generateAltSheetJS(s,r+"_","");for(var c in rat.graphics.spritesheet.registerSpriteSheet(a,l),app.Buildings.types){var u=r+"_"+c+".png";rat.graphics.spritesheet.findInSpriteSheet([u])||(u=r+"_placeholder.png");var h=new rat.graphics.ImageRef(u);h.setCentered(!0,!0),o[c]=h}for(var d in _a.civPartRenderInfo)if(!o[d]){var p=r+"_"+d+".png",g=new rat.graphics.ImageRef(p);g.setCentered(!0,!0),o[d]=g}return o},r=0;r<e.length;r++){var i=e[r],o=new rat.graphics.Color(i.info.style);if(_a.civImages[r]=n(0,o),i.hero){i.hero.animSet=app.animations.makeAnimSet("avatar");var s="idle";i.isDead&&(s="dead"),i.hero.animSet.setAnimByName(s)}}_a.unknownCivImages=n(0,new rat.graphics.Color(64,64,64),!0)},update:function(e){for(var t=0;t<game.civs.length;t++){var n=e;game.civs[t].isAI&&(n/=2),game.civs[t].hero.animTimer+=n}for(var r in _a.assets)_a.assets[r].image.update(e)},applyAnimSet:function(e,t){if(t){var n=t.getCurAnimation();if(n){var r=n.getTransform("root");e.translate(5*r.translation.x,5*r.translation.y),e.rotate(r.rotation),e.scale(r.scale.x,r.scale.y)}}},drawHeroAvatar:function(t,n,r,i,o,s){var a,l=app.ctx,c=game.civs[t];if(i||(i=app.config.graphics.heroSize),l.save(),l.translate(n,r),_a.applyAnimSet(l,o),(a=s?this.getImage(c.info.avatarAsset):this.getImage("unknown_hero"))&&a.draw(l,0,0,i,i),l.restore(),c.isDead&&c.showDeadTimer&&(a=this.getImage("dizzy"))&&a.draw(l,n,r,i,i),!c.isAI&&c.isDead&&c.showDeadTimer){l.font="60px "+e.mainFont,l.textAlign="center",l.textBaseline="middle",l.fillStyle="#ffff9b",l.strokeStyle="#201000",l.lineWidth=9;var u=n+10*Math.random(),h=r-80;l.strokeText(""+c.deadTimer,u,h,50),l.fillText(""+c.deadTimer,u,h,50)}},drawHeroDead:function(e){var t=app.ctx,n=game.civs[e.civIndex],r=e.size;r||(r=app.config.graphics.heroSize),t.save(),t.translate(e.x,e.y),t.save(),t.rotate(Math.PI/2);var i=this.getImage(n.info.avatarAsset);i&&i.draw(t,0,0,r,r),t.restore(),t.restore()},drawCreature:function(t,n,r,i){var o=n.classInfo.creatureSize||app.config.graphics.creatureSize,s=n.classInfo.creatureHurtSize||app.config.graphics.creatureHurtSize;t.save(),t.translate(r,i);for(var a=0;a<n.showHealths.length;a++){var l=n.showHealths[a],c=l.foreColor,u=l.backColor;game.civs[l.civIndex].haveMet||(c=e.unknownStyle,u=e.unknownStrokeDark),_a.drawHealthBar(t,l.health,n.maxHealth,c,u),o=s}_a.applyAnimSet(t,n.animSet),this.getImage(n.asset).draw(t,0,0,o,o),t.restore()},getImage:function(e,t){return this.assets[e]&&this.assets[e].image?this.assets[e].image:null},getImageSmall:function(e){if(rat.graphics.canvasPixelRatio<1.4){var t=_a.getImage(e+"_low");if(t)return t}return _a.getImage(e)},getImageCopy:function(e,t){return this.assets[e]&&this.assets[e].image?this.assets[e].image.copy():null},getImageResourcePath:function(e,t){return this.assets[e]&&this.assets[e].image?this.assets[e].res:null},getCivImage:function(e,t){return _a.civImages[e][t]},drawHealthBar:function(e,t,n,r,i){t<=0||(e.lineCap="round",e.beginPath(),e.arc(0,0,app.config.graphics.resourceRegenBarRadius,0,t/n*Math.PI*2,!1),e.lineWidth=app.config.graphics.resourceRegenBarOuterWidth,e.strokeStyle=i,e.stroke(),e.lineWidth=app.config.graphics.resourceRegenBarInnerWidth,e.strokeStyle=r,e.stroke(),e.lineCap="butt")},drawNewRegenBar:function(e,t,n,r,i){var o=app.config.graphics.resourceRegenBarRadius-app.config.graphics.resourceRegenBarInnerWidth;e.lineCap="butt",e.strokeStyle=r,e.lineWidth=app.config.graphics.resourceRegenBarInnerWidth;for(var s=2*Math.PI/(n+1),a=2*Math.PI*.02,l=2*Math.PI*3/4,c=n-t+1,u=0;u<c;u++){var h=s*u+l,d=s*(u+1)-a+l;e.strokeStyle=i,e.lineWidth=app.config.graphics.resourceRegenBarInnerWidth+8,e.beginPath(),e.arc(0,0,o,h-a,d+a,!1),e.stroke(),e.strokeStyle=r,e.lineWidth=app.config.graphics.resourceRegenBarInnerWidth,e.beginPath(),e.arc(0,0,o,h,d,!1),e.stroke()}},drawNewFullRegenBar:function(e,t,n,r,i){var o=app.config.graphics.resourceRegenFullRadius,s=o-4;e.fillStyle=i,e.beginPath(),e.arc(0,0,o,0,2*Math.PI,!1),e.fill(),e.fillStyle=r,e.beginPath(),e.arc(0,0,s,0,2*Math.PI,!1),e.fill()},drawResource:function(e,t,n,r,i,o){var s;if(o||(o=app.ctx),i||(i=app.config.graphics.resourceSize),r||(r=0),o.save(),o.translate(t,n),o.rotate(r),s=i<32?this.getImageSmall(e):this.getImage(e))i*=1.5,s.draw(o,0,0,i,i);else{var a=app.World.resourceTypes[e].style;o.fillStyle=a,o.fillRect(-i/2,-i/2,i,i),o.lineWidth=2,o.strokeStyle="#202020",o.strokeRect(-i/2,-i/2,i,i)}o.restore()},drawPoints:function(e,t,n,r){if(e&&e.limit)if(e.points>=5)_a.drawResource("points_5",t,n,0,app.config.graphics.resourceSize*(1.4*r));else for(var i=0;i<e.points;i++)_a.drawResource("points",t,n+30*i,0,app.config.graphics.resourceSize*r)},drawBuilding:function(e,t,n,r,i,o,s,a){var l,c=_a.civPartRenderInfo[e]||{};l=game.civs[t].haveMet?_a.civImages[t][e]:_a.unknownCivImages[e],c&&l&&(a||(a=app.ctx),s||(s=app.config.graphics.buildingSize),o||(o=0),a.save(),a.translate(r,i),a.rotate(o),l.draw(a,0,0,s,s),a.restore())},drawBuildingConnector:function(e,t,n,r,i,o,s){var a;a=game.civs[t].haveMet?_a.civImages[t].road:_a.unknownCivImages.road,s.save();var l=app.config.world.TILE_SIDE_PIXELS,c={"-10":{x:.866*-l,y:0,rot:0},"0-1":{x:.433*-l,y:.575*-l,rot:-4*Math.PI/6},"1-1":{x:.433*l,y:.575*-l,rot:-2*Math.PI/6}}[""+i+o];s.translate(n+c.x,r+c.y),s.scale(1,app.config.world.V_SCALE),s.rotate(c.rot),a.draw(s,0,0),s.restore()},drawAsset:function(e,t,n,r,i,o){e||(e=app.ctx),o||(o=app.config.graphics.resourceSize),i||(i=0),e.save(),e.translate(n,r),e.rotate(i),this.getImage(t).draw(e,0,0,o,o),e.restore()},drawPet:function(e,t,n,r,i,o){e||(e=app.ctx);if(i||(i=app.config.graphics.worldPetSize),e.save(),e.translate(n,r),o&&_a.applyAnimSet(e,o),e.rotate(-.1),!t.imageRef){var s=app.cards.getCard(t.cardID);t.imageRef=new rat.graphics.ImageRef(s.image),t.imageRef.setCentered(!0,!0)}t.imageRef.draw(e,0,0,i,i),e.restore()}};window.gfx=_a;var xa={init:function(){xa.image=_a.getImage("menu_background")},release:function(){},applyToScreen:function(e){xa.canvas||xa.init();var t=xa.image.getSize(),n=e.size.x/(2*t.w);e.size.y>e.size.x&&(n=e.size.x/t.w);var r=t.w*n,i=t.h*n,o=Math.ceil(e.size.y/i),s=e.background=new rat.ui.Element(e);s.name="menu_background",e.background.setSize(e.size.x,e.size.y),s.drawSelf=function(e){for(var t=0;t<2;t++)for(var n=!!(t%2),s=0;s<o;s++){var a=!(s%2),l=r*t,c=i*s;xa.image.setFlipped(n,a),xa.image.draw(e,l,c,r+1,i+1)}}}};const Ta={makeAnimAuditionScreen:function(e,t){var n=gfx.getImage("blank_avatar"),r=app.animations.makeAnimSet("avatar");return rat.auditions.keyAnimAudition.makeScreen(n,r,{uiScale:2,onKilled:function(){app.gotoScreen("main")}}),screen}},ka=e.mainFont,Ia=e.titleFont,Pa=new rat.graphics.Color("#df5a5b"),Ea=new rat.graphics.Color(255,245,254),Aa=new rat.graphics.Color(255,245,254);var Da={panelBackground:new rat.graphics.Color(12,30,44,.85),panelLight:new rat.graphics.Color(31,54,72,.85),panelLightText:new rat.graphics.Color(56,118,129),panelExtraLight:new rat.graphics.Color(0,182,170),tipTextColor:new rat.graphics.Color(235,247,246),solidPanelBackground:new rat.graphics.Color(12,30,44),solidPanelLight:new rat.graphics.Color(31,54,72),subPanelBackground:new rat.graphics.Color(30,12,32),subPanelLight:new rat.graphics.Color(62,34,64),statsCategoryBackground:new rat.graphics.Color(31,54,72,.85),statsSubCategoryBackground:new rat.graphics.Color(13,30,50,.85),textMainColor:new rat.graphics.Color(255,245,254),textPaleColor:new rat.graphics.Color(222,201,148),textDarkPaleColor:new rat.graphics.Color(160,144,104),textBoldColor:new rat.graphics.Color("#df5a5b"),scrollBoxBorderColor:new rat.graphics.Color("#df5a5b"),textHighColor:new rat.graphics.Color(255,140,141),cardTextColor:new rat.graphics.Color("#192738"),cardRarityColor:new rat.graphics.Color("#c9deaf"),helpButtonColor:new rat.graphics.Color("#01b6aa"),customButtonColor:new rat.graphics.Color("#b383b7"),customButtonFontColor:new rat.graphics.Color("#F4F4F4"),unplayedButtonColor:new rat.graphics.Color("#df875a"),unplayedButtonFontColor:new rat.graphics.Color("#F4F4F4")},Ba={colors:Da,mainFont:ka,config:{resourcePanelHeight:120,worldDisplay:{x:0,y:80,w:800,h:400},actionPanel:{x:0,y:80,w:320,h:1e3},bottomPanelHeight:270},menus:{id:"menus",buttonHeight:140,buttonWidth:520,buttonGap:80,squareButton:{width:160,height:160,gap:80},checkButton:{width:96,height:96},buttonColor:Pa,buttonFont:{font:ka,style:"",size:80,color:Ea},smallButtonFont:{font:ka,style:"",size:45,color:Aa},titleFont:{font:Ia,style:"",size:128,color:Da.textBoldColor},popTitleFont:{font:Ia,style:"",size:80,color:Da.textBoldColor},headingFont:{font:ka,style:"bold",size:96,color:Da.textBoldColor},creditsHeadingFont:{font:ka,style:"bold",size:76,color:Da.textBoldColor},mainFont:{font:ka,style:"",size:56,color:Da.textMainColor},statsMainCategoryFont:{font:ka,style:"",size:64,color:Da.textBoldColor},statsMainLabelFont:{font:ka,style:"",size:56,color:Da.textPaleColor},statsMainFont:{font:ka,style:"",size:56,color:Da.textBoldColor},statsMainSubCategoryFont:{font:ka,style:"",size:56,color:Da.textDarkPaleColor},statsFont:{font:ka,style:"",size:56,color:Da.textPaleColor},dailyHeadingFont:{font:ka,style:"",size:64,color:Da.textMainColor},editTextFont:{font:ka,style:"",size:56,color:Da.textMainColor},cardFont:{font:ka,style:"",size:56,color:Da.cardTextColor},cardExtraFont:{font:ka,style:"",size:48,color:Da.cardTextColor},cardDetailFont:{font:ka,style:"",size:80,color:Da.cardTextColor},cardDetailDescriptionFont:{font:ka,style:"",size:60,color:Da.cardTextColor},cardRarityFont:{font:ka,style:"italic",size:80,color:Da.cardRarityColor},tipFont:{font:ka,style:"italic",size:54,color:Da.tipTextColor},actionTipFont:{font:ka,style:"italic",size:48,color:Da.tipTextColor},tipHotKeyFont:{font:ka,style:"",size:36,color:Da.panelExtraLight},explanationFont:{font:ka,style:"",size:60,color:new rat.graphics.Color(220,220,200)},introAdviceFont:{font:ka,style:"",size:72,color:Da.textMainColor},titleOffset:80,backButtonOffset:220,squareButtonBottomOffset:160},game:{id:"game",buttonHeight:110,buttonWidth:320,buttonGap:64,squareButton:{width:120,height:120},buttonColor:Pa,buttonFont:{font:ka,style:"",size:42,color:Ea},titleFont:{font:ka,style:"",size:72,color:Da.textBoldColor},headingFont:{font:ka,style:"",size:62,color:Da.textBoldColor},bigHeadingFont:{font:ka,style:"bold",size:96,color:Da.textBoldColor},subHeadingFont:{font:ka,style:"",size:62,color:Da.textBoldColor},mainFont:{font:ka,style:"",size:42,color:Da.textMainColor},hexTipTitleFont:{font:ka,style:"",size:52,color:Da.textMainColor},hexTipFont:{font:ka,style:"",size:52,color:Da.textMainColor},helpFont:{font:ka,style:"",size:52,color:Da.tipTextColor},subTopicHeadingFont:{font:ka,style:"bold",size:54,color:Da.panelExtraLight},needHeadingFont:{font:ka,style:"bold",size:54,color:Da.panelExtraLight},resourceFont:{font:ka,style:"",size:56,color:"#FFFFFF"},smallResourceFont:{font:ka,style:"",size:32,color:"#FFFFFF"},victoryFont:{font:ka,style:"",size:96,color:new rat.graphics.Color(175,188,255),stroke:{width:14,color:"#000000",doCleanup:!1}},titleOffset:25,backButtonOffset:100},color:{primary:{normal:"#fefee0"}},curScreen:null,snapScreen:null,lastSize:{x:rat.graphics.SCREEN_WIDTH,y:rat.graphics.SCREEN_HEIGHT},solidPanelFrameWidth:20,forMobile:!1,menuButtonScale:1};Ba.menuButtonSpacing={x:Ba.menus.buttonWidth+Ba.menus.buttonGap,y:Ba.menus.buttonHeight+Ba.menus.buttonGap},Ba.menuIconButtonSpacing={x:Ba.menus.squareButton.width+Ba.menus.squareButton.gap,y:Ba.menus.squareButton.height+Ba.menus.squareButton.gap},Ba.gameButtonSpacing={x:Ba.game.buttonWidth+Ba.game.buttonGap,y:Ba.game.buttonHeight+Ba.game.buttonGap},Ba.menuBack=xa,Ba.init=function(){rat.ui.Button.setDefaultTextInset(40),xa.init(),rat.system.has.mobile&&(Ba.forMobile=!0,Ba.menuButtonScale=1)},Ba.fixButtonColorStates=function(e,t){"string"==typeof t&&(t=new rat.graphics.Color(t));var n=t,r=new rat.graphics.Color(n.r/4,n.g/4,n.b/4,n.a),i=n.copy();i.matchLuminanceTo(new rat.graphics.Color(250,250,250));var o=rat.ui.Element,s=[{state:o.enabledFlag|o.highlightedFlag,frameColor:i},{state:o.enabledFlag|o.pressedFlag,frameColor:r},{state:o.enabledFlag|o.highlightedFlag|o.pressedFlag,frameColor:i},{state:o.enabledFlag|o.toggledFlag,frameColor:r},{state:o.enabledFlag|o.toggledFlag|o.highlightedFlag,frameColor:i},{state:o.enabledFlag|o.toggledFlag|o.pressedFlag,frameColor:r}];e.setStateFrameColors(s)},Ba.makeButtonAt=function(e,t,n,r,i,o){o||(o=Ba.game);var s=i;s||(s=o.buttonColor);var a=rat.ui.Button.makeCoolButton(null,s);return Ba.fixButtonColorStates(a,s),a.setPos(n-o.buttonWidth/2,r-o.buttonHeight/2),a.setSize(o.buttonWidth,o.buttonHeight),a.setTextValue(t),a.setFont(o.buttonFont.font),a.setFontStyle(o.buttonFont.style),a.setFontSize(o.buttonFont.size),a.setTextColors(o.buttonFont.color,o.buttonFont.color,o.buttonFont.color),e.appendSubElement(a),a},Ba.makeMenuButtonAt=function(e,t,n,r,i){return Ba.makeButtonAt(e,t,n,r,i,Ba.menus)},Ba.makeIconButtonAt=function(e,t,n,r,i,o,s){"string"==typeof n&&(n=gfx.getImageCopy(n).setCentered(!1,!1));var a=(e=e||Ba.menus).buttonColor;o=o||e.squareButton.width,s=s||e.squareButton.height;var l=rat.ui.Button.makeCoolButton(null,a);Ba.fixButtonColorStates(l,a),l.setPos(r-o/2,i-s/2),l.setSize(o,s),t.appendSubElement(l);var c=new rat.ui.Sprite(l);return c.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),c.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),c.setSize(o,s),c.loadImage(n),l.icon=c,c.usedUISetID=e.id,l},Ba.setIconButtonLabel=function(e,t){var n,r=Ba.menus;n="menus"===e.icon.usedUISetID?{posY:-20,inset:8,offsetY:50}:{posY:-17,inset:6,offsetY:39},e.icon.setPosY(n.posY),e.setFont(r.smallButtonFont.font),e.setFontStyle(r.smallButtonFont.style),e.setFontSize(r.smallButtonFont.size),e.setTextInset(n.inset),e.setTextOffset(0,n.offsetY),e.setTextValue(t),e.setTextColors(r.smallButtonFont.color,r.smallButtonFont.color,r.smallButtonFont.color,r.smallButtonFont.color)},Ba.makeCheckBoxAt=function(e,t,n,r,i,o){const s=Ba.menus;var a=s.buttonColor,l=s.checkButton.width,c=s.checkButton.height;i=i||500,o=o||c;var u=rat.ui.Button.makeCoolButton(null,a);Ba.fixButtonColorStates(u,a),u.setPos(n-i/2,r-o/2),u.setSize(i,o),u.setCustomBounds({x:0,y:0,w:l,h:c}),u.setToggles(!0),e.appendSubElement(u);var h=new rat.ui.Sprite(u),d=gfx.getImageCopy("menu_checkmark");d.setCentered(!1,!1),h.useImageRef(d),h.setSize(l,c),h.scaleImageToSize(),u.icon=h,h.setVisible(!1),u.setFlagsChangedCallback((function(e,t){u.flags&rat.ui.Element.toggledFlag||u.flags&rat.ui.Element.pressedFlag?h.setVisible(!0):h.setVisible(!1)}));var p=null;if(t){var g=Ba.menus.smallButtonFont;p=new rat.ui.TextBox(t),u.appendSubElement(p);p.setPos(120,0),p.setSize(i-120,c),p.setBaseline("middle"),Ba.applyTextProperties(p,g)}return u.checkBoxLabel=p,u},Ba.makeTitleBox=function(e,t,n){n||(n=Ba.game);var r=n.titleFont,i=new rat.ui.TextBox(t);return i.setPos(0,n.titleOffset),i.setSize(e.getSize().w,r.size),Ba.applyTextProperties(i,r),i.centerText(),e.appendSubElement(i),i},Ba.makeMenuTitleBox=function(e,t){return Ba.makeTitleBox(e,t,Ba.menus)},Ba.makePopTitleBox=function(e,t,n){var r=Ba.menus.popTitleFont,i=new rat.ui.TextBox(t);return i.setPos(0,40),i.setSize(e.getSize().w,r.size),Ba.applyTextProperties(i,r),i.centerText(),e.appendSubElement(i),i},Ba.makeHeading=function(e,t,n,r,i){i||(i=Ba.game),n=n||0,r=r||100;var o=e.getWidth()-40,s=new rat.ui.TextBox(t);return s.setPos(n-o/2,r-20),s.setSize(o,40),Ba.applyTextProperties(s,i.headingFont),s.centerText(),e.appendSubElement(s),s},Ba.makeMenuHeading=function(e,t,n,r){return Ba.makeHeading(e,t,n,r,Ba.menus)},Ba.makeText=function(e,t,n){if(n&&"object"==typeof n){t=t||"";var r=n.useFont||Ba.game.mainFont,i=n.w||e.getSize().w-100,o=n.h||r.size,s=new rat.ui.TextBox(t);return n.centerX?s.setPosX(n.centerX-i/2):s.setPosX(n.x||0),n.centerY?s.setPosY(n.centerY-o/2):s.setPosY(n.y||0),s.setSize(i,o),Ba.applyTextProperties(s,r),s.centerText(),e.appendSubElement(s),s}console.error("ERROR: bad params to ui.makeText")},Ba.makeMenuText=function(e,t,n,r){return Ba.makeText(e,t,{centerX:n,centerY:r,useFont:Ba.menus.mainFont})},Ba.applyTextProperties=function(e,t){e.setFont(t.font),e.setFontStyle(t.style),e.setFontSize(t.size),e.setColor(t.color),t.stroke&&(e.setStroke(t.stroke.width,t.stroke.color,t.stroke.doCleanup),e.setMiterLimit(2))},Ba.placeMiniLogo=function(e){var t=new rat.ui.Sprite("res/images/ui/menus/title_small.png");return t.autoCenter(),t.getSize(),t.setPos(e.getWidth()/2,50),e.appendSubElement(t),t},Ba.setMenuBackAction=function(e){e.setAllowBackClose(!0),e.setUserPostCloseCallback((function(e,t,n){var r=rat.screenManager.getTopScreen();r?app.screenList.setCurScreenIDFromScreen(r):app.gotoScreen("main")}))},Ba.makeMenuBackButtonAndAction=function(e,t){t||(t=e);var n=t.getHeight()-Ba.menus.backButtonOffset,r=Ba.makeMenuButtonAt(t,"back",t.getWidth()/2,n);return r.callback=app.screenList.goBackScreen,Ba.setMenuBackAction(e),r},Ba.addPopupBackground=function(e){var t=e.setBackground(Da.solidPanelBackground);return t.setStroke(Ba.solidPanelFrameWidth,Da.solidPanelLight),t},Ba.addRoundedBackground=function(e,t,n){t=t||Da.solidPanelBackground,n=n||Da.solidPanelLight;var r=e.makeBackground(t);return r.setShapeType("roundrect"),r.setCornerRadius(140/6),r.setStroke(Ba.solidPanelFrameWidth,n),r},Ba.addDimmer=function(e,t){void 0===t&&(t="rgba(0, 0, 0, 0.4)");var n=3*rat.graphics.SCREEN_WIDTH,r=3*rat.graphics.SCREEN_HEIGHT,i=new rat.ui.Shape("square");i.setColor(t),i.setSize(n,r),i.setPos(.5*-n,.5*-r),e.insertSubElement(i)};Ba.addHotKeyBox=function(e,t,n){if(n&&("mouse"===rat.input.lastUIInputType||"keyboard"===rat.input.lastUIInputType)){var r=t.container.getHeight();t.container.setHeight(r+50);var i=new rat.ui.TextBox(t.container,n);i.setPos(0,r-10),i.setSize(t.container.getWidth()-60,50),i.setBaseline("middle"),i.setAlign("right"),Ba.applyTextProperties(i,Ba.menus.tipHotKeyFont)}},Ba.setTooltip=function(e,t,n,r,i){var o=Ba.colors.panelLightText,s=Ba.colors.solidPanelBackground,a=Ba.colors.panelExtraLight,l=60,c=70;i&&(l=i.w||i,c=i.h||i);var u=e.setTextToolTip(t,o,s);u.container.setShapeType("roundRect"),u.container.setCornerRadius(20),u.container.setStroke(12,a),u.textBox.setTextInset(40,0);var h=Ba.menus.tipFont;Ba.applyTextProperties(u.textBox,h),e.sizeTextToolTip(h.size,u.container,u.textBox),u.container.setHeight(u.container.getHeight()+60),u.textBox.setHeight(u.textBox.getHeight()+60),Ba.addHotKeyBox(e,u,n);var d,p=u.container.getSize(),g=new rat.ui.Element(u.container);return u.tail=g,g.setSize(l,c),e.getGlobalBounds().y>200?(e.positionToolTip("top",{x:50,y:-c}),d=p.y-4):(e.positionToolTip("bottom",{x:50,y:c}),d=4,g.setScale(1,-1)),g.setPos(l/2,d),e.setToolTipMoveCallback((function(t,n){var r=e.getGlobalBounds(),i=r.x+r.w/2-l/2;g.setPosX(i-n.getPosX())})),g.drawSelf=function(e){var t=this.getSize();e.fillStyle=a.toString(),e.beginPath(),e.moveTo(0,0),e.lineTo(t.w,0),e.lineTo(t.w/2,t.h),e.closePath(),e.fill()},u.container.setFrame(0),u},Ba.setActionTooltip=function(e,t,n,r){var i=Ba.colors.panelLightText,o=Ba.colors.solidPanelBackground,s=Ba.colors.panelExtraLight;t=Ba.formatText(t);var a=e.setTextToolTip(t,i,o,r);a.container.setShapeType("roundRect"),a.container.setCornerRadius(20),a.container.setStroke(12,s),a.textBox.setTextInset(40,0),a.textBox.enableDefaultSpecialFormatting();var l=Ba.menus.actionTipFont;return Ba.applyTextProperties(a.textBox,l),a.textBox.setAutoWrap(!0),e.sizeTextToolTip({fontSize:l.size,maxWidth:800,maxHeight:600,extraSpace:{x:40,y:16}},a.container,a.textBox),Ba.addHotKeyBox(e,a,n),e.positionToolTip("rightHigh",{x:50,y:0}),a.container.setFrame(0),a},Ba.formatText=function(e){var t=[{formatChar:"*",color:"#7fdd7e"},{formatChar:"^",color:Da.textBoldColor},{formatChar:"`",color:"#f1d37b"}],n=app.World.resourceTypes;for(var r in n){var i=n[r],o=new rat.graphics.Color(i.textStyle);t.push({formatChar:i.colorCode,color:o})}var s=rat.ui.TextBox.formatText(e,t);for(var a in gfx.textImageMap)do{var l="["+a+"]",c=s.indexOf(l);if(c>=0){var u=rat.ui.TextBox.makeSpecialImageString(a);s=s.substring(0,c)+u+s.substring(c+l.length)}}while(c>=0);return s},Ba.isTracking=function(e){if(!e)return!1;var t=e.flags;return!!(t&rat.ui.Element.visibleFlag&&t&rat.ui.Element.visibleFlag&&t&(rat.ui.Element.highlightedFlag|rat.ui.Element.pressedFlag|rat.ui.Element.trackingMouseDownFlag))},Ba.resizeHandler=function(){},Ba.tryRedirectWindow=function(e){try{return window.top.location.href=e,"replaced"}catch(t){return console.error("Top-level navigation failed, opening new tab:",t),window.open(e,"_blank"),"newtab"}};let Ra,Fa,Na,Ma=!1;const La={signInState:"signed_out",user:null,state:0,initURIs:function(){"localhost"===window.location.hostname?(Ma=!0,Fa="localhost",Ra=encodeURIComponent("https://localhost:8000/game/?service=discord"),Na="https://localhost:8000/game/"):"html-classic.itch.zone"===window.location.hostname?(document.referrer&&document.referrer.includes("staging")?(Fa="itch_staging",Ra=encodeURIComponent("https://whalebunny.itch.io/whalebunny-staging-area?service=discord"),Na="https://whalebunny.itch.io/whalebunny-staging-area"):(Fa="itch",Ra=encodeURIComponent("https://whalebunny.itch.io/civ-hero?service=discord"),Na="https://whalebunny.itch.io/civ-hero"),rat.system.has.firefoxBrowser&&(Ma=!0)):(Fa="whalebunny",Ra=encodeURIComponent("https://play.whalebunny.com/play/civhero/?service=discord"),Na="https://play.whalebunny.com/play/civhero/"),Ma&&(Ra=encodeURIComponent("https://play.whalebunny.com/play/civhero/authpopredir/?service=discord"))}},Oa=encodeURIComponent("identify email");rat.eventEmitter.eventify(La);const Ha="ch_oauthstate";La.storeAuthState=function(e){La.state=e,sessionStorage&&sessionStorage.setItem(Ha,La.state)},La.startAuthState=function(){const e="s"+(1e7*Math.random()|0);La.storeAuthState(e)},La.restoreAuthState=function(){sessionStorage&&(La.state=sessionStorage.getItem(Ha)),La.state=La.state||0},La.makeAuthUrl=function(){return`https://discord.com/api/oauth2/authorize?client_id=1297276478597369917&redirect_uri=${Ra}&response_type=code&scope=${Oa}&state=${La.state}`},La.lookForAuthRedirect=function(){console.log("check for AuthRedirect: "+window.location.href+" ... referrer: "+document.referrer);let e=new URL(window.location.href).searchParams,t=e.get("service");if(!t&&document.referrer){e=new URL(document.referrer).searchParams,t=e.get("service"),t&&console.log("using referrer, service was "+t)}if("discord"!==t)return!1;La.restoreAuthState();const n=e.get("state");console.log("check given state "+n+" against stored "+La.state);const r=e.get("code");return!!r&&(La.handleAuthCode(r),!0)};La.handleAuthCode=function(e){const t=function(e){return`${"localhost"===window.location.hostname?"https://localhost:3048":"https://play.whalebunny.com:3048"}/${e}`}("discord-auth"),n={code:e,clientHost:Fa,redirectUri:Ra};fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)}).then((e=>(console.log("handleAuthCode server response:",e),e.json()))).then((e=>{console.log("handleAuthCode server response data:",e),e&&"OK"===e.status&&e.token&&(La.signInState="signed_in",La.user=e.user,La.emit("signed_in",La.user),ba.signInWithCustom(e.token),Ma||history.replaceState({},document.title,Na))})).catch((e=>{console.error("handleAuthCode Error:",e)}))},La.startup=function(){La.lookForAuthRedirect()?console.log("accountDiscord got auth redirect... waiting for that to be handled"):console.log("accountDiscord no redirect"),La.storeAuthState(0)},La.oneTimeInit=function(){La.initURIs(),La.startup(),La.setupPopRedirListener()},La.setupPopRedirListener=function(){window.addEventListener("message",(function(e){console.log("Received message from popup:",e);["https://localhost:8000","https://play.whalebunny.com","https://whalebunny.itch.io","html-classic.itch.zone"].indexOf(e.origin)<0?console.log("auth message from unexpected origin:",e.origin):e.data.authCode&&e.data.state&&"discord"===e.data.service&&(console.log("received auth code from popup:",e.data.authCode),console.log("check given state "+e.data.state+" against stored "+La.state),La.handleAuthCode(e.data.authCode))}))},La.signIn=function(){La.startAuthState();const e=La.makeAuthUrl();if(Ma)return console.log("Using popup redir to "+e),void window.open(e,"discordAuth","width=600,height=800");console.log("Redirecting to "+e);"replaced"!=Ba.tryRedirectWindow(e)&&console.log("Still here?")},La.signOut=function(){La.signInState="signed_out"},La.signInOut=function(){"signed_in"===La.signInState?La.signOut():La.signIn()},La.getDisplayName=function(){return"signed_in"===La.signInState&&La.user?La.user.username:null};var za={init:function(){za.setSoundVolume(0),za.setMusicVolume(0),rat.utils.loadJSONObjectAsync("res/audio/audio.json",(function(e,t,n){e?za.initialLoadComplete(t):rat.console.logError("audio : "+n)}))},initialLoadComplete:function(e){za.doneLoading=!0,rat.audio.loadSounds(e.sounds),rat.ui.Button.defaultClickSound="click",rat.ui.Button.defaultFocusSound="select",za.defaultFocusVolume=rat.audio.getSoundVolume("select"),rat.audio.setSoundVolume("select",0),rat.input.on("lastUIInputTypeChanged",(function(e){rat.input.usingDirectionInput()?rat.audio.setSoundVolume("select",za.defaultFocusVolume):rat.audio.setSoundVolume("select",0)}))},playSound:function(e,t){t?setTimeout((function(){rat.audio.playSound(e)}),1e3*t):rat.audio.playSound(e)},stopSound:function(e){rat.audio.stopSound(e)},setSoundVolume:function(e){rat.audio.setGroupVolume("sfx",e)},setMusicVolume:function(e){rat.audio.setGroupVolume("music",e)}};const qa={tileEmitter:null,flashupEmitter:null,flashes:[],someEffect:function(e,t){},oneTimeInit:function(){qa.uiParticles=rat.particle.createSystem(),qa.worldParticles=rat.particle.createSystem(),rat.graphics.imageCache.preLoadImages(["res/images/effects/puff.png","res/images/effects/e_black_tile.png","res/images/effects/e_gold_tile.png"]),qa.puffSprite=new rat.graphics.ImageRef("res/images/effects/puff.png"),qa.puffSprite.setCentered(!0,!0),qa.blackTileSprite=new rat.graphics.ImageRef("res/images/effects/e_black_tile.png"),qa.blackTileSprite.setCentered(!0,!0),qa.goldTileSprite=new rat.graphics.ImageRef("res/images/effects/e_gold_tile.png"),qa.goldTileSprite.setCentered(!0,!0)},init:function(){this.flashes=[],qa.uiParticles.killAllEmitters(),qa.worldParticles.killAllEmitters(),this.initFlashups(),this.initTileEmitter()},exit:function(){this.init()},update:function(e){qa.uiParticles.update(e),qa.worldParticles.update(e),this.updateFlashes(e)},initFlashups:function(){var e=qa.worldParticles.newEmitter();qa.flashupEmitter=e,e.emitType=rat.particle.System.emitTypeBurst,e.renderType=rat.particle.System.RENDER_SPRITE,e.asset=qa.puffSprite,e.rate=0,e.startState.ageLimit=1,e.startState.size=150,e.startState.color.a=1,e.startState.offset.y=-80,e.startState.vel.x=0,e.startState.vel.y=-450,e.startState.friction=2,e.initEndState(),e.endState.color.a=0},flashup:function(e,t,n,r){r=r||{};var i=qa.flashupEmitter;"small"===r.impact?(i.startState.size=120,i.startState.offset.y=-60,i.startState.vel.x=0,i.startState.vel.y=-450,i.startState.friction=5.5):(i.startState.size=150,i.startState.offset.y=-80,i.startState.vel.x=0,i.startState.vel.y=-450,i.startState.friction=2),i.startState.ageLimit=1,r.size&&(i.startState.size=r.size),r.offset&&(i.startState.offset.x=r.offset.x,i.startState.offset.y=r.offset.y),r.vel&&(i.startState.vel.x=r.vel.x,i.startState.vel.y=r.vel.y),r.age&&(i.startState.ageLimit=r.age);var o=game.hud.worldDisplay.hexToPixelPos(t,n);return i.asset=gfx.getImage(e),i.pos.x=o.x,i.pos.y=o.y,i.spawn()},initTileEmitter:function(){var e=qa.worldParticles.newEmitter();qa.tileEmitter=e,e.emitType=rat.particle.System.emitTypeBurst,e.renderType=rat.particle.System.RENDER_SPRITE,e.asset=qa.blackTileSprite,e.rate=0,qa.setBlackTileEmitterState(e),e.initEndState(),e.endState.color.a=0},setBlackTileEmitterState:function(t){t.startState.ageLimit=.2;var n=2*e.world.TILE_SIDE_PIXELS;t.startState.size=n,t.startState.grow=-n/.8,t.startState.color.a=.6,t.startState.vel.x=0,t.startState.vel.y=0,t.startState.friction=2},spawnTileEffect:function(t,n){var r=qa.tileEmitter;r.pos.x=t,r.pos.y=n;var i=r.spawn();return i.scaleHeight=e.world.V_SCALE,i},addBlackTileEffect:function(e,t){var n=qa.tileEmitter;return n.asset=qa.blackTileSprite,qa.setBlackTileEmitterState(n),qa.spawnTileEffect(e,t)},addGoldTileEffect:function(t,n){var r=qa.tileEmitter;r.asset=qa.goldTileSprite;r.startState.ageLimit=1;var i=2*e.world.TILE_SIDE_PIXELS;r.startState.size=i,r.startState.grow=3*i,r.startState.color.a=.5,r.startState.vel.x=0,r.startState.vel.y=0,qa.spawnTileEffect(t,n),r.startState.size=i/2,r.startState.grow=2*i,qa.spawnTileEffect(t,n)},touchPetEffect:function(e,t,n,r){var i=game.hud.worldDisplay.hexToPixelPos(t,n),o={x:i.x+r.x,y:i.y+r.y};qa.addFlash({pos:i,time:0,endTime:2,start:{pos:i,scale:{x:.25,y:.25},rot:-.1,alpha:1},end:{pos:o,scale:{x:.5,y:.5},rot:0,alpha:0},image:e.imageRef,easing:rat.ui.Animator.filterEaseOut}),qa.addFlash({pos:i,time:0,endTime:2,start:{pos:{x:i.x,y:i.y+150},scale:{x:1,y:1},rot:-.1,alpha:1},end:{pos:{x:o.x,y:o.y+150},scale:{x:2,y:2},rot:0,alpha:0},text:e.name,easing:rat.ui.Animator.filterEaseOut,draw:function(e,t){e.textAlign="center",e.textBaseline="middle",e.font="48px "+Ba.mainFont,e.fillText(t.text,0,0,300)}});qa.addFlash({pos:i,delay:0,time:0,endTime:2,start:{pos:{x:i.x+200,y:i.y-50},scale:{x:1,y:1},rot:0,alpha:1},end:{pos:{x:i.x+200+r.x,y:i.y-50+r.y},scale:{x:.5,y:.5},rot:0,alpha:0},image:gfx.getImage("menu_favorite_red"),easing:rat.ui.Animator.filterEaseOut})},fadeInWorldEffect:function(){qa.addFlash({layer:"under_ui",pos:{x:0,y:0},delay:0,time:0,endTime:1,start:{pos:{x:0,y:0},scale:{x:1,y:1},rot:0,alpha:1},end:{pos:{x:0,y:0},scale:{x:1,y:1},rot:0,alpha:0},image:null,easing:rat.ui.Animator.filterEaseOut}).draw=function(e,t){e.fillStyle="#000000";const n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT;e.fillRect(0,0,n,r)}},testWorldEffect:function(){},testEffect:function(){qa.discoverTileEffect(game.hero.pos.q+1,game.hero.pos.r,"mountains")},discoverTileEffect:function(e,t,n){if(game.hud&&game.hud.worldDisplay){var r=game.hud.worldDisplay.hexToPixelPos(e,t);qa.addBlackTileEffect(r.x,r.y);var i=qa.worldParticles.newEmitter();i.flags|=rat.particle.Emitter.fAutoDie,i.flags|=rat.particle.Emitter.fRadialStartVelocity,i.pos.x=r.x,i.pos.y=r.y,i.angle.angle=Math.random()*Math.PI*2,i.emitType=rat.particle.System.emitTypeBurst,i.renderType=rat.particle.System.RENDER_SPRITE,i.asset=qa.puffSprite,i.setupStandardBurst(5),i.startState.ageLimit=.5,i.startVariance.ageLimit=.05,i.startState.size=192,i.startVariance.size=10,i.startState.color.a=.5,i.startState.offset.x=0,i.startVariance.offset.x=40,i.startState.offset.y=0,i.startVariance.offset.y=40,i.startState.vel.x=200,i.startState.vel.y=0,i.startVariance.vel.x=0,i.startState.friction=2.5,i.startVariance.roll=5,i.initEndState(),i.endState.color.a=0,i.endState.roll=40}},discoverResourceEffect:function(e,t){if(game.hud&&game.hud.worldDisplay){var n=game.hud.worldDisplay.hexToPixelPos(e,t),r=qa.worldParticles.newEmitter();r.flags|=rat.particle.Emitter.fAutoDie,r.flags|=rat.particle.Emitter.fRadialStartVelocity,r.pos.x=n.x,r.pos.y=n.y,r.angle.angle=Math.random()*Math.PI*2,r.emitType=rat.particle.System.emitTypeBurst,r.renderType=rat.particle.System.RENDER_BOX,r.setupStandardBurst(10),r.startState.ageLimit=1.1,r.startVariance.ageLimit=.15,r.startState.size=20,r.startVariance.size=5,r.startState.color.a=1,r.startState.color.r=230,r.startState.color.g=230,r.startState.color.b=150,r.startVariance.color.r=24,r.startVariance.color.g=24,r.startVariance.color.b=30,r.startState.offset.x=0,r.startVariance.offset.x=40,r.startState.offset.y=0,r.startVariance.offset.y=40,r.startState.vel.x=350,r.startState.vel.y=0,r.startVariance.vel.x=0,r.startState.friction=2.6,r.startState.accel.y=0,r.startVariance.roll=15,r.initEndState(),r.endState.color.a=0,r.endState.roll=40}},discoverTreasureEffect:function(e,t){if(game.hud&&game.hud.worldDisplay){var n=game.hud.worldDisplay.hexToPixelPos(e,t);qa.discoverResourceEffect(e,t),qa.addGoldTileEffect(n.x,n.y)}},detectThingEffect:function(e,t){var n=game.world.hexGrid.hexWidth;qa.flashup("tile_glow",e,t,{size:n,offset:{x:0,y:-128},vel:{x:0,y:0},age:2})},builtBuildingEffect:function(e,t,n,r){if(game.hud&&game.hud.worldDisplay){var i=game.hud.worldDisplay.hexToPixelPos(t,n);o(6,180,200,.4),o(12,64,400,.3)}function o(e,t,n,r){var o=qa.worldParticles.newEmitter();o.flags|=rat.particle.Emitter.fAutoDie,o.flags|=rat.particle.Emitter.fRadialStartVelocity,o.pos.x=i.x,o.pos.y=i.y,o.angle.angle=Math.random()*Math.PI*2,o.emitType=rat.particle.System.emitTypeBurst,o.renderType=rat.particle.System.RENDER_SPRITE,o.asset=qa.puffSprite,o.setupStandardBurst(e),o.startState.ageLimit=.8,o.startVariance.ageLimit=.2,o.startState.size=t,o.startVariance.size=.3*t,o.startState.color.a=r,o.startState.offset.x=0,o.startVariance.offset.x=40,o.startState.offset.y=0,o.startVariance.offset.y=40,o.startState.vel.x=n,o.startState.vel.y=0,o.startVariance.vel.x=0,o.startState.friction=2.5,o.startVariance.roll=5,o.initEndState(),o.endState.color.a=0,o.endState.roll=40}},clashEffect:function(e,t,n){n=n||{};var r=(e.q+t.q)/2,i=(e.r+t.r)/2,o=game.hud.worldDisplay.hexToPixelPos(r,i),s=qa.worldParticles.newEmitter();s.flags|=rat.particle.Emitter.fAutoDie,s.flags|=rat.particle.Emitter.fRadialStartVelocity,s.pos.x=o.x,s.pos.y=o.y,s.angle.angle=Math.random()*Math.PI*2,s.emitType=rat.particle.System.emitTypeBurst,s.renderType=rat.particle.System.RENDER_BOX,s.setupStandardBurst(12),s.startState.ageLimit=.5,s.startVariance.ageLimit=.2,s.startState.size=14,s.startVariance.size=8,s.startState.color.a=.8,n.color?s.startState.color=n.color:(s.startState.color.r=213,s.startState.color.g=98,s.startState.color.b=101),s.startVariance.color.r=40,s.startVariance.color.g=40,s.startVariance.color.b=40,s.startState.offset.x=0,s.startState.offset.y=0,s.startVariance.offset.x=0,s.startVariance.offset.y=0,s.startState.vel.x=400,s.startState.vel.y=0,s.startVariance.vel.x=300,s.startState.friction=2.5,s.startVariance.roll=15,s.initEndState(),s.endState.color.a=0,s.endState.roll=40},monsterClashEffect:function(e,t,n){n=n||{};var r=(e.q+t.q)/2,i=(e.r+t.r)/2,o=game.hud.worldDisplay.hexToPixelPos(r,i),s=qa.worldParticles.newEmitter();s.flags|=rat.particle.Emitter.fAutoDie,s.flags|=rat.particle.Emitter.fRadialStartVelocity,s.pos.x=o.x,s.pos.y=o.y,s.angle.angle=Math.random()*Math.PI*2,s.emitType=rat.particle.System.emitTypeBurst,s.renderType=rat.particle.System.RENDER_BOX,s.setupStandardBurst(12),s.startState.ageLimit=.5,s.startVariance.ageLimit=.2,s.startState.size=14,s.startVariance.size=8,s.startState.color.a=.8,n.color?s.startState.color=n.color:(s.startState.color.r=213,s.startState.color.g=98,s.startState.color.b=101),s.startVariance.color.r=40,s.startVariance.color.g=40,s.startVariance.color.b=40,s.startState.offset.x=0,s.startState.offset.y=0,s.startVariance.offset.x=0,s.startVariance.offset.y=0,s.startState.vel.x=400,s.startState.vel.y=0,s.startVariance.vel.x=300,s.startState.friction=2.5,s.startVariance.roll=15,s.initEndState(),s.endState.color.a=0,s.endState.roll=40},shoveSlideEffect:function(e,t){if(t=t||{},game.hud&&game.hud.worldDisplay){var n=qa.worldParticles.newEmitter();n.flags|=rat.particle.Emitter.fAutoDieAfterAgeLimit,n.pos={x:0,y:0},n.customUpdate=function(t){var n=game.hud.worldDisplay.hexToPixelPos(e.displayPos);t.pos=n},n.renderType=rat.particle.System.RENDER_SPRITE,n.asset=gfx.getImage("puff_gray"),n.rate=18,n.ageLimit=t.emitterLife||.5,n.startState.ageLimit=1,n.startVariance.ageLimit=.15,n.startState.size=50,n.startVariance.size=8,n.startState.grow=-30,n.startState.color.a=.8,n.startState.offset.x=0,n.startVariance.offset.x=40,n.startState.offset.y=28,n.startState.vel.y=0,n.startVariance.vel.x=100,n.startState.friction=2.5,n.startVariance.roll=5,n.initEndState(),n.endState.color.a=0,n.endState.roll=40}},builtVictoryBuildingEffect:function(e,t,n,r,i){if(game.hud&&game.hud.worldDisplay){var o=game.hud.worldDisplay.hexToPixelPos(t,n),s=qa.worldParticles.newEmitter();s.pos.x=o.x,s.pos.y=o.y,s.renderType=rat.particle.System.RENDER_DOT,s.rate=8,s.ageLimit=5,s.startState.ageLimit=.6,s.startVariance.ageLimit=.15,s.startState.size=28,s.startVariance.size=3,s.startState.grow=-30,s.startState.color.a=1,s.startState.color.r=230,s.startState.color.g=230,s.startState.color.b=150,s.startVariance.color.r=24,s.startVariance.color.g=24,s.startVariance.color.b=30,s.startState.offset.x=0,s.startVariance.offset.x=50,s.startState.offset.y=0,s.startVariance.offset.y=50,s.startState.vel.y=-140,s.startVariance.vel.x=0,s.startState.friction=2.5,s.startVariance.roll=15,s.initEndState(),s.endState.color.a=0,s.endState.roll=40}},testWorldEffect2:function(){var e=game.hud.worldDisplay.hexToPixelPos(game.hero.pos.q,game.hero.pos.r),t=qa.worldParticles.newEmitter();t.flags|=rat.particle.Emitter.fAutoDie,t.flags|=rat.particle.Emitter.fRadialStartVelocity,t.pos.x=e.x,t.pos.y=e.y,t.angle.angle=Math.random()*Math.PI*2,t.emitType=rat.particle.System.emitTypeBurst,t.renderType=rat.particle.System.RENDER_BOX,t.setupStandardBurst(20),t.startState.ageLimit=.5,t.startVariance.ageLimit=.25,t.startState.size=5,t.startVariance.size=1,t.startState.color.r=230,t.startState.color.g=230,t.startState.color.b=150,t.startVariance.color.r=24,t.startVariance.color.g=24,t.startVariance.color.b=30,t.startState.vel.x=0,t.startState.vel.y=0,t.startVariance.vel.x=1200,t.startVariance.vel.y=1200,t.startState.friction=2.5,t.startVariance.roll=5,t.initEndState(),t.endState.color.a=0,t.endState.roll=40},updateFlashes:function(e){for(var t=this.flashes.length-1;t>=0;t--){var n=this.flashes[t];if(n.delay&&n.delay>0)n.delay-=e;else if(n.time+=e,n.time>n.endTime)n.endCallback&&n.endCallback(n),this.flashes.splice(t,1);else{var r=n.time/n.endTime;n.easing&&(r=n.easing(r)),n.pos.x=rat.math.interpolate(n.start.pos.x,n.end.pos.x,r),n.pos.y=rat.math.interpolate(n.start.pos.y,n.end.pos.y,r),n.start.scale&&n.end.scale&&(n.scale.x=rat.math.interpolate(n.start.scale.x,n.end.scale.x,r),n.scale.y=rat.math.interpolate(n.start.scale.y,n.end.scale.y,r)),void 0!==n.start.rot&&void 0!==n.end.rot&&(n.rot=rat.math.interpolate(n.start.rot,n.end.rot,r)),void 0!==n.start.alpha&&void 0!==n.end.alpha&&(n.alpha=rat.math.interpolate(n.start.alpha,n.end.alpha,r))}}},addFlash:function(e,t){return!1===e.pos?null:(e.layer=t||e.layer||"world",e.start||(e.start={}),e.end||(e.end={}),e.start.pos&&(e.pos={x:e.start.pos.x,y:e.start.pos.y}),void 0!==e.start.scale&&(e.scale=e.start.scale),e.scale||(e.scale={x:1,y:1}),e.start.pos||(e.start.pos={x:e.pos.x,y:e.pos.y}),e.end.pos||(e.end.pos={x:e.start.pos.x,y:e.start.pos.y}),e.delay||(e.delay=0),e.time||(e.time=0),e.endTime||(e.endTime=10),e.start.rot&&(e.rot=e.start.rot),e.rot||(e.rot=0),void 0===e.start.rot&&(e.start.rot=e.rot),void 0===e.end.rot&&(e.end.rot=e.rot),this.flashes.push(e),e)},drawFlashes:function(e,t){for(var n=0;n<this.flashes.length;n++){var r=this.flashes[n];r.layer===t&&(r.delay&&r.delay>0||(e.save(),e.translate(r.pos.x,r.pos.y),r.scale&&e.scale(r.scale.x,r.scale.y),r.rot&&e.rotate(r.rot),void 0!==r.alpha&&(e.globalAlpha=r.alpha),r.draw?r.draw(e,r):r.image&&r.image.draw(e),e.restore()))}}};window.effects=qa;const Va=rat.spaces.HexGrid,Wa={plugins:{postStage:{},preStage:{}},init:function(e,t,n){this.rng=n.rng;var r=n.rng.getSeed();for(var i in r|=0,n.rng.setSeed(r),this.startSeed=r,console.log("--- hexwg.init with seed "+r),this.terrainTypes=rat.utils.deepCopy(app.World.terrainTypes),this.passableTerrainTypes={},this.terrainTypes)this.terrainTypes[i].heroPassable&&(this.passableTerrainTypes[i]=this.terrainTypes[i]);this.WORLD_W=t.WORLD_W,this.WORLD_H=t.WORLD_H,this.TILE_SIDE_PIXELS=e.TILE_SIDE_PIXELS,this.V_SCALE=e.V_SCALE,this.gameConfig=t,this.landConfig=n,this.stage="fill",this.fillDone=!1,this.done=!1,this.valid=!0,this.updateCount=0,this.objectLayerData=null,this.showGeneration="gen"===app.settings.debug.skipTo,this.debugGeneration=app.settings.debug.generation||app.settings.debug.show.generation},log:function(e){(this.showGeneration||this.debugGeneration)&&console.log(e)},addPlugin:function(e,t,n){var r=this.plugins[e];r[t]||(r[t]=[]),r[t].push(n)},initWorld:function(){this.world=new app.World(this.WORLD_W,this.WORLD_H,this.TILE_SIDE_PIXELS,this.V_SCALE),this.hexGrid=this.world.hexGrid,this.world.makeMasterHexLists()},buildWorld:function(){this.log("buildWorld..."),this.initWorld();var e={dots:[],done:!1,seedPoints:[]};this.islands=[],this.islands.push(e),this.landConfig.map?this.startLoadMap(e,this.landConfig.map):"thumb"===this.landConfig.style?this.startThumb(e):this.startBlobIsland(e),this.showGeneration&&this.updateIntermediateDraw()},startBlobIsland:function(e){var t={q:Math.floor(this.WORLD_W/3),r:Math.floor(this.WORLD_H/2)};this.addToIsland(e,t,"plains",1),e.seedPoints.push(t)},startLoadMap:function(e,t){var n=this;n.stage="loadMap",rat.utils.loadJSONObjectAsync(t,(function(r,i){r&&i&&(console.log("loaded map."),n.log("loaded map "+t),n.processLoadMap(i,e))}))},processLoadMap:function(e,t){var n=this,r=rat.data.tiledUtils.getNamedLayerIndex(e,"land");if(r<0)rat.console.log("ERROR loading map "+n.landConfig.map);else{var i=e.hexsidelength;e.firstResGID=0;for(var o=e.tilesets,s=0;s<o.length;s++)"mc_resources"===o[s].name&&(e.firstResGID=o[s].firstgid);var a=["ocean","ocean","ocean","ocean","water","plains","forest","desert","hills","mountains"];n.hexGrid.loadLayersFromData(e,(function(e){var i=e.layerData[r];if(void 0!==i){var o=a[i];if("ocean"!==o){var s={q:e.q,r:e.r};n.addToIsland(t,s,o),t.seedPoints.length<=0&&n.passableTerrainTypes[o]&&t.seedPoints.push(s)}}}),null);a=["misc","science","money","food","production","war"];var l=rat.data.tiledUtils.getNamedLayerIndex(e,"resources");if(l>-1){n.objectLayerData=e.layers[l];var c=n.objectLayerData.objects;for(s=0;s<c.length;s++){var u=c[s],h=u.x+24,d=u.y-24,p=Math.floor(d/(i+i/2)),g=Math.floor(p%2)*e.tilewidth/2,m=Math.floor((h-g)/e.tilewidth-Math.floor(p/2));u.q=m,u.r=p,u.objectType=a[u.gid-e.firstResGID],"misc"===u.objectType&&"spawn"===u.type&&(u.spawnPlayerIndex=parseInt(u.player),void 0===n.landConfig.forcedStarts&&(n.landConfig.forcedStarts=[]),n.landConfig.forcedStarts.push(u))}}n.log("done processing load map"),n.showGeneration&&n.world.renderOffWorld(!0),n.stage="fill",n.landConfig.landFullyDefined&&(t.done=!0,n.fillDone=!0,this.checkAndAdvanceStage("cleanup"))}},startThumb:function(e){this.stage="loadThumb";var t=["res/maps/mapthumbs/thumb_small_hex.png","res/maps/mapthumbs/thumb_small_star.png","res/maps/mapthumbs/thumb_small_spray.png","res/maps/mapthumbs/thumb_small_barbell.png","res/maps/mapthumbs/thumb_small_cross.png","res/maps/mapthumbs/thumb_small_hex2.png","res/maps/mapthumbs/thumb_small_rattle.png","res/maps/mapthumbs/thumb_small_tri.png","res/maps/mapthumbs/thumb_small_oval.png","res/maps/mapthumbs/thumb_small_jester.png"],n=rat.utils.randomInList(t,void 0,this.rng);this.log("loading thumb: "+n),this.thumb={imageSrc:n};var r=new Image;this.thumb.image=r;var i=this;r.onload=function(){i.log("loaded thumb"),i.processThumb(e,r)},r.src=this.thumb.imageSrc},processThumb:function(e,t){this.log("processing thumb");var n=document.createElement("canvas");n.width=t.width,n.height=t.height;const r=n.getContext("2d");r.drawImage(t,0,0);var i=r.getImageData(0,0,t.width,t.height).data;var o=(this.gameConfig.WORLD_W-4)/t.width;this.log("thumbScale "+o);var s=this.randomTerrainType(!0),a=1,l=Math.floor(6*this.rng.random()),c=Math.floor(3*this.rng.random());function u(e,t){var r,i;return 0===l?e=n.width-e:1===l?t=n.height-t:2===l&&(e=n.width-e,t=n.height-t),0===c?(r=n.width-t,i=e):1===c?(r=t,i=n.height-e):(r=e,i=t),{x:r,y:i}}for(var h=0;h<n.height;h++)for(var d=0;d<n.width;d++){var p=4*(h*n.width+d),g=u(d,h),m=i[p+0],f=i[p+1],v=i[p+2];if(i[p+3],m>32||f>32||v>32){var y=(2+g.x*o)*this.hexGrid.hexWidth,w=(2+g.y*o)*(this.hexGrid.hexHeight/2+this.TILE_SIDE_PIXELS/2*this.hexGrid.vScale),C=this.hexGrid.pixelPosToHex(y,w);if(this.world.hexGrid.inBounds(C.q,C.r)){var S=!1;f>200&&v>200&&(S=!0);var b=this.addToIsland(e,C,s,a,S);S&&"mountains"===b.terrainType&&this.log("WHOAH>>>"),s=b.terrainType,a=b.keepVal,S&&e.seedPoints.push(C)}}}this.log("done processing thumb"),this.showGeneration&&this.updateIntermediateDraw(),this.stage="fill"},startLineIsland:function(e){var t={q:10,r:5},n=this.addLine(e,t,Va.direction.downRight,this.WORLD_H-5);e.seedPoints.push(t),e.seedPoints.push(n),this.terrainTypes.mountains.weight*=1.5},startXIsland:function(e){var t=this.WORLD_H-10,n={q:8,r:5},r=this.addLine(e,n,Va.direction.downRight,t);this.addLine(e,{q:7,r:5},Va.direction.left,3),this.addLine(e,r,Va.direction.right,3),e.seedPoints.push(n),e.seedPoints.push(r);n={q:-4,r:this.WORLD_H-5},r=this.addLine(e,n,Va.direction.upRight,t);this.addLine(e,{q:-5,r:this.WORLD_H-5},Va.direction.left,3),this.addLine(e,r,Va.direction.right,3),e.seedPoints.push(n),e.seedPoints.push(r),this.terrainTypes.mountains.weight*=2},addLine:function(e,t,n,r){for(var i="plains",o=1,s=t.q,a=t.r,l=0;l<r;l++){var c={q:s,r:a},u=this.addToIsland(e,c,i,o,!0);if(i=u.terrainType,o=u.keepVal,l<r){var h=Va.neighbors[n];s+=h.delta.q,a+=h.delta.r}}return{q:s,r:a}},randomTerrainType:function(e){var t;t=e?this.passableTerrainTypes:this.terrainTypes;var n=0;for(var r in t)n+=t[r].weight;var i=this.rng.random()*n,o=0;for(var r in t)if((o+=t[r].weight)>=i)return r;return"plains"},addToIsland:function(e,t,n,r,i){n||(n="plains");var o=!1;void 0===r&&(r=1),r>=1&&(o=!0),void 0===i&&(i=!1),e.dots.push(t);var s,a=this.terrainTypes[n];o||this.rng.random()<a.keepProb*r?(s=n,r-=.5):(s=this.randomTerrainType(i),r=1);var l=this.terrainTypes[s];i&&!l.heroPassable&&(s=this.randomTerrainType(i)),this.hexGrid.getValueAt(t.q,t.r);var c={terrainType:s,keepVal:r};return this.hexGrid.setValueAt(t.q,t.r,c),this.hexGrid.setDebugStyleAt(t.q,t.r,l.style),c},setTerrainType:function(e,t){var n=this.terrainTypes[t];e.entry.value.terrainType=t,this.hexGrid.setDebugStyleAt(e.q,e.r,n.style)},updateIsland:function(e){var t=!1;do{var n=Math.floor(this.rng.random()*e.dots.length),r=e.dots[n],i=this.hexGrid.getValueAt(r.q,r.r),o=this.hexGrid.getNeighbors(r.q,r.r);if(o.length<=0)break;rat.utils.randomizeList(o,this.rng);for(var s=null,a=0;a<o.length;a++){var l=o[a].q,c=o[a].r,u=this.hexGrid.getValueAt(l,c);u&&u.terrainType||(this.hexGrid.isEdgeHex(l,c,1)||(s={q:l,r:c,val:u}))}if(s){t=!0,this.addToIsland(e,{q:s.q,r:s.r},i.terrainType,i.keepVal);break}}while(!t);e.dots.length>this.landConfig.targetTileCount&&(this.log("island generation done with "+e.dots.length+" tiles"),e.done=!0,this.fillDone=!0)},forcePassablePath:function(e,t){var n="main";this.forceSinglePassable(e.q,e.r),this.forceSinglePassable(t.q,t.r);var r=Va.fullBlocking,i=Va.noBlocking,o=this.world;this.world.hexGrid.forEachHex((function(e){e.value&&o.terrainPassable(e.value.terrainType)?e.entry.blocking[n]=i:e.entry.blocking[n]=r}));var s={start:e,end:t,findClosest:!0};if(o.hexGrid.findPath(s),!s.valid){this.log("path problem! "+e.q+","+e.r+" -> "+t.q+","+t.r);var a={q:s.closest.pos.q,r:s.closest.pos.r};s={start:t,end:e,findClosest:!0};o.hexGrid.findPath(s);for(var l={q:s.closest.pos.q,r:s.closest.pos.r};a.q!==l.q||a.r!==l.r;){var c=99999,u={};o.hexGrid.forEachNeighbor(a.q,a.r,(function(e){var t=Va.distance(l.q,l.r,e.q,e.r);t<c&&(c=t,u.q=e.q,u.r=e.r)}),null,!1,!1,1),this.forceSinglePassable(u.q,u.r),a.q=u.q,a.r=u.r}}},forceSinglePassable:function(e,t){var n=this.hexGrid.getValueAt(e,t);if(!n||!this.world.terrainPassable(n.terrainType)){var r="plains",i=this.terrainTypes[r],o={terrainType:r,keepVal:.1};this.hexGrid.setValueAt(e,t,o),this.hexGrid.setDebugStyleAt(e,t,i.style)}},floodCheckPassable:function(e){var t=this,n=Va.fullBlocking,r=Va.noBlocking,i=e.seedPoints[0],o="main",s=0;return this.hexGrid.forEachHex((function(e){var i=e.value;i&&t.world.terrainPassable(i.terrainType)&&!i.startPointCreature?(e.entry.blocking[o]=r,s++):e.entry.blocking[o]=n})),e.passableCount=s,this.hexGrid.floodFill(i.q,i.r,null,(function(e){e.value.reachable=!0,t.hexGrid.forEachNeighbor(e.q,e.r,(function(e){e.value.touchable=!0}),null,!1,!1,1)}))===s},fixPassable:function(e){var t=this,n=this.world;Va.fullBlocking;var r=Va.noBlocking,i=e.seedPoints[0],o="main",s=this.hexGrid.getValueAt(i.q,i.r);s&&n.terrainPassable(s.terrainType)||(this.log("!!! Had to fix seed point type "+(s?s.terrainType:"none")),this.addToIsland(e,i,"plains",.5,!0));var a=!1,l=0;do{if(l++,this.log("fix passable, pass "+l),a=!1,!this.floodCheckPassable(e)){this.log("problem with passability");var c=null;if(this.hexGrid.forEachHex((function(e){var t=e.value;t&&"ocean"!==t.terrainType?"mountains"===t.terrainType?e.entry.blocking[o]=13:"water"===t.terrainType?e.entry.blocking[o]=6:(e.entry.blocking[o]=r,t.reachable||c||(c={q:e.q,r:e.r})):e.entry.blocking[o]=4})),!c)return void console.log("!!!!!!!! ERROR in fixPassable: didn't find the problem tile");var u={start:i,end:c};if(this.hexGrid.findPath(u),!u.valid||!u.done)return void console.log("!!!!!!!! ERROR in fixPassable: path");this.log("fixing path from "+i.q+","+i.r+" -> "+c.q+","+c.r);for(var h=0;h<u.path.length;h++){var d=u.path[h],p=this.hexGrid.getValueAt(d.q,d.r);p&&n.terrainPassable(p.terrainType)||(this.log("replacing "+(p?p.terrainType:"ocean")),this.addToIsland(e,d,"plains",.5,!0))}a=!0}}while(a);(this.showGeneration||this.debugGeneration)&&this.hexGrid.forEachHex((function(e){var n=e.value;"ocean"===n.terrainType||n.touchable||t.log("untouchable tile : "+e.q+", "+e.r)}))},removeWalls:function(e){var t=this,n=this.world;Va.fullBlocking;var r=Va.noBlocking,i="main",o=[],s=[];this.hexGrid.forEachHex((function(e){var t=e.value;t&&"ocean"===t.terrainType?(e.entry.blocking[i]=r,o.push(rat.utils.copyObject(e,!1))):n.terrainPassable(t.terrainType)?e.entry.blocking[i]=1:(s.push(rat.utils.copyObject(e,!1)),e.entry.blocking[i]=2)}));for(var a=0,l=0;l<o.length;l++){if(void 0===(d=o[l]).value.oceanIndex){var c=[],u=this.hexGrid.floodFill(d.q,d.r,null,(function(e){e.value.oceanIndex=a,c.push(rat.utils.copyObject(e,!1))}));if(t.log("ocean "+a+" has "+u+" tiles."),u<10)for(var h=0;h<c.length;h++)t.setTerrainType(c[h],"water");a++}}for(l=0;l<s.length;l++){var d=s[l],p=-1;if(this.hexGrid.forEachNeighbor(d.q,d.r,(function(e){"ocean"===e.value.terrainType&&(p=e.value.oceanIndex)}),null,!1,!1,1),p>-1){"water"===d.value.terrainType&&t.setTerrainType(d,"mountains");u=this.hexGrid.floodFill(d.q,d.r,null,(function(e){var n=!1;if(t.hexGrid.forEachNeighbor(e.q,e.r,(function(e){e.value.oceanIndex&&e.value.oceanIndex!==p&&(n=!0)}),null,!1,!1,1),n){var r=t.randomTerrainType(!0);t.setTerrainType(e,r)}}))}}},cleanUpWater:function(e){},fillOcean:function(){this.world.fillOcean()},finishIsland:function(e){var t=[],n=this;this.hexGrid.forEachHex((function(e){e.value&&"ocean"!==e.value.terrainType&&t.push({q:e.q,r:e.r,value:e.value});var r=e.value;r.fog=[],r.aiData=[];for(var i=0;i<n.gameConfig.civCount;i++)r.fog[i]=1,r.aiData[i]={};(app.config.aiTest||app.settings.debug.revealAll||n.showGeneration)&&(r.fog[0]=0),app.config.debugCivReveal&&void 0!==app.config.debugCiv&&(r.fog[app.config.debugCiv]=0)})),this.cleanUpWater(t),this.placeBonuses(e,t);for(var r=0;r<6&&!this.findStartPoints(e);r++)this.log("bad start points pass "+r);if(r>=6)return this.valid=!1,void(this.invalidInfo={reason:"couldn't find enough good starting points"});this.gameConfig.hasCreatures&&this.findCreatureStartPoints(e),this.gameConfig.hasPets&&this.placePets(e,t),this.gameConfig.treasureMax&&this.placeTreasure(e,t),this.world.landTileCount=e.dots.length,this.log("island cleanup done"),this.log("  "+this.world.landTileCount+" total world tiles.")},revealStarts:function(){for(var e=0;e<this.gameConfig.civCount;e++)this.world.removeFogFrom(this.world.startPoints[e].q,this.world.startPoints[e].r,e,!0,.04),this.showGeneration&&(this.world.hexGrid.getValueAt(this.world.startPoints[e].q,this.world.startPoints[e].r).startPointCiv=e)},placeBonusesFromFileData:function(e){for(var t={},n=e.objects,r=0;r<n.length;r++){var i=n[r],o=i.objectType,s=this.hexGrid.getValueAt(i.q,i.r),a=s.terrainType,l=app.World.terrainTypes[a];if(l&&l.bonuses)for(var c=0;c<l.bonuses.length;c++){var u=l.bonuses[c];if(u.extra===o){s.bonus={regenCounter:0,bonusEntry:u},t[u.name]=(t[u.name]||0)+1;break}}}return t},placeBonuses:function(e,t){rat.utils.randomizeList(t,this.rng);var n={};this.objectLayerData&&(n=this.placeBonusesFromFileData(this.objectLayerData),console.log("loaded startCounts:"),console.log(n));var r=[];for(var i in app.World.terrainTypes){var o=app.World.terrainTypes[i];if(r[i]={},o.bonuses)for(var s=0;s<o.bonuses.length;s++){var a=o.bonuses[s];r[i][a.extra]=a}}for(var l=[],c=this.landConfig.bonusTargets,u=0;u<c.length;u++){var h=c[u],d=h.name,p=h.percent*e.dots.length/100|0;l.push({name:d,count:p}),this.log("target "+d+" : "+p)}for(s=0;s<l.length;s++)for(var g=l[s],m=0;m<g.count;m++)for(var f=Math.floor(this.rng.random()*t.length),v=0;v<t.length;v++){var y=t[(v+f)%t.length];if(!y.value.bonus)if(a=r[y.value.terrainType][g.name])if(y.value.touchable||y.value.reachable){var w=!1,C=this;if(this.hexGrid.forEachNeighbor(y.q,y.r,(function(e){C.countBonusesNear(e.q,e.r,1)>=3&&(w=!0)}),null,!0,!1,1),!w){y.value.bonus={regenCounter:0,bonusEntry:a};break}this.log("skipped "+y.q+","+y.r+" for too many res")}else this.log("skipped "+y.q+","+y.r+" for untouchable/unreachable")}},countBonusesNear:function(e,t,n,r){r||(r="all");var i=0;return this.hexGrid.forEachNeighbor(e,t,(function(e){!e.value.bonus||"all"!==r&&r!==e.value.bonus.bonusEntry.extra||i++}),null,!1,!1,n),i},placePets:function(e,t){var n=this.rng.random(),r=this.rng.random(),i=app.cards.getFavorites();if(!(i.length<1))for(var o=i[n*i.length|0],s=Math.floor(r*t.length),a=0;a<t.length;a++){var l=t[(a+s)%t.length];if(app.World.terrainTypes[l.value.terrainType].heroPassable&&!l.value.bonus&&(!this.nearKeyPoint(this.world.startPoints,l.q,l.r,5)&&!this.nearKeyPoint(this.world.creatureStartPoints,l.q,l.r,2))){l.value.pet={cardID:o};break}}},placeTreasure:function(e,t){rat.utils.randomizeList(t,this.rng);var n=["money","food","science","production"];this.gameConfig.hasWar&&n.push("war");for(var r=[],i=this.gameConfig.treasureMin+Math.floor(this.rng.random()*(this.gameConfig.treasureMax-this.gameConfig.treasureMin+1)),o=0;o<i;o++)for(var s=Math.floor(this.rng.random()*t.length),a=0;a<t.length;a++){var l=t[(a+s)%t.length];if(app.World.terrainTypes[l.value.terrainType].heroPassable&&!l.value.bonus&&!l.value.pet){for(var c=!1,u=0;u<r.length;u++){if(Va.distance(l.q,l.r,r[u].q,r[u].r)<4){c=!0;break}}if(!c&&!this.nearKeyPoint(this.world.startPoints,l.q,l.r,5)&&!this.nearKeyPoint(this.world.creatureStartPoints,l.q,l.r,3)){l.value.treasure={type:rat.utils.randomInList(n,void 0,this.rng),count:4},r.push({q:l.q,r:l.r});break}}}},nearKeyPoint:function(e,t,n,r){if(!e)return!1;for(var i=0;i<e.length;i++){var o=e[i];if(Va.distance(o.q,o.r,t,n)<r)return!0}return!1},distToKeyPoint:function(e,t,n){var r=9999999;if(!e)return 0;for(var i=0;i<e.length;i++){var o=e[i],s=Va.distance(o.q,o.r,t,n);s<r&&(r=s)}return r},findStartPoints:function(e){rat.utils.randomizeList(e.dots,this.rng),this.world.startPoints=[];for(var t=0;t<e.dots.length;t++){var n=e.dots[t];delete(u=this.hexGrid.getValueAt(n.q,n.r)).possibleStartPoint}var r=0;if(this.landConfig.forcedStarts)for(var i=0;i<this.landConfig.forcedStarts.length;i++){var o=this.landConfig.forcedStarts[i];this.world.startPoints[r]={q:o.q,r:o.r,resourceValue:20-o.spawnPlayerIndex,forcedPlayerIndex:o.spawnPlayerIndex},r++}var s=6*this.landConfig.linearSizeScaleFactor|0;s+=[0,3,2,1,0,0,-1,-2][this.gameConfig.civCount],this.log("sizescale factor "+this.landConfig.linearSizeScaleFactor),this.log("nearOtherStartThresh "+s);for(var a=2*this.gameConfig.civCount;r<a;r++){var l=!1,c=Math.floor(this.rng.random()*e.dots.length);for(t=0;t<e.dots.length;t++){var u,h=(t+c)%e.dots.length;n=e.dots[h];if("mountains"!==(u=this.hexGrid.getValueAt(n.q,n.r)).terrainType&&"water"!==u.terrainType&&!u.bonus&&!this.nearKeyPoint(this.world.startPoints,n.q,n.r,s)){var d=this.measureNearResources(n);if(d){var p=d.resourceValue;if(!(p<2.2||p>6.5)){this.world.startPoints[r]={q:n.q,r:n.r,resourceValue:p,spotValue:d},l=!0,u.possibleStartPoint=1;break}}}}if(!l){this.log("Warning:  Could not find start point #"+r);break}}var g=this.world.startPoints.length;if(g<this.gameConfig.civCount)return this.log("ERROR:  Found only "+g+" start points, needed "+this.gameConfig.civCount),!1;if(this.world.startPoints.sort((function(e,t){return t.resourceValue-e.resourceValue})),this.showGeneration||this.debugGeneration)for(i=0;i<this.world.startPoints.length;i++){var m=this.world.startPoints[i];console.log("spot @"+m.q+","+m.r),console.log(m.spotValue.debugText)}var f=this.world.startPoints[0];for(i=1;i<this.world.startPoints.length;i++){(m=this.world.startPoints[i]).startDist=Va.distance(f.q,f.r,m.q,m.r)}f.startDist=9999,this.world.startPoints.sort((function(e,t){return t.startDist-e.startDist})),this.world.startPoints.splice(this.gameConfig.civCount,g-this.gameConfig.civCount);for(i=0;i<this.world.startPoints.length;i++){m=this.world.startPoints[i];this.log(i+": "+m.resourceValue)}return!0},measureNearResources:function(e,t){var n="",r=[{type:"food",weight:.4,minDist:10,bestDist:99999,totalNear:0},{type:"money",weight:1.2,minDist:9,bestDist:99999,totalNear:0},{type:"production",weight:1.2,minDist:9,bestDist:99999,totalNear:0},{type:"science",weight:.5,minDist:3,bestDist:99999,totalNear:0}];this.gameConfig.hasWar&&r.push({type:"war",weight:.4,minDist:20,bestDist:99999,totalNear:0});var i=0;this.hexGrid.forEachHex((function(t){if(t.value.bonus)for(var n=t.value.bonus.bonusEntry.extra,i=0;i<r.length;i++){var o=r[i];if(n===o.type){var s=Va.distance(e.q,e.r,t.q,t.r);s<o.bestDist&&(o.bestDist=s),s<=5&&o.totalNear++}}}));for(var o=0,s=0,a=0;a<r.length;a++){var l=r[a];if(l.type===this.rareResourceType&&(l.weight*=1.1),s+=l.totalNear,l.bestDist<=1)return null;if(l.bestDist>l.minDist)return null;if(this.landConfig.requireScienceStart&&"science"===l.type&&2!==l.bestDist)return null;l.bestDist<=2&&o++;var c=3/Math.pow(l.bestDist,1.15);c>1.5&&(c=1.5);var u=c*l.weight;n+="    "+l.type+": "+(10*u|0)/10+" (dist "+l.bestDist+")\n",i+=u}if(o<1)return null;var h=o/12;i+=h,n+="    withinSight: "+(10*h|0)/10+" (count "+o+")\n";const d=s/12;return{resourceValue:i+=d,debugText:n="total: "+i+"\n"+(n+="    generalNearby: "+(10*d|0)/10+" (count "+s+")\n")}},findCreatureStartPoints:function(e){this.log("creature placement start"),rat.utils.randomizeList(e.dots,this.rng),this.world.creatureStartPoints=[];for(var t=0;t<15;t++){for(var n=!1,r=Math.floor(this.rng.random()*e.dots.length),i=0;i<e.dots.length;i++){var o=(i+r)%e.dots.length,s=e.dots[o],a=this.hexGrid.getValueAt(s.q,s.r);if(app.World.terrainTypes[a.terrainType].heroPassable&&!a.bonus&&(!this.nearKeyPoint(this.world.startPoints,s.q,s.r,4)&&!this.nearKeyPoint(this.world.creatureStartPoints,s.q,s.r,3))){if(a.startPointCreature=t+1,this.floodCheckPassable(e)){this.world.creatureStartPoints[t]={q:s.q,r:s.r},n=!0;break}a.startPointCreature=void 0}}if(!n)return void this.log("problem finding creature start point")}this.log("creature placement done")},pickTileVariants:function(){var e=this;this.hexGrid.forEachHex((function(t){t.value.tileVariant=12*e.rng.random()|0}))},normalizeWorld:function(){},checkAndAdvanceStage:function(e){var t=this.stage;const n=this.plugins.postStage[t];if(n)for(let e=0;e<n.length;e++){n[e].run({worldGen:this})}if(this.stage=e,this.log("> new stage "+e),this.showGeneration&&this.updateIntermediateDraw(),!this.valid){var r="";return this.invalidInfo&&this.invalidInfo.reason&&(r=": "+this.invalidInfo.reason),console.log("-------------------- RESTART worldgen"+r),app.worldGen.init(app.config.world,this.gameConfig,this.landConfig),void app.worldGen.buildWorld()}},update:function(e){if(this.updateCount++,this.done||"invalid"===this.stage||this.log("WG update "+this.updateCount),"loadThumb"!==this.stage){if("fill"===this.stage){var t=!1,n=240;this.showGeneration&&(n=125);for(var r=0;r<this.islands.length;r++)if(!this.islands[r].done){t=!0;for(var i=0;i<n&&!this.islands[r].done;i++)this.updateIsland(this.islands[r])}return t&&this.showGeneration&&this.updateIntermediateDraw(),void(this.fillDone&&this.checkAndAdvanceStage("cleanup"))}if("cleanup"!==this.stage){if("finish"===this.stage){for(r=0;r<this.islands.length;r++)this.finishIsland(this.islands[r]);return this.world.resetMainBlocking(),void this.checkAndAdvanceStage("reveal")}if("reveal"===this.stage)return this.revealStarts(),void this.checkAndAdvanceStage("finalize");"finalize"===this.stage&&(this.normalized||(this.normalizeWorld(),this.normalized=!0),this.pickTileVariants(),this.world.finalize(),this.checkAndAdvanceStage("postgenerate")),"postgenerate"===this.stage&&(this.stage="done",this.done=!0,this.log("full world generation complete."),this.showGeneration&&this.log(" - since skipTo is set to 'gen', we're done and will hang here.")),"invalid"===this.stage&&this.showGeneration&&(this.stage="done",this.done=!0,this.log("!!! Invalid map, but we're holding here to see it."))}else{if(this.fillOcean(),this.landConfig.landFullyDefined)for(r=0;r<this.islands.length;r++)this.floodCheckPassable(this.islands[r]);else{for(var r=0;r<this.islands.length;r++)this.fixPassable(this.islands[r]);this.removeWalls()}this.checkAndAdvanceStage("finish")}}},drawWorld:function(e){(e=e).fillStyle="#101030",e.fillRect(0,0,rat.graphics.SCREEN_WIDTH,rat.graphics.SCREEN_HEIGHT);var t=this.world.getPixelSpace();t.w-=t.gutter.left+t.gutter.right,t.h-=t.gutter.top+t.gutter.bottom;var n=rat.graphics.SCREEN_WIDTH/t.w,r=rat.graphics.SCREEN_HEIGHT/t.h;n=1.095*Math.min(n,r),e.save(),e.scale(n,n),e.translate(-t.gutter.left,96-t.gutter.top),this.world.renderWorldView(e,{left:0,top:0,right:t.w,bottom:t.h}),e.restore()},updateIntermediateDraw:function(){this.hexGrid.forEachHex((function(e){var t=e.value;t&&(t.fog?t.fog[0]:t.fog=[0])})),this.world.finalize()}},Ga={lakeNames:[{name:"Steve"},{name:"Abbey"},{name:"Woody"},{name:"Justin"},{name:"Derek"},{name:"Puf"},{name:"Jared"},{name:"Jeremy"},{name:"Brent"},{name:"John"}]};Ga.run=function(e){console.log("namedRegions run");const t=e.worldGen,n=Ga,r=n.lakeNames;for(let e=0;e<r.length;e++){r[e].used=!1}n.rng=new rat.math.rng.Simple,n.rng.setSeed(t.startSeed),console.log("nr seed "+t.startSeed);var i=0;const o="main",s=rat.spaces.HexGrid,a=s.fullBlocking,l=s.noBlocking;t.hexGrid.forEachHex((function(e){var t=e.value;t&&"water"===t.terrainType?e.entry.blocking[o]=l:(e.entry.blocking[o]=a,i++)})),console.log("total lake water on this map : "+i),t.hexGrid.forEachHex((function(e){if(e.value&&"water"===e.value.terrainType&&!e.value.name){const i=function(){var e=n.rng.random()*r.length|0;for(let t=0;t<r.length;t++){const n=(e+t)%r.length,i=r[n];if(!i.used)return i.used=!0,i.id=n,i}return r[e]}();t.hexGrid.floodFill(e.q,e.r,null,(function(e){e.value.name={id:i.id,t:"l",displayName:"Lake "+i.name}}))}}))},Ga.serializeName=function(e){var t=e.name;return{id:t.id,t:t.type}},Ga.deserializeName=function(e){var t=Ga.lakeNames[e.id];return{id:e.id,type:e.t,displayName:"Lake "+t.name}},Wa.addPlugin("postStage","finalize",{run:Ga.run});const Ua=function(e,t,n,r){for(var i in this.WORLD_W=e,this.WORLD_H=t,this.TILE_SIDE_PIXELS=n,this.hexGrid=new rat.spaces.HexGrid({colCount:this.WORLD_W,rowCount:this.WORLD_H,sideSize:this.TILE_SIDE_PIXELS,vScale:r}),this.usedHexList=[],this.allHexList=[],Ua.terrainTypes){var o=Ua.terrainTypes[i];if(o.images=[],o.imageSrc)o.images[0]=new rat.graphics.ImageRef(o.imageSrc);else if(o.imageSources)for(var s=0;s<o.imageSources.length;s++)o.images[s]=new rat.graphics.ImageRef(o.imageSources[s].src)}this.fogTile=new rat.graphics.ImageRef("res/images/tiles/tile_fog.png");var a=app.settings.display.zoomScaleMin||.8;const l=7*this.TILE_SIDE_PIXELS/a;this.pixelOffset={x:l,y:3*this.TILE_SIDE_PIXELS};const c=1.5*this.TILE_SIDE_PIXELS/a;this.bottomRightGutter={x:0,y:c}};for(var ja in Ua.resourceTypes={science:{name:"science",style:"#00b6aa",partialStyle:"#ffffff",darkStyle:"#ffffff",tipText:"science",displayIndex:0,colorCode:"§"},money:{name:"gold",style:"#f1d37b",partialStyle:"#ffffff",darkStyle:"#ffffff",tipText:"gold",displayIndex:1,colorCode:"$"},food:{name:"food",style:"#82d73e",partialStyle:"#ffffff",darkStyle:"#ffffff",tipText:"food",displayIndex:2,colorCode:"£"},production:{name:"production",style:"#b383b7",partialStyle:"#3e2740",darkStyle:"#251726",tipText:"production resources",displayIndex:3,colorCode:"¶"},war:{name:"war",style:"#d56265",partialStyle:"#672527",darkStyle:"#260e0e",tipText:"war resources",displayIndex:4,colorCode:"¥"}},Ua.resourceTypeCount=0,Ua.resourceTypes){var Ka=Ua.resourceTypes[ja];Ka.id=ja;var Ya=new rat.graphics.Color(Ka.style),Xa=rat.graphics.Color.getHSVFromColor(Ya);Ka.partialStyle=rat.graphics.Color.makeColorFromHSV(Xa.h,Xa.s,.75*Xa.v),Ka.darkStyle=rat.graphics.Color.makeColorFromHSV(Xa.h,Xa.s,.15),Ka.textStyle||(Ka.textStyle=new rat.graphics.Color(Ka.style)),Ua.resourceTypeCount++}Ua.terrainTypes={plains:{name:"plains",style:"#655530",imageSources:[{src:"res/images/tiles/tile_flat.png"}],heroPassable:!0,weight:5,keepProb:.5,bonuses:[{key:"berries",name:"berries",placePercent:2,regenTurns:7,color:"#E02080",extra:"food",extraAmount:1},{key:"horses",name:"horses",placePercent:1,regenTurns:7,color:"#E02080",extra:"war",extraAmount:1}]},desert:{name:"desert",style:"#706540",imageSources:[{src:"res/images/tiles/tile_sand.png"}],heroPassable:!0,weight:1,keepProb:1,bonuses:[{key:"gems",name:"gems",placePercent:1,regenTurns:7,color:"#90A0F0",extra:"money",extraAmount:1},{key:"nomads",name:"nomads",placePercent:.5,regenTurns:7,color:"#504010",extra:"science",extraAmount:1}]},forest:{name:"forest",style:"#207530",imageSrc:"res/images/tiles/tile_trees.png",heroPassable:!0,weight:3,keepProb:.8,bonuses:[{key:"redwoods",name:"redwoods",placePercent:.5,regenTurns:7,color:"#E02080",extra:"production",extraAmount:1},{key:"plants",name:"rare plants",placePercent:.7,regenTurns:7,color:"#E02080",extra:"science",extraAmount:1}]},hills:{name:"hills",style:"#504015",imageSrc:"res/images/tiles/tile_hill.png",heroPassable:!0,weight:2,keepProb:.8,bonuses:[{key:"iron",name:"iron",placePercent:1,regenTurns:7,color:"#8090F0",extra:"production",extraAmount:1}]},mountains:{name:"mountains",style:"#505055",imageSrc:"res/images/tiles/tile_mountain.png",heroPassable:!1,weight:1,keepProb:.8,bonuses:[{key:"gold",name:"gold",placePercent:1,regenTurns:7,color:"#F0F030",extra:"money",extraAmount:1}]},water:{name:"lake",style:"#304075",imageSrc:"res/images/tiles/tile_lake.png",heroPassable:!1,weight:1,keepProb:.4,bonuses:[{key:"fish",name:"fish",placePercent:1,regenTurns:7,color:"#FFFFFF",extra:"food",extraAmount:1}]},ocean:{name:"ocean",style:"#304075",imageSrc:"res/images/tiles/tile_ocean.png",heroPassable:!1,weight:0,keepProb:0,bonuses:[{key:"whales",name:"whales",placePercent:1,regenTurns:7,color:"#D0D0E0",extra:"production",extraAmount:1}]}},Ua.backgroundStyle="#101010",Ua.fullFogStyle="#303030",Ua.partialFogColor=new rat.graphics.Color(112,112,128,1),Ua.bonusEntryFromKey=function(e){for(var t in Ua.terrainTypes)for(var n=Ua.terrainTypes[t].bonuses,r=0;r<n.length;r++)if(n[r].key===e)return n[r];return null},Ua.prototype.terrainPassable=function(e){return Ua.terrainTypes[e].heroPassable},Ua.prototype.getPixelSpace=function(){var e=(this.WORLD_W+1)*this.hexGrid.hexWidth+this.pixelOffset.x+this.bottomRightGutter.y,t=(this.WORLD_H+1)*(this.hexGrid.hexHeight/2+this.TILE_SIDE_PIXELS/2*this.hexGrid.vScale)+this.pixelOffset.y+this.bottomRightGutter.y;return{w:e|=0,h:t|=0,gutter:{left:this.pixelOffset.x,top:this.pixelOffset.y,right:this.bottomRightGutter.x,bottom:this.bottomRightGutter.y}}},Ua.prototype.renderOffWorld=function(e){},Ua.prototype.adjustViewLimits=function(e){return{left:e.left-2*this.TILE_SIDE_PIXELS-this.pixelOffset.x,top:e.top-2.5*this.TILE_SIDE_PIXELS-this.pixelOffset.y,right:e.right+2*this.TILE_SIDE_PIXELS-this.pixelOffset.x,bottom:e.bottom+2.5*this.TILE_SIDE_PIXELS-this.pixelOffset.y}},Ua.prototype.renderWorldView=function(e,t){e.save(),e.translate(this.pixelOffset.x,this.pixelOffset.y);var n=this.adjustViewLimits(t);this.renderWorld(e,!0,n),e.restore()},Ua.prototype.renderFogInView=function(e,t){e.save(),e.translate(this.pixelOffset.x,this.pixelOffset.y);var n=this.adjustViewLimits(t);this.renderWorldFog(e,!0,n),e.restore()},Ua.prototype.renderWorld=function(t,n,r){var i=app.config.showForCiv,o=this.hexGrid;t.lineWidth=2,t.strokeStyle="#8080C0";var s=this.allHexList;this.renderHexList(s,!1,n,r,(function(e){var n=e.value,r=e.entry.pixelPos,s=e.q,a=e.r;if(!n.fog||1!==n.fog[i]){var l=Ua.terrainTypes[n.terrainType];if(l.images){var c=(n.tileVariant||0)%l.images.length;l.images[c].draw(t,r.x-o.hexWidth/2-1,r.y-o.hexHeight/2-1,o.hexWidth+2,o.hexHeight+2)}else e.entry.debugStyle&&(t.fillStyle=e.entry.debugStyle,o.fillOneHex(t,s,a))}})),app.settings.display.showHexBorders&&this.renderHexList(s,!1,n,r,(function(e){var n=e.value,r=e.q,s=e.r;(!n.fog||n.fog[i]<=0)&&("mountains"===n.terrainType?(t.strokeStyle="#202020",t.lineWidth=8,o.strokeOneHex(t,r,s,3.9)):"ocean"===n.terrainType||"water"===n.terrainType||(t.lineWidth=4,t.strokeStyle="rgba(30, 50, 40, 1)",o.strokeOneHex(t,r,s,0)))})),this.renderHexList(s,!1,n,r,(function(n){var r=n.value,s=n.entry.pixelPos,a=n.q,l=n.r;if(r.structure&&"empty"!==r.structure.showAs&&(!r.fog||1!==r.fog[i])&&app.settings.display.showCivBorders){var c=game.civs[r.structure.civIndex],u=c.info.style;c.haveMet||(u=e.unknownStyle),t.strokeStyle=u,t.lineWidth=6,o.strokeOneHex(t,a,l,3)}if(r.structure&&r.structure.drawConnectors){var h=r.structure.drawConnectors;for(var d in h){var p=h[d];gfx.drawBuildingConnector(r.terrainType,r.structure.civIndex,s.x,s.y,p.q-a,p.r-l,t)}}})),this.renderHexList(s,!1,n,r,(function(e){var n=e.value,r=e.entry.pixelPos;if(e.q,e.r,n.bonus){var i=Ua.resourceTypes[n.bonus.bonusEntry.extra],o=n.bonus.regenCounter;n.bonus.regenEffectDelay&&n.bonus.regenEffectDelay>0&&(o=0),t.save(),t.translate(r.x,r.y);var s=app.config.graphics.resourceSize;if(o>0&&(s=app.config.graphics.resourceRegenSize),o>0){var a=n.bonus.bonusEntry.regenTurns;gfx.drawNewRegenBar(t,o,a,i.style,i.darkStyle)}else gfx.drawNewFullRegenBar(t,o,a,i.style,i.darkStyle);gfx.drawResource(n.bonus.bonusEntry.extra,0,0,0,s,t),t.restore()}if(n.structure&&"empty"!==n.structure.showAs){var l=n.structure.showAs||n.structure.type;gfx.drawBuilding(l,n.structure.civIndex,n.terrainType,r.x,r.y,0,null,t)}if(n.treasure&&gfx.drawAsset(t,"treasure",r.x,r.y,0,90),n.pet&&gfx.drawPet(t,n.pet,r.x,r.y),"gen"===app.settings.debug.skipTo||app.settings.debug.show.generation){const e=Math.PI;void 0!==n.startPointCiv?(gfx.drawAsset(t,"blank_avatar",r.x,r.y,e,100),t.font="bold 50px arial",t.fillStyle="#000000",t.fillText(""+n.startPointCiv,r.x-20,r.y+2)):n.possibleStartPoint?gfx.drawAsset(t,"unknown_hero",r.x,r.y,e,100):n.startPointCreature&&gfx.drawAsset(t,"dragon",r.x,r.y,e,70)}}))},Ua.prototype.renderWorldFog=function(t,n,r){var i=app.config.showForCiv,o=this.hexGrid,s=this,a=this.allHexList;e.semiFog&&(t.globalAlpha=.5),this.renderHexList(a,!0,n,r,(function(e){var n=e.value,r=e.entry.pixelPos;e.q,e.r,n.fog&&1===n.fog[i]&&s.fogTile.draw(t,r.x-o.hexWidth/2-1,r.y-o.hexHeight/2-1,o.hexWidth+2,o.hexHeight+2)})),t.globalAlpha=1},Ua.prototype.renderHexList=function(e,t,n,r,i){for(var o=app.config.showForCiv,s=0,a=0;a<e.length;a++){var l=e[a],c=l.value;if(c&&c.terrainType){var u=l.entry.pixelPos;r&&(u.x<r.left||u.y<r.top||u.x>r.right||u.y>r.bottom)||(!1!==c.dirty&&(1!==c.fog[o]||c.structure)||n)&&(t&&(c.dirty=!1),s++,i(l))}}this.lastHexDrawCount=s},Ua.prototype.dirtySingleHex=function(e,t,n,r){n||(n=this.hexGrid.getValueAt(e,t)),(1!==n.fog[app.config.showForCiv]||n.structure)&&(n.dirty=!0,this.dirty=!0)},Ua.prototype.dirtyHex=function(e,t,n,r){const i=this;if(n||(n=this.hexGrid.getValueAt(e,t)),n.structure){var o=i.getRootParentBuilding(e,t);!function e(t,n,o){i.dirtySingleHex(t,n,o,r+"-connected");for(var s=o.structure.childStructures,a=0;a<s.length;a++){var l=s[a],c=i.hexGrid.getValueAt(l.q,l.r);e(l.q,l.r,c)}}(o.q,o.r,o.val)}else i.dirtySingleHex(e,t,n,r)},Ua.prototype.removeFogFrom=function(e,t,n,r){(g=this.hexGrid.getValueAt(e,t)).fog[n]>=1&&n===app.config.showForCiv&&(qa.discoverTileEffect(e,t,g.terrainType),this.dirtyHex(e,t,g,"removeFogFrom_1")),g.fog[n]=0;var i=[],o=this.hexGrid.getNeighbors(e,t);this.hexGrid.mergeHexList(i,o);for(var s=[],a=0;a<i.length;a++){var l=this.hexGrid.getValueAt(i[a].q,i[a].r);if("ocean"===l.terrainType||"water"===l.terrainType)for(var c=this.hexGrid.getNeighbors(i[a].q,i[a].r),u=0;u<c.length;u++){var h=this.hexGrid.getValueAt(c[u].q,c[u].r);"ocean"!==h.terrainType&&"water"!==h.terrainType||s.push({q:c[u].q,r:c[u].r})}}if(this.hexGrid.mergeHexList(i,s),"hills"===g.terrainType||r)for(a=0;a<o.length;a++){if("mountains"!==(g=this.hexGrid.getValueAt(o[a].q,o[a].r)).terrainType){var d=this.hexGrid.getNeighbors(o[a].q,o[a].r);this.hexGrid.mergeHexList(i,d)}}var p=[];for(a=0;a<i.length;a++){var g,m=i[a].q,f=i[a].r;1===(g=this.hexGrid.getValueAt(m,f)).fog[n]&&(g.fog[n]=0,n===app.config.showForCiv&&(this.dirtyHex(m,f,g,"removeFogFrom_2"),this.triggerDiscoverEffects(m,f,g)),p.push({q:m,r:f,val:g}))}return p},Ua.prototype.removeFogFromSingle=function(e,t,n){var r=this.hexGrid.getValueAt(e,t);r.fog[n]=0,n===app.config.showForCiv&&(this.dirtyHex(e,t,r,"removeFogFromSingle"),this.triggerDiscoverEffects(e,t,r))},Ua.prototype.triggerDiscoverEffects=function(e,t,n){qa.discoverTileEffect(e,t,n.terrainType),n.bonus&&qa.discoverResourceEffect(e,t),n.treasure&&(qa.discoverTreasureEffect(e,t),za.playSound("treasure_tease"))},Ua.prototype.isSingleVisible=function(e,t){return this.hexGrid.getValueAt(e,t).fog[app.config.showForCiv]<1},Ua.prototype.hasNeighborBonus=function(e,t){for(var n=this.hexGrid.getNeighbors(e,t),r=0;r<n.length;r++){if(this.hexGrid.getValueAt(n[r].q,n[r].r).bonus)return!0}return!1},Ua.prototype.hasNeighborBuilding=function(e,t,n,r){for(var i=this.hexGrid.getNeighbors(e,t),o=0;o<i.length;o++){var s=this.hexGrid.getValueAt(i[o].q,i[o].r);if(s.structure&&(!n||s.structure.type===n)&&(void 0===r||s.structure.civIndex===r))return{q:i[o].q,r:i[o].r,val:s}}return!1},Ua.prototype.mostDevelopedNeighborBuilding=function(e,t,n){for(var r=0,i=null,o=this.hexGrid.getNeighbors(e,t),s=0;s<o.length;s++){var a=0,l=o[s].q,c=o[s].r,u=this.hexGrid.getValueAt(l,c);if(u.structure&&u.structure.civIndex===n){var h=this.getRootParentBuilding(l,c);a="city"===h.val.structure.type?50:"town"===h.val.structure.type?25:1,(a+=this.countChildBuildings(h.val))>r&&(r=a,i={q:l,r:c,val:u})}}return i},Ua.prototype.hasNearBuilding=function(e,t){for(var n=[],r=this.hexGrid.getNeighbors(e,t),i=0;i<r.length;i++){if(this.hexGrid.getValueAt(r[i].q,r[i].r).structure)return!0;var o=this.hexGrid.getNeighbors(r[i].q,r[i].r);this.hexGrid.mergeHexList(n,o)}for(i=0;i<n.length;i++){if(n[i].q!==e||n[i].r!==t)if(this.hexGrid.getValueAt(n[i].q,n[i].r).structure)return!0}return!1},Ua.prototype.getRootParentBuilding=function(e,t){var n,r={q:e,r:t};do{n=this.hexGrid.getValueAt(r.q,r.r),e=r.q,t=r.r,r=n.structure.parentStructure}while(r);return{val:n,q:e,r:t}},Ua.prototype.countChildBuildings=function(e){var t=0,n=e.structure.childStructures;if(!n||n.length<1)return 0;for(var r=0;r<n.length;r++){var i=n[r],o=this.hexGrid.getValueAt(i.q,i.r);o.structure&&(t++,t+=this.countChildBuildings(o))}return t},Ua.prototype.isBlocking=function(e,t){if(!this.hexGrid.inBounds(e,t))return!0;var n=this.hexGrid.getValueAt(e,t);return!this.terrainPassable(n.terrainType)},Ua.prototype.update=function(e){app.config.showForCiv;var t=this;this.hexGrid.forEachHex((function(n){var r=n.value;r.bonus&&r.bonus.regenEffectDelay&&(r.bonus.regenEffectDelay-=e,r.bonus.regenEffectDelay<0&&(r.bonus.regenEffectDelay=0,t.dirtyHex(n.q,n.r,r,"update_regen_effect")))}))},Ua.prototype.updateTurn=function(){var e=this;this.hexGrid.forEachHex((function(t){var n=t.value;n.bonus&&n.bonus.regenCounter>0&&(n.bonus.regenCounter--,e.dirtyHex(t.q,t.r,n,"updateTurn_regen"))}))},Ua.prototype.revealAll=function(e){void 0===e&&(e=app.config.showForCiv),this.hexGrid.forEachHex((function(t){t.value.fog[e]=0}))},Ua.prototype.fogAll=function(e){void 0===e&&(e=app.config.showForCiv),this.hexGrid.forEachHex((function(t){t.value.fog[e]=1}))},Ua.prototype.resetMainBlocking=function(){var e=this,t=rat.spaces.HexGrid.fullBlocking,n=rat.spaces.HexGrid.noBlocking;this.hexGrid.forEachHex((function(r){var i,o=r.value;i=o&&e.terrainPassable(o.terrainType)?n:t,r.entry.blocking.main=i;for(var s=1;s<=6;s++)r.entry.blocking["ai"+s]=i}))},Ua.prototype.makeMasterHexLists=function(){var e=this;this.usedHexList=[],this.allHexList=[];var t=this.hexGrid;this.hexGrid.forEachHex((function(n){n.entry.pixelPos=t.axialToPixelPos(n.q,n.r);var r={q:n.q,r:n.r,entry:n.entry,value:n.value};n.value&&("ocean"===n.value.terrainType||e.usedHexList.push(r)),e.allHexList.push(r)}))},Ua.prototype.finalize=function(){this.makeMasterHexLists();for(var e=0;e<this.usedHexList.length;e++){var t=this.usedHexList[e];t.value.pet&&(t.value.pet.name=app.cards.getCard(t.value.pet.cardID).name)}this.counts=this.countThings()},Ua.prototype.countThings=function(){var e=this.usedHexList,t={resources:{total:0}},n=app.World.resourceTypes;for(var r in n)t.resources[r]=0;for(var i=0;i<e.length;i++){var o=e[i];if(o.value.bonus){const e=o.value.bonus.bonusEntry.extra;t.resources[e]++,t.resources.total++}}return t},Ua.prototype.fillOcean=function(){var e=app.World.terrainTypes.ocean;this.hexGrid.forEachHex((function(t){t.value&&t.value.terrainType||(t.hexGrid.setValueAt(t.q,t.r,{terrainType:"ocean"}),t.hexGrid.setDebugStyleAt(t.q,t.r,e.style))}))},Ua.updateDrawConnectors=function(e,t,n,r,i){const o=rat.spaces.HexGrid;var s=r-e,a=i-t,l=o.deltaToDirection[s][a];l!==o.direction.left&&l!==o.direction.upLeft&&l!==o.direction.upRight||(n.structure.drawConnectors[l]={q:r,r:i})},Ua.prototype.serialize=function(){var e={};e.WORLD_W=this.WORLD_W,e.WORLD_H=this.WORLD_H,e.usedHexList=[];for(var t=0;t<this.usedHexList.length;t++){var n=this.usedHexList[t],r={q:n.q,r:n.r,tileVariant:n.value.tileVariant};r.terrainType=n.value.terrainType;var i=n.value.structure;i&&(r.structure={type:i.type,civIndex:i.civIndex},i.childStructures&&i.childStructures.length>0&&(r.structure.childStructures=rat.utils.copyObject(i.childStructures,!0)));var o=n.value.bonus;o&&(r.bonus={key:o.bonusEntry.key,regenCounter:o.regenCounter});var s=n.value.treasure;s&&(r.treasure=s);var a=n.value.pet;a&&(r.petID=a.cardID),n.value.name&&(r.name=Ga.serializeName(n.value)),e.usedHexList.push(r)}e.noFogRuns=[];var l=-1,c=0;function u(t){e.noFogRuns[t].push({start:l,length:c}),l=-1,c=0}for(var h=0;h<game.civs.length;h++){e.noFogRuns[h]=[];for(t=0;t<this.allHexList.length;t++)this.allHexList[t].value.fog[h]<1?(l<0&&(l=t),c++):l>=0&&u(h);l>=0&&u(h)}return e},Ua.deserialize=function(e,t,n){var r=app.config.world,i=new app.World(e.WORLD_W,e.WORLD_H,r.TILE_SIDE_PIXELS,r.V_SCALE);i.fillOcean();for(var o=0;o<e.usedHexList.length;o++){var s=e.usedHexList[o],a=i.hexGrid.getValueAt(s.q,s.r);if(a.dirty=!0,a.terrainType=s.terrainType,a.tileVariant=s.tileVariant,s.structure){var l=app.Buildings.types[s.structure.type],c=n[s.structure.civIndex];a.structure={civIndex:s.structure.civIndex,type:s.structure.type,pos:{q:s.q,r:s.r},name:l.name,childStructures:s.structure.childStructures||[],drawConnectors:{},showAs:null},c.buildings.push(a.structure)}s.bonus&&(a.bonus={regenCounter:s.bonus.regenCounter,bonusEntry:app.World.bonusEntryFromKey(s.bonus.key)}),s.treasure&&(a.treasure=s.treasure),s.petID&&(a.pet={cardID:s.petID}),s.name&&(a.name=Ga.deserializeName(s.name))}i.resetMainBlocking(),i.finalize();for(var u=0;u<i.allHexList.length;u++){var h=i.allHexList[u];h.value.fog=[],h.value.aiData=[];for(var d=0;d<n.length;d++)h.value.fog[d]=1,h.value.aiData[d]={};if(h.value.structure)for(var p=0;p<h.value.structure.childStructures.length;p++){var g=h.value.structure.childStructures[p],m=i.hexGrid.getValueAt(g.q,g.r);m.structure.parentStructure={q:h.q,r:h.r},Ua.updateDrawConnectors(g.q,g.r,m,h.q,h.r),Ua.updateDrawConnectors(h.q,h.r,h.value,g.q,g.r)}}for(var f=0;f<n.length;f++)for(var v=e.noFogRuns[f],y=0;y<v.length;y++){var w=v[y];for(u=w.start;u<w.start+w.length;u++)i.allHexList[u].value.fog[f]=0}return app.settings.debug.revealAll&&i.revealAll(),i};const $a={types:{town:{name:"town",fillStyle:"#A0A0E0",strokeStyle:"#202040",category:"town",countCap:4,cost:[{money:4,food:4,production:4}],harvestCount:1},city:{name:"city",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"city",upgradeFrom:"town",upgradeProblemCode:"NEEDS_TOWN",countCap:2,cost:[{money:17,food:17,production:17}],harvestCount:2},expansion:{name:"Collector",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"expansion",isExpansion:!0,countCap:4,cost:[{money:5,food:5,production:5}],harvestCount:1},tech1:{name:"Launch Pad",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"science",upgradeTo:"tech2",isExpansion:!0,countCap:1,cost:[{science:10,money:4,production:4}]},tech2:{name:"Rocket",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"science",upgradeFrom:"tech1",upgradeTo:"tech3",upgradeProblemCode:"NEEDS_TECH1",isExpansionUpgrade:!0,countCap:1,cost:[{science:15,money:5,production:5}]},tech3:{name:"Mars Lander",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"science",upgradeFrom:"tech2",upgradeProblemCode:"NEEDS_TECH2",isExpansionUpgrade:!0,countCap:1,cost:[{science:20,money:6,production:6}]},money1:{name:"Bank Building",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"money",upgradeTo:"money2",isExpansion:!0,countCap:1,cost:[{money:10,war:4,production:4}]},money2:{name:"Security System",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"money",upgradeFrom:"money1",upgradeTo:"money3",upgradeProblemCode:"NEEDS_MONEY1",isExpansionUpgrade:!0,countCap:1,cost:[{money:15,war:5,science:5}]},money3:{name:"Gold Vault",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"money",upgradeFrom:"money2",upgradeProblemCode:"NEEDS_MONEY2",isExpansionUpgrade:!0,countCap:1,cost:[{money:20,war:6,production:6}]},prod1:{name:"Monument Base",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"production",upgradeTo:"prod2",isExpansion:!0,countCap:1,cost:[{production:10,money:4,war:4}]},prod2:{name:"Monument Stage 2",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"production",upgradeFrom:"prod1",upgradeTo:"prod3",upgradeProblemCode:"NEEDS_PROD1",isExpansionUpgrade:!0,countCap:1,cost:[{production:15,money:5,science:5}]},prod3:{name:"Finished Monument",fillStyle:"#A0F0E0",strokeStyle:"#202040",category:"victory",victoryType:"production",upgradeFrom:"prod2",upgradeProblemCode:"NEEDS_PROD2",isExpansionUpgrade:!0,countCap:1,cost:[{production:20,money:6,science:6}]},watchtower:{name:"watchtower",fillStyle:"#A0A0E0",strokeStyle:"#202040"}},victoryChains:{science:{label:"Mars Rocket",unlockAction:"sciTech1",chain:["tech1","tech2","tech3"]},money:{label:"World Bank",unlockAction:"sciMoney1",chain:["money1","money2","money3"]},production:{label:"Monument",unlockAction:"sciProd1",chain:["prod1","prod2","prod3"]}},isFirstInChain:function(e){return!$a.types[e].upgradeFrom},isLastInChain:function(e){return!$a.types[e].upgradeTo},nextInChain:function(e){return $a.types[e].upgradeTo},getChainInfo:function(e){var t=$a.types[e];if(!t.victoryType)return null;var n=$a.victoryChains[t.victoryType],r=n.chain.indexOf(e);return{victoryType:t.victoryType,chainInfo:n,chainLength:n.chain.length,chainIndex:r}},isAnyVictoryBuilding:function(e){return!!$a.types[e].victoryType},checkCost:function(e,t){var n=$a.getCost(e,t);return game.checkCost(n,t)},getCost:function(e,t){var n=$a.types[e];if(!n)return null;var r=t.actionCounts[e]||0;return r>n.cost.length-1&&(r=n.cost.length-1),game.adjustCost(n.cost[r],t)}},Ja={oneTimeInit:function(){rat.data.dataCSV.read("res/data/civs.csv",Ja.processData,{tag:"civs",leadingKey:!1})},processData:function(e,t,n){if(t.civs){var r;"default"===t.civs[0].id?(r=t.civs[0],t.civs.splice(0,1)):r={};for(var i=0;i<t.civs.length;i++){var o=t.civs[i];rat.utils.extendObject(o,r,!0);var s=new rat.graphics.Color(o.style);s.scale(.15),o.backStyle=s.toString(),o.avatarAsset=o.id}Ja.civInfo=t.civs,Ja.readDone=!0}else console.log("Error loading civ data")},initAfterLoad:function(){gfx.loadCivImages(Ja.civInfo)},isDoneLoading:function(){return Ja.readDone},getInfoFromID:function(e){for(var t=0;t<Ja.civInfo.length;t++)if(Ja.civInfo[t].id===e)return Ja.civInfo[t];return Ja.civInfo[0]}},Qa={victories:{points:{indefiniteName:"Victory",name:"Victory",style:"#dbb222"}},pointsFor:{town:{points:1,limit:2,got:0},city:{points:2,limit:2,got:0},expansion:{points:1,limit:2,got:0},tech3:{points:5,limit:1,got:0,progressName:"working on a Rocket to Mars",parts:{sciTech1:{partial:.25},tech1:{partial:.5},tech2:{partial:.75},tech3:{partial:1,trackResources:!0}}},money3:{points:5,limit:1,got:0,progressName:"working on a World Bank",parts:{sciMoney1:{partial:.25},money1:{partial:.5},money2:{partial:.75},money3:{partial:1,trackResources:!0}}},prod3:{points:5,limit:1,got:0,progressName:"building a Monument",parts:{sciProd1:{partial:.25},prod1:{partial:.5},prod2:{partial:.75},prod3:{partial:1,trackResources:!0}}},monster1:{points:1,limit:1,got:0},monster2:{points:1,limit:1,got:0},monster3:{points:1,limit:1,got:0},monster4:{points:5,limit:1,got:0,exclusive:!0,progressName:"hit the Dragon",partialProgressNames:[{threshold:.25,name:"fighting the Dragon"},{threshold:.8,name:"beating the Dragon"}]}},getCleanPointsFor:function(){var e=rat.utils.deepCopy(app.rules.pointsFor);for(var t in e)e[t].lastTurn=0,e[t].lastTurnProgress=0;return e},updateCivProgress:function(e,t){var n=!1;for(var r in e.victoryProgress||(e.victoryProgress=[]),Qa.victories){for(var i=null,o=0;o<e.victoryProgress.length;o++)e.victoryProgress[o].type===r&&(i=e.victoryProgress[o]);if(!i){i={type:r,amount:0,lastTurn:0,lastTurnAmount:0};e.victoryProgress.push(i)}if(game.turns.turn>i.lastTurn&&(i.lastTurn=game.turns.turn,i.lastTurnAmount=i.amount),Qa.victories[r],"points"===i.type){i.amount=e.showPoints/game.config.pointsToWin,i.points=e.showPoints,i.pointsToWin=game.config.pointsToWin,n=e.points>=game.config.pointsToWin,i.partialType=null,i.partialPointsFor=null;var s=0;for(var a in e.pointsFor){var l=e.pointsFor[a];if(l.progress&&l.limit>0){var c=l.progress*l.points;c>s&&(s=c,i.partialType=a,i.partialPointsFor=l)}}if(i.partialPointsFor){var u=i.partialPointsFor;if(i.progressMessage=u.progressName,u.partialProgressNames)for(var h=u.partialProgressNames,d=h.length-1;d>=0;d--)if(u.progress>=h[d].threshold){i.progressMessage=h[d].name;break}}}else i.amount=0;i.amount<0&&(i.amount=0),i.amount>=1&&(i.amount=1)}n&&t&&game.declareWinner(e.civIndex),e.victoryProgress.sort((function(e,t){return t.amount-e.amount})),game.hud.updateProgressDisplay()},evaluateCostProgress:function(e,t){var n=0,r=0;for(var i in t){var o=e.resources[i].count,s=t[i];o>s&&(o=s),n+=o,r+=s}return n/r},updateAllCivProgress:function(e,t){for(var n=0;n<e.length;n++)Qa.updateCivProgress(e[n],t)}},Za=[{code:"weak",searchTarget:"creature",searchCode:0},{code:"medium",searchTarget:"creature",searchCode:1},{code:"strong",searchTarget:"creature",searchCode:2},{code:"money",searchTarget:"resource",searchCode:"money"},{code:"food",searchTarget:"resource",searchCode:"food"},{code:"science",searchTarget:"resource",searchCode:"science"},{code:"production",searchTarget:"resource",searchCode:"production"},{code:"war",searchTarget:"resource",searchCode:"war"},{code:"pet",searchTarget:"pet",searchCode:"pet"}];function el(e){for(var t=game.civs[e].hero.pos.q,n=game.civs[e].hero.pos.r,r=0;r<Za.length;r++){(a=Za[r]).searchTarget&&(a.result=null,a.bestDist=99999999)}for(var i=0;i<game.world.usedHexList.length;i++){var o=game.world.usedHexList[i],s=o.value;for(r=0;r<Za.length;r++){var a,l=!1;if("creature"===(a=Za[r]).searchTarget?s.creature&&s.creature.monsterLevel===a.searchCode&&(l=!0):"resource"===a.searchTarget?s.bonus&&s.bonus.bonusEntry.extra===a.searchCode&&(l=!0):"pet"===a.searchTarget&&s.pet&&(l=!0),l&&s.fog[e]>=1){var c,u=rat.spaces.HexGrid.distance(t,n,o.q,o.r);if(u>=a.bestDist)continue;(c=u)<a.bestDist&&(a.bestDist=c,a.result={q:o.q,r:o.r,dist:c,value:s})}}}return Za}const tl={buildSearchResults:el,aiSearchFor:function(e,t){var n=game.civs[e];el(e);for(var r=0;r<Za.length;r++){var i=Za[r];if(i.searchCode===t&&i.result){var o=i.result;game.world.removeFogFromSingle(o.q,o.r,e);var s={science:tl.getSearchCost(n)};return game.animateAndApplyCost(s,n),n.actionCounts.sciSearch++,game.addActionIconTurnPart(n,"search_action"),o}}return!1},getSearchCost:function(e){return e||(e=game.playerCiv),e.isAI&&game.config.aiDifficulty>=4?1:2+1*e.actionCounts.sciSearch}},nl=rat.spaces.HexGrid;var rl={RECHECK_BAD_HEX_TURNS:30,RECHECK_CREATURE_HEX_TURNS:12,RECHECK_HERO_HEX_TURNS:4,oneTimeInit:function(){},init:function(){for(var e=0;e<game.civs.length;e++){var t=game.civs[e];if(!t.isAI)continue;t.aiData=t.aiData||{};const r={income:{},attitude:{civs:[]},highestIncome:0,highestIncomeCount:0,buildingCategories:{town:[],city:[],expansion:[],victory:[]},knownResourceRatio:0};if(rat.utils.extendObject(t.aiData,r,!0),t.aiData.rng=new rat.math.rng.Simple,void 0!==t.aiData.rngState)t.aiData.rng.setState(t.aiData.rngState);else{var n=game.rngSeed+137*e;t.aiData.rng.setSeed(n)}this.setExploreMode(t)}},updateTurn:function(){for(var e=0;e<game.civs.length;e++){var t=game.civs[e];t.isAI&&(t.isDead||this.updateOneCivTurn(e,t))}},updateOneCivTurn:function(e,t){if(!this.considerShoving(t)){var n=t.aiData.target;if(n&&"creature"===n.type)(a=game.creatureAt(n.q,n.r))&&!a.isDead||(rl.log(t,"creature at "+n.q+","+n.r+" was killed out from under me"),t.aiData.target=null);if(this.evaluateCurrentSpot(t),this.evaluateWorld(t,e),t.aiData.objectTarget)t.aiData.intention="treasure",app.config.debugCiv===t.civIndex&&rl.log(t,"civ "+t.civIndex+" : I see treasure at "+t.aiData.objectTarget.q+", "+t.aiData.objectTarget.r),t.aiData.target={q:t.aiData.objectTarget.q,r:t.aiData.objectTarget.r,type:"treasure"};else{var r=t.aiData.buildingCategories,i=t.aiData.nextVictoryBuilding,o=3;if(game.config.pointsToWin>15&&(o=4),r.town.length>0&&l(t,"city","sciCity")&&r.city.length<2&&t.aiData.cityTarget){if(t.aiData.intention="city",c("city",t.aiData.cityTarget,"sciCity"))return}else if(game.config.hasCityExpansions&&r.city.length>0&&r.expansion.length<o&&l(t,"expansion","sciExpansion")&&t.aiData.expansionTarget){if(t.aiData.intention="expansion",c("expansion",{pos:t.aiData.expansionTarget},"sciExpansion"))return}else if(r.town.length<4&&l(t,"town","sciTown")&&t.aiData.townTarget){if(t.aiData.intention="town",c("town",{pos:t.aiData.townTarget},"sciTown"))return}else if(i&&r.town.length>1&&r.city.length>0&&(r.expansion.length>1||!t.aiData.expansionTarget)&&l(t,i)&&t.aiData.victoryBuildingTarget){t.aiData.intention="victory_building";var s=rl.getVictoryUnlockAction(t.aiData.victoryBuildingType);if(c(i,{pos:t.aiData.victoryBuildingTarget},s))return!0}}if(!rl.considerTrading(t)){if(t.aiData.target&&(this.updateMyBlocking(t),this.targetPathStillValid(t)||(rl.log(t,"path became invalid to "+t.aiData.target.q,NaN+t.aiData.target.r),t.aiData.target=null)),t.aiData.target)t.aiData.jogTarget&&(rl.log(t," jogging!"),t.aiData.target=t.aiData.jogTarget);else if(t.aiData.creatureTarget){t.aiData.intention="monster";var a=t.aiData.creatureTarget;rl.log(t,"I'm going after creature "+a.name+" at "+a.pos.q+", "+a.pos.r),t.aiData.target={q:a.pos.q,r:a.pos.r,type:"creature"}}else{if("resource"===t.aiData.mode&&!t.aiData.resourceTarget&&rl.setExploreMode(t))return;if("explore"===t.aiData.mode&&(!t.aiData.exploreTarget||t.aiData.modeQuota<=0)&&rl.setResourceMode(t))return;"resource"===t.aiData.mode?t.aiData.resourceTarget&&(rl.log(t," switching to res target with weight "+t.aiData.bestResWeight+" @"+t.aiData.resourceTarget.q+","+t.aiData.resourceTarget.r+" for "+t.aiData.myLowestResource),t.aiData.target={q:t.aiData.resourceTarget.q,r:t.aiData.resourceTarget.r,resWeight:t.aiData.resourceTarget.resWeight,distFactor:t.aiData.resourceTarget.distFactor,dist:t.aiData.resourceTarget.dist,type:"resource"}):t.aiData.exploreTarget&&(t.aiData.target={q:t.aiData.exploreTarget.q,r:t.aiData.exploreTarget.r,type:"explore"}),t.aiData.intention=t.aiData.mode}this.updateMyBlocking(t),this.updateHero(t,e)}}function l(e,t,n){return!(n&&!e.actionCounts[n]&&!game.canAffordActionForAI(e,n))&&!(app.Buildings.types[t].countCap&&e.actionCounts[t]>=app.Buildings.types[t].countCap||!app.Buildings.checkCost(t,e))}function c(e,n,r){var i,o,s=rl.payUnlockCost(t,r);return"paid_now"===s?(rl.log(t,"paid unlock cost of "+r),!0):!("paid_already"!==s||(rl.log(t,"I can make a "+e),o=e,!(i=n)||(i.pos.q===t.hero.pos.q&&i.pos.r===t.hero.pos.r?(rl.log(t,"got to my build target.  Building "+o),game.makeHeroBuilding(o,t.hero),t.aiData.target=null,t.aiData.expansionTarget=null,t.aiData.townTarget=null,rl.setExploreMode(t),0):(t.aiData.target={q:i.pos.q,r:i.pos.r,type:"site"},1))))}},setExploreMode:function(e){e.aiData.knownResourceRatio>=.99?console.log("AI ERROR: trying to set explore mode when we've explored everything."):(e.aiData.mode="explore",e.aiData.modeQuota=4,rl.log(e,"explore mode"))},setResourceMode:function(e){var t={money:2,food:1,science:1,production:2,war:1};for(var n in e.buildings.length<1&&(t={money:1,food:1,science:1,production:1}),e.buildings.length>=2&&(t={money:2,food:3,science:2,production:2}),game.scenario.gameConfig.hasWar||delete t.war,t)if(!e.aiData.knownResources[n]||e.aiData.knownResources[n]<t[n]){rl.log(e,"  .. no res mode for me, not enough known "+n);var r=tl.getSearchCost(e),i=e.resources.science.count;if(i>=r&&r<10){rl.log(e,"  search for "+n+" at a cost of "+r+"/"+i);var o=tl.aiSearchFor(e.civIndex,n);if(o)return game.world.hexGrid.getValueAt(o.q,o.r).aiData[e.civIndex].isSearchResult=!0,!0}return rl.setExploreMode(e),void(e.aiData.modeQuota=1)}e.aiData.resourceTarget?(e.aiData.mode="resource",rl.log(e,"civ "+e.civIndex+" in res mode.")):rl.setExploreMode(e)},updateMyBuildings:function(e,t){for(var n={town:[],city:[],expansion:[],victory:[]},r={},i=!1,o=0;o<e.buildings.length;o++){var s=app.Buildings.types[e.buildings[o].type];n[s.category].push(e.buildings[o]),"victory"===s.category&&(r[s.victoryType]=e.buildings[o].type,e.buildings[o].type===e.aiData.nextVictoryBuilding&&(i=!0))}if(e.aiData.buildingCategories=n,e.aiData.nextVictoryBuilding)if(i){var a=app.Buildings.nextInChain(e.aiData.nextVictoryBuilding);a?(e.aiData.nextVictoryBuilding=a,rl.log(e,"nextVictoryBuilding "+e.aiData.nextVictoryBuilding)):e.aiData.nextVictoryBuilding=null}else app.Buildings.isFirstInChain(e.aiData.nextVictoryBuilding)&&(e.aiData.nextVictoryBuilding=null);if(!e.aiData.nextVictoryBuilding&&(n.town.length>=3||n.city.length>=1)){var l=0,c=-1;for(var u in app.World.resourceTypes)if((!r[u]||!app.Buildings.isLastInChain(r[u]))&&app.Buildings.victoryChains[u]){var h=e.harvestTrack[u];h.claimCount>c&&(c=h.claimCount,l=u)}if(l&&c>=0){var d=app.Buildings.victoryChains[l];d&&d.chain[0]&&(r[l]?e.aiData.nextVictoryBuilding=app.Buildings.nextInChain(r[l]):e.aiData.nextVictoryBuilding=d.chain[0],e.aiData.victoryBuildingType=l,rl.log(e,"nextVictoryBuilding "+e.aiData.nextVictoryBuilding+" / "+e.aiData.victoryBuildingType))}}},updateBuildingsForAll:function(){for(var e=0;e<game.civs.length;e++){var t=game.civs[e];t.isAI&&rl.updateMyBuildings(t,e)}},pickBestTownToCity:function(e){for(var t=e.aiData.buildingCategories.town,n=null,r=-1,i=0;i<t.length;i++){for(var o=t[i],s=0,a=game.world.hexGrid.getNeighbors(o.pos.q,o.pos.r),l=0;l<a.length;l++){var c=game.world.hexGrid.getValueAt(a[l].q,a[l].r);c.bonus&&("food"===c.bonus.bonusEntry.extra?s+=.5:s+=1)}s>r&&(r=s,n=o)}return n||null},civAttacked:function(e,t,n,r){var i=game.civs[e];if(i.isAI){var o=i.aiData.attitude,s=o.civs[t.civIndex];s||(s=o.civs[t.civIndex]={violenceToAny:{shove:0,knockdown:0},violenceToMe:{shove:0,knockdown:0},totalViolence:0,opinion:0}),s.totalViolence++,s.violenceToAny[r]++,s.opinion-="shove"===r?1:3,n.civIndex===e&&(s.violenceToMe[r]++,s.opinion-="shove"===r?1:3)}},considerShoving:function(e){var t=game.civs[0];if(nl.distance(t.hero.pos.q,t.hero.pos.r,e.hero.pos.q,e.hero.pos.r)>1)return!1;var n=e.aiData.attitude.civs[0];if(n&&(n.violenceToMe.shove>=2||n.violenceToMe.knockdown>=1)&&e.resources.war.count>2&&e.aiData.rng.random()>.33)return game.tryCivHeroMoveTo(e,t.hero.pos.q,t.hero.pos.r)},considerTrading:function(e){if(e.resources.war.count<25&&game.hasNeighborCreature(e.hero.pos.q,e.hero.pos.r))return rl.log(e,"suppress trade action because I'm next to a creature"),!1;for(var t in app.World.resourceTypes){var n=e.resources[t].count,r=.8*game.config.resourceCap,i=.6*game.config.resourceCap;if((app.config.aiDifficultyMods[game.scenario.gameConfig.aiDifficulty].cost||1)>1&&(r=game.config.resourceCap,i=.8*game.config.resourceCap),n>=game.config.allowTradeLevel){if(e.aiData.nextVictoryBuilding&&e.aiData.victoryBuildingType===t&&app.Buildings.isLastInChain(e.aiData.nextVictoryBuilding)){rl.log(e,"suppress trade of "+t+" because I'm working on "+e.aiData.nextVictoryBuilding);break}if("war"===t&&e.aiData.creatureTarget&&"monster4"===e.aiData.creatureTarget.code){rl.log(e,"suppress trade of "+t+" because I have a dragon target "+e.aiData.creatureTarget.name);break}if(!e.actionCounts.sciTrade){if(game.processActionForAI(e,"sciTrade"))return!0;break}if((n=e.resources[t].count)>=r){var o=e.aiData.myLowestResource,s=e.resources[o].count,a=game.config.resourceCap;if(e.aiData.nextVictoryBuilding&&e.aiData.victoryBuildingType===o||(a=i),s<a)return rl.log(e,"civ "+e.civIndex+" trading resource "+t+" for "+o),rl.log(e,"  (had "+n+" "+t+" and "+s+" "+o+")"),game.tradeResource(e,t,o),!0}}}return!1},resourceCountChanged:function(e,t){},payUnlockCost:function(e,t){return e.actionCounts[t]?"paid_already":game.processActionForAI(e,t)?"paid_now":"unpaid"},getVictoryUnlockAction:function(e){return app.Buildings.victoryChains[e].unlockAction},payVictoryUnlockCost:function(e,t){var n=app.Buildings.victoryChains[t].unlockAction;return rl.payUnlockCost(e,n)},updateBlocking:function(e,t,n){window.performance.now();var r=e.aiData,i="main";e.isAI&&(i="ai"+t);var o=nl.fullBlocking,s=10,a=20;e.resources.war.count>2&&(a=12);var l=50,c=90;e.resources.war.count>4&&(l=12,c=14);var u=game.world.usedHexList;e.isAI||(u=game.world.allHexList);for(var h=0;h<u.length;h++){var d=u[h],p=d.value,g=nl.distance(d.q,d.r,e.hero.pos.q,e.hero.pos.r);if(e.isAI&&"ocean"===p.terrainType||p.fog[t]<1&&!game.world.terrainPassable(p.terrainType))d.entry.blocking[i]=o;else if(d.entry.blocking[i]=s,e.isAI){var m=1;"hills"===p.terrainType&&(m=2);var f=0;game.world.hexGrid.forEachNeighbor(d.q,d.r,(function(e){e.value.fog[t]>=1&&f++}),null,!1,!1,m);var v=0;game.world.hexGrid.forEachNeighbor(d.q,d.r,(function(n){var r=n.value;if(r.fog[t]<1&&r.bonus){var i=r.bonus.bonusEntry.extra;e.resources[i].count<e.resources[i].cap&&g>=r.bonus.regenCounter&&(v+=1)}}),null,!1,!0,1),d.entry.blocking[i]-=2*v,d.entry.blocking[i]<5&&(d.entry.blocking[i]=5),d.entry.blocking[i]-=f,d.entry.blocking[i]<1&&(d.entry.blocking[i]=1)}}for(var y=0;y<game.civs.length;y++)if(y!==t){var w=game.civs[y].hero.pos,C=nl.distance(e.hero.pos.q,e.hero.pos.r,w.q,w.r);if(C<=1||e.isAI&&C<=5)(p=game.world.hexGrid.getValueAt(w.q,w.r)).fog[t]<1&&game.world.hexGrid.setBlockingAt(w.q,w.r,o,i);if(e.isAI){var S=r.attitude.civs[y];if(S){var b=0;S.totalViolence>=2&&(b=l),S.totalViolence>=5&&(b=c),b&&game.world.hexGrid.forEachNeighbor(w.q,w.r,(function(e){var t=e.entry.blocking;t[i]!==o&&t[i]<b&&(t[i]=b)}),null,!0,!1,1)}}}for(y=0;y<game.creatures.length;y++){var _=game.creatures[y];if((p=game.world.hexGrid.getValueAt(_.pos.q,_.pos.r)).fog[t]<1){if(n&&n.q===_.pos.q&&n.r===_.pos.r)continue;game.world.hexGrid.setBlockingAt(_.pos.q,_.pos.r,o,i),e.isAI&&game.world.hexGrid.forEachNeighbor(_.pos.q,_.pos.r,(function(e){var t=e.entry.blocking;t[i]!==o&&t[i]<a&&(t[i]=a)}),null,!0,!1,1)}}window.performance.now()},updateMyBlocking:function(e){var t=null;e.aiData.target&&"creature"===e.aiData.target.type&&(t=e.aiData.target),this.updateBlocking(e,e.civIndex,t)},calculateMyProduction:function(e){var t=e.aiData;for(var n in t.want={},app.World.resourceTypes)t.want[n]=1;t.want.production*=1.75,t.want.money*=1.75,t.want.food*=.9;var r=[];for(var n in e.harvestTrack)r.push({code:n,prod:e.harvestTrack[n].claim,prodCount:e.harvestTrack[n].claimCount});r.sort((function(e,t){return e.prod-t.prod}));for(var i=0;i<r.length;i++)r[i].prod<=0?t.want[r[i].code]*=3:t.want[r[i].code]/=r[i].prodCount},isHeroAt:function(e,t,n){for(var r=0;r<game.civs.length;r++)if(r!==n&&game.civs[r].hero.pos.q===e&&game.civs[r].hero.pos.r===t)return r;return-1},evaluateCurrentSpot:function(e){var t=e.civIndex,n=e.hero;e.aiData,game.world.hexGrid.forEachNeighbor(n.pos.q,n.pos.r,(function(n){n.value.aiData[t].isSearchResult&&(rl.log(e,"got to my search result at "+n.q+", "+n.r),n.value.aiData[t].isSearchResult=!1)}),null,!1,!0,1)},evaluateWorld:function(e,t){window.performance.now(),rl.log(e,"-------------- AI evaluate world turn "+game.turns.turn);var n=e.hero,r=e.aiData;r.bestTownValue=0,r.bestTownDistance=99999,r.bestExpansionValue=0,r.bestExpansionDistance=99999,r.bestVictoryBuildingDistance=99999,r.bestExploreWeight=-9999,r.bestResWeight=-9999,r.jogTarget=null,r.exploreTarget=null,r.objectTarget=null,r.resourceTarget=null,r.cityTarget=null,r.knownResources||(r.knownResources={total:0}),r.knownResources.totalPrev=r.knownResources.total,r.knownResources.total=0;var i=999;for(var o in r.myLowestResource=null,app.World.resourceTypes)"war"===o&&(!game.scenario.gameConfig.hasWar||e.buildings.length<2)||e.resources[o].count<i&&(r.myLowestResource=o,i=e.resources[o].count);rl.calculateMyProduction(e),r.fogTileCount=0;for(var s=0;s<game.world.usedHexList.length;s++){var a=game.world.usedHexList[s],l=a.value,c=a.q,u=a.r;if(l.aiData[t].problem&&l.aiData[t].problem<0){if(!(game.turns.turn>=l.aiData[t].problemRecheckTurn))continue;l.aiData[t].problem=0,rl.log(e,"trying again on location "+c+","+u)}if(!l.creature){var h=nl.distance(c,u,n.pos.q,n.pos.r);if(l.fog[t]<1&&l.bonus){var d=l.bonus.bonusEntry.extra;r.knownResources[d]||(r.knownResources[d]=0),r.knownResources[d]++,r.knownResources.total++}rl.evaluateExploreSpot(c,u,l,h,e),rl.evaluateResourceSpot(c,u,l,h,e),rl.evaluateJogSpot(c,u,l,h,e),l.fog[t]<1&&(rl.evaluateObjectSpot(c,u,l,h,e),app.Buildings.checkCost("town",e)&&rl.evaluateTownSpot(c,u,l,h,e),app.Buildings.checkCost("expansion",e)&&rl.evaluateExpansionSpot(c,u,l,h,e),r.nextVictoryBuilding&&app.Buildings.checkCost(r.nextVictoryBuilding,e)&&rl.evaluateVictoryBuildingSpot(c,u,l,h,e))}}r.knownResourceRatio=r.knownResources.total/game.world.counts.resources.total;var p=r.knownResources.total-r.knownResources.totalPrev;p>0&&rl.log(e,"num new resources known "+p+" ("+r.knownResources.total+")"),"explore"===r.mode&&p>0&&(r.modeQuota-=p),!rl.findCreatureTargets(e)&&r.target&&"creature"===r.target.type&&(r.target=null),r.cityTarget=this.pickBestTownToCity(e),window.performance.now()},findCreatureTargets:function(e){var t=e.aiData,n=e.civIndex;t.creatureTarget=null,t.bestCreatureDistance=9999999;for(var r=e.resources.war.count,i=0;i<game.creatures.length;i++){var o=game.creatures[i];if(!o.isDead){var s=game.world.hexGrid.getValueAt(o.pos.q,o.pos.r);if(!(s.fog[n]>=1))if(s.aiData[n].problem&&s.aiData[n].problem<0)rl.log(e,"unreachable monster?!");else{var a=nl.distance(o.pos.q,o.pos.r,e.hero.pos.q,e.hero.pos.r),l=game.civs[n].pointsFor[o.code],c=0;l&&l.limit>0&&(c=l.points);var u=o.health[n];if(1===game.config.aiDifficulty&&(u=Math.floor(1.5*u)),2===game.config.aiDifficulty&&(u=Math.floor(1.2*u)),u>.8*game.config.resourceCap&&(u=.8*game.config.resourceCap),!(u>r&&(a>2||c<=0||r<4)||c<=0&&a>6)){if(a>3){for(var h=!1,d=0;d<game.civs.length;d++){if(d!==n)if(!game.civs[d].isDead)if(!(game.civs[d].resources.war.count<=1))if(1===nl.distance(o.pos.q,o.pos.r,game.civs[d].hero.pos.q,game.civs[d].hero.pos.r)){h=!0;break}}if(h)continue}a<t.bestCreatureDistance&&(t.creatureTarget=o,t.bestCreatureDistance=a)}}}}return t.creatureTarget},evaluateExploreSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex;if(!(r<2)&&!(n.fog[s]<1)&&game.world.terrainPassable(n.terrainType)){o.fogTileCount++;var a=0,l=0;game.world.hexGrid.forEachNeighbor(e,t,(function(e){1===e.value.fog[s]?l++:(e.value.aiData[s].isSearchResult&&(a=5),e.value.creature&&(a-=4))}),null,!1,!0),(a+=l/3+1/(.3*r))>o.bestExploreWeight&&(o.bestExploreWeight=a,o.exploreTarget={q:e,r:t},rl.log(i,"ai "+s+" bestex "+a+" with dist "+r+" @"+e+","+t))}},evaluateResourceSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex;if(n.aiData[s].resValue=void 0,game.world.terrainPassable(n.terrainType)&&!(rl.isHeroAt(e,t,s)>=0)){var a=0,l=0,c=0,u=0;game.world.hexGrid.forEachNeighbor(e,t,(function(e){if(e.value.creature&&(a-=5),1!==e.value.fog[s]){if(e.value.bonus){var t=1,n=0,i=game.world.hasNeighborBuilding(e.q,e.r);if(i)if(i.val.structure.civIndex===s){if(app.Buildings.types[i.val.structure.type].harvestCount)return}else n++;t/=n+1;for(var h=0,d=0;d<game.civs.length;d++)if(d!==s){if(game.civs[d].hero.pos.q===e.q&&game.civs[d].hero.pos.r===e.r)return;1===nl.distance(game.civs[d].hero.pos.q,game.civs[d].hero.pos.r,e.q,e.r)&&h++}t/=h+1,e.value.bonus.regenCounter>1?e.value.bonus.regenCounter<r?c++:t*=.5:c++,e.value.bonus.bonusEntry.extra===o.myLowestResource&&(t*=3,l++),a+=t}}else u++}),null,!1,!0);var h,d=a+u/5;d+=h=r>5?-r/6:-r/20,d-=.1,n.aiData[s].resValue=d,n.aiData[s].resFogValue=u,n.aiData[s].resHasNeeded=l,n.aiData[s].resHasFull=c,l&&d>o.bestResWeight&&(o.bestResWeight=d,o.resourceTarget={q:e,r:t,distFactor:h,dist:r,resWeight:d},app.config.debugCiv===i.civIndex&&console.log("++ new best res @"+e+","+t+" : "+d+": res "+a+", fog "+u/5+", dist "+h+" (hd: "+r+"), hasNeeded "+l+", hasFull "+c+", "))}},evaluateObjectSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex;n.treasure&&1!==n.fog[s]&&(o.objectTarget={q:e,r:t})},evaluateJogSpot:function(e,t,n,r,i){},evaluateTownSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex;if(1!==n.fog[s]&&"OK"===game.canMakeBuildingHere("town",e,t,s)&&!game.world.hasNearBuilding(e,t)){var a=rl.evaluateHarvestSpot(e,t,n,r,i);(a>o.bestTownValue||a===o.bestTownValue&&r<o.bestTownDistance)&&(o.bestTownDistance=r,o.bestTownValue=a,o.townTarget={q:e,r:t,desperate:!1})}},evaluateHarvestSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex,a=0,l={};return game.world.hexGrid.forEachNeighbor(e,t,(function(e){if(e.value.bonus){var t=1;if(game.world.hasNearBuilding(e.q,e.r)){var n=game.makeClaimList(e.q,e.r,e.value,!1);n.contested?t=.33:n.length>0&&n[0].civIndex===s&&(t=0)}var r=e.value.bonus.bonusEntry.extra;l[r]?a+=t:(a+=o.want[r]*t,t>=1&&(l[r]=!0))}})),a},evaluateExpansionSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex;if(1!==n.fog[s]&&"OK"==game.canMakeBuildingHere("expansion",e,t,s)){var a=rl.evaluateHarvestSpot(e,t,n,r,i);a>=1&&game.world.hasNeighborBuilding(e,t,"city",s)&&(a*=2,rl.log(i,"exp at "+e+","+t+" has city nearby")),o.buildingCategories.expansion.length<2&&i.points>game.config.pointsToWin-1&&(a=10),a>0&&(a>o.bestExpansionValue||a===o.bestExpansionValue&&r<o.bestExpansionDistance)&&(o.bestExpansionDistance=r,o.bestExpansionValue=a,o.expansionTarget={q:e,r:t})}},evaluateVictoryBuildingSpot:function(e,t,n,r,i){var o=i.aiData,s=i.civIndex,a=o.nextVictoryBuilding;"OK"===game.canMakeBuildingHere(a,e,t,s)&&r<o.bestVictoryBuildingDistance&&(o.bestVictoryBuildingDistance=r,o.victoryBuildingTarget={q:e,r:t})},targetPathStillValid:function(e){if(!e.aiData.target)return!1;var t=e.hero,n=e.aiData.target,r={start:{q:t.pos.q,r:t.pos.r},end:{q:n.q,r:n.r},blockingSet:"ai"+e.civIndex};return game.world.hexGrid.findPath(r),r.valid},updateHero:function(e,t){if(e.aiData.target){var n=e.hero,r=(t=n.civIndex,e.aiData.target),i={start:{q:n.pos.q,r:n.pos.r},end:{q:r.q,r:r.r},blockingSet:"ai"+t};if(game.world.hexGrid.findPath(i),!i.valid){var o=game.world.hexGrid.getValueAt(r.q,r.r);return o.aiData[t].problem=-1,o.aiData[t].problemRecheckTurn=game.turns.turn+rl.RECHECK_BAD_HEX_TURNS,console.log("civ "+t+" no valid path to target "+r.q+","+r.r+" : type "+r.type),o.creature?o.aiData[t].problemRecheckTurn=game.turns.turn+rl.RECHECK_CREATURE_HEX_TURNS:rl.isHeroAt(r.q,r.r,t)>=0&&(o.aiData[t].problemRecheckTurn=game.turns.turn+rl.RECHECK_HERO_HEX_TURNS),void(e.aiData.target=null)}if(i.path.length>0){var s=i.path[0];game.tryCivHeroMoveTo(e,s.q,s.r)||rl.log(e,"failed move to "+s.q+", "+s.r)}n.pos.q===r.q&&n.pos.r===r.r&&(e.aiData.target=null);for(var a=game.world.removeFogFrom(n.pos.q,n.pos.r,t),l=0;l<a.length;l++){a[l].val.creature&&(rl.log(e,"yikes! creature!"),e.aiData.target=null)}}else console.log("civ "+t+" no target, no move "+game.turns.turn)},serialize:function(e){if(!e.isAI)return{};var t=e.aiData;return{attitude:t.attitude,knownResources:{totalPrev:t.knownResources?t.knownResources.totalPrev:0},target:t.target,rngState:t.rng.getState()}},deserialize:function(e,t){e.isAI&&t?e.aiData=t:e.aiData={}},log:function(e,t){app.config.debugCiv===e.civIndex&&console.log("AI("+e.civIndex+"): "+t)}};const il=rat.spaces.HexGrid;var ol={oneTimeInit:function(){},init:function(){},getDefaultAIData:function(e){for(var t={civs:[]},n=0;n<e;n++)t.civs[n]={seenTurns:0};return t},updateTurn:function(){for(var e=0;e<game.creatures.length;e++){var t=game.creatures[e];if(!t.isDead){for(var n=t.aiData,r=0;r<game.civs.length;r++){var i=n.civs[r],o=game.civs[r];!o.isDead&&il.isNeighbor(t.pos.q,t.pos.r,o.hero.pos.q,o.hero.pos.r)?(i.seenTurns++,i.seenTurns<=t.classInfo.turnsBeforeAttack?game.turns.addTurnPart({type:"effectFlashup",actor:t,effectCode:"monster_notice",pos:t.pos}):game.tryCreatureAttack(t,o.hero)&&void 0!==t.classInfo.setTurnsAfterAttack&&(i.seenTurns=t.classInfo.setTurnsAfterAttack)):i.seenTurns=0}ol.updateIdleAnim(t)}}},updateIdleAnim:function(e){for(var t=!1,n=0;n<game.civs.length;n++){var r=e.aiData.civs[n],i=game.civs[n];if(!i.isDead&&il.isNeighbor(e.pos.q,e.pos.r,i.hero.pos.q,i.hero.pos.r)&&r.seenTurns>=e.classInfo.turnsBeforeAttack){t=!0;break}}e.animSet.useIdle=t?"angry":"idle",e.animSet.setAnimByName(e.animSet.useIdle)}};const sl={resFlashes:[],reset:function(){sl.resFlashes=[]},resourceFlashup:function(e,t,n,r,i,o){if(void 0===i&&(i=1),o||(o=0),n.length<2)console.log("ERROR! flashups need at least a source and dest");else{for(var s=0;s<n.length;s++){var a=n[s];a.endTime||(a.endTime=.4),"shake"===a.posCode&&!1===a.origPos&&(console.log("WHAT weird shake bug, with civIndex "+e+" and resName "+t),console.log(a)),"hero"===a.posCode&&e===app.config.showForCiv&&(a.endTime=.2),a.scale||(a.scale=1,0==s&&(a.scale=2)),void 0===a.rot&&(a.rot=0)}for(s=0;s<i;s++){var l={time:0-(o+.2*s),endTime:n[1].endTime,civIndex:e,resName:t,value:r,stages:rat.utils.copyObject(n,!0),curStage:0};sl.resFlashes.push(l)}}},update:function(e){for(var t=sl.resFlashes,n=t.length-1;n>=0;n--){var r=t[n];r.time+=e;var i=r.stages[r.curStage],o=r.stages[r.curStage+1];if(r.time>=0&&!i.started&&(i.started=!0,"subFromHud"===i.startActionCode&&sl.updateHudDelta(r.civIndex,r.resName,-r.value)),r.time>r.endTime)if(o.actionCode&&game.hud.actionPanelGroup.actionCostFinished(o.actionCode),"hero"===o.posCode&&r.civIndex===app.config.showForCiv){o.posCode="hud",o.actionCode=0,o.endActionCode="addToHud";var s=game.civs[r.civIndex].hero.pos,a=game.hexToPixelPos(s.q,s.r);i.pos=a,i.posCode=null,o.layer="hud",i.layer="hud",r.layer="hud",r.time=0,r.endTime=.3}else r.curStage<r.stages.length-2?(r.curStage++,r.time=0,r.endTime=r.stages[r.curStage+1].endTime):t.splice(n,1),"addToHud"===o.endActionCode&&sl.updateHudDelta(r.civIndex,r.resName,r.value)}},updateHudDelta:function(e,t,n){"points"===t?(game.civs[e].showPoints+=n,app.rules.updateAllCivProgress(game.civs)):(game.civs[e].resources[t].showCount+=n,game.hud.updateResourcePanel())},draw:function(e,t){t=t||"hud";for(var n=sl.resFlashes,r=0;r<n.length;r++){var i=n[r];if(i.time<0)continue;var o=i.stages[i.curStage],s=i.stages[i.curStage+1];if((o.layer||"hud")==t){var a=i.time/i.endTime;a=rat.ui.Animator.filterEaseInOut(a);for(var l=i.curStage;l<=i.curStage+1;l++){var c=i.stages[l];if("hud"===c.posCode)"points"===i.resName?c.pos=game.hud.pointsDisplayPos(i.civIndex):c.pos=game.hud.resourceDisplayPos(i.resName);else if("hero"===c.posCode||"hero_intermediate"===c.posCode){var u=game.civs[i.civIndex].hero.pos;"world"===c.layer?c.pos=game.hexToWorldPos(u.q,u.r):c.pos=game.hexToPixelPos(u.q,u.r)}else if("shake"===c.posCode){c.pos=c.origPos;c.pos.x+=20*Math.random()-10,c.pos.y+=20*Math.random()-10}}if(o.pos&&s.pos){var h=rat.math.interpolate(o.rot,s.rot,a),d=rat.math.interpolate(o.scale,s.scale,a),p=rat.math.interpolate(o.pos.x,s.pos.x,a),g=rat.math.interpolate(o.pos.y,s.pos.y,a);gfx.drawResource(i.resName,p,g,h,d*app.config.graphics.resourceSize)}}}}},al={init:function(e){this.turn=0,this.timeSinceTurnStart=0,this.turnParts=[],this.turnPartIndex=0,this.speedMult=1},update:function(e){if("turn"===game.state){e=this.speedMult*e;app.config.aiTest&&(e=1),this.updateTurnParts(e)}this.timeSinceTurnStart+=e},commitTurn:function(){game.updateCivConsciousness(),rl.updateTurn(),this.addTurnPart({type:"sync"}),ol.updateTurn(),this.addTurnPart({type:"sync"}),this.addTurnPart({type:"worldUpdate"}),this.addTurnPart({type:"resourceCollection"}),this.addTurnPart({type:"objects"}),this.addTurnPart({type:"checkWinner"}),this.addTurnPart({type:"meetCivs"}),this.startTurnParts()},insertTurnPart:function(e,t){e.civ&&(this.checkToFlushTurnList(e.civ.civIndex,e.type)&&console.log("!shouldn't need flush in addTurnPart"));return e.timeDelay||(e.timeDelay=0),e.time=0,e.timeMax||(e.timeMax=0,"civRest"===e.type&&(e.timeMax=.1),"civMove"===e.type&&(e.civ.isAI?(e.timeDelay=.2,e.timeMax=.3):e.timeMax=.5),"civShove"===e.type&&(e.timeMax=.5),"attack"!==e.type&&"getHit"!==e.type&&"civKnockedDown"!==e.type&&"civShoveKnockout"!==e.type||(e.timeMax=.5),"creatureDeath"===e.type&&(e.timeMax=.6),"awardPoints"===e.type&&(e.timeMax=1.3),"creatureTreasure"===e.type&&(e.timeMax=1),"civBuild"===e.type&&(e.timeMax=1)),void 0===e.blocks&&(e.blocks=!1),"sync"!==e.type&&"creatureDeath"!==e.type&&"creatureTreasure"!==e.type&&"civDeath"!==e.type&&"awardPoints"!==e.type||(e.blocks=!0),void 0===e.hideInvisible&&(e.hideInvisible=!0,"sync"!==e.type&&"worldUpdate"!==e.type&&"resourceCollection"!==e.type&&"updateCivConsciousness"!==e.type&&"objects"!==e.type&&"checkWinner"!==e.type&&"meetCivs"!==e.type&&"applyCost"!==e.type&&"applyBuildingCost"!==e.type&&"postActionButtonUpdate"!==e.type||(e.hideInvisible=!1)),e.wasHidden=!1,e.hideInvisible&&(e.checkVisPos=[],e.pos&&e.checkVisPos.push(e.pos),e.info&&e.info.pos&&e.checkVisPos.push(e.info.pos),e.info&&e.info.fromPos&&e.checkVisPos.push(e.info.fromPos),e.info&&e.info.toPos&&e.checkVisPos.push(e.info.toPos),e.checkVisPos.length<1&&console.log("Error:  hideInvisible set, but no positions to check: "+e.type)),t<0&&(t=this.turnParts.length+t),this.turnParts.splice(t,0,e),e},addTurnPart:function(e){return this.insertTurnPart(e,this.turnParts.length)},addTimeDelayTurnPart:function(e){this.addTurnPart({type:"sync",timeDelay:e})},startTurnParts:function(){this.turnPartIndex=0,game.setState("turn")},updateTurnParts:function(e){for(var t=this.turnPartIndex;t<this.turnParts.length;t++){var n=this.turnParts[t];if(this.processTurnPart(n,e),n.timeDelay<=0&&n.time>=n.timeMax&&this.turnPartIndex===t&&this.turnPartIndex++,n.blocks)break}this.turnPartIndex>=this.turnParts.length&&this.finishTurn()}};var ll=function(e){return!e.wasHidden||!(!e.civ||e.civ.civIndex!==game.playerCivIndex)};const cl=function(e){var t=app.Buildings.isAnyVictoryBuilding(e.buildingCode);if(game.showBuilding(e.civ,e.pos),!e.wasHidden){if(t){var n=app.Buildings.getChainInfo(e.buildingCode);qa.builtVictoryBuildingEffect(e.civ.civIndex,e.pos.q,e.pos.r,e.buildingCode,n.chainIndex)}qa.builtBuildingEffect(e.civ.civIndex,e.pos.q,e.pos.r,e.buildingCode)}t?za.playSound("build_big"):ll(e)&&za.playSound("build")};al.processTurnPart=function(e,t){if(!e.complete){var n;if(e.isFirstUpdate=!1,e.time<=0&&(e.isFirstUpdate=!0),e.hideInvisible)e.hideInvisible=!1,game.checkPosListVisible(e.checkVisPos)||(e.wasHidden=!0,e.timeDelay=0,e.time=e.timeMax);if(e.timeDelay>0){if(e.timeDelay-=t,e.timeDelay>0)return}else e.time+=t;if((n=e.timeMax<=0?1:e.time/e.timeMax)<0&&(n=0),n>=1&&(n=1,e.complete=!0),e.doProcess)e.doProcess(e,n);else if("civRest"===e.type)e.complete&&ll(e)&&za.playSound("rest");else if("civMove"===e.type){var r=e.useAnimName||"hop";g(e,e.civ,r,"idle",e.info.fromPos,e.info.toPos,n),e.civ.hero.displayPos.q=rat.math.interpolate(e.info.fromPos.q,e.info.toPos.q,n),e.civ.hero.displayPos.r=rat.math.interpolate(e.info.fromPos.r,e.info.toPos.r,n),e.complete&&ll(e)&&za.playSound("step")}else if("civShove"===e.type)e.civ.hero.displayPos.q=rat.math.interpolate(e.info.fromPos.q,e.info.toPos.q,n),e.civ.hero.displayPos.r=rat.math.interpolate(e.info.fromPos.r,e.info.toPos.r,n),e.complete&&game.world.removeFogFrom(e.info.toPos.q,e.info.toPos.r,e.civ.civIndex);else if("civKnockedDown"===e.type)g(e,e.civ,"hit_knocked_down","idle",e.info.toPos,null,n);else if("civDeath"!==e.type||e.done)if("civShoveKnockout"===e.type)e.complete&&game.knockCivOut(e.civ,3);else if("civBuild"===e.type){var i=g(e,e.civ,"build","idle",e.pos,null,n);e.isFirstUpdate&&(e.complete?cl(e):i.getCurAnim().setOnTrackChange("root","event_0",(function(t){1===t&&cl(e)})))}else if("worldUpdate"===e.type)game.world.updateTurn();else if("updateCivConsciousness"===e.type)game.updateCivConsciousness();else if("resourceCollection"===e.type)game.handleResourceCollection();else if("objects"===e.type)game.handleObjects();else if("checkWinner"===e.type)app.rules.updateAllCivProgress(game.civs,!0);else if("meetCivs"===e.type)game.updateMet();else if("applyBuildingCost"===e.type){var o=app.Buildings.getCost(e.buildingCode,e.civ);game.animateAndApplyCost(o,e.civ,{actionCode:e.buildingCode})}else if("attack"!==e.type||e.done)if("monsterClashEffect"===e.type)!e.wasHidden&&e.isFirstUpdate&&qa.monsterClashEffect(e.info.fromPos,e.info.toPos,e.opts);else if("getHit"===e.type){h=(s=e.actor.hero||e.actor).animSet.useIdle||"idle";g(e,e.actor,"got_hit",h,e.info.toPos,e.info.fromPos,n)}else if("clashEffect"===e.type)e.isFirstUpdate&&qa.clashEffect(e.info.fromPos,e.info.toPos,e.opts),e.complete&&ll(e)&&za.playSound("attack_civ_clash");else if("knockedDownEffect"===e.type)e.isFirstUpdate&&qa.clashEffect(e.info.fromPos,e.info.toPos,e.opts),e.complete&&ll(e)&&za.playSound("attack_civ_knock");else if("shoveSlideEffect"===e.type){var s=e.actor.hero||e.actor;e.isFirstUpdate&&qa.shoveSlideEffect(s,e.opts)}else if("stealResult"===e.type)game.turnStealResult(e.civ,e.tCiv,e.resource);else if("creatureDeath"===e.type){if(!e.done){e.done=!0;var a=e.info;if(game.resolveCreatureDeath(a),e.info.classInfo.deathAudibleEverywhere||ll(e)){p=a.classInfo.audioTag;za.playSound(p+"_die")}if(!e.wasHidden){var l=game.hud.worldDisplay.hexToPixelPos(a.pos.q,a.pos.r);qa.addFlash({pos:l,time:0,endTime:.8,start:{scale:{x:1,y:1},rot:0,alpha:1},end:{scale:{x:4,y:4},rot:Math.PI,alpha:0},image:gfx.getImage(a.asset),easing:rat.ui.Animator.filterEaseIn})}}}else if("creatureTreasure"===e.type)e.done||(e.done=!0,game.dropCreatureTreasure(e.civ,e.info));else if("effectFlashup"!==e.type||e.done){if("awardPoints"===e.type){if(!e.done){e.done=!0;var c=game.awardPointsFor(e.actionCode,e.civ.civIndex);if(c&&e.civ.civIndex===app.config.showForCiv){e.civ.showPoints-=c;var u=game.hud.getActionButtonPointsPos(e.actionCode);u||(u=game.hexToPixelPos(e.pos.q,e.pos.r,!1)),sl.resourceFlashup(e.civ.civIndex,"points",[{pos:u,scale:1},{pos:u,scale:2},{pos:u,scale:3},{posCode:"hud",endActionCode:"addToHud",value:1}],1,c,0),za.playSound("points_start")}else e.time=e.timeMax,n=1}n>=1&&(game.trackProgressFor(e.actionCode,e.civ.civIndex),e.civ.civIndex===app.config.showForCiv&&game.revealMyCivProgress(),app.rules.updateAllCivProgress(game.civs))}}else{if(e.done=!0,game.world.hexGrid.getValueAt(e.pos.q,e.pos.r).fog[app.config.showForCiv]<1&&qa.flashup(e.effectCode,e.pos.q,e.pos.r,e.effectOpts),ll(e)&&e.isFirstUpdate&&"monster_notice"===e.effectCode){p=e.actor.classInfo.audioTag;za.playSound(p+"_growl")}}else{var h=e.actor.animSet.useIdle||"idle",d=e.animID||"attack";if(g(e,e.actor,d,h,e.info.fromPos,e.info.toPos,n),e.isFirstUpdate&&ll(e))if(e.target.isMonster)za.playSound("attack_monster"),console.log("attack monster sound");else if(e.actor.isMonster){var p=e.actor.classInfo.audioTag;za.playSound(p+"_attack"),console.log("monster sound")}}else e.done=!0,game.knockCivOut(e.civ)}function g(e,t,n,r,i,o,s){var a=(t=t.hero||t).animSet;if(e.complete)a.setAnimByName(r),a.setTime(0);else if(e.isFirstUpdate){a.setAnimByName(n);var l=a.getCurAnim();if(i&&o){var c=!1,u=!1,h=game.world.hexGrid.axialToPixelPos(i.q,i.r),d=game.world.hexGrid.axialToPixelPos(o.q,o.r),p=d.y-h.y,g=d.x-h.x;if(d.x<h.x&&(c=!0,u=!0,g*=-1,p*=-1),l.setFlipX(c),l.setFlipRotation(u),l.applySpecialXRotation){var m=Math.atan2(p,g);l.setAnimSpecialXRotation(m)}}l.setInterpTime(0)}else{(l=a.getCurAnim()).setInterpTime(s)}return a}},al.finishTurn=function(){game.hud.updateResourcePanel(),this.turnParts=[],this.turn++,game.hud.updateTurn(),this.timeSinceTurnStart=0,game.setState("play"),game.input.hasPending()||(this.speedMult=1,"play"===game.state&&app.settings.autoSaveEachTurn&&app.saver.saveToSettings())},al.checkToFlushTurnList=function(e,t){if(!this.turnParts.length)return!1;if(!(e===game.playerCivIndex&&("civMove"===t||"civRest"===t)))return!1;for(;this.turnParts.length;)this.updateTurnParts(.03);return!0},al.clearTurnList=function(){this.turnParts=[],this.turnPartIndex=0};var ul={};const hl={dimension:36,tileCount:308},dl={dimension:40,tileCount:420},pl={dimension:44,tileCount:540},gl=hl.dimension;ul.defaults={gameConfig:{WORLD_W:gl,WORLD_H:gl,aiCivCount:2,aiDifficulty:3,pointsToWin:12,baseRewardCards:2,rareRewardCards:0,lossRewardCards:1,awardAICards:!1,hasWar:!0,hasCreatures:!0,hasPets:!0,hasSearch:!0,hasCityExpansions:!0,hasScienceVictory:!0,hasMoneyVictory:!0,hasProductionVictory:!0,treasureMin:10,treasureMax:14,resourceCap:30,allowTradeLevel:20,showExtraResources:!0,tradeRate:5},landConfig:{style:"thumb",targetSize:"small",bonusTargets:[{name:"food",percent:3.5},{name:"science",percent:2.5},{name:"production",percent:1.7},{name:"money",percent:1.7},{name:"war",percent:1.5}]}},ul.templates={},ul.templates.custom={name:"Custom Game",shortName:"Custom",gameConfig:{aiCivCount:2,aiDifficulty:3,pointsToWin:12,adaptRewards:!0,showExtraResources:!0},landConfig:{style:"thumb",targetSize:"small"}},ul.templates.daily={name:"Daily",shortName:"Daily",gameConfig:{aiCivCount:3,aiDifficulty:4,pointsToWin:12,adaptRewards:!1,baseRewardCards:3,lossRewardCards:1,rareRewardCards:0,showExtraResources:!0},landConfig:{style:"thumb",targetSize:"small"}},ul.templates.introGame={name:"Introductory Game",shortName:"Intro",nextScenario:"normalGame",nextScenarioButtonName:"new normal game",resultsShowIntro:!0,resultsNextButtonTip:"start a new normal game",resultsNextButtonName:"new",gameConfig:{hasWar:!1,hasCreatures:!1,hasPets:!1,hasCityExpansions:!1,treasureMin:8,treasureMax:13,aiDifficulty:1,pointsToWin:4,baseRewardCards:0,lossRewardCards:0,allowTradeLevel:100,showExtraResources:!1},landConfig:{map:"res/maps/intro1.json",landFullyDefined:!0,requireScienceStart:!0,bonusAdds:{science:2}}},ul.templates.normalGame={name:"Warlord Game",shortName:"Warlord",gameConfig:{aiCivCount:2,aiDifficulty:2,baseRewardCards:2,lossRewardCards:1}},ul.templates.advancedGame={name:"Prince Game",shortName:"Prince",gameConfig:{aiCivCount:3,aiDifficulty:3,awardAICards:!0,baseRewardCards:3,lossRewardCards:2}},ul.templates.difficultGame={name:"King Game",shortName:"King",gameConfig:{aiCivCount:3,aiDifficulty:4,awardAICards:!0,baseRewardCards:4,lossRewardCards:2}},ul.templates.veryDifficultGame={name:"Emperor Game",shortName:"Emperor",gameConfig:{aiCivCount:3,aiDifficulty:5,awardAICards:!0,baseRewardCards:4,rareRewardCards:1,lossRewardCards:2}},ul.templates.extraDifficultGame={name:"Deity Game",shortName:"Deity",gameConfig:{aiCivCount:3,aiDifficulty:6,awardAICards:!0,baseRewardCards:4,rareRewardCards:2,lossRewardCards:2}},ul.testScenario=ul.templates.advancedGame,ul.getScenarioByName=function(e){var t={intro:"introGame",intro2:"introGame2",warlord:"normalGame",prince:"advancedGame",king:"difficultGame",emperor:"veryDifficultGame",deity:"extraDifficultGame"};return t[e]&&(e=t[e]),ul.templates[e]},ul.oneTimeInit=function(){for(var e in ul.templates)ul.templates[e].key=e},ul.prepCustomScenario=function(e){rat.utils.extendObject(e,ul.templates.custom,!0);var t=e.gameConfig,n=null;for(var r in ul.templates)if("custom"!==r){var i=ul.templates[r];if(i.gameConfig.aiDifficulty===t.aiDifficulty){n=i;break}}if(t.adaptRewards){if(n&&t.aiDifficulty>=3&&t.aiCivCount>=1){var o=n.gameConfig;t.baseRewardCards=o.baseRewardCards,t.rareRewardCards=o.rareRewardCards}else t.aiDifficulty>=2&&t.aiCivCount>=1?t.baseRewardCards=2:t.baseRewardCards=1,t.rareRewardCards=0;t.lossRewardCards=1}return e},ul.readyScenario=function(e){var t,n=rat.utils.copyObject(e,!0);if(rat.utils.extendObject(n,ul.defaults,!0),!n.gameConfig.hasWar)for(var r=n.landConfig.bonusTargets.length-1;r>=0;r--)"war"===n.landConfig.bonusTargets[r].name&&n.landConfig.bonusTargets.splice(r,1);return t="xlarge"===n.landConfig.targetSize?pl:"large"===n.landConfig.targetSize?dl:hl,n.gameConfig.WORLD_W=n.gameConfig.WORLD_H=t.dimension,n.landConfig.targetTileCount=t.tileCount,n.landConfig.linearSizeScaleFactor=n.gameConfig.WORLD_W/gl,app.config.debugAICivCount&&(n.gameConfig.aiCivCount=app.config.debugAICivCount),n.gameConfig.civCount=n.gameConfig.aiCivCount+1,n},ul.serialize=function(e){var t=ul.templates[e.key],n=ul.readyScenario(t),r=rat.utils.diff(n,e);return{k:e.key,d:r}},ul.deserialize=function(e){var t=ul.templates[e.k],n=ul.readyScenario(t);return rat.utils.applyDiff(n,e.d)};const ml={arrowsPending:{},init:function(){ml.pending=[],ml.clickPath=null},update:function(e){"play"===game.state&&this.processPending()},hasPending:function(){return ml.pending.length},addPending:function(e){if("victory"!==game.state&&(ml.pending.push(e),"play"===game.state&&1===ml.pending.length&&ml.processPending(),ml.pending.length)){var t=Math.min(ml.pending.length+1,4);game.turns.speedMult<t&&(game.turns.speedMult=t)}},clearPending:function(){ml.pending=[]},processPending:function(){if(ml.pending.length){var e=ml.pending.shift();if("hexClick"===e.type)ml.processHexClick(e.hexPos)||game.input.clearPending();else"actionButton"===e.type?game.hud.actionPanelGroup.processKeyDown(e):"moveKey"===e.type?game.input.processMoveKey(e.moveInfo):"restKey"===e.type&&game.restMove()}},allowMoveEntry:function(){return!0},handleHexClick:function(e){ml.addPending({type:"hexClick",hexPos:e})},processHexClick:function(e){if(game.playerCiv.isDead)return game.restMove(),!0;if(ml.planClickPath(e),ml.clickPath&&ml.clickPath.path.length>0&&ml.clickPath.end.q===e.q&&ml.clickPath.end.r===e.r){var t=ml.clickPath.path.length,n={q:game.hero.pos.q,r:game.hero.pos.r};if(e=ml.clickPath.path[0],game.checkNeighborAndMove(game.hero.pos,e)){ml.planClickPath(ml.clickPath.end);var r=game.hud.worldView.getCenteredContentPos(),i=game.hud.worldDisplay.hexToPixelPos(n.q,n.r),o=game.hud.worldDisplay.hexToPixelPos(game.hero.pos.q,game.hero.pos.r),s=i.x-r.x,a=i.y-r.y,l=o.x-r.x,c=o.y-r.y,u=Math.abs(s),h=Math.abs(a),d=Math.abs(l),p=Math.abs(c);if((d>u||p>h)&&t<=1){var g=game.hud.scrollToShowHero(game.playerCivIndex,1.5,.5);if(g){var m=g.getStartVector(),f=g.getEndVector();d<=u&&(f.x=m.x),p<=h&&(f.y=m.y),g.setEndVector(f)}}return!0}return ml.planClickPath(ml.clickPath.end),!0}return e.q===game.hero.pos.q&&e.r===game.hero.pos.r?(game.restMove(),!0):!!game.checkNeighborAndMove(game.hero.pos,e)},planClickPath:function(e){this.clickPath=null,rl.updateBlocking(game.playerCiv,0,e);var t={start:{q:game.hero.pos.q,r:game.hero.pos.r},end:{q:e.q,r:e.r},settings:{prioritizeXYDistance:!0}};game.world.hexGrid.findPath(t),t.valid&&t.path.length>0&&(this.clickPath=t)},clearClickPath:function(e){this.clickPath=null},mouseMove:function(e,t){},mouseDown:function(e,t){},handleKeyUp:function(e){if(!ml.actualArrowKeyEventDir(e)||e.sysEvent.shiftKey||e.sysEvent.ctrlKey)this.arrowsPending={};else{for(var t=[{keys:[rat.input.keys.leftArrow,rat.input.keys.upArrow],move:{dq:0,dr:-1}},{keys:[rat.input.keys.rightArrow,rat.input.keys.upArrow],move:{dq:1,dr:-1}},{keys:[rat.input.keys.leftArrow,rat.input.keys.downArrow],move:{dq:-1,dr:1}},{keys:[rat.input.keys.rightArrow,rat.input.keys.downArrow],move:{dq:0,dr:1}},{keys:[rat.input.keys.leftArrow],move:{dq:-1,dr:0}},{keys:[rat.input.keys.rightArrow],move:{dq:1,dr:0}}],n=null,r=0;r<t.length;r++){var i=!1;n=t[r];for(var o=0;o<n.keys.length;o++){var s=n.keys[o];if(!this.arrowsPending[s]){n=null;break}e.which===s&&(i=!0)}if(n&&i)return game.input.addPending({type:"moveKey",moveInfo:n.move}),this.arrowsPending={},!0}rat.input.keyboard.isKeyDown(rat.input.keys.leftArrow)||rat.input.keyboard.isKeyDown(rat.input.keys.rightArrow)||rat.input.keyboard.isKeyDown(rat.input.keys.upArrow)||rat.input.keyboard.isKeyDown(rat.input.keys.downArrow)||(this.arrowsPending={})}return!1},handleKeyDown:function(e){if(app.settings.admin&&!app.settings.release){if(e.which>=rat.input.keys[0]&&e.which<=rat.input.keys[9]&&e.sysEvent.ctrlKey||e.which===rat.input.keys[0]&&e.sysEvent.shiftKey){if(e.which===rat.input.keys[0]){for(var t in app.World.resourceTypes)game.giveResource(app.config.showForCiv,t,1,50,!0);return game.hud.updateResourcePanel(),!0}var n=this.numberKeyToResource(e);if(n)return game.giveResource(app.config.showForCiv,n,1,5,!0),game.hud.updateResourcePanel(),!0}if(e.which===rat.input.keys.p)return qa.testEffect(),!0;if(e.which===rat.input.keys.f)return game.testFlashup(),!0;e.which===rat.input.keys.backslash&&(console.log("toggle aiTest"),app.config.aiTest=!app.config.aiTest)}if(ml.actualArrowKeyEventDir(e)&&!e.sysEvent.repeat)return this.arrowsPending[e.which]=!0,!0;var r=game.input.isHexMoveKey(e);return!r||r.shiftKey||r.ctrlKey?e.which===rat.input.keys.esc?(game.hud.doPauseMenu(),!0):(e.which===rat.input.keys.numPad5||e.which===rat.input.keys.period||e.which===rat.input.keys.space)&&(game.input.addPending({type:"restKey"}),!0):(game.input.addPending({type:"moveKey",moveInfo:r}),!0)},processMoveKey:function(e){if(!game.playerCiv.isDead){game.hud.clearHexTip(),game.tryHeroMove(e.dq,e.dr),this.clickPath=null;var t=2.5,n=game.hud.getWorldScale();return n<1.5&&(t=3.75/n),t=Math.min(t,4),console.log("world space "+t),game.hud.scrollToShowHero(game.playerCivIndex,t,.5),!0}return game.restMove(),!1},directionKeys:[{keys:[rat.input.keys.numPad7,rat.input.keys.y],dir:{dq:0,dr:-1,dx:-1,dy:-1}},{keys:[rat.input.keys.numPad8,rat.input.keys.k,rat.input.keys.upArrow],dir:{dx:0,dy:-1}},{keys:[rat.input.keys.numPad9,rat.input.keys.u],dir:{dq:1,dr:-1,dx:1,dy:-1}},{keys:[rat.input.keys.numPad4,rat.input.keys.h,rat.input.keys.leftArrow],dir:{dq:-1,dr:0,dx:-1,dy:0}},{keys:[rat.input.keys.numPad6,rat.input.keys.l,rat.input.keys.rightArrow],dir:{dq:1,dr:0,dx:1,dy:0}},{keys:[rat.input.keys.numPad1,rat.input.keys.b],dir:{dq:-1,dr:1,dx:-1,dy:1}},{keys:[rat.input.keys.numPad2,rat.input.keys.j,rat.input.keys.downArrow],dir:{dx:0,dy:1}},{keys:[rat.input.keys.numPad3,rat.input.keys.n],dir:{dq:0,dr:1,dx:1,dy:1}}],isHexMoveKey:function(e){for(var t=ml.translateFakeArrowKeyEvent(e),n={shiftKey:t.shiftKey,ctrlKey:t.ctrlKey},r=0;r<ml.directionKeys.length;r++){var i=ml.directionKeys[r];if(i.keys.indexOf(t.which)>=0&&(i.dir.dq||i.dir.dr))return n.dq=i.dir.dq,n.dr=i.dir.dr,n}return null},isDirKey:function(e){for(var t=ml.translateFakeArrowKeyEvent(e),n={shiftKey:t.shiftKey,ctrlKey:t.ctrlKey},r=0;r<ml.directionKeys.length;r++){var i=ml.directionKeys[r];if(i.keys.indexOf(t.which)>=0)return n.dx=i.dir.dx,n.dy=i.dir.dy,n}return null},translateFakeArrowKeyEvent:function(e){var t={which:e.which,timestamp:e.sysEvent.timestamp,code:e.sysEvent.code,key:e.sysEvent.key,shiftKey:e.sysEvent.shiftKey,ctrlKey:e.sysEvent.ctrlKey};e.which;var n={Numpad1:rat.input.keys.numPad1,Numpad2:rat.input.keys.numPad2,Numpad3:rat.input.keys.numPad3,Numpad4:rat.input.keys.numPad4,Numpad5:rat.input.keys.numPad5,Numpad6:rat.input.keys.numPad6,Numpad7:rat.input.keys.numPad7,Numpad8:rat.input.keys.numPad8,Numpad9:rat.input.keys.numPad9},r={Home:rat.input.keys.numPad1,ArrowUp:rat.input.keys.numPad2,PageUp:rat.input.keys.numPad3,ArrowLeft:rat.input.keys.numPad4,Clear:rat.input.keys.numPad5,ArrowRight:rat.input.keys.numPad6,End:rat.input.keys.numPad7,ArrowDown:rat.input.keys.numPad8,PageDown:rat.input.keys.numPad9},i=n[e.sysEvent.code];return n[t.code]&&r[t.key]&&(t.which=i,t.shiftKey=!0),t},translateFakeArrowKey:function(e){return ml.translateFakeArrowKeyEvent(e).which},actualArrowKeyEventDir:function(e){return e.sysEvent.code&&"ArrowUp"!==e.sysEvent.code&&"ArrowDown"!==e.sysEvent.code&&"ArrowLeft"!==e.sysEvent.code&&"ArrowRight"!==e.sysEvent.code?null:rat.input.keyToDirection(e.which)},numberKeyToResource:function(e){return e.which===rat.input.keys[1]?"science":e.which===rat.input.keys[2]?"money":e.which===rat.input.keys[3]?"food":e.which===rat.input.keys[4]?"production":e.which===rat.input.keys[5]?"war":null}};var fl={status:{OK:{message:"OK"},PLAYER_DEAD:{message:"Your hero is unconscious.",helpTopics:["dead"]},LACKING_RESOURCE:{message:"First collect the resources shown under the action.",pointAt:"button"},NEEDS_NEAR_RESOURCE:{message:"Towns need to be placed next to resources.",pointAt:"hero"},TOO_NEAR_BUILDING:{message:"Buildings can't be placed next to other buildings.",pointAt:"hero"},ON_BUILDING:{message:"Towns can't be placed on or near other buildings.",pointAt:"hero"},ON_RESOURCE:{message:"Towns need to be next to resources, but not on top of one.",pointAt:"hero"},NEEDS_PASSABLE:{message:"Towns need to be on accessible terrain.",pointAt:"hero"},NEEDS_TOWN:{message:"A City needs to be built on a Town."},NEEDS_CITY:{message:"A Metro needs to be built on a City."},EXPANSION_ON_BUILDING:{message:"Expansions go next to buildings, not on top of anything.",pointAt:"hero"},EXPANSION_ON_RESOURCE:{message:"Expansions can go near resourecs, but not on top of them.",pointAt:"hero"},NEEDS_NEAR_BUILDING:{message:"Expansions go next to your buildings."},NEEDS_TECH1:{message:"A rocket can be built on the launchpad you already built."},NEEDS_TECH2:{message:"A lander can be built on the rocket you already built."},NEEDS_MONEY1:{message:"Add the security system to a bank you've already built."},NEEDS_MONEY2:{message:"Add a vault to your secured bank."},NEEDS_PROD1:{message:"Monument Stage 2 can be built on the Monument Base you already built."},NEEDS_PROD2:{message:"The Finished Monument can be built on top of Monument Stage 2."},LACKING_SWORDS:{message:"You need the [war_embed]^war^  resource to attack this monster!",pointAt:"heroTarget"},LACKING_SWORDS_SHOVE:{message:"You need the [war_embed]^war^  resource to fight another leader!",pointAt:"heroTarget"}}};function vl(e,t,n){return game.canMakeHeroBuilding(t.code,game.hero,n)}function yl(e,t,n,r){r.unlockButton(t.unlockCode),n.removeButton(t.code),game.trackProgressFor(t.code,app.config.showForCiv),n.updateActionButtons(),app.telemetry.sessionLog("[0:"+t.code+"@"+game.turns.turn+"]")}function wl(e,t,n){e.setEnabled(!1)}function Cl(e,t,n){game.makeHeroBuilding(t.code,game.hero),n.updateEntryCost(t.code);var r=game.playerCiv.actionCounts[t.code];n.buttons[t.code].setEnabled(!1),game.turns.addTurnPart({type:"postActionButtonUpdate",civ:game.playerCiv,doProcess:function(e,n){var i=t;if(e.isFirstUpdate){var o=game.hud.actionPanelGroup;i.buttonCount&&o.removeButton(i.code),i.unlockCode&&o.unlockButton(i.unlockCode),"town"===i.code&&r>1&&o.unlockButton("sciCity"),o.updateActionButtons()}},timeMax:.5}),app.rules.updateAllCivProgress(game.civs),game.showMyCivProgress=!0}var Sl=rat.ui.TextBox.makeSpecialImageString("mini_ui_arrow");fl.list={sciTown:{code:"sciTown",isTech:!0,unlockCode:"town",buttonSlot:0,helpTopics:["towns"],title:"Discover\nTown\nBuilding",tipText:"Use [science_embed]science to discover how to build towns.",unavailableTitle:"Can't Research Yet...",autoApplyCost:!0,cost:{science:1},pos:{x:240,y:300},checkUnlock:function(e,t,n){game.playerCiv.resources.science.count>=1&&n.unlockButton("sciTown")},act:wl,costCompleteAct:yl,turnActionImage:"sci_action",autoEndTurn:!0},sciCity:{code:"sciCity",isTech:!0,unlockCode:"city",buttonSlot:1,helpTopics:["cities"],title:"Discover\nCity\nBuilding",tipText:"Use [science_embed]science to discover how to build cities.",unavailableTitle:"Can't Research Yet...",autoApplyCost:!0,cost:{science:12},pos:{x:240,y:500},act:wl,costCompleteAct:yl,turnActionImage:"sci_action",autoEndTurn:!0},sciExpansion:{code:"sciExpansion",isTech:!0,buttonSlot:4,title:"Discover\nExpansions",helpTopics:["expansions"],tipText:"Use [science_embed]science to discover how to build town expansions.",unavailableTitle:"Can't Research Yet...",autoApplyCost:!0,cost:{science:8},pos:{x:240,y:700},act:wl,costCompleteAct:function(e,t,n,r){n.removeButton(t.code),n.updateActionButtons(),r.unlockExpansionMenu(),app.telemetry.sessionLog("[0:"+t.code+"@"+game.turns.turn+"]")},turnActionImage:"sci_action",autoEndTurn:!0},sciTrade:{code:"sciTrade",isTech:!0,unlockCode:null,buttonSlot:3,title:"Discover\nTrading",helpTopics:["expansions"],tipText:"Use [science_embed]science to discover resource trading.",unavailableTitle:"Can't Trade Yet...",autoApplyCost:!0,cost:{science:5},act:null,costCompleteAct:function(e,t,n){n.removeButton(t.code),n.updateActionButtons(),game.hud.resPanel.allowTradeButtons(),app.telemetry.sessionLog("[0:"+t.code+"@"+game.turns.turn+"]")},turnActionImage:"sci_action",autoEndTurn:!0},sciSearch:{code:"sciSearch",isTech:!0,buttonSlot:2,title:"Detect",helpTopics:["detection"],tipText:"Use [science_embed]science to find things.",unavailableTitle:"Can't Detect Yet...",autoApplyCost:!1,cost:{science:2},act:function(e,t,n){game.hud.showSearchBox(),n.updateActionButtons(),app.telemetry.sessionLog("[0:search@"+game.turns.turn+"]")}},town:{code:"town",buttonSlot:0,buttonCount:$a.types.town.countCap,title:"Build\nTown",helpTopics:["towns","resources","victorypoints"],tipText:"Collect these resources and build a town where your hero stands.\n\nMust be built near (not on) a resource, and not next to another building.",unavailableTitle:"Can't Build Town Yet...",cost:$a.types.town.cost[0],pos:{x:240,y:300},checkConditions:vl,act:Cl,unlockCode:"sciExpansion"},city:{code:"city",buttonSlot:1,buttonCount:$a.types.city.countCap,title:"Town\n"+Sl+"City",helpTopics:["cities"],tipText:"A town can be upgraded into a city, which collects double resources.",unavailableTitle:"Can't Build City...",cost:$a.types.city.cost[0],pos:{x:240,y:300},checkConditions:vl,act:Cl},subExp:{code:"subExp",buttonSlot:4,title:"Expansions\n>>",titleOpen:"Expansions\n<<",helpTopics:["expansions"],tipText:"Click to open expansions menu.",tipTextOpen:"Click to close expansions menu.",unavailableTitle:"Can't Build Expansions...",act:function(e,t,n){game.hud.showSubMenu("expansions")}},expansion:{code:"expansion",buttonSlot:0,buttonSubMenu:1,buttonCount:$a.types.expansion.countCap,title:"Collector",helpTopics:["collectors"],tipText:"Build a collector to extend the harvesting reach of your Town or City.",unavailableTitle:"Can't Build Expansion...",cost:$a.types.expansion.cost[0],checkConditions:vl,act:Cl,unlockCode:["sciCity","sciTech1"]},sciTech1:{code:"sciTech1",isTech:!0,unlockCode:"tech1",buttonSlot:1,buttonSubMenu:1,title:"Discover\nRocketry",helpTopics:["techvictory"],tipText:"Use [science_embed]science to discover how to §travel to Mars§.",unavailableTitle:"Can't Research Yet...",autoApplyCost:!0,cost:{science:12},act:wl,costCompleteAct:yl,turnActionImage:"unlock_victory_action",autoEndTurn:!0},tech1:{code:"tech1",buttonSlot:1,buttonSubMenu:1,buttonCount:$a.types.tech1.countCap,title:"Launch\nPad",helpTopics:["techvictory"],tipText:"Start your §Mars project§.",unavailableTitle:"Can't Build Launch Pad...",cost:$a.types.tech1.cost[0],checkConditions:vl,act:Cl,unlockCode:"tech2"},tech2:{code:"tech2",buttonSlot:1,buttonSubMenu:1,buttonCount:$a.types.tech2.countCap,title:"Rocket",helpTopics:["techvictory"],tipText:"Continue your §Mars project§.",unavailableTitle:"Can't Build Rocket...",cost:$a.types.tech2.cost[0],checkConditions:vl,act:Cl,unlockCode:"tech3"},tech3:{code:"tech3",buttonSlot:1,buttonSubMenu:1,buttonCount:$a.types.tech3.countCap,title:"Mars\nLander",helpTopics:["techvictory"],tipText:"Complete your §Mars project§.",unavailableTitle:"Can't Build Mars Lander...",cost:$a.types.tech3.cost[0],checkConditions:vl,act:Cl},sciMoney1:{code:"sciMoney1",isTech:!0,unlockCode:"money1",buttonSlot:2,buttonSubMenu:1,title:"Buy\nBank\nPlans",helpTopics:["moneyvictory"],tipText:"[money_embed]Buy plans for a $World Bank$.",unavailableTitle:"Can't Buy Plans Yet...",autoApplyCost:!0,cost:{money:10},act:wl,costCompleteAct:yl,turnActionImage:"unlock_victory_action",autoEndTurn:!0},money1:{code:"money1",buttonSlot:2,buttonSubMenu:1,buttonCount:$a.types.money1.countCap,title:"Build\nBank",helpTopics:["moneyvictory"],tipText:"Start your $World Bank$.",unavailableTitle:"Can't Build Yet...",cost:$a.types.money1.cost[0],checkConditions:vl,act:Cl,unlockCode:"money2"},money2:{code:"money2",buttonSlot:2,buttonSubMenu:1,buttonCount:$a.types.money2.countCap,title:"Secure\nBank",helpTopics:["moneyvictory"],tipText:"Upgrade your $World Bank$ with a security system.",unavailableTitle:"Can't Build Yet...",cost:$a.types.money2.cost[0],checkConditions:vl,act:Cl,unlockCode:"money3"},money3:{code:"money3",buttonSlot:2,buttonSubMenu:1,buttonCount:$a.types.money3.countCap,title:"Gold\nVault",helpTopics:["moneyvictory"],tipText:"Complete your $World Bank$ project.",unavailableTitle:"Can't Build Yet...",cost:$a.types.money3.cost[0],checkConditions:vl,act:Cl},sciProd1:{code:"sciProd1",isTech:!0,unlockCode:"prod1",buttonSlot:3,buttonSubMenu:1,title:"Model\nMonument",helpTopics:["prodvictory"],tipText:"[production_embed]Build a model of a ¶Monument¶ that will bring glory to your civilization.",unavailableTitle:"Can't Build Yet...",autoApplyCost:!0,cost:{production:10},act:wl,costCompleteAct:yl,turnActionImage:"unlock_victory_action",autoEndTurn:!0},prod1:{code:"prod1",buttonSlot:3,buttonSubMenu:1,buttonCount:$a.types.prod1.countCap,title:"Monument\nBase",helpTopics:["prodvictory"],tipText:"Start your ¶Monument project¶.",unavailableTitle:"Can't Build Yet...",cost:$a.types.prod1.cost[0],checkConditions:vl,act:Cl,unlockCode:"prod2"},prod2:{code:"prod2",buttonSlot:3,buttonSubMenu:1,buttonCount:$a.types.prod2.countCap,title:"Monument\nStage 2",helpTopics:["prodvictory"],tipText:"Advance your ¶Monument project¶.",unavailableTitle:"Can't Build Yet...",cost:$a.types.prod2.cost[0],checkConditions:vl,act:Cl,unlockCode:"prod3"},prod3:{code:"prod3",buttonSlot:3,buttonSubMenu:1,buttonCount:$a.types.prod3.countCap,title:"Finish\nMonument",helpTopics:["prodvictory"],tipText:"Complete your ¶Monument project¶.",unavailableTitle:"Can't Build Yet...",cost:$a.types.prod3.cost[0],checkConditions:vl,act:Cl}},fl.init=function(){fl.list.sciSearch.cost.science=2},fl.updateSearchCost=function(){fl.list.sciSearch.cost.science=tl.getSearchCost()},fl.actionHotKeys=["q","w","e","r","t"],fl.actionHotKeysShiftKey=!1,fl.subActionHotKeys=["q","w","e","r","t"],fl.subActionHotKeysShiftKey=!0,fl.tradeHotKeys=["1","2","3","4","5"];const bl={};var _l=[{levelName:"1",raceName:"Slime",names:["Snotto","Gooze","Globb","Snrrk","Snulk","Fnorr","Muko","Nozzo","Schnorz","Shump","Boog"],asset:"slime",audioTag:"blob",creatureSize:80,creatureHurtSize:70,minHealth:2,maxHealth:2,minTreasure:4,maxTreasure:4,turnsBeforeAttack:2,setTurnsAfterAttack:0},{levelName:"2",raceName:"Skull",names:["Biter","Gnaw","Bono","Maw","Frac","Jawka","Osteorr","Gnolar","Gnarr"],asset:"skull",audioTag:"skull",minHealth:5,maxHealth:5,minTreasure:7,maxTreasure:7,turnsBeforeAttack:1},{levelName:"3",raceName:"Spider",names:["Swick","Fangor","Spinner","Webula","Sholka","Threak","Shnkk"],asset:"spider",audioTag:"spider",portraitAsset:"spider_portrait",creatureSize:180,creatureHurtSize:160,minHealth:10,maxHealth:10,minTreasure:11,maxTreasure:11,turnsBeforeAttack:1},{levelName:"4",raceName:"Dragon",names:["Kracius","Krolla","Thraxus","Rauhx","Magnor","Drakka","Infernus","Lavka","Agmus","Proxog","Ullox"],asset:"dragon",audioTag:"dragon",deathAudibleEverywhere:!0,creatureSize:130,creatureHurtSize:95,minHealth:45,maxHealth:45,minTreasure:18,maxTreasure:18,turnsBeforeAttack:1}];bl.monsterTable=_l;var xl=["money","food","production","science"];bl.serialize=function(e){for(var t=[],n=0;n<e.length;n++){for(var r=e[n],i={civs:[]},o=0;o<game.civs.length;o++){var s=r.aiData.civs[o].seenTurns;0!==s&&(i.civs[o]={seenTurns:s})}var a={pos:{q:r.pos.q,r:r.pos.r},monsterLevel:r.monsterLevel,treasureType:r.treasureType,treasureCount:r.treasureCount,name:r.name,health:r.health,maxHealth:r.maxHealth,aiData:i};t.push(a)}return t},bl.deserialize=function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r],o=ol.getDefaultAIData(t.length);rat.utils.extendObject(o,i.aiData,!0,!0);var s=_l[i.monsterLevel],a={classInfo:s,pos:{q:i.pos.q,r:i.pos.r},displayPos:{q:i.pos.q,r:i.pos.r},civIndex:-1,monsterLevel:i.monsterLevel,treasureType:i.treasureType,treasureCount:i.treasureCount,code:"monster"+s.levelName,isMonster:!0,name:i.name,asset:s.asset,aiData:o,health:i.health,showHealths:[],lastClashTurn:[],maxHealth:i.maxHealth};n.push(a)}return n},bl.placeCreatures=function(e,t,n,r){var i;if(e){for(var o=0;o<e.length;o++){var s=e[o];r.hexGrid.getValueAt(s.pos.q,s.pos.r).creature=s}i=e}else{var a=[],l=[0,0,0,1,1,1,2,2,3],c=l.length;c>r.creatureStartPoints.length&&(c=r.creatureStartPoints.length);for(o=0;o<_l.length;o++){(h=_l[o]).names=rat.utils.randomizeList(h.names,n.rng),h.nameNextIndex=0}var u=0;for(o=0;o<c;o++){for(var h,d=r.creatureStartPoints[u++],p=l[o],g=(h=_l[p]).names[h.nameNextIndex++]+" the "+h.raceName,m=h.minHealth+Math.floor((h.maxHealth-h.minHealth)*n.rng.random()),f=h.minTreasure+Math.floor((h.maxTreasure-h.minTreasure)*n.rng.random()),v=rat.utils.randomInList(xl,void 0,n.rng),y={pos:{q:d.q,r:d.r},displayPos:{q:d.q,r:d.r},civIndex:-1,monsterLevel:p,treasureType:v,treasureCount:f,isMonster:!0,code:"monster"+h.levelName,name:g,asset:h.asset,aiData:ol.getDefaultAIData(n.civs.length),health:[],lastClashTurn:[],showHealths:[],maxHealth:m,classInfo:h},w=0;w<n.civs.length;w++)y.health[w]=m;a.push(y),r.hexGrid.getValueAt(d.q,d.r).creature=y}i=a}for(w=0;w<i.length;w++){var C=app.animations.makeAnimSet("monster");i[w].animSet=C,ol.updateIdleAnim(i[w])}return i};const Tl={};Tl.dailies=new rat.math.BitList,Tl.generateForDaily=function(e,t,n,r){var i=rat.utils.copyObject(ul.templates.daily,!0);function o(e){return e<10?"0"+e:e}i.shortName=r+"."+o(n+1)+"."+o(t+1),i.name=i.shortName+" Challenge",i.nextScenario=null;var s=new rat.math.rng.Simple;s.setSeed(e),i.gameConfig.showExtraResources=!0,i.gameConfig.aiCivCount=1+3*s.random()|0;var a=[{size:"normal",pointsToWin:12},{size:"large",pointsToWin:15},{size:"xlarge",pointsToWin:18}],l=a[s.random()*a.length|0];return i.landConfig={targetSize:l.size},i.gameConfig.pointsToWin=l.pointsToWin,i.challengeSeed=e,i.challengeDay=e,i},Tl.markDailyWon=function(e,t){void 0===t&&(t=!0),Tl.dailies.setBit(e,t)};const kl=function(e){this.world=e,kl.prototype.parentConstructor.call(this),console.log("Set up world display");this.setPos(0,0),this.setSize(e.getPixelSpace()),this.lastMouseHex={q:-1,r:-1,time:0,touchTime:0,valid:!1,tipValid:!1,tipWanted:!1,mousePos:{x:0,y:0}}};rat.utils.inheritClassFrom(kl,rat.ui.Element),kl.prototype.updateSelf=function(e){for(var t=0;t<game.civs.length;t++){var n=game.civs[t];n.hero.animSet&&n.hero.animSet.update(e)}for(var r=0;r<game.creatures.length;r++){var i=game.creatures[r];i.animSet&&i.animSet.update(e)}var o=this.lastMouseHex.time;if(this.lastMouseHex.time+=e,this.lastMouseHex.valid&&this.lastMouseHex.tipValid&&this.lastMouseHex.tipWanted){var s=!1;this.flags&rat.ui.Element.trackingMouseDownFlag&&(this.lastMouseHex.touchTime+=e,this.lastMouseHex.touchTime>app.config.touchTipTime&&(this.clearFlag(rat.ui.Element.trackingMouseDownFlag),game.input.clickPath&&(game.input.clickPath.valid=!1),s=!0)),"touch"!==rat.input.lastUIInputType&&this.lastMouseHex.time>=app.config.hexTipTime&&o<app.config.hexTipTime&&(s=!0),s&&game.hud.showHexTip(this.lastMouseHex,"touch"==rat.input.lastUIInputType)}},kl.prototype.drawSelf=function(){var e=app.ctx,t=this.world,n=this.parent.localToContentPos(0,0),r=this.parent.localToContentPos(this.parent.size.x,this.parent.size.y);t.renderWorldView(e,{left:n.x,top:n.y,right:r.x,bottom:r.y});for(var i=t.pixelOffset.x,o=t.pixelOffset.y,s=0;s<game.civDrawOrder.length;s++){var a=game.civDrawOrder[s],l=a.civIndex,c=0|(T=a.hero.displayPos.q),u=0|(k=a.hero.displayPos.r),h=this.world.hexGrid.getValueAt(c,u),d=t.hexGrid.axialToPixelPos(T,k);app.config.showForCiv;var p=i+d.x,g=o+d.y,m=app.config.graphics.heroSize;if("victory"===game.state&&l===game.winningCivIndex&&(m*=2,a.stats.gotPetInfo&&a.hero.animSet)){e.save();var f=a.hero.animSet.getCurAnimation().getTransform("root"),v=app.config.graphics.heroSize+20;e.translate(p+2*f.translation.x+v,g+2*f.translation.y),e.rotate(-f.rotation),e.scale(f.scale.x,f.scale.y),gfx.drawPet(e,a.stats.gotPetInfo,0,0,.5*m),e.restore()}if(gfx.drawHeroAvatar(l,p,g,m,a.hero.animSet,a.haveMet),app.config.debugCiv===l){var y=a.aiData.intention;y&&(e.font="bold 36px arial",e.strokeStyle="#FF8080",e.fillStyle=e.strokeStyle,e.fillText(""+y,p,g,500));var w=a.aiData.townTarget;if(w){d=t.hexGrid.axialToPixelPos(w.q,w.r);e.save(),e.translate(i+d.x,o+d.y),e.fillStyle=a.info.style,e.fillRect(-20,-20,40,40),e.restore()}var C=a.aiData.expansionTarget;if(C){d=t.hexGrid.axialToPixelPos(C.q,C.r);e.save(),e.translate(i+d.x,o+d.y),e.rotate(Math.PI/8),e.fillStyle=a.info.style,e.fillRect(-20,-20,40,40),e.restore()}var S=game.civs[l].aiData.target;if(S){d=t.hexGrid.axialToPixelPos(S.q,S.r);e.save(),e.translate(i+d.x,o+d.y),e.fillStyle=a.info.style;var b=100;e.fillRect(-50,-5,b,10),e.fillRect(-5,-50,10,b),e.restore()}}}for(var _=0;_<game.creatures.length;_++){var x=game.creatures[_],T=x.pos.q,k=x.pos.r;h=this.world.hexGrid.getValueAt(T,k);if(app.config.debugHeroes||!(h.fog[app.config.showForCiv]>0)){p=i+(D=t.hexGrid.axialToPixelPos(x.displayPos.q,x.displayPos.r)).x,g=o+D.y;gfx.drawCreature(e,x,p,g);var I=game.civs[app.config.showForCiv].pointsFor[x.code];gfx.drawPoints(I,p-45,g-20,.5)}}if(t.renderFogInView(e,{left:n.x,top:n.y,right:r.x,bottom:r.y}),app.config.debugCivValue){var P="main";game.civs[app.config.showForCiv].isAI&&(P="ai"+app.config.showForCiv),e.lineWidth=10,e.font="bold 40px arial",e.textAlign="center",e.textBaseline="middle";for(var E=t.usedHexList,A=0;A<E.length;A++){var D,B,R=E[A],F=(p=i+(D=t.hexGrid.axialToPixelPos(R.q,R.r)).x,g=o+D.y,R.value.aiData[app.config.showForCiv]);if(void 0!==F.problem&&(e.font="bold 36px arial",e.strokeStyle="#FF8080",e.fillStyle=e.strokeStyle,e.fillText("!"+F.problem,p,g-42,30)),void 0!==(B="blocking"===app.config.debugCivValue?R.entry.blocking[P]:F[app.config.debugCivValue])){e.font="bold 40px arial",B=Math.floor(10*B)/10,e.strokeStyle=B<0?"#FF8080":"#80FF80";e.strokeRect(p-40,g-25,80,50),e.fillStyle=e.strokeStyle,e.fillText(""+B,p,g,50)}}}this.drawClickPath(),game.postWorldDraw(e)},kl.prototype.drawArrowHead=function(e,t,n){var r=this.world.pixelOffset.x,i=this.world.pixelOffset.y;e.save(),e.globalAlpha=.5;var o=t[t.length-1],s=this.world.hexGrid.axialToPixelPos(o.q,o.r),a=r+s.x,l=i+s.y;e.translate(a,l);var c=t[t.length-2];c||(c=game.hero.pos);var u=this.world.hexGrid.axialToPixelPos(c.q,c.r),h=Math.atan2(s.y-u.y,s.x-u.x);e.rotate(h),gfx.getCivImage(game.playerCivIndex,"civ_arrow").draw(e,-20,0,70,70),e.restore()},kl.prototype.drawClickPath=function(){if("victory"!==game.state){var e=app.ctx,t=this.world.pixelOffset.x,n=this.world.pixelOffset.y;if(rat.screenManager.getTopScreen()===game.hud&&game.input.clickPath&&game.input.clickPath.valid&&game.input.clickPath.path.length>0){var r=game.input.clickPath.path;e.beginPath(),e.lineCap="round",e.lineJoin="round";var i=this.world.hexGrid.axialToPixelPos(game.hero.pos.q,game.hero.pos.r),o={x:i.x,y:i.y},s=r[0],a=this.world.hexGrid.axialToPixelPos(s.q,s.r),l=i.x+.42*(a.x-i.x),c=i.y+.42*(a.y-i.y);e.moveTo(t+l,n+c);for(var u=0;u<r.length;u++){var h,d,p=r[u];if(i=this.world.hexGrid.axialToPixelPos(p.q,p.r),u===r.length-1){var g=.55;o.y==i.y&&(g=.65),h=o.x+(i.x-o.x)*g,d=o.y+(i.y-o.y)*g}else h=i.x,d=i.y;e.lineTo(t+h,n+d),o=i}e.globalAlpha=.4,e.lineWidth=22,e.strokeStyle="#202020",e.stroke(),e.lineWidth=12,e.strokeStyle=game.playerCiv.info.style,e.stroke(),this.drawArrowHead(e,r,game.hero.pos),e.lineCap="butt",e.lineJoin="miter",e.globalAlpha=1}}},kl.prototype.mouseToHexPos=function(e){var t=this.world.hexGrid.pixelPosToHex(e.x-this.world.pixelOffset.x,e.y-this.world.pixelOffset.y);return this.world.hexGrid.inBounds(t.q,t.r)?t:null},kl.prototype.hexToPixelPos=function(e,t){void 0!==e.q&&(t=e.r,e=e.q);var n=this.world.hexGrid.axialToPixelPos(e,t);return n.x+=this.world.pixelOffset.x,n.y+=this.world.pixelOffset.y,n},kl.prototype.checkValidHexTipPos=function(e){if(this.lastMouseHex.tipValid=!1,this.lastMouseHex.valid){var t=this.world.hexGrid.getValueAt(e.q,e.r);t&&t.fog[app.config.showForCiv]<1&&t.terrainType&&"ocean"!==t.terrainType&&(this.lastMouseHex.tipValid=!0)}},kl.prototype.updateMouseHexPos=function(e,t){var n=game.hud.isTrackingSomething(),r=this.mouseToHexPos(e);if(n||!r)return this.lastMouseHex.valid=!1,game.hud.clearHexTip(),game.input.clearClickPath(),!1;"mouseup"===t&&(this.lastMouseHex.tipWanted=!1,game.hud.clearHexTip()),"mousedown"===t&&(this.lastMouseHex.tipWanted=!0),"mousemove"!==t||this.lastMouseHex.mousePos.x===e.x&&this.lastMouseHex.mousePos.y===e.y||(this.lastMouseHex.tipWanted=!0),this.lastMouseHex.mousePos={x:e.x,y:e.y},this.lastMouseHex.valid&&this.lastMouseHex.q===r.q&&this.lastMouseHex.r===r.r||(this.lastMouseHex.time=0,this.lastMouseHex.q=r.q,this.lastMouseHex.r=r.r,this.lastMouseHex.valid=!0,game.hud.clearHexTip(),this.checkValidHexTipPos(r),"mouseup"!==t&&game.input.planClickPath(r))},kl.prototype.mouseMove=function(e,t){return this.updateMouseHexPos(e,"mousemove"),!1},kl.prototype.mouseLeaveAll=function(e,t){return this.stopMouseTracking(),!0},kl.prototype.stopMouseTracking=function(){this.lastMouseHex.time=0,this.lastMouseHex.valid=!1,this.lastMouseHex.q=this.lastMouseHex.r=-1,game.hud.clearHexTip(),game.input.clickPath&&(game.input.clickPath.valid=!1)},kl.prototype.mouseDown=function(e,t){var n=kl.prototype.parentPrototype.mouseDown.call(this,e,t);return this.updateMouseHexPos(e,"mousedown"),this.lastMouseHex.touchTime=0,this.lastMouseHex.time=0,this.touchPos={x:e.x,y:e.y},n},kl.prototype.mouseUp=function(e,t){var n=!!(this.flags&rat.ui.Element.trackingMouseDownFlag);if(kl.prototype.parentPrototype.mouseUp.call(this,e,t),this.lastMouseHex.touchTime=0,this.updateMouseHexPos(e,"mouseup"),!n||game.hud.isTrackingSomething())return!1;var r=this.mouseToHexPos(e);return!!r&&(game.input.handleHexClick(r),!0)};const Il=function(e,t){Il.prototype.parentConstructor.call(this,e),this.showCivProgress=[],t&&(this.showCivProgress=t.showCivProgress,this.setSize(t.getSize())),this.extra=[]};rat.utils.inheritClassFrom(Il,rat.ui.Element),Il.prototype.getNeededHeight=function(){return 58*game.civs.length+50},Il.prototype.getNeededHeightNoTitle=function(){return 58*game.civs.length},Il.prototype.getNeededWidthForProgress=function(){return 800},Il.prototype.drawCivProgress=function(e,t,n,r){var i=game.civs[t],o=!!i.winner,s=796,a=n+60,l=gfx.styles.star,c=i.victoryProgress[0];if(c){var u=app.rules.victories[c.type],h=s*c.amount;if(c.pointsToWin){var d=null;c.partialType&&(d=c.partialPointsFor);for(var p=c.pointsToWin,g=-1,m=0;m<p;m++){var f="points_empty";if(c.points>m)f="points_full";else if(g<0&&(g=m),c.points<=m&&(m-g)%10<=4)f="points_empty_counter";var v=a+2+(m+.5)*s/p,y=r+0+29+2;e.globalAlpha=1,gfx.drawResource(f,v,y,0,.8*app.config.graphics.resourceSize,e),e.globalAlpha=1}if(d){e.fillStyle="rgba(219, 178, 34, 0.5)",d.newEffectTimer>0&&(e.fillStyle="rgba(255, 255, 255, 0.5)");var w=s*d.points/p;h+w>s&&(w=s-h);var C=58/6,S=C+41.083333333333336*d.progress,b=(58-S)/2;e.fillRect(a+2+h,r+0+b,w,S)}}var _,x=70;if(this.extra[t]&&this.extra[t].newMetTimer&&(x+=280*this.extra[t].newMetTimer/.5),gfx.drawHeroAvatar(t,n+30,r+29,x,!1,i.haveMet),this.resultsMode&&(e.font="40px "+Ba.mainFont,e.textAlign="right",e.textBaseline="middle",e.fillStyle=Ba.colors.textMainColor.toString(),e.fillText(i.info.heroName,0,r+29,300)),e.font="bold 40px "+Ba.mainFont,e.textAlign="left",e.textBaseline="middle",e.fillStyle=l,o)_=u.name+"!";else if(c.partialType){d=c.partialPointsFor;_=c.progressMessage,d.newEffectTimer>=0&&(e.fillStyle="#FFFFFF",e.font="bold 50px "+Ba.mainFont,d.newEffectTimer>.2&&(e.fillStyle=rat.graphics.Color.randomColor().toString()))}if(_&&!this.resultsMode){e.lineWidth=7,e.strokeStyle="#202020";var T=e.miterLimit;e.miterLimit=2,e.strokeText(_,n+800+80,r+29,500),e.fillText(_,n+800+80,r+29,500),e.miterLimit=T}}},Il.prototype.drawAllCivProgress=function(e,t){var n=0;if(!this.resultsMode){e.font="bold 36px "+Ba.mainFont,e.textAlign="left",e.textBaseline="middle";const t="Victory Progress";var r=e.measureText(t);e.fillStyle=Ba.colors.panelBackground.toString(),e.fillRect(320,n,r.width+40,50.5),e.fillStyle=Ba.colors.panelLightText.toString(),e.fillText(t,340,32,500)}n+=50;var i=this.getNeededHeightNoTitle();e.fillStyle=Ba.colors.panelBackground.toString(),e.fillRect(80,n,800,i);for(var o=n,s=0;s<game.civs.length;s++)t[s]&&(this.drawCivProgress(e,s,20,o),o+=58)},Il.prototype.pointsDisplayPos=function(e){return{x:120,y:40}},Il.prototype.setNewMet=function(e){this.extra[e]||(this.extra[e]={}),this.extra[e].newMetTimer=.5},Il.prototype.drawSelf=function(e){this.drawAllCivProgress(e,this.showCivProgress)},Il.prototype.updateSelf=function(e){for(var t in this.extra){var n=this.extra[t];n.newMetTimer>0&&(n.newMetTimer-=e,n.newMetTimer<0&&(n.newMetTimer=0))}},Il.prototype.updateProgressDisplay=function(e){e&&(this.showCivProgress=e),this.setDirty(!0)},Il.prototype.setResultsMode=function(){this.resultsMode=!0};const Pl=function(e,t,n){Pl.prototype.parentConstructor.call(this,e),this.buildingCode=t,this.civIndex=n,this.drawSize=null};rat.utils.inheritClassFrom(Pl,rat.ui.Element),Pl.prototype.drawSelf=function(e){if(this.buildingCode){var t=this.size.x/2-this.center.x,n=this.size.y/2-this.center.y;gfx.drawBuilding(this.buildingCode,this.civIndex,null,t,n,0,this.drawSize,e)}},Pl.prototype.setBuilding=function(e,t){this.buildingCode=e,this.civIndex=t,this.setDirty(!0)},Pl.prototype.setBuildingDrawSize=function(e){this.drawSize=e};const El=240,Al=240,Dl=function(e){Dl.prototype.parentConstructor.call(this,e);var t=this,n=Ba.makeIconButtonAt(Ba.game,this,"dragon",120,120,El,Al);this.button=n,this.button.icon.setSize(192,192),n.setCallback((function(e,n){var r=t.events[t.events.length-1];r&&game.scrollToEventLocation(r.pos),t.popEvent()}));var r=this.exclam=new rat.ui.Sprite(this);r.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),r.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),r.setSize(160,160),r.setPos(-60,0),r.setRotation(-Math.PI/8),r.useImageRef(gfx.getImageCopy("event_notice"));var i=this.buildingPane=new Pl(n);i.setSize(El,Al),i.setPos(115,130),i.setBuildingDrawSize(336),i.autoCenter(!0);var o=this.avatarPane=new rat.ui.Element(this);o.drawSelf=function(e){if(!(this.civIndex<0)){var t=.8*this.size.x;gfx.drawHeroAvatar(this.civIndex,0,0,t,!1,!0)}},o.setSize(El,Al),o.setPos(175,160),o.autoCenter(!0),o.civIndex=1,this.setVisible(!1),this.events=[]};rat.utils.inheritClassFrom(Dl,rat.ui.Element),Dl.prototype.updatePlacement=function(){this.setPos(rat.graphics.SCREEN_WIDTH-El-4,rat.graphics.SCREEN_HEIGHT-Al-70),this.setSize(El,Al),this.autoCenter(!0,!0);Ba.setTooltip(this.button,"Scroll to show important civ event","[hotkey: enter]")},Dl.prototype.pushEvent=function(e){this.events.push(e),this.updateDisplayFrom(e),this.flashExclam(),za.playSound("warning")},Dl.prototype.popEvent=function(e){this.events.pop();var t=this.events[this.events.length-1];this.updateDisplayFrom(t),t&&this.flashExclam()},Dl.prototype.updateDisplayFrom=function(e){if(!e)return this.setVisible(!1),void this.button.setVisible(!1);this.setVisible(!0),this.button.setVisible(!0),"building"===e.eventType?(this.button.icon.setVisible(!1),this.buildingPane.setVisible(!0),this.buildingPane.setBuilding(e.structure.type,e.civIndex)):(this.button.icon.setVisible(!0),this.buildingPane.setVisible(!1)),this.avatarPane.civIndex=e.civIndex},Dl.prototype.flashExclam=function(){var e;(e=new rat.ui.Animator(rat.ui.Animator.scaler,this.exclam)).setTimer(.3),e.setStartEnd(2.5,1),(e=new rat.ui.Animator(rat.ui.Animator.scaler,this)).setTimer(.4),e.setStartEnd(2.5,1)},Dl.prototype.isTrackingSomething=function(){return!!this.isVisible()&&!!Ba.isTracking(this.button)},Dl.prototype.tryPressingButton=function(e){return!!this.isVisible()&&(!(!this.button.isVisible()||!this.button.isEnabled())&&this.button.press(e))},Dl.prototype.testMe=function(){game.hud.civEventPanel.pushEvent({eventType:"building",structure:{type:"tech1"},civIndex:0,pos:{q:game.hero.pos.q,r:game.hero.pos.r}})};const Bl=function(e,t){Bl.prototype.parentConstructor.call(this,e,t)};rat.utils.inheritClassFrom(Bl,rat.ui.Button),Bl.techColor=new rat.graphics.Color(Ua.resourceTypes.science.style),Bl.techUnavailColor=new rat.graphics.Color(130,130,130),Bl.actionColor=new rat.graphics.Color(Ua.resourceTypes.production.style),Bl.actionUnavailColor=new rat.graphics.Color(130,130,130),Bl.prototype.elementType="actionbutton",Bl.make=function(e,t){var n,r=e.code,i=e.title,o=e.tipText,s="";e.buttonSubMenu?(n=fl.subActionHotKeys[e.buttonSlot],s="shift + "):n=fl.actionHotKeys[e.buttonSlot];var a="[hotkey: "+s+n+"]";if("subExp"===e.code){var l=160,c=120;(h=new Bl(rat.ui.Button.coolType)).setCornerRadius(10),h.setTextInset(4);var u=e.isTech?Bl.techUnavailColor:Bl.actionUnavailColor;h.colorStates=rat.ui.Button.createStandardColorStates(u),h.setSize(l,c),h.autoCenter(!0,!0),h.setTextValue(i),Ba.applyTextProperties(h,Ba.game.buttonFont),h.updateShowState=function(t){h.setTextValue(t?e.titleOpen:e.title);var n=t?e.tipTextOpen:e.tipText;Ba.setActionTooltip(h,n,a)}}else{var h;l=160,c=145;(h=new Bl(rat.ui.Button.coolType)).setCornerRadius(10),h.setTextInset(4);u=e.isTech?Bl.techUnavailColor:Bl.actionUnavailColor;h.colorStates=rat.ui.Button.createStandardColorStates(u),h.setSize(l,c),h.autoCenter(!0,!0),h.setTextValue(i),Ba.applyTextProperties(h,Ba.game.buttonFont),h.getTextBox().enableDefaultSpecialFormatting()}if(h.setEnabled(!0),h.setVisible(!1),h.unlocked=!1,h.available=!1,h.code=r,h.entry=e,e.cost){var d=new Rl(e.cost);d.setPos(0,c-1),d.setSize(l,32),h.appendSubElement(d),h.costPane=d}return Ba.setActionTooltip(h,o,a),t&&h.setDormant(!0),h},Bl.prototype.setDormant=function(e){this.isDormant=e,this.costPane&&this.costPane.setVisible(!e),this.getTextBox().setVisible(!e),this.setEnabled(!e),this.setNeedsUpdate(!e)},Bl.prototype.setUnlocked=function(e,t){if(!this.unlocked&&(this.unlocked=!0,this.setVisible(!0),t)){var n=this.getPos().copy();n.x-=200;var r=new rat.ui.Animator(rat.ui.Animator.mover,this);r.setTimer(.5),r.setStartEndVectors(n,this.getPos()),r.setInterpFilter(rat.ui.Animator.filterEaseOutElastic)}},Bl.prototype.setUsed=function(e){if(!this.used){this.setEnabled(!1),this.used=!0;var t=this.getPos().copy();t.x+=300,t.y+=300;var n;(n=new rat.ui.Animator(rat.ui.Animator.mover,this)).setTimer(.5),n.setStartEndVectors(null,t),(n=new rat.ui.Animator(rat.ui.Animator.rotator,this)).setTimer(.5),n.setStartEnd(0,2*Math.PI),(n=new rat.ui.Animator(rat.ui.Animator.scaler,this)).setTimer(.5),n.setStartEnd(1,.2),n.setAutoRemoveTarget()}},Bl.prototype.setAvailable=function(e){var t=this.available;if(e&&!t){var n=this.entry.isTech?Bl.techColor:Bl.actionColor;this.colorStates=rat.ui.Button.createStandardColorStates(n),this.setTextColors(Ba.game.buttonFont.color,Ba.game.buttonFont.color,Ba.game.buttonFont.color)}else if(!e&&t){n=this.entry.isTech?Bl.techUnavailColor:Bl.actionUnavailColor;this.colorStates=rat.ui.Button.createStandardColorStates(n),this.setTextColors(Ba.game.buttonFont.color,Ba.game.buttonFont.color,Ba.game.buttonFont.color)}this.available=e},Bl.prototype.drawSelf=function(){if(Bl.prototype.parentPrototype.drawSelf.call(this),!this.isDormant&&this.pointsInfo){var e=this.size.x+20-this.center.x,t=20-this.center.y;gfx.drawPoints(this.pointsInfo,e,t,.7)}};const Rl=function(e){Rl.prototype.parentConstructor.call(this),this.cost=e};rat.utils.inheritClassFrom(Rl,rat.ui.Element),Rl.prototype.updateCost=function(e){this.cost=e},Rl.prototype.getCostPos=function(e){var t=0;for(var n in this.cost){if(n===e)return this.getGlobalPos(58*t+10,10);t++}return null},Rl.prototype.drawSelf=function(){var e=rat.graphics.getContext();e.font="36px "+Ba.mainFont,e.textAlign="center",e.textBaseline="middle",e.lineWidth=2;var t=-20;for(var n in this.cost){var r=Ua.resourceTypes[n],i=this.cost[n],o=game.playerCiv.resources[n].count;if(o>=i)e.fillStyle=r.style,e.fillRect(t,-17,56,60);else{e.fillStyle="#202020",e.fillRect(t,-17,56,60);var s=60*(Math.floor(o/i*5)/5);e.fillStyle=r.partialStyle,e.fillRect(t,43-s,56,s),e.strokeStyle=r.style,e.strokeRect(t,-17,56,60)}gfx.getImageSmall(n).draw(e,t+28,12,56,56),e.fillStyle=r.style,e.fillText(""+i,t+23,60,40),t+=74}};const Fl={topics:{espionage:{title:"Espionage",description:"Espionage lets you see how well other players are doing."},detection:{title:"Detection",description:"Spend science to find resources and other things in the world."},towns:{title:"Towns",description:"A town collects resources around it automatically."},cities:{title:"City",description:"A town can be upgraded into a city, which collects double resources."},expansions:{title:"Expansions",description:"Building an expansion will earn more victory points and extend your reach",helpTopics:["victorypoints"]},collectors:{title:"Collectors",description:"Building a collector will earn more victory points and extend the harvest range of your Town or City",helpTopics:["victorypoints"]},techvictory:{title:"Rocket",description:"Build a launch pad, rocket, and Mars lander for a bunch of victory points",helpTopics:["victorypoints"]},moneyvictory:{title:"World Bank",description:"Build a World Bank with a security system and gold vault for a bunch of victory points",helpTopics:["victorypoints"]},prodvictory:{title:"Monument",description:"Build a Monument in three stages for glory and victory points",helpTopics:["victorypoints"]},science:{title:"Science",description:"Collect scientific knowledge from the world, and use it to unlock new abilities for your civilization"},resources:{title:"Resources",description:"Collect resources from the world, and use them to build your civilization"},victorypoints:{title:"Points",description:"Some actions give you victory points.\n\nLook for the little star [point_embed] next to actions and monsters.\n\nCollect enough victory points (before your opponents) to win the game."},dead:{title:"Unconscious",description:"Your hero can get knocked out for a few turns.  No big deal.  You'll be back."}}},Nl=function(e,t){Nl.prototype.parentConstructor.call(this);var n=this;n.setModal(!0),n.setAllowClickAway(!0),n.setAllowBackClose(!0),n.setUserCloseCallback((function(e,t){Nl.currentScreen=null}));var r=800;if(n.setSize(r,600),e&&"NeedScreen"===e.screenType){var i=e.getPos();this.setPos(i.x,i.y)}else this.position();Ba.addPopupBackground(n);var o=Fl.topics[t],s=Ba.makeHeading(n,o.title,400,50);s.setColor(Ba.colors.panelExtraLight),s.setBaseline("top");var a=Ba.formatText(o.description),l=Ba.makeText(n,a,{centerX:400,centerY:150,useFont:Ba.game.helpFont});l.enableDefaultSpecialFormatting(),l.setBaseline("top"),l.setAutoWrap(!0);var c=l.getPosY()+l.getTextHeight()+Ba.game.buttonGap+90;o.helpTopics&&(c+=Nl.addHelpTopicButtons(n,c,o.helpTopics));c+=Ba.game.buttonGap;var u=Ba.makeButtonAt(n,"OK",400,c);u.callback=function(e,t){rat.screenManager.removeScreen(n),Nl.currentScreen=null};var h=c+Ba.game.buttonHeight;n.setHeight(h),n.elementBackground.autoSizeToParent(),this.autoBuildInputMap({defaultFocusTo:u})};rat.utils.inheritClassFrom(Nl,rat.ui.Screen),Nl.currentScreen=null,Nl.make=function(e,t){Nl.currentScreen&&rat.screenManager.removeScreen(Nl.currentScreen);var n=new Nl(e,t);rat.screenManager.pushScreen(n),Nl.currentScreen=n},Nl.prototype.position=function(){this.centerAt(rat.graphics.SCREEN_WIDTH/2,rat.graphics.SCREEN_HEIGHT/3)},Nl.prototype.onWindowResize=function(){},Nl.addHelpTopicButtons=function(e,t,n){if(n.length<=0)return 0;var r=0,i=e.getWidth();n.length>0&&(Ba.makeText(e,"- Related Topics -",{centerX:i/2,centerY:t-50,useFont:Ba.game.subTopicHeadingFont}),t+=50);for(var o=0;o<n.length;o++){var s=n[o],a=Fl.topics[s].title,l=Ba.makeButtonAt(e,a+" ?",i/2,t+r,null,Ba.game),c=Ba.colors.helpButtonColor,u=Ba.colors.customButtonFontColor;l.applyStandardColorStates(c),Ba.fixButtonColorStates(l,c),l.setTextColors(u,u,u),l.callback=function(e,t){Nl.make(this,t)},l.callbackInfo=s,r+=Ba.game.buttonHeight+Ba.game.buttonGap}return r};const Ml=function(e,t,n){Ml.prototype.parentConstructor.call(this),this.statusCode=n;var r=this;r.screenType="NeedScreen",r.setModal(!0),r.setAllowClickAway(!0),r.setAllowBackClose(!0);var i=Ml.WIDTH,o=Ml.HEIGHT;r.setSize(i,o),Ba.addPopupBackground(r),Ba.addDimmer(r,"rgba(0,0,0,0.3)");var s=t.unavailableTitle;s||(s="Action Unavailable...");var a=100,l=Ba.makeText(r,s,{centerX:i/2,centerY:a-50,useFont:Ba.game.needHeadingFont});a+=50;var c=fl.status[n].message;c=Ba.formatText(c),(l=Ba.makeText(r,c,{centerX:i/2,centerY:a,useFont:Ba.game.helpFont})).setBaseline("top"),l.setAutoWrap(!0),l.enableDefaultSpecialFormatting(),a+=l.getTextHeight()+100;var u=[];fl.status[n].helpTopics&&(u=fl.status[n].helpTopics),t.helpTopics&&t.helpTopics.length>0&&(u=u.concat(t.helpTopics)),a+=Nl.addHelpTopicButtons(r,a,u),a+=Ba.game.buttonGap;var h=Ba.makeButtonAt(r,"OK",i/2,a,null,Ba.game);h.callback=function(e,t){rat.screenManager.removeScreen(r)};var d=a+Ba.game.buttonHeight;r.setHeight(d),r.elementBackground.autoSizeToParent(),this.position(e,fl.status[n].pointAt),this.autoBuildInputMap({defaultFocusTo:h})};rat.utils.inheritClassFrom(Ml,rat.ui.Screen),Ml.WIDTH=800,Ml.HEIGHT=500,Ml.prototype.position=function(e,t){var n=null,r=new rat.math.Vector(rat.graphics.SCREEN_WIDTH/2,rat.graphics.SCREEN_HEIGHT/2);"button"===t&&e?((n=e.getGlobalPos(e.size.x/2,e.size.y/2)).x+=50,n.y+=40):"hero"===t?n=game.hexToPixelPos(game.hero.pos.q,game.hero.pos.r):"heroTarget"===t&&game.hero.target&&(n=game.hexToPixelPos(game.hero.target.pos.q,game.hero.target.pos.r)),n&&(r.y=n.y,n.x<rat.graphics.SCREEN_WIDTH/2?r.x=n.x+640:r.x=n.x-640);var i=40+this.size.x/2,o=40+this.size.y/2,s={x:i,y:o,w:rat.graphics.SCREEN_WIDTH-2*i,h:rat.graphics.SCREEN_HEIGHT-2*o-Ba.config.bottomPanelHeight};if(r.limitToRect(s),this.centerAt(r.x,r.y),n){var a={x:n.x+.3*(r.x-n.x)-this.place.pos.x,y:n.y+.3*(r.y-n.y)-this.place.pos.y},l=Math.atan2(n.y-r.y,n.x-r.x),c=new rat.ui.Sprite("res/images/ui/arrow_top.png");this.insertSubElement(c),c.autoCenter(),c.setPos(a.x,a.y),c.setRotation(l);c=new rat.ui.Sprite("res/images/ui/arrow_bottom.png");this.insertSubElement(c),c.autoCenter(),c.setPos(a.x,a.y),c.setRotation(l)}},Ml.prototype.onWindowResize=function(){},Ml.alreadyExists=function(e){return null!==rat.screenManager.forEachScreenTopDown((function(t){return t.statusCode===e}))};const Ll=Ba.solidPanelFrameWidth/2,Ol=function(e,t){Ol.prototype.parentConstructor.call(this,e),this.state={},this.setClipped(!0);var n=this.background=new rat.ui.Shape("square");this.appendSubElement(n),t?(n.setColor(Ba.colors.subPanelBackground),n.setStroke(Ll,Ba.colors.subPanelLight)):(n.setColor(Ba.colors.panelBackground),n.setStroke(Ll,Ba.colors.solidPanelLight));var r=rat.ui.Button.createInvisibleColorStates();this.backButton=rat.ui.Button.makeCheapButtonWithColors(this,r),this.extraButton=null};function Hl(e,t,n){var r=new Ml(e,t,e.status);rat.screenManager.pushScreen(r)}rat.utils.inheritClassFrom(Ol,rat.ui.Element),Ol.prototype.setupActionButtons=function(e){var t=this;this.actionTable=e;const n=function(n,r,i,o){var s=e[n],a=Bl.make(s,!!o);a.setPos(r,i),o?t.insertSubElementBefore(a,o):t.appendSubElement(a);var l=game.civs[app.config.showForCiv].pointsFor[s.code];return l&&(a.pointsInfo=l),a.setCallback((function(e,n){e.toolTip&&(e.toolTip.timer=0),game.input.hasPending()||t.processAction(n.code)}),s),s.startUnlocked&&a.setUnlocked(!0,!0),a};this.buttons={},this.buttonSets={};var r=null;for(var i in e){var o=e[i];if(!(o.buttonSlot<0)){var s=this.getActionButtonPos(i,0);this.buttons[i]=n(i,s.x,s.y),r=this.buttons[i],this.buttonSets[i]=[];var a=1;if(o.buttonCount&&o.buttonCount>1)for(var l=0;l<o.buttonCount-1;l++){var c=n(i,(s=this.getActionButtonPos(i,l+1)).x,s.y,r);(a-=.1)<.1&&(a=.1),c.setScale(a,a),r=c,this.buttonSets[i].push(c)}o.buttonSubMenu?o.hotKey={keyCode:rat.input.keys[fl.subActionHotKeys[o.buttonSlot]],shiftKey:fl.subActionHotKeysShiftKey}:o.hotKey={keyCode:rat.input.keys[fl.actionHotKeys[o.buttonSlot]],shiftKey:fl.actionHotKeysShiftKey}}}this.updateSize()},Ol.prototype.serialize=function(){return this.state},Ol.prototype.deserialize=function(e){for(var t in e)"u"===e[t]?this.unlockButton(t):"r"===e[t]?this.removeButton(t,!0,!1):e[t]&&e[t]>0&&(this.unlockButton(t),this.updateButtonCount(t,e[t]));this.updateActionButtons()},Ol.prototype.makeExtraButton=function(e){var t=rat.ui.Button.makeCoolButton(this,Ba.menus.buttonColor);return t.setSize(240,100),t.setTextValue(e),t.centerFromSize(),this.extraButton=t,this.updateExtraButton(),this.startExtraNoticeAnimation(),t},Ol.prototype.startExtraNoticeAnimation=function(){var e=new rat.ui.Animator(rat.ui.Animator.scaler,this.extraButton);e.setDelay(.4),e.setTimer(.4),e.setStartEnd(1.33,1)},Ol.prototype.updateExtraButton=function(){if(this.extraButton){var e=this.extraButton.size.y;this.extraButton.setPos(this.size.x/2,this.size.y-this.extraButton.size.y-15+e/2)}},Ol.prototype.getCodeButton=function(e){return this.buttons[e]},Ol.prototype.getCodeButtonState=function(e){return this.state[e]?this.state[e]:null},Ol.prototype.getActionButtonPos=function(e,t){t||(t=0);var n=this.actionTable[e],r=0;n.buttonSlot>0&&(r=n.buttonSlot);const i=120+230*r;return{x:Ba.config.actionPanel.w/2-26*t,y:i,scale:1-.1*t}},Ol.prototype.isTrackingSomething=function(){var e=rat.ui.Element;if(this.flags&(e.mouseInFlag||e.highlightedFlag))return!0;for(var t in this.buttons){var n=this.buttons[t];if(n&&n.isVisible()&&n.isEnabled()&&n.flags&(e.highlightedFlag|e.pressedFlag|e.trackingMouseDownFlag))return!0}return!!Ba.isTracking(this.extraButton)},Ol.prototype.processAction=function(e){var t=this.actionTable[e],n=this.buttons[e];if(!n)return!1;var r=n.available;r&&t.autoApplyCost&&game.animateAndApplyCost(t.cost,game.playerCiv,{actionCode:t.code}),t.turnActionImage&&game.addActionIconTurnPart(game.playerCiv,t.turnActionImage);var i=this.parent;return r&&t.act?t.act(n,t,this,i):r||(t.unavailableAct?t.unavailableAct(n,t,this):Hl(n,t)),!0},Ol.prototype.getActionButtonCostPos=function(e,t){var n=this.buttons[e];return n&&n.costPane?n.costPane.getCostPos(t):null},Ol.prototype.getActionButtonPointsPos=function(e){var t=this.buttons[e];return t?t.getGlobalPos(t.getWidth()+20-t.center.x,10-t.center.y):null},Ol.prototype.actionCostFinished=function(e){var t=this.buttons[e],n=this.actionTable[e];t&&n&&(n.costCompleteAct&&n.costCompleteAct(t,n,this,this.parent),n.autoEndTurn&&game.turns.commitTurn())},Ol.prototype.updateActionButtons=function(){for(var e in this.actionTable){var t=this.actionTable[e],n=this.buttons[e];if(n){!n.used&&t.checkUnlock&&t.checkUnlock(n,t,this);var r=!0;if(n.unlocked&&!n.used&&game.checkCost(t.cost,game.playerCiv)||(n.status="LACKING_RESOURCE",r=!1),t.checkConditions){var i=t.checkConditions(n,t);n.status=i,"OK"!==i&&(r=!1)}game.playerCiv.isDead&&(n.status="PLAYER_DEAD",r=!1),n.setAvailable(r)}}},Ol.prototype.updateEntryCost=function(e){if(this.buttons[e]){var t=app.Buildings.getCost(e,game.playerCiv);t&&this.buttons[e].costPane.updateCost(t)}},Ol.prototype.unlockButton=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var n=e[t];if(this.buttons[n]&&(this.state[n]||(this.state[n]="u"),("sciExpansion"!==n||game.config.hasCityExpansions)&&("sciMoney1"!==n||game.config.hasMoneyVictory)&&("sciProd1"!==n||game.config.hasProductionVictory))){this.buttons[n].setUnlocked(!0,!0);for(var r=0;r<this.buttonSets[n].length;r++)this.buttonSets[n][r].setVisible(!0)}}this.updateSize()},Ol.prototype.removeButton=function(e,t,n){if(this.buttons[e]){void 0===n&&(n=!0),void 0===t&&(t=!1),n?this.buttons[e].setUsed(!0):(this.buttons[e].removeFromParent(),this.buttons[e].setEnabled(!1));var r=this.buttonSets[e];if(r&&r.length>0&&!t)this.recalcButtonSetPositions(e,n),this.buttons[e]=r[0],this.buttons[e].setDormant(!1),this.buttons[e].setUnlocked(!0,!1),r.shift(),this.state[e]=r.length+1;else{if(r){for(var i=0;i<r.length;i++)r[i].removeFromParent();this.buttonSets[e]=[]}this.state[e]="r"}this.updateSize()}},Ol.prototype.recalcButtonSetPositions=function(e,t){var n=this.buttonSets[e];if(n)for(var r=0;r<n.length;r++){var i,o=this.getActionButtonPos(e,r),s=n[r].getPos(),a=n[r].getScale();if(t)(i=new rat.ui.Animator(rat.ui.Animator.mover,n[r])).setTimer(.4),i.setStartEndVectors(s,o),i.setInterpFilter(rat.ui.Animator.filterEaseOutElastic),(i=new rat.ui.Animator(rat.ui.Animator.scaler,n[r])).setTimer(.2),i.setStartEnd(a.x,o.scale),i.setInterpFilter(rat.ui.Animator.filterEaseIn);else n[r].setPos(o.x,o.y),n[r].setScale(o.scale)}},Ol.prototype.updateButtonCount=function(e,t){var n=this.buttonSets[e];if(!n||n.length<t)rat.console.log("ERROR: trying to reduce button count but it's already lower!");else for(var r=n.length+1;r>t;)this.removeButton(e,!1,!1),r--},Ol.prototype.updateSize=function(){for(var e=0,t=0,n=null,r=0;r<this.subElements.length;r++){var i=this.subElements[r];if("actionbutton"===i.elementType&&(i.isVisible()&&!i.used)){n=i;var o=i.place.pos.y+i.size.y/2;o>e&&(e=o),t++}}var s=Ba.config.actionPanel.w,a=e+24;n&&n.entry&&n.entry.cost&&(a+=70);var l=Ll/2;this.background.setSize(s-2*l,a-2*l),this.background.setPos(l,l),this.background.setVisible(t>0),this.backButton.setVisible(t>0);const c=l+40;this.backButton.setPos(c,c),this.backButton.setSize(s-2*c,a-2*c),this.extraButton&&(a+=this.extraButton.getHeight()+30+10),this.setSize(s,a),this.updateExtraButton()},Ol.prototype.updateSelf=function(e){},Ol.prototype.handleKeyDown=function(e){if(!e.sysEvent.ctrlKey)for(var t=0;t<=fl.actionHotKeys.length;t++)if(rat.input.keys[fl.actionHotKeys[t]]===e.which||rat.input.keys[fl.subActionHotKeys[t]]===e.which)return game.input.addPending({type:"actionButton",keyCode:e.which,shiftKey:e.sysEvent.shiftKey,ctrlKey:e.sysEvent.ctrlKey}),!0;return!1},Ol.prototype.processKeyDown=function(e){var t=e.keyCode;for(var n in this.buttons){var r=this.buttons[n];if(r){var i=r.entry.hotKey.shiftKey==e.shiftKey;if(r.isVisible()&&r.isEnabled()&&r.entry.hotKey.keyCode===t&&i)return r.press(),!0}}return!1},Ol.prototype.testUI=function(){var e;(e=this.buttons&&this.buttons[0]?this.buttons[0]:this).status="LACKING_RESOURCE",Hl(e,this.actionTable.town)};var zl={x:0,y:0},ql={x:0,y:0};const Vl=function(e){Vl.prototype.parentConstructor.call(this),this.showingExpansionMenu=!1,this.setPos(0,0),this.actionPanel2=new Ol(this,!0),this.actionPanel2.name="subActionPanel",this.actionPanel=new Ol(this),this.actionPanel.name="actionPanel"};rat.utils.inheritClassFrom(Vl,rat.ui.Element),Vl.prototype.handleResize=function(e){var t,n=Ba.config.actionPanel,r={w:n.w,h:1100},i=(n.w,r.h+976+14),o=e.h-i>0;t=o?e.y+(e.h-i)/2:e.y+(e.h-r.h)/2,n.y=t,this.setPos(n.x,t),this.adjustSubMenuAnchor(o,r);var s=this.showingExpansionMenu?zl:ql;this.actionPanel2.setPos(s)},Vl.prototype.adjustSubMenuAnchor=function(e,t){var n=Ba.config.actionPanel;e?(zl.x=n.x,zl.y=0+t.h+14,ql.x=-n.w,ql.y=zl.y):(zl.x=n.w+-14,zl.y=100,ql.x=-(n.w+-14),ql.y=100)},Vl.prototype.getActionCodePanel=function(e){return this.actionPanel.getCodeButton(e)?this.actionPanel:this.actionPanel2.getCodeButton(e)?this.actionPanel2:null},Vl.prototype.setupActionButtons=function(){var e=[],t=[];for(var n in fl.list){var r=fl.list[n];r.buttonSubMenu?t[n]=r:e[n]=r}this.actionPanel.setupActionButtons(e),this.actionPanel2.setupActionButtons(t)},Vl.prototype.serialize=function(){return{p1:this.actionPanel.serialize(),p2:this.actionPanel2.serialize()}},Vl.prototype.deserialize=function(e){this.actionPanel.deserialize(e.p1),this.actionPanel2.deserialize(e.p2)},Vl.prototype.getCodeButtonState=function(e){var t=this.actionPanel.getCodeButtonState(e);return t||this.actionPanel2.getCodeButtonState(e)},Vl.prototype.getActionButtonPos=function(e,t){return this.getActionCodePanel(e).getActionButtonPos(e,t)},Vl.prototype.isTrackingSomething=function(){return!!this.actionPanel.isTrackingSomething()||!!this.actionPanel2.isTrackingSomething()},Vl.prototype.processAction=function(e){return this.getActionCodePanel(e).getActionButtonPos(e)},Vl.prototype.getActionButtonCostPos=function(e,t){return this.getActionCodePanel(e).getActionButtonCostPos(e,t)},Vl.prototype.getActionButtonPointsPos=function(e){var t=this.getActionCodePanel(e);return t?t.getActionButtonPointsPos(e):null},Vl.prototype.actionCostFinished=function(e){this.getActionCodePanel(e).actionCostFinished(e)},Vl.prototype.updateActionButtons=function(){this.actionPanel.updateActionButtons(),this.actionPanel2.updateActionButtons()},Vl.prototype.updateEntryCost=function(e){this.getActionCodePanel(e).updateEntryCost(e)},Vl.prototype.unlockButton=function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){var n=e[t];this.getActionCodePanel(n).unlockButton(n)}},Vl.prototype.removeButton=function(e){return this.getActionCodePanel(e).removeButton(e)},Vl.prototype.updateSelf=function(e){},Vl.prototype.handleKeyDown=function(e){return!!this.actionPanel.handleKeyDown(e)||this.actionPanel2.handleKeyDown(e)},Vl.prototype.processKeyDown=function(e){return!!this.actionPanel.processKeyDown(e)||!!this.showingExpansionMenu&&this.actionPanel2.processKeyDown(e)},Vl.prototype.testUI=function(){},Vl.prototype.getProperWidth=function(){return this.showingExpansionMenu?this.actionPanel2.getPosX()+this.actionPanel2.getWidth():Ba.config.actionPanel.w},Vl.prototype.debugUnlockExpansionMenu=function(){this.unlockExpansionMenu()},Vl.prototype.unlockExpansionMenu=function(){this.unlockButton(["subExp","expansion","sciTech1","sciMoney1","sciProd1"]),this.actionPanel.updateActionButtons(),this.actionPanel2.updateActionButtons()},Vl.prototype.showExpansionMenu=function(e){void 0===e&&(e=!this.showingExpansionMenu),this.showingExpansionMenu=e,this.actionPanel.getCodeButton("subExp").updateShowState(e);rat.ui.animationManager.killAnimatorsForElement(this.actionPanel2);var t=this.actionPanel2.getPos(),n=e?zl:ql,r=new rat.ui.Animator("mover",this.actionPanel2);r.setTimer(.1),r.setStartEndVectors(t,n),r.setInterpFilter(rat.ui.Animator.filterEaseIn)};const Wl=180,Gl=function(e,t,n){Gl.prototype.parentConstructor.call(this,e),this.civIndex=t,this.civInfo=n,this.buildContents(),this.position()};rat.utils.inheritClassFrom(Gl,rat.ui.Element),Gl.prototype.buildContents=function(){var e=this,t=rat.graphics.SCREEN_WIDTH;this.setSize(t,180);var n=this.back=new rat.ui.Shape(this,"rect");n.setColor(Ba.colors.panelBackground),n.fitToParentSize(),(i=Gl.makeWinText(this,this.civInfo)).setPos(100,0),i.setSize(t-200,Wl),this.winText=i;var r=Ba.makeIconButtonAt(Ba.menus,this,"menu_next",.8*t,90);if(Ba.setIconButtonLabel(r,"results"),r.setCallback((function(t,n){game.hud.showResultsScreen(e.civInfo)})),this.nextButton=r,game.scenario.challengeSeed){const e=game.scenario.name;var i;(i=Ba.makeText(n,e,{useFont:Ba.game.subHeadingFont,x:0,y:140,w:rat.graphics.SCREEN_WIDTH,h:30})).setAlignment("center"),i.setBaseline("middle"),i.setFontSize(40)}},Gl.prototype.onWindowResize=function(){this.removeAllSubElements(),this.buildContents(),this.position()},Gl.makeWinText=function(e,t){var n,r,i,o=new rat.graphics.Color(t.info.style);o.luminance()>.2?(n=o,r=new rat.graphics.Color(0,0,0)):(n=o,r=new rat.graphics.Color(200,200,200)),i=t.isAI?t.info.heroName+" Wins":"You Win!";var s=Ba.makeText(e,i,{useFont:Ba.game.victoryFont,x:0,y:0,w:rat.graphics.SCREEN_WIDTH,h:Wl});return s.setBaseline("middle"),s.setColor(n),s.setStrokeColor(r),s},Gl.prototype.position=function(){this.setPos(0,150)},Gl.prototype.tryPressingButton=function(e){return!!this.isVisible()&&(!(!this.nextButton.isVisible()||!this.nextButton.isEnabled())&&this.nextButton.press(e))};const Ul={canPost:!0,username:void 0,inviteURL:"https://discord.gg/7FuDFPfcPH",setUsername:function(e){Ul.username=e},postToDiscord:function(e){if(!ba.isSignedIn())return;const t=ba.getDisplayName(),n=rat.utils.copyObject(e);n.accountName=t,n.uid=ba.user.uid,n.postAs=e.postAs||Ul.username||t||"(unknown)",n.ts=Date.now(),os.postToWins(n)},postTestToDiscord:function(){},postToMilestones:function(e){if(!ba.isSignedIn())return;const t=ba.getDisplayName(),n=rat.utils.copyObject(e);n.accountName=t,n.uid=ba.user.uid,n.postAs=e.postAs||Ul.username||t||"(unknown)",n.ts=Date.now();const r=new Date;n.lDate={y:r.getFullYear(),m:r.getMonth()+1,d:r.getDate()},os.postToMilestones(n)}},jl={makeVictoryMessage:function(e,t){const n=e.getWidth();var r;e.getHeight(),r=t.isAI?t.info.heroName+" Wins!":"You Win!";var i=Ba.makeText(e,r,{useFont:Ba.menus.mainFont,x:0,y:70,w:n});i.setColor("#F2B900"),i.setFontSize(96);var o=180,s=new rat.ui.Element(e);return s.drawSelf=function(e){gfx.drawHeroAvatar(t.civIndex,90-this.center.x,90-this.center.y,o,!1,!0),this.petInfo&&(e.save(),e.translate(-36-this.center.x,90-this.center.y),e.rotate(.6),e.scale(.8,.8),gfx.drawPet(e,this.petInfo,0,-15),e.restore())},t.stats.gotPet&&(s.petInfo={cardID:t.stats.gotPet}),s.setPos(200,98),s.setSize(o,o),s.centerFromSize(),s.setRotation(-.25),{winTextBox:i,avatarPane:s}}},Kl={width:250,height:350,cornerRadius:19,spaceX:50,spaceY:50,faceYShift:-32,nameOffsetY:-90,labelHeight:50,normalColor:new rat.graphics.Color("#a6d072"),highlightColor:new rat.graphics.Color("#fdeaff"),highlightStrokeColor:new rat.graphics.Color(255,255,255,.95),pressColor:new rat.graphics.Color("#bf9cc2"),pressStrokeColor:new rat.graphics.Color("A0A0A0"),backColor:new rat.graphics.Color("#d9cbda")},Yl=Kl.labelHeight;var Xl=function(e,t,n,r,i){if(Xl.prototype.parentConstructor.call(this,e),void 0===(i=i||{}).includeName&&(i.includeName=!0),i.showNew=i.showNew||!1,i.showPlus=i.showPlus||!1,i.showBack=i.showBack||!1,i.showStroke=i.showStroke||!1,this.opts=i,this.screen=t,this.setSize(Kl.width,Kl.height),this.category=n,this.cardID=r,this.cardInfo=app.cards.getCard(r),this.cardRawCount=app.cards.cardRawCountFromFullID(r),this.name=this.cardInfo.name,this.mainImageRef=new rat.graphics.ImageRef(this.cardInfo.image),this.mainImageRef.setCentered(!0,!0),this.setColor(Kl.normalColor),i.showNew){var o=new rat.ui.Sprite(this);o.useImageRef(gfx.getImage("new_card")),o.setPos(46,46),o.setSize(100,100),o.scaleImageToSize(),this.newIcon=o}if(i.showPlus){var s=new rat.ui.Sprite(this);s.useImageRef(gfx.getImage("card_plus")),s.setPos(Kl.width-110,38),s.setSize(70,70),s.scaleImageToSize(),this.plusIcon=s}if(r&&i.includeName){var a=this.name;this.textBox=Ba.makeText(this,a,{x:10,y:Kl.height+Kl.nameOffsetY,w:Kl.width-20,h:Yl,useFont:Ba.menus.cardFont}),this.textBox.centerText(),this.textBox.setAutoWrap(!0),i.showBack&&this.textBox.setVisible(!1)}if(i.includeFavorite){var l=app.cards.getFavoriteFlag(this.cardRawCount,this.cardID),c=new rat.ui.Sprite(this);c.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),c.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),c.setBounds(Kl.width-90,-8,90,90);var u=gfx.getImageCopy("menu_favorite_red").setCentered(!1,!1);c.loadImage(u),c.setVisible(l),this.favIcon=c}Xl.backImageRef||(Xl.backImageRef={normal:gfx.getImage("card_back"),pressed:gfx.getImage("card_back_pressed"),high:gfx.getImage("card_back_high")}),Xl.frontImageRef||(Xl.frontImageRef={normal:gfx.getImage("card_front"),pressed:gfx.getImage("card_front_pressed"),high:gfx.getImage("card_front_high")})};rat.utils.inheritClassFrom(Xl,rat.ui.Button),Xl.prototype.setImageList=function(e){this.imageList=e},Xl.prototype.getCardCenterPos=function(){return{x:this.size.x/2,y:this.size.y/2}},Xl.prototype.hideNew=function(){this.newIcon&&this.newIcon.setVisible(!1)},Xl.prototype.hidePlus=function(){this.plusIcon&&this.plusIcon.setVisible(!1)},Xl.prototype.showFavorite=function(e){void 0===e&&(e=!0),this.favIcon&&this.favIcon.setVisible(e)},Xl.prototype.updateShowFavorite=function(){var e=app.cards.getFavoriteFlag(this.cardRawCount,this.cardID);this.showFavorite(e)},Xl.prototype.setShowBack=function(e){this.opts.showBack=e,this.textBox&&this.textBox.setVisible(!e)},Xl.prototype.drawSelf=function(e){var t,n=Kl.width,r=Kl.height;e.save(),e.translate(n/2-this.center.x,r/2-this.center.y),e.scale(1,1),this.opts.showUnknown&&(e.globalAlpha=.6),t=this.opts.showBack?Xl.backImageRef:Xl.frontImageRef,(this.isPressed()?t.pressed:this.isHighlighted()?t.high:t.normal).draw(e,0,0,Kl.width,Kl.height),this.opts.showStroke&&(rat.graphics.draw.roundRect({x:0-this.center.x,y:0-this.center.y,w:n,h:r},Kl.cornerRadius),e.lineWidth=8,e.strokeStyle="#000000",e.stroke());var i=0;if(this.isToggled()||this.isPressed()?i=Kl.pressStrokeColor:this.isHighlighted()&&(i=Kl.highlightStrokeColor),i){rat.graphics.draw.roundRect({x:0-this.center.x-12,y:0-this.center.y-12,w:n+24,h:r+24},Kl.cornerRadius+6),e.strokeStyle=i,e.lineWidth=10,e.stroke()}if(!this.opts.showBack){var o=Kl.width,s=o;this.mainImageRef.draw(e,0,Kl.faceYShift,o,s)}e.restore()},Xl.drawOneCard=function(e,t,n,r,i,o){o=o||{};var s=Kl.width,a=Kl.height;rat.graphics.draw.roundRect({x:0-s/2,y:0-a/2,w:s,h:a},Kl.cornerRadius);var l=Kl.normalColor;if(e.fillStyle=l.toString(),e.fill(),o.strokeStyle&&(e.lineWidth=10,e.strokeStyle=o.strokeStyle,e.stroke()),i){var c=Kl.width,u=Kl.width;i.draw(e,0,Kl.faceYShift,c,u)}},Xl.prototype.flipOver=function(e){var t=this,n=t.getScale(),r={x:n.x,y:n.y};t.killMyAnimators();var i=new rat.ui.Animator(rat.ui.Animator.scaler,t);i.setTimer(.08),i.setStartEndVectors(r,{x:0,y:r.y}),i.setDoneCallback((function(n,i){t.setShowBack(!t.opts.showBack);var o=new rat.ui.Animator(rat.ui.Animator.scaler,t);o.setTimer(.08),o.setStartEndVectors({x:0,y:r.y},r),o.setDoneCallback((function(n,r){e(t)}))}))},Xl.cardConfig=Kl;const $l=1e3,Jl=1400,Ql=76,Zl=400,ec=400,tc=Xl.cardConfig,nc=function(e,t,n,r){nc.prototype.parentConstructor.call(this);var i=this;i.setModal(!0),i.setAllowClickAway(!0),i.setAllowBackClose(!0),i.setUserCloseCallback((function(e,t){i.closeMe()})),i.fromCardUI=n,i.cardID=e,i.sourcePos=t,i.fromScreen=r,i.cardInfo=app.cards.getCard(e),i.cardRawCount=app.cards.cardRawCountFromFullID(e),i.buildScreen(!1)};rat.utils.inheritClassFrom(nc,rat.ui.Screen),nc.prototype.buildScreen=function(e){this.removeAllSubElements(),e?this.buildScreenClosed():this.buildScreenOpen()},nc.prototype.buildScreenOpen=function(){var e=this;this.openCloseState="open";var t=$l,n=Jl,r=app.cards.getFavoriteFlag(e.cardRawCount,e.cardID),i=app.cards.getFavoriteTreasure(e.cardID),o=null!==i&&i.length>0;e.setPos(0,0),e.setSize(t,n),e.centerHighInDisplay(),e.centerFromSize(!0,!0);var s=app.cards.getRarityDisplayString(this.cardInfo.rarity),a=Ba.makeText(this,s,{h:80,w:1300,useFont:Ba.menus.cardRarityFont});a.setRotation(Math.PI/2),a.setPos(100,50),a.setAlignment("left");var l=new rat.ui.Sprite(this),c=new rat.graphics.ImageRef(this.cardInfo.image);l.useImageRef(c),l.setSize(Zl,ec),l.setPos(t/2,220),l.centerFromSize(),l.scaleImageToSize();var u=new rat.ui.Sprite(e);u.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),u.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),u.setBounds(t-280,100,200,200);var h=gfx.getImageCopy("menu_favorite_red").setCentered(!1,!1);u.loadImage(h),u.setVisible(r);var d=10,p=this.cardInfo.name;this.nameBox=Ba.makeText(this,p,{x:d,y:410,w:t-2*d,h:80,useFont:Ba.menus.cardDetailFont}),this.nameBox.centerText();d=60,p=this.cardInfo.description;if(this.descBox=Ba.makeText(this,p,{x:d,y:550,w:t-2*d,h:300,useFont:Ba.menus.cardDetailDescriptionFont}),this.descBox.setAlignment("center"),this.descBox.setBaseline("top"),this.descBox.setAutoWrap(!0),o){this.rewardLabel=Ba.makeText(this,"pet reward in game:",{x:d,y:880,w:t-2*d,h:50,useFont:Ba.menus.cardDetailDescriptionFont}),this.rewardLabel.setFontSize(this.rewardLabel.getFontSize()-5),this.rewardLabel.setFontStyle("italic"),this.rewardLabel.setAlignment("center");for(var g=(t-240)/(i.length+1),m=0;m<i.length;m++){var f=i[m].type;(l=new rat.ui.Sprite(e)).useImageRef(gfx.getImageCopy(f).setCentered(!1,!1)),l.setSize(90,90),l.scaleImageToSize(),l.setPos(120+g*(m+1)-45,960)}}if(o){var v=Ba.makeIconButtonAt(Ba.menus,e,"menu_favorite",t-200,n-160);Ba.setTooltip(v,"mark/unmark as one of your pets"),v.setCallback((function(){return v.isToggled()?(console.log("hit favorite on"),u.setVisible(!0),app.cards.setFavoriteFlag(e.cardID,!0),e.fromCardUI.showFavorite(!0),app.writeSettings()):(console.log("hit favorite off"),u.setVisible(!1),app.cards.setFavoriteFlag(e.cardID,!1),e.fromCardUI.showFavorite(!1),app.writeSettings()),!0})),Ba.setIconButtonLabel(v,"my pet"),v.setToggles(!0);var y=new rat.ui.Sprite(v);y.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),y.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),y.setBounds(v.icon.getBounds());h=gfx.getImageCopy("menu_notfavorite").setCentered(!1,!1);y.loadImage(h),y.setVisible(!0),v.icon.setVisible(!1),v.icon2=y,v.setFlagsChangedCallback((function(e,t){v.flags&rat.ui.Element.toggledFlag||v.flags&rat.ui.Element.pressedFlag?(v.icon.setVisible(!0),v.icon2.setVisible(!1)):(v.icon.setVisible(!1),v.icon2.setVisible(!0))})),v.setToggled(r)}var w=Ba.makeIconButtonAt(Ba.menus,e,"menu_back",t/2,n-160);Ba.setTooltip(w,"go back"),w.setCallback((function(){return e.closeMe(),!0})),Ba.setIconButtonLabel(w,"back"),e.autoBuildInputMap({defaultFocusTo:w})},nc.prototype.closeMe=function(){rat.screenManager.popScreen()},nc.prototype.drawSelf=function(e){var t=this.size.x,n=this.size.y,r=this.getPos();e.fillStyle="rgba(0,0,0,0.75)",e.fillRect(-r.x,-r.y,rat.graphics.SCREEN_WIDTH,rat.graphics.SCREEN_HEIGHT),rat.graphics.draw.roundRect({x:0-this.center.x,y:0-this.center.y,w:t,h:n},Ql);var i=tc.normalColor;e.fillStyle=i.toString(),e.fill(),e.lineWidth=24,e.strokeStyle="#f2f8e9",e.stroke()},nc.prototype.handleKeyDown=function(e){if(e.sysEvent.ctrlKey&&(e.which==rat.input.keys.leftArrow||e.which==rat.input.keys.rightArrow)){console.log("ctrl arrow");var t=1;return e.which==rat.input.keys.leftArrow&&(t=-1),this.closeMe(),this.fromScreen.shortcutNextCard(this.cardID,t),!0}return!1},nc.prototype.onWindowResize=function(){this.buildScreen(!1)};var rc=function(e,t){rc.prototype.parentConstructor.call(this),console.log("setup InfoPopup");var n=this,r=1280,i=880;n.setSize(r,i),n.centerHighInDisplay(),this.slideInFrom("bottom",.1),za.playSound("slide_in");var o=Ba.addRoundedBackground(this);Ba.makePopTitleBox(this,e);var s=800,a=Ba.makeText(this,t,{x:100,y:200,w:1080,h:s,useFont:Ba.menus.explanationFont});a.setBaseline("top"),a.enableDefaultSpecialFormatting(),a.setAutoWrap(!0),s=a.getTextHeight(),a.setHeight(s),i=s+200+250,o.setHeight(i);var l=640,c=2*Ba.menus.squareButton.gap+Ba.menus.squareButton.width;Ba.menus.squareButton.gap,Ba.menus.squareButton.height;var u=i-.9*Ba.menus.squareButton.height,h=Ba.makeIconButtonAt(Ba.menus,n,"menu_back",l,u);Ba.setTooltip(h,"close"),h.setCallback((function(){return rat.ui.animationManager.killAllAnimators(),rat.screenManager.popScreen(),!0})),Ba.setIconButtonLabel(h,"back"),l+=c,this.setModal(!0),this.setAllowClickAway(!0),this.setAllowBackClose(!0),this.setAllowClickBodyClose(!0),n.autoBuildInputMap({defaultFocusTo:h}),Ba.addDimmer(n)};rat.utils.inheritClassFrom(rc,rat.ui.Screen),rc.prototype.myScreenActivate=function(){console.log("info popup activate")},rc.prototype.myScreenDeactivate=function(){console.log("info popup deactivate")},rc.prototype.onWindowResize=function(){this.centerHighInDisplay()},rc.make=function(e,t){var n=new rc(e,t);rat.screenManager.pushScreen(n)};var ic=function(e,t){ic.prototype.parentConstructor.call(this),console.log("setup CollectionScreen "+e),e||(e="dog"),this.cardCategory=e,this.cardCategoryList=app.cards.getCategoryNameList(),this.categoryIndex=this.cardCategoryList.indexOf(e),this.rebuildUI(),this.updateCelebrateDestinations(),ic.celebrateList.length>0&&za.playSound("card_unlock"),this.setModal(!0),this.setOverlay(!1),Ba.setMenuBackAction(this)};rat.utils.inheritClassFrom(ic,rat.ui.Screen),ic.celebrateList=[],ic.newList=[],ic.prototype.rebuildUI=function(e){var t=this;e&&this.cardPanel?t.cardPanel&&t.cardPanel.removeAllSubElements():(this.cardPanel=null,this.background=null,t.removeAllSubElements());var n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT;t.setSize(n,r),this.background||xa.applyToScreen(this),this.cardPanel||(this.cardPanel=new rat.ui.Element(this),this.cardPanel.name="cardPanel group",this.cardPanel.fitToParentSize(),this.cardPanel.setUseOffscreen(!0)),this.setupDragging(),this.cardList=app.cards.getCardCategoryIDList(this.cardCategory);var i=ic.newList[this.cardCategory]||{};this.cardList.sort((function(e,t){if("1"===e)return-1;if("1"===t)return 1;var n=app.cards.getCard(e),r=app.cards.getCard(t);return n.rarityOrder<r.rarityOrder?-1:n.rarityOrder>r.rarityOrder?1:n.sort<r.sort?-1:n.sort>r.sort?1:n.name<r.name?-1:n.name>r.name?1:0}));var o,s,a=Xl.cardConfig,l=50,c=50;n<r?(o=7,s=6):(o=10,s=4),t.fitX=o,t.fitY=s,t.shiftedLastRow=!1;var u=n-2*c,h=(a.width+a.spaceX)*o,d=(r-2*l-230)/((a.height+a.spaceY)*s),p=u/h,g=d;p<d&&(g=p),t.cardScale=g;var m=a.width*g,f=a.height*g,v=a.spaceX*g,y=a.spaceY*g;c=(n-(o*m+(o-1)*v))/2,l=(r-230-(s*f+(s-1)*y))/2,this.cards=[];for(var w=0,C=0,S=0;S<this.cardList.length;S++){var b=w%o,_=w/o|0;r>n&&5==_&&(t.shiftedLastRow=!0,b++);var x=this.cardList[S],T=x,k=app.cards.getCard(x),I=ic.findInCelebrateList(this.cardCategory,x),P=app.settings.collection[x];(!P||I&&I.wasNew)&&(x="?");var E={};i[x]&&!I&&(E.showNew=!0),"?"===x&&(E.showUnknown=!0),E.includeFavorite=!0;var A=new Xl(this.cardPanel,this,this.cardCategory,x,E);if(this.cards[T]=A,"?"===x);else{var D=app.cards.getUnlockCount(P,x);if(D.have>0&&!I){var B=rat.ui.Button.makeSpriteButton("res/images/ui/menus/card_plus.png","res/images/ui/menus/card_plus_button_high.png","res/images/ui/menus/card_plus_button_pressed.png"),R=app.cards.canUseUnlock(x);if(R){C++;var F=new rat.graphics.ImageRef(["res/images/ui/menus/card_plus.png","res/images/ui/menus/card_plus_button_high.png"]);F.setAnimSpeed(3);var N=[{state:rat.ui.Element.enabledFlag,imageRef:F},{state:0,imageRef:F}];B.setStateImages(N)}A.appendSubElement(B);var M=B.getImage();M.setSize(60,60),M.scaleImageToSize();var L=50;D.have+D.need>1e3?L=0:D.have+D.need>100?L=15:D.have+D.need>10&&(L=35);if(B.setSize(a.width-L,60),B.setPos(L,0),R){var O={cardPane:A,cardID:x,cardIndex:S,have:D.have,need:D.need,but:B};B.setCallback((function(e,n){t.unlockCardClick(n,n.cardPane)}),O),A.unlockExtraInfo=O}else B.setCallback(ic.progressCardClick,D),A.unlockExtraInfo=null;B.setEnabled(!1);var H=D.have+"/"+D.need;"legendary"===k.rarity&&app.cards.allRarityCatCollected(k.rarityOrder,k.category)&&(H=""+D.have);var z=Ba.makeText(A,H,{useFont:Ba.menus.cardExtraFont});z.setPos(L+60,16),z.setSize(a.width-60-L,30),z.setAlign("left")}}var q=c+b*(m+v),V=l+_*(f+y);A.setPos(q+m/2,V+f/2),A.setSize(a.width,a.height),A.setScale(g,g),A.centerFromSize(!0),"none"===x&&A.setToggled(!0),"?"===x?A.setCallback(ic.mysteryCardClick,{isPet:"pet"===k.metaCategory}):A.setCallback(ic.cardClick,{isPet:"pet"===k.metaCategory}),w++}if(this.cardPanel.setHeight(r-230),e){if(this.buts)for(var W=0;W<this.buts.length;W++)this.moveSubElementToFront(this.buts[W])}else{this.buts=[];var G=2*Ba.menus.squareButton.gap+Ba.menus.squareButton.width;Ba.menus.squareButton.gap,Ba.menus.squareButton.height;V=r-Ba.menus.squareButton.height,q=n/2,B=Ba.makeIconButtonAt(Ba.menus,t,"menu_back",q,V);Ba.setTooltip(B,"go back"),B.setCallback((function(){return function(e,n){ic.clearNewList(t.cardCategory),ic.clearCelebrateList(),app.screenList.goBackScreen(e,n)}(),!0})),Ba.setIconButtonLabel(B,"back"),this.buts.push(B),q+=G,t.backButton=B;q=.15*n,B=Ba.makeIconButtonAt(Ba.menus,t,"menu_left",q,V);Ba.setTooltip(B,"more cards"),B.setCallback((function(){return t.slidePage(-1),!0})),this.buts.push(B),t.leftButton=B;q=.85*n,B=Ba.makeIconButtonAt(Ba.menus,t,"menu_right",q,V);Ba.setTooltip(B,"more cards"),B.setCallback((function(){return t.slidePage(1),!0})),this.buts.push(B),t.rightButton=B;q=.33*n,B=Ba.makeIconButtonAt(Ba.menus,t,"menu_help",q,V);Ba.setTooltip(B,"help"),B.setCallback((function(){return t.showHelp(t.cardCategory),!0})),Ba.setIconButtonLabel(B,"help"),this.buts.push(B);q=.67*n,B=Ba.makeIconButtonAt(Ba.menus,t,"menu_unlock_all",q,V);Ba.setTooltip(B,"unlock with all extra cards"),B.setCallback((function(e,n){var r=app.cards.doAllUnlocks(t.cardCategory);return za.playSound("card_unlock"),t.rebuildUI(!0),t.animateUnlocks(r),e.setVisible(!1),!0})),Ba.setIconButtonLabel(B,"trade in all"),this.buts.push(B),t.unlockAllButton=B}t.unlockAllButton&&(C>=2?t.unlockAllButton.setVisible(!0):t.unlockAllButton.setVisible(!1)),this.buildInputMap()},ic.prototype.buildInputMap=function(){var e=this,t=e.fitX;e.fitY;var n=[],r=this.cardPanel.subElements,i=r.length%t;0===i&&(i=t);for(var o=r.length-i,s=[],a=0;a<this.buts.length;a++){(b=this.buts[a]).isVisible()&&b.isEnabled()&&s.push(b)}s.sort((function(e,t){return e.getPosX()-t.getPosX()}));const l=s.length;for(a=0;a<r.length;a++){var c=a/t|0,u=a%t,h=c*t,d=t,p=a>=o,g=a<o&&a>=o-t;p&&(d=i);var m=h+(u-1+d)%d,f=h+(u+1)%d;if((P={currObj:I=r[a]}).left=r[m],P.right=r[f],c>0){var v=(c-1)*t+u;p&&e.shiftedLastRow&&v++,P.up=r[v]}if(p){var y=I.getGlobalPos();y.x+=I.parent.getAnchor().x;for(var w,C=null,S=0;S<s.length;S++){var b,_=(b=s[S]).getGlobalPos(),x=Math.abs(_.x-y.x);(!C||x<w)&&(w=x,C=b)}P.down=C}else{var T=(c+1)*t+u;e.shiftedLastRow&&g&&--T<h+t&&T++,T>=r.length&&T--,P.down=r[T]}P.tabOrder=a,n.push(P)}var k=r.length;for(a=0;a<s.length;a++){var I,P={currObj:I=s[a]};m=s[(a-1+l)%l],f=s[(a+1)%l];P.left=m,P.right=f,P.tabOrder=k++;var E=a/(l-1),A=i*(E=rat.math.clamp(E,0,1))|0,D=o+(A=rat.math.clamp(A,0,i-1));P.up=r[D],n.push(P)}var B=this.inputMap?this.inputMap.getCurrentFocusedButton():null,R=-1;B&&B.cardID&&(R=B.cardID);var F=-1;rat.input.usingDirectionInput()&&(F=n.length-1);for(a=0;a<n.length;a++)if(n[a].currObj===B||n[a].currObj.cardID===R){F=a;break}e.inputMap=new rat.input.InputMap(n,F)},ic.prototype.changeCollection=function(e){var t=this;ic.clearNewList(t.cardCategory),ic.clearCelebrateList(),t.categoryIndex=(t.categoryIndex+e+t.cardCategoryList.length)%t.cardCategoryList.length,t.cardCategory=t.cardCategoryList[t.categoryIndex],t.rebuildUI(!0)},ic.prototype.slidePage=function(e){var t=this,n=this.cardPanel,r=this.size.x+100;n.killMyAnimators();var i=new rat.ui.Animator(rat.ui.Animator.centerer,n);i.setTimer(.1);var o={x:n.center.x,y:n.center.y},s={x:e*r,y:0};i.setStartEndVectors(o,s),i.setDoneCallback((function(i,o){t.changeCollection(e);var s=new rat.ui.Animator(rat.ui.Animator.centerer,n);s.setTimer(.1);var a={x:-e*r,y:n.center.y};s.setStartEndVectors(a,{x:0,y:0})}))},ic.prototype.cardFromCardID=function(e){return this.cards[e]},ic.mysteryCardClick=function(e,t){if(t.isPet){r="mystery card";var n="You can unlock cards by winning games.\n\nCollect duplicates to exchange for more rare cards."}else{var r="mystery civ card";n="You can unlock cards by winning games.\n\nThese civ cards are awarded for defeating AI civs (in normal games above a certain difficulty)"}rc.make(r,n)},ic.prototype.showHelp=function(e){var t={default:{bodyText:"These cards can be collected from normal games.\n\nYou can mark cards as `pets` and find them in later games for `bonus resources`.\n\nWhen you've collected enough `extra` of a card, you can trade those extras in for a more `rare card`.\n\n"},bird:{bodyText:"Bird cards can be collected only from daily challenge games.\n\nYou can mark birds as `pets` and find them in later games for `bonus resources`.\n\nWhen you've collected enough `extra` of a card, you can trade those extras in for a more `rare card`.\n\n"},civ:{bodyText:"Civilization cards are collected for each civ you defeat in a game.\n\n"}},n=t[e];n||(n=t.default);var r=Ba.formatText(n.bodyText);rc.make("Collectible Cards",r)},ic.progressCardClick=function(e,t){var n="You've collected extra of this card.  You can trade those for a new card.\n\nYou've got *"+t.have+"* of the *"+t.need+"* you need for the next trade-in.";n=Ba.formatText(n),rc.make("trade in extra cards",n)},ic.prototype.unlockCardClick=function(e,t){console.log("unlockCardClick : "+e.cardID+", #"+e.cardIndex);var n=app.cards.useUnlock(e.cardID,e),r=t.getCardCenterPos();n.sourcePos=t.getGlobalPos(r.x,r.y),ic.addToCelebrateList(n),this.updateCelebrateDestinations(),za.playSound("card_unlock"),n.wasNew&&n.cardCategory!==this.cardCategory&&ic.addToNewList(n.cardCategory,n.cardID),this.rebuildUI(!0)},ic.cardClick=function(e,t){var n=e.screen;if(e.unlockExtraInfo)return n.unlockCardClick(e.unlockExtraInfo,e),!0;za.playSound("card_single");var r=new nc(e.cardID,e.pos,e,n);rat.screenManager.pushScreen(r)},ic.prototype.shortcutNextCard=function(e,t){for(var n=0;n<this.cardList.length;n++){if(e===this.cardList[n]){var r=(n+t+this.cardList.length)%this.cardList.length,i=this.cardList[r];return void this.cardFromCardID(i).trigger()}}},ic.prototype.animateUnlocks=function(e){for(var t in e){var n=e[t];console.log(t+" used "+n.usedCount+", added "+n.addedCount);var r=this.cards[t],i=r.getPos(),o=r.getSize(),s=r.getScale();if(n.addedCount){var a=new Xl(this.cardPanel,this,this.cardCategory,t,{});a.setEnabled(!1),a.setPos(i),a.setSize(o),a.centerFromSize(!0),a.setScale(2*s.x,2*s.y),(l=new rat.ui.Animator(rat.ui.Animator.scaler,a)).setTimer(.33);var l,c={x:2*s.x,y:2*s.y},u={x:s.x,y:s.y};l.setStartEndVectors(c,u),l.setAutoRemoveTarget(!0),(l=new rat.ui.Animator(rat.ui.Animator.rotator,a)).setTimer(.33),l.setStartEnd(0,2*Math.PI)}else n.usedCount}},ic.prototype.myScreenActivate=function(){console.log("collection screen activate")},ic.prototype.myScreenDeactivate=function(){console.log("collection screen deactivate"),ic.celebrateList=[],ic.newList[this.cardCategory]={}},ic.prototype.onWindowResize=function(){this.rebuildUI()},ic.prototype.drawSelf=function(e){},ic.prototype.drawSelfPost=function(e,t){e=this;for(var n=ic.celebrateList,r=0;r<n.length;r++){var i=n[r],o=rat.math.interpolatePos(i.sourcePos,i.destPos,i.interp),s=Math.sin(i.interp*Math.PI);s*=200;var a=i.interp*Math.PI/2;o.x+=s*Math.cos(a),o.y+=s*Math.sin(a),t.save(),t.translate(o.x,o.y);var l=i.scale*e.cardScale;t.scale(l,l),t.rotate(i.rot),Xl.drawOneCard(t,0,0,i.cardID,i.imageRef),t.restore()}},ic.prototype.handleKeyDown=function(e){var t=this;function n(e){for(var n=0;n<e;n++){var r=app.cards.getOneRarityCardIDList(0,t.cardCategory),i=rat.utils.pickRandomInList(r);app.cards.addCardFromFullID(i)}t.rebuildUI(!0)}if(app.settings.admin){if(e.which===rat.input.keys.leftBracket)return n(1),!0;if(e.which===rat.input.keys.rightBracket)return n(10),!0;if(e.which===rat.input.keys.backslash)return n(1e3),!0;e.which===rat.input.keys["="]&&(app.cards.doAllUnlocks(),t.rebuildUI(!0))}return!1},ic.prototype.updateSelf=function(e){for(var t=ic.celebrateList,n=t.length-1;n>=0;n--){var r=t[n];r.time+=e;var i=r.time/r.timeMax;i=Math.min(1,i),i=rat.ui.Animator.filterEaseOut(i),r.interp=i,r.rot=i*Math.PI*2*1,r.scale=1+Math.sin(Math.PI*i),i>=1&&(t.splice(n,1),this.rebuildUI(!0),r.goesOffScreen||za.playSound("card_land"))}},ic.prototype.updateCelebrateDestinations=function(){for(var e=ic.celebrateList,t=0;t<e.length;t++){var n=e[t];if(!n.destPos)if(n.cardCategory===this.cardCategory){var r=this.cardFromCardID(n.cardID),i=r.getCardCenterPos(),o=r.getGlobalPos(i.x,i.y);n.destPos=o}else n.goesOffScreen=!0,n.destPos={x:rat.graphics.SCREEN_WIDTH+300,y:rat.graphics.SCREEN_HEIGHT-500}}},ic.make=function(e){var t=new ic(e);rat.screenManager.pushScreen(t)},ic.addToNewList=function(e,t){var n=ic.newList[e];n||(n=ic.newList[e]={}),n[t]=!0},ic.clearNewList=function(e){ic.newList[e]={}},ic.addToCelebrateList=function(e){e.time=0,e.interp=0,e.timeMax=1,e.rot=0;var t=app.cards.getCard(e.cardID);e.imageRef=new rat.graphics.ImageRef(t.image),e.imageRef.setCentered(!0,!0),ic.celebrateList.push(e)},ic.findInCelebrateList=function(e,t){for(var n=null,r=0;r<ic.celebrateList.length;r++){var i=ic.celebrateList[r];i.cardID==t&&i.cardCategory===e&&(n&&!i.wasNew||(n=i))}return n},ic.clearCelebrateList=function(){ic.celebrateList=[]},ic.prototype.setupDragging=function(){var e=this,t=this.cardPanel;this.dragHandler||(this.dragHandler=new rat.ui.DragHandler),this.dragHandler.attach(t,{allowY:!1,setDragOffset:function(e,n){t.center.x=-e},releaseHandler:function(n,r){var i=Math.abs(r.x);if(i>250){var o=1;r.x>0&&(o=-1),e.slidePage(o)}else if(i>0){var s=new rat.ui.Animator(rat.ui.Animator.centerer,t);s.setTimer(.1);var a={x:t.center.x,y:t.center.y};s.setStartEndVectors(a,{x:0,y:0})}}}),t.flags|=rat.ui.Element.handleAllMouseInMe};const oc=function(e,t,n,r){oc.prototype.parentConstructor.call(this,null),this.civInfo=e;var i=r.width,o=r.height;this.setSize(i,o),new rat.graphics.Color(e.info.style),jl.makeVictoryMessage(this,e);var s=game.scenario.name,a=Ba.makeText(this,s,{useFont:Ba.game.subHeadingFont,x:0,y:190,w:i});if(!e.isAI){const e=game.scenario.key,t=app.records.trackedCatsByID[e];var l=app.records.getStatsByCat(e);if(l&&l.totals){const e=l.totals.wins;var c="("+t.name+" win # ^"+e+"^)";c=Ba.formatText(c),(a=Ba.makeText(this,c,{useFont:Ba.game.mainFont,x:0,y:200,w:i})).setColor(Ba.colors.textPaleColor),a.setAlignment("right"),a.enableDefaultSpecialFormatting()}}var u=280-15*game.civs.length;n&&(n.setVisible(!0),n.setResultsMode(!0),this.appendSubElement(n),n.setPos(360,u));var h=e.rewards?e.rewards.length:0;if(h){var d="Reward Cards";e.isAI&&(d="Consolation Reward");a=Ba.makeText(this,d,{useFont:Ba.game.subHeadingFont,x:0,y:620,w:i});var p=Xl.cardConfig;p.width;for(var g=(i-20)/(h+1),m=0;m<h;m++){var f=e.rewards[m],v={faceDown:!0,showStroke:!1,showBack:!0};v.showNew=f.wasNew,v.showPlus=f.canUnlock,v.includeFavorite=!0;var y=new Xl(this,this,f.cardCategory,f.cardID,v);y.showFavorite(!1),y.setSize(p.width,p.height),y.setScale(.7,.7),y.centerFromSize(!0),y.setPos(10+g*(m+1),860),y.setRotation(-.1),y.setCallback((function(e,t){e.flipOver((function(n){t.wasNew&&ic.addToNewList(t.cardCategory,t.cardID),n.updateShowFavorite(),e.setCallback((function(n,r){e.hideNew(),e.hidePlus();var i=new ic(t.cardCategory,t.cardID);rat.screenManager.pushScreen(i)}))}))}),f);const t=.5+.1*m;var w=y.slideInFrom("left",.3),C=-rat.graphics.SCREEN_WIDTH/2-200;w.setStartVector({x:C,y:y.place.pos.y}),w.setDelay(t);var S=new rat.ui.Animator(rat.ui.Animator.rotator,y);S.setTimer(.3),S.setDelay(t),S.setStartEnd(2*-Math.PI,0)}}h>0&&setTimeout((function(){h>1?za.playSound("card_deal"):za.playSound("card_single")}),600)};rat.utils.inheritClassFrom(oc,rat.ui.Element);const sc={makeIconRow:function(e,t,n){var r=e.size.x,i=t.length,o=r-200,s=i*n.itemWidth+(i-1)*n.itemSpacing;if(s>o){var a=n.itemWidth*i-o;n.itemSpacing=-a/(i-1),s=o}var l=r/2-s/2;function c(e,t){return l+e*(n.itemWidth+n.itemSpacing)+n.itemWidth/2+0}for(var u=n.baseY+n.itemHeight/2,h=0;h<i;h++){if((d=t[h]).back)(f=new rat.ui.Sprite(e)).setSize(n.itemWidth,n.itemHeight),f.centerFromSize(),f.setPos(c(h),u),f.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),f.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),d.back.resource&&f.loadImage(d.back.resource)}for(h=0;h<i;h++){var d;if((d=t[h]).icon){var p=n.iconWidth,g=n.iconHeight;if(d.spacing&&d.spacing.imageWidth&&(p=g=d.spacing.imageWidth),d.icon.pane){var m=d.icon.pane;m.setSize(p,g),m.centerFromSize(),m.setPos(c(h),u),e.moveSubElementToFront(m)}else{var f=new rat.ui.Sprite(e);d.icon.image&&f.useImageRef(d.icon.image),f.setSize(p,g),f.scaleImageToSize(),f.centerFromSize(),f.setPos(c(h),u),d.rot&&f.setRotation(d.rot)}}}},makeMonsterList:function(e,t,n){for(var r=[],i=0;i<t.length;i++){var o=t[i],s=bl.monsterTable[o.level],a=gfx.getImageCopy(s.portraitAsset||s.asset);a.setCentered(!1),r.push({back:{resource:"res/images/tiles/tile_sand.png"},icon:{image:a}})}sc.makeIconRow(e,r,n)},makeIntroContent:function(e,t,n){const r=n.width||e.getWidth(),i=n.height||e.getHeight();var o=n.topLeftOffset||{x:.1*r,y:250},s=o.y;r<i&&(s=.2*i);for(var a=0;a<t.length;a++){const n=t[a],i=Ba.formatText(n.text);var l=Ba.makeText(e,i,{x:o.x,y:s,useFont:Ba.menus.introAdviceFont});if(l.enableDefaultSpecialFormatting(),l.setAlignment("left"),s+=100,n.image||n.civImage){var c={w:(m=(g=gfx.getImageCopy(n.image)).getSize()).w,h:m.h};if(n.imageWidth){var u=n.imageWidth/m.w;c.w*=u,c.h*=u}(f=new rat.ui.Sprite(e)).clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),f.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),f.setSize(c.w,c.h),f.centerInParent();var h=s;n.offset&&(h+=n.offset.y),f.setPosY(h),n.imageXPos&&f.setPosX(n.imageXPos),f.useImageRef(g),s+=n.spaceOverride?n.spaceOverride.h:c.h+70}else if(n.imageSet){var d=[],p=o.x;p=r/2-200*n.imageSet.length/2,n.imageXPos&&(p=n.imageXPos);for(let t=0;t<n.imageSet.length;t++){const r=n.imageSet[t];var g;(g=r.isCivImage?gfx.civImages[0][r.image].copy():gfx.getImageCopy(r.image)).setCentered(!1,!1);var m;c={w:(m=g.getSize()).w,h:m.h};if(r.imageWidth){u=r.imageWidth/m.w;c.w*=u,c.h*=u}var f,v=p,y=s;if(r.offset&&(v+=r.offset.x,y+=r.offset.y),n.usingIconRow)d.push({back:r.showBack?{resource:"res/images/tiles/tile_sand.png"}:null,icon:{image:g},rot:r.rot,spacing:r});else(f=new rat.ui.Sprite(e)).clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),f.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),f.setSize(c.w,c.h),f.setPos(v,y),f.useImageRef(g),p+=c.w+20}const t={baseY:s+30,itemWidth:150,itemHeight:150,iconWidth:160,iconHeight:160,itemSpacing:-2};sc.makeIconRow(e,d,t),s+=180}}}},ac=function(e,t,n,r){ac.prototype.parentConstructor.call(this,null),this.civInfo=t;var i=r.width,o=r.height;this.setSize(i,o),new rat.graphics.Color(t.info.style);var s=t.stats.resourcesSpent+t.stats.resourcesSpentInWar,a=40;this.makeStatsRow(i/2,a,"turns",game.turns.turn),a+=70,this.makeStatsRow(i/2,a,"resources collected",t.stats.resourcesTotal),a+=70,this.makeStatsRow(i/2,a,"resources used",s),a+=70,this.makeStatsRow(i/2,a,"things built",t.stats.thingsBuilt),a+=70,this.makeStatsRow(i/2,a,"final buildings",t.buildings.length),a+=70;for(var l=[],c=0;c<t.buildings.length;c++){var u=t.buildings[c],h=new Pl(this,u.type,u.civIndex);l.push({back:{resource:"res/images/tiles/tile_sand.png"},icon:{pane:h}})}sc.makeIconRow(this,l,{baseY:a+30,itemWidth:150,itemHeight:150,iconWidth:150,iconHeight:150,itemSpacing:-1}),t.creatureHistory.length&&(sc.makeMonsterList(this,t.creatureHistory,{baseY:820,itemWidth:180,itemHeight:180,iconWidth:130,iconHeight:130,itemSpacing:-50}),Ba.makeText(this,"Monsters Defeated",{useFont:Ba.game.subHeadingFont,x:0,y:720,w:i}))};rat.utils.inheritClassFrom(ac,rat.ui.Element),ac.prototype.makeStatsRow=function(e,t,n,r){var i=this.size.x/3;Ba.makeText(this,n,{useFont:Ba.menus.statsFont,x:e-40-i,y:t,w:i}).setAlignment("right"),Ba.makeText(this,""+r,{useFont:Ba.menus.statsFont,x:e+40,y:t,w:i}).setAlignment("left")};const lc=function(e,t,n,r){lc.prototype.parentConstructor.call(this,null),this.civInfo=t;var i=r.width,o=r.height;this.setSize(i,o),jl.makeVictoryMessage(this,e);var s=[{text:"•    This was a `simplified` intro level."},{text:"                Normal levels have more `interesting things`...",imageXPos:i/2-700,usingIconRow:!0,imageSet:[{image:"war",showBack:!0,imageWidth:100,offset:{x:0,y:30}},{image:"skull",showBack:!0,imageWidth:120,offset:{x:0,y:30}},{image:"dragon",showBack:!0,imageWidth:130,offset:{x:30,y:30}},{image:"prod3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"tech3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"money3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"intro_card",isCivImage:!1,showBack:!1,offset:{x:0,y:0},rot:.15},{image:"intro_dotdotdot",isCivImage:!1,showBack:!1,offset:{x:0,y:0}}]},{text:""},{text:"•    The ^new^ button below will start a new full game."}];sc.makeIntroContent(this,s,{topLeftOffset:{x:.1*i,y:350}})};rat.utils.inheritClassFrom(lc,rat.ui.Element);var cc=function(e,t,n){cc.prototype.parentConstructor.call(this);var r=this;r.setModal(!0),r.setOverlay(!1);var i=rat.graphics.SCREEN_WIDTH,o=rat.graphics.SCREEN_HEIGHT;const s=Ba.menus.squareButtonBottomOffset-40;r.setSize(i,o),xa.applyToScreen(r);var a=new rat.ui.PageSlider(r);r.pager=a,a.fitToParentSize(),a.setOrientation("horizontal");var l=Ba.makeIconButtonAt(Ba.menus,r,"menu_left",.15*i,120);r.leftButton=l,Ba.setIconButtonLabel(l,"more");var c=Ba.makeIconButtonAt(Ba.menus,r,"menu_right",.85*i,120);r.rightButton=c,Ba.setIconButtonLabel(c,"more"),a.attachButtons(l,c);var u=Ba.makeIconButtonAt(Ba.menus,r,"menu_map",.3*i,o-s);r.backButton=u,Ba.setIconButtonLabel(u,"map"),Ba.setTooltip(u,"go back to look at map"),u.setCallback((function(e,t){game.hud.returnFromResultsScreen(),cc.builtScreen=r,rat.screenManager.popScreen()}));var h=game.scenario,d={icon:"menu_play",name:"new",tipText:"start a new game of the same type",callback:function(e,t){game.checkAndPostResults(),game.restartNew()}};if(h.nextScenario){var p=h.resultsNextButtonTip||"continue to the next scenario";d={icon:"menu_play",name:h.resultsNextButtonName||"next",tipText:p,callback:function(e,t){game.checkAndPostResults(),game.restartNew(ul.templates[h.nextScenario])}}}h.challengeSeed&&(d={icon:"menu_dailies",name:"dailies",tipText:"return to daily challenge screen",callback:function(e,t){app.screenList.pushScreen("daily")}});u=Ba.makeIconButtonAt(Ba.menus,r,d.icon,.6*i,o-s);r.playButton=u,Ba.setIconButtonLabel(u,d.name),Ba.setTooltip(u,d.tipText),u.setCallback(d.callback);u=Ba.makeIconButtonAt(Ba.menus,r,"menu_back",.5*i,o-s);r.exitButton=u,Ba.setIconButtonLabel(u,"exit"),Ba.setTooltip(u,"exit to main menu"),u.setCallback((function(e,t){game.checkAndPostResults(),game.exit(),app.prepStateForLeavingGame(),app.gotoScreen("main")})),e.isAI;u=Ba.makeIconButtonAt(Ba.menus,r,"menu_restart",.4*i,o-s);r.retryButton=u,Ba.setIconButtonLabel(u,"restart"),Ba.setTooltip(u,"restart this scenario"),u.setCallback((function(e,t){game.checkAndPostResults(),rat.screenManager.popScreen(),game.restart()}));u=Ba.makeIconButtonAt(Ba.menus,r,"menu_records",.85*i,o-s);r.recordsButton=u,Ba.setIconButtonLabel(u,"records"),Ba.setTooltip(u,"show records"),u.setCallback((function(e,t){const n=app.gotoScreen("records"),r=game.scenario.key;n.scrollToShowCategory(r)})),r.contentPanes=[{pageName:"Results",content:new oc(e,t,n,uc)},{pageName:"Your Stats",content:new ac(e,t,n,uc)}],h.resultsShowIntro&&r.contentPanes.unshift({pageName:"Intro Level",content:new lc(e,t,n,uc)});for(var g=0;g<r.contentPanes.length;g++){var m=r.contentPanes[g],f=new rat.ui.Element;f.setSize(r.getSize()),f.appendSubElement(m.content),m.holder=f;var v=new rat.ui.Shape(f,"rect");m.titleBack=v,v.setColor("#202020");var y=new rat.ui.Shape(f,"rect");m.line1=y,y.setColor(Ba.colors.solidPanelLight);y=new rat.ui.Shape(f,"rect");m.line2=y,y.setColor(Ba.colors.solidPanelLight),m.title=Ba.makeText(f,m.pageName,{useFont:Ba.game.bigHeadingFont,x:0,y:75,w:i})}if(h.challengeSeed&&game.winningCivIndex===game.playerCivIndex&&!app.settings.discord.autoPost&&Ul.canPost&&ba.isSignedIn()){var w=Ba.makeCheckBoxAt(r,"add to discord thread",100,100,500);r.discordCheck=w;var C=app.settings.discord.allowPost;w.setToggled(!!C),w.setCallback((function(e,t){var n=w.isToggled();app.settings.discord.allowPost=n,app.writeSettings()})),Ba.setTooltip(w,"post this game's results to the relevant Discord thread")}this.onWindowResize(),a.setCreatePage((function(e,t,n){return r.contentPanes[e].holder})),a.setPageCount(r.contentPanes.length),a.setPageIndex(0),a.setVisiblePageChanged((function(e,t,n){if(za.playSound("page_flip"),r.inputMap){var i=r.inputMap.getTarget();a.snapPageAnimationTemp(),r.autoBuildInputMap(),a.restorePageAnimationTemp(),"mouse"!==rat.input.lastUIInputType&&"touch"!==rat.input.lastUIInputType&&(i&&i.isVisible()&&i.isEnabled()&&(i===l||i===c)?r.inputMap.focusByButton(i):l.isVisible()&&l.isEnabled?r.inputMap.focusByButton(l):r.inputMap.focusByButton(c))}})),r.autoBuildInputMap(),setTimeout((function(){r.autoBuildInputMap({restoreFocus:!0})}),1500)};rat.utils.inheritClassFrom(cc,rat.ui.Screen),cc.prototype.destroy=function(){game.checkAndPostResults()};const uc={width:1450,height:1200};cc.prototype.onWindowResize=function(){cc.prototype.parentPrototype.onWindowResize.call(this);var e=this,t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setSize(t,n),e.background.fitToParentSize(),e.pager.fitToParentSize(),e.pager.updateContentSize();for(var r=0;r<e.contentPanes.length;r++){var i=e.contentPanes[r];i.holder.setSize(e.getSize()),i.content.centerInParent();i.titleBack.setPos(0,60),i.titleBack.setSize(t,120),i.line1.setPos(0,60),i.line1.setSize(t,5),i.line2.setPos(0,180),i.line2.setSize(t,5),i.title.setPos(0,75),i.title.setWidth(t)}e.pager.snapPageAnimation();const o=Ba.menus.squareButtonBottomOffset-40;if(e.backButton.centerAt(.33*t,n-o),e.exitButton.centerAt(.5*t,n-o),e.playButton.centerAt(.67*t,n-o),e.recordsButton.centerAt(.84*t,n-o),e.retryButton&&e.retryButton.centerAt(.16*t,n-o),e.discordCheck){const r=.16*t-Ba.menus.squareButton.width/2,i=n-o-240;e.discordCheck.setPos(r,i)}e.leftButton.centerAt(.15*t,120),e.rightButton.centerAt(.85*t,120)},cc.prototype.keyDown=function(e){return!!this.pager.keyDown(e)},cc.make=function(e,t,n){if(cc.builtScreen)rat.screenManager.pushScreen(cc.builtScreen),cc.builtScreen=null;else{var r=new cc(e,t,n);rat.screenManager.pushScreen(r)}},cc.reset=function(){cc.builtScreen=null};const hc=function(e,t){hc.prototype.parentConstructor.call(this);const n=game.config.tradeRate;var r=this;r.screenType="TradeMenu",r.setModal(!0),r.setAllowClickAway(!0),r.setAllowBackClose(!0);var i=1250;r.setSize(i,650),r.centerHighInDisplay(),Ba.addPopupBackground(r);(a=Ba.makeText(r,"trade    ",{centerX:0,centerY:73})).setPosX(0),a.setWidth(575),a.setAlignment("right");var o=new rat.ui.Sprite(r);o.useImageRef(gfx.getImageCopy(e).setCentered(!1,!1)),o.setSize(80,80),o.scaleImageToSize(),o.setPos(575,30),(a=new rat.ui.TextBox(r,""+n)).setPos(660,45),a.setSize(100,60),Ba.applyTextProperties(a,Ba.game.resourceFont);var s=app.World.resourceTypes[e];a.setColor(new rat.graphics.Color(s.textStyle));var a=Ba.makeText(r,"for one of these...",{centerX:625,centerY:170});r.tradeButtons=[];var l=165,c=0;for(var u in app.World.resourceTypes){var h=!0;u===e&&(h=!1),app.World.resourceTypes[u].name;var d=u,p=l-.5*Ba.game.squareButton.width/2,g=Ba.makeIconButtonAt(Ba.game,r,d,p,310);g.setScale(1.5),g.icon.insetBounds(14,14),g.icon.scaleImageToSize(),h?g.setCallback((function(n,i){game.tradeResource(t,e,i),r.handleUserClose()}),u):(g.setEnabled(!1),g.icon.setOpacity(.25)),r.tradeButtons[c]=g,l+=230,c++}Ba.makeButtonAt(r,"Cancel",625,560).callback=function(e,t){rat.screenManager.removeScreen(r)},this.autoBuildInputMap(!1,!1)};rat.utils.inheritClassFrom(hc,rat.ui.Screen),hc.prototype.handleKeyDown=function(e){if(e.which>=rat.input.keys[1]&&e.which<=rat.input.keys[5]){var t=e.which-rat.input.keys[1],n=this.tradeButtons[t];if(n&&n.isEnabled())return n.press(e),!0}return!1},hc.prototype.onWindowResize=function(){};const dc=function(e){dc.prototype.parentConstructor.call(this,e);var t=app.World.resourceTypeCount,n=t*pc+(t-1)*gc;this.setSize(n,Ba.config.resourcePanelHeight),this.tradeButtonsAllowed=!1,this.resBuiltList={}};rat.utils.inheritClassFrom(dc,rat.ui.Element);const pc=200,gc=20;dc.prototype.resourceBoxPos=function(e){var t=app.World.resourceTypes[e].displayIndex;return{x:(pc+gc)*t,y:0}},dc.prototype.resourceDisplayPos=function(e){var t=this.resourceBoxPos(e);return t.x+=38,t.y+=38,t},dc.prototype.allowTradeButtons=function(){this.tradeButtonsAllowed=!0,this.updateResources()},dc.prototype.updateResources=function(){var e=game.civs[app.config.showForCiv],t=app.World.resourceTypes,n=0;for(var r in t){var i=this.resBuiltList[r],o=e.resources[r].showCount,s=e.resources[r].count,a=e.harvestTrack[r].claimCount;if(void 0===o||o<=0&&!a)i&&(i.back&&i.back.setVisible(!1),i.tradeButton&&i.tradeButton.setVisible(!1)),n++;else{o<0&&(o=0),i||(i=this.resBuiltList[r]={});var l=o/game.config.resourceCap,c=t[r],u=this.resourceBoxPos(r),h=this.resourceDisplayPos(r),d=Ba.forMobile?220:140,p=!1;if(s>=game.config.allowTradeLevel)if(this.tradeButtonsAllowed){if(p=!0,!i.tradeButton){var g=rat.ui.Button.makeCheapButton(null,Ba.game.buttonColor);g.setTextValue("trade"),i.back?this.insertSubElementBefore(g,i.back):this.appendSubElement(g),i.tradeButton=g,g.setPos(u.x,u.y),g.setSize(pc,d);var m=g.getTextBox();m.setPos(0,70),m.setSize(pc,d-70),Ba.applyTextProperties(m,Ba.game.buttonFont),Ba.forMobile&&g.setFontSize(Ba.game.buttonFont.size+20),g.setTextColors(Ba.game.buttonFont.color,Ba.game.buttonFont.color,Ba.game.buttonFont.color),g.setCallback((function(t,n){var r=new hc(n,e);rat.screenManager.pushScreen(r)}),r);var f="Trade several "+app.World.resourceTypes[r].name+" for another resource.",v=fl.tradeHotKeys[n];Ba.setTooltip(g,f,"[hotkey: "+v+"]")}}else game.hud.actionPanelGroup.unlockButton("sciTrade");p&&!this.inWinState?i.tradeButton.setVisible(!0):i.tradeButton&&i.tradeButton.setVisible(!1);var y,w=i.back;if(!w){var C;w=i.back=new rat.ui.Shape("square"),this.appendSubElement(w);var S=gfx.getImageSmall(r);C=new rat.ui.Sprite;var b=new rat.graphics.ImageRef(S);b.setCentered(!1,!1),C.useImageRef(b),C.setSize(60,60),C.scaleImageToSize(),C.setPos(h.x-u.x,h.y-u.y-7),C.autoCenter(),w.appendSubElement(C),C.setEnabled(!0),C.setTracksMouse(!0),Ba.setTooltip(C,c.tipText,null,null,{w:60,h:40});var _=new rat.ui.TextBox(""+o),x={x:h.x+50-22,y:h.y-13-20};_.setPos(x.x-u.x,x.y-u.y),_.setSize(200,60),Ba.applyTextProperties(_,Ba.game.resourceFont),_.setColor(new rat.graphics.Color(c.textStyle)),w.appendSubElement(_),i.countTextBox=_;_=new rat.ui.TextBox(""+o),x={x:h.x+50-22,y:h.y-13-20};_.setPos(x.x-u.x,x.y-u.y+6),_.setSize(200,30),Ba.applyTextProperties(_,Ba.game.resourceFont),_.setFontSize(.92*Ba.game.resourceFont.size),_.setColor(new rat.graphics.Color(c.textStyle)),w.appendSubElement(_),i.maxCountTextBox=_,_.setVisible(!1);var T=i.harvestBox=new rat.ui.Element(w);T.count=0,T.setPos(x.x+70-u.x,x.y-4-u.y),T.setSize(60,60),T.dotColor=c.textStyle,T.drawSelf=function(e){var t=this.size,n=17,r=[{x:n,y:n},{x:t.x-n,y:n},{x:n,y:t.y-n},{x:t.x-n,y:t.y-n},{x:t.x/2,y:t.y/2}];this.dotCount>r.length&&(this.dotCount=r.length);for(var i=0;i<this.dotCount;i++){var o=r[i];e.fillStyle=this.dotColor,e.beginPath();var s=.62*Math.PI,a=s+2*Math.PI;i>this.dotCount-1&&this.dotCount-(0|this.dotCount)!=0&&(a=s+1.15*Math.PI),e.arc(o.x,o.y,9,s,a),e.closePath(),e.fill()}},T.setDotCount=function(e){e!=this.dotCount&&this.setDirty(!0),this.dotCount=e},(_=new rat.ui.TextBox("+1")).setPos(x.x+65-u.x,x.y-2-u.y),_.setSize(60,40),Ba.applyTextProperties(_,Ba.game.smallResourceFont),_.setColor(new rat.graphics.Color(c.textStyle)),w.appendSubElement(_),i.harvestTextBox=_;var k=x.x-u.x-10,I=x.y-u.y+40,P=new rat.ui.Shape("square");P.setSize(70,30),P.setPos(k,I),P.setColor(rat.graphics.Color.makeFromStyleString(c.style)),P.setFrame(3,new rat.graphics.Color(80,80,10)),w.appendSubElement(P),i.maxBox=P,(_=new rat.ui.TextBox("MAX")).setPos(k+2,I+3),_.setSize(70,30),_.setFont("arial"),_.setFontStyle("bold"),_.setFontSize(30),_.setColor("#000"),w.appendSubElement(_),i.maxTextBox=_}if(w.setVisible(!0),i.countTextBox.setTextValue(""+o),i.maxCountTextBox.setTextValue(""+o),a)if(a<=5)i.harvestBox.setDotCount(a),i.harvestBox.setVisible(!0),i.harvestTextBox.setVisible(!1);else y="+"+(10*a|0)/10,i.harvestTextBox.setTextValue(y),i.harvestTextBox.setVisible(!0),i.harvestBox.setVisible(!1);else i.harvestTextBox.setVisible(!1),i.harvestBox.setVisible(!1);l>=1?(i.maxBox.setVisible(!0),i.maxTextBox.setVisible(!0),i.countTextBox.setVisible(!1),i.maxCountTextBox.setVisible(!0)):(i.maxBox.setVisible(!1),i.maxTextBox.setVisible(!1),i.countTextBox.setVisible(!0),i.maxCountTextBox.setVisible(!1)),p?w.setColor("black"):w.setColor(Ba.colors.panelBackground);var E={x:u.x,y:u.y,w:pc,h:70};w.setBounds(E),n++}}},dc.prototype.prepForWinState=function(){for(var e in this.inWinState=!0,this.resBuiltList){var t=this.resBuiltList[e];t&&t.tradeButton&&t.tradeButton.setVisible(!1),t.maxBox.setVisible(!1),t.maxTextBox.setVisible(!1)}},dc.prototype.handleKeyDown=function(e){var t=game.input.numberKeyToResource(e);if(t&&!e.sysEvent.ctrlKey){var n=game.civs[app.config.showForCiv],r=n.resources[t].count;if(this.tradeButtonsAllowed&&r>=game.config.allowTradeLevel){var i=new hc(t,n);return rat.screenManager.pushScreen(i),!0}}return!1},dc.prototype.isTrackingSomething=function(){for(var e in this.resBuiltList){var t=this.resBuiltList[e];if(t&&t.tradeButton&&t.tradeButton.isVisible()&&t.tradeButton.isEnabled()&&t.tradeButton.flags&(rat.ui.Element.highlightedFlag|rat.ui.Element.pressedFlag|rat.ui.Element.trackingMouseDownFlag))return!0}return!1};var mc=function(e){e=e||{},this.opts=e;const t=Ba.menus.squareButton.height,n=.7*Ba.menus.buttonGap;var r=e.addDimmer;void 0===r&&(r=!0),mc.prototype.parentConstructor.call(this);var i=this,o=e.width||1280,s=e.width||1200;i.setSize(o,s),Ba.addRoundedBackground(this),r&&Ba.addDimmer(this),i.titleTextBox=Ba.makePopTitleBox(this,e.title),i.titleTextBox.setPosY(60),i.titleTextBox.enableDefaultSpecialFormatting();var a=o-200,l=(o-a)/2,c=s-400,u=Ba.makeText(this,e.message,{x:l,y:200,w:a,h:c,useFont:Ba.menus.explanationFont});u.setBaseline("top"),u.enableDefaultSpecialFormatting(),u.setAutoWrap(!0),i.messageTextBox=u;var h=[];e.yesButton&&h.push(e.yesButton),e.noButton&&h.push(e.noButton);var d=h.length>0?t+n:0;s=200+u.getTextHeight()+Ba.menus.buttonGap+d,this.setSize(o,s),this.elementBackground.setSize(o,s);for(var p=o/2-(h.length*Ba.menus.buttonWidth+(h.length-1)*Ba.menus.buttonGap)/2+Ba.menus.buttonWidth/2,g=s-t/2-n,m=0;m<h.length;m++){var f=h[m],v=p+m*(Ba.menus.buttonWidth+Ba.menus.buttonGap),y=g,w=Ba.makeMenuButtonAt(i,f.label,v,y);f.useColor&&(w.applyStandardColorStates(f.useColor),Ba.fixButtonColorStates(w,f.useColor),w.setTextColors(f.useFontColor,f.useFontColor,f.useFontColor));var C=f.go;C?w.setCallback(C,f):f.dismissPopup&&w.setCallback((function(){i.doClose()})),f.tooltipText&&Ba.setTooltip(w,f.tooltipText)}i.autoBuildInputMap(!1,!1),i.setModal(!0),(e.easyDismiss||void 0===e.easyDismiss)&&(i.setAllowClickAway(!0),i.setAllowClickBodyClose(!0)),i.setAllowBackClose(!0),i.setUserCloseCallback((function(t,n,r){e.onClose&&e.onClose(t,n,r)})),i.centerHighInDisplay();var S=e.slideInFrom;if(void 0===S&&(S="bottom"),S){var b=e.slideTime;void 0===b&&(b=.24),this.slideInFrom(S,b)}var _=e.slideInSound;void 0===_&&(_="slide_in"),_&&za.playSound(_)};rat.utils.inheritClassFrom(mc,rat.ui.Screen),mc.prototype.doClose=function(e){this.handleUserClose("back",e)},mc.prototype.myScreenActivate=function(){console.log("info popup activate")},mc.prototype.myScreenDeactivate=function(){console.log("info popup deactivate")},mc.prototype.onWindowResize=function(){this.centerHighInDisplay()},mc.make=function(e){var t=new mc(e);return rat.screenManager.pushScreen(t),t};var fc=function(e){fc.prototype.parentConstructor.call(this);var t=this;t.setPos(0,0);var n=900;t.setSize(n,1200),t.centerHighInDisplay();var r=Ba.addPopupBackground(t),i=game.scenario,o=i.name;Ba.makeMenuHeading(t,o,450,80);var s="turn "+game.turns.turn;Ba.makeMenuText(t,s,450,160),t.setModal(!0);var a,l={name:"restart game",tip:"restart this game",callback:function(e,t){var n=mc.make({title:"Restart Game?",message:"This will discard your current game and restart the same scenario.",yesButton:{label:"OK",tooltipText:"discard and start a new game",go:function(e){n.doClose(),app.saver.clearSaveToSettings(),game.restart()}},noButton:{label:"cancel",tooltipText:"return to pause menu",dismissPopup:!0},addDimmer:!0,easyDismiss:!1,slideTime:.15})}};(a=i.challengeSeed?null:{name:"new game",tip:"start a new game",callback:function(e,t){var n=mc.make({title:"New Game?",message:"This will discard your current game and start another one.",yesButton:{label:"OK",tooltipText:"discard and start a new game",go:function(e){n.doClose(),app.saver.clearSaveToSettings(),game.restartNew()}},noButton:{label:"cancel",tooltipText:"return to pause menu",dismissPopup:!0},addDimmer:!0,easyDismiss:!1,slideTime:.15})}},i.nextScenario)&&(a={name:i.nextScenarioButtonName,tip:"start a new game",callback:function(e,t){app.saver.clearSaveToSettings(),game.restartNew(ul.templates[i.nextScenario])}});for(var c=[{name:"resume",tip:"continue playing this game",callback:function(e,n){rat.screenManager.removeScreen(t)}},{name:"options",tip:"change game options",callback:function(e,t){app.screenList.pushScreen("options","game")}},l,a,{name:"quit game",tip:"discard game and exit back to main menu",callback:function(e,t){var n=mc.make({title:"Quit Game?",message:"This will discard your current game and return to the main menu.  Really quit?",yesButton:{label:"yes",tooltipText:"discard and quit",go:function(e){n.doClose(),app.saver.clearSaveToSettings(),game.exit(),app.prepStateForLeavingGame(),app.gotoScreen("main")}},noButton:{label:"cancel",tooltipText:"return to pause menu",dismissPopup:!0},addDimmer:!0,easyDismiss:!1,slideTime:.15})}}],u=320,h=0;h<c.length;h++){var d=c[h];if(d){var p=Ba.makeMenuButtonAt(t,d.name,450,u);d.callback&&p.setCallback(d.callback,d.userInfo),d.tip&&Ba.setTooltip(p,d.tip),u+=.9*Ba.menuButtonSpacing.y}}if(t.setAllowClickAway(!0),t.setAllowClickBodyClose(!0),t.setAllowBackClose(!0),e.creatureHistory&&e.creatureHistory.length>0){const t=u;u+=190,sc.makeMonsterList(this,e.creatureHistory,{baseY:t,itemWidth:120,itemHeight:120,iconWidth:80,iconHeight:80,itemSpacing:-30}),Ba.makeText(this,"Monsters Defeated",{useFont:Ba.game.subHeadingFont,x:0,y:t-70,w:n})}t.setHeight(u),r.setHeight(u),t.autoBuildInputMap(!1,!1)};rat.utils.inheritClassFrom(fc,rat.ui.Screen),fc.prototype.destroy=function(){fc.currentScreen=null},fc.prototype.onWindowResize=function(){this.centerHighInDisplay(),this.haveResized()},fc.prototype.screenActivate=function(){this.onWindowResize()},fc.make=function(e){var t=fc.currentScreen=new fc(e);rat.screenManager.pushScreen(t)};const vc=function(){vc.prototype.parentConstructor.call(this);var e=this;e.screenType="SearchMenu",e.setModal(!0),e.setAllowClickAway(!0),e.setAllowBackClose(!0),e.buildUI()};rat.utils.inheritClassFrom(vc,rat.ui.Screen),vc.prototype.onWindowResize=function(){},vc.prototype.buildUI=function(){var e=this,t=tl.buildSearchResults(app.config.showForCiv),n=1200;e.setSize(n,1200),e.centerHighInDisplay(),Ba.addPopupBackground(e),Ba.addDimmer(e);Ba.makeTitleBox(e,"Search For");var r={weak:{title:"weak",iconAsset:"slime",pointsForCode:"monster1"},medium:{title:"medium",iconAsset:"skull",pointsForCode:"monster2"},strong:{title:"strong",iconAsset:"spider",pointsForCode:"monster3",iconScale:1.5,iconOffset:{x:0,y:-20}},money:{title:"gold",iconAsset:"money"},food:{title:"food",iconAsset:"food"},science:{title:"science",iconAsset:"science"},production:{title:"production",iconAsset:"production"},war:{title:"war",iconAsset:"war"},pet:{title:"pet",iconAsset:"pet_icon"}};function i(t,n){if(n&&n.result){var r=n.result;game.world.removeFogFromSingle(r.q,r.r,app.config.showForCiv),qa.detectThingEffect(r.q,r.r),za.playSound("detect")}game.hud.scrollToShowHex(r,2,0,.5,!0),rat.screenManager.removeScreen(e);var i=fl.list.sciSearch;game.animateAndApplyCost(i.cost,game.playerCiv,{actionCode:i.code}),game.playerCiv.actionCounts.sciSearch++,fl.updateSearchCost(),game.hud.updateResourcePanel(),game.addActionIconTurnPart(game.playerCiv,"search_action"),game.turns.addTimeDelayTurnPart(.5),game.turns.commitTurn()}for(var o=[300,600,900],s=0;s<t.length;s++){var a=t[s];if(a.code&&(!a.searchTarget||a.result)){var l=r[a.code],c=o[s%3],u=220+280*(s/3|0),h=l.iconAsset,d=Ba.makeIconButtonAt(Ba.game,e,h,c,u);if(Ba.setIconButtonLabel(d,l.title),l.iconScale){var p=d.icon.getSize();d.icon.setSize(p.x*l.iconScale,p.y*l.iconScale),d.icon.scaleImageToSize()}d.setPos(c-100,u-100),d.setSize(200,200),d.text.setTextInset(10,0),d.text.setAutoWrap(!0),d.text.setPosY(d.text.getPosY()+14);var g={x:0,y:30};l.iconOffset&&(g.x+=l.iconOffset.x,g.y+=l.iconOffset.y);var m=d.icon.getWidth(),f=d.icon.getPosY();if(d.icon.setPos((200-m)/2+g.x,f+g.y),a.searchTarget&&(a.result?d.setCallback(i,a):d.setEnabled(!1)),l.pointsForCode){var v=game.playerCiv.pointsFor[l.pointsForCode],y=new rat.ui.Element(d);y.sizeToParent(),y.pointsInfo=v,y.drawSelf=function(e){var t=this.pointsInfo;gfx.drawPoints(t,32,40,.8)}}}}(d=Ba.makeButtonAt(e,"None",600,1120)).setCallback((function(){rat.screenManager.removeScreen(e)})),e.autoBuildInputMap(!1,!1)},vc.showSearchBox=function(){var e=new vc;rat.screenManager.pushScreen(e)};var yc=function(){yc.prototype.parentConstructor.call(this),console.log("Set up HUD");var e=this;e.setPos(0,0),e.setSize(rat.graphics.SCREEN_WIDTH,rat.graphics.SCREEN_HEIGHT);var t=new rat.ui.ScrollView;t.name="worldView",e.appendSubElement(t),t.setDragOpts({minimumDragThreshold:100,meaningfulDragThreshold:100,flingRequiresDrag:!0}),t.supportZoom();var n=app.settings.display.zoomScaleMin||.8;t.setContentScaleLimits(n,2);var r=1.5;app.settings.display.zoomScale&&(r=app.settings.display.zoomScale),t.setContentScale(r,r),t.viewChanged=function(){var e=t.contentScale.x;e!=app.settings.display.zoomScale&&(app.settings.display.zoomScale=e,app.writeSettings(1))},t.drawSelfPost=function(e,t){qa.drawFlashes(t,"under_ui")},this.worldView=t;var i=new kl(game.world);i.name="worldDisplay",t.appendSubElement(i),this.worldDisplay=i;var o=this.civProgressPanel=new Il(this);o.name="civProg",o.setVisible(!1);var s=this.civEventPanel=new Dl(this);s.name="civEvent",s.updatePlacement();var a=new dc;a.name="resPanel",e.appendSubElement(a),this.resPanel=a;var l=new rat.ui.TextBox("");l.setFont("arial"),l.setFontStyle("bold"),l.setFontSize(40),l.setAlign(rat.ui.TextBox.alignRight),l.setBaseline(rat.ui.TextBox.baselineMiddle),l.setColor(new rat.graphics.Color(220,220,180)),e.appendSubElement(l),e.turnText=l,this.setupActionPanel(),this.setupHexTip(),this.setupMenu(),this.resizeContents(),this.snapToCenterHero(),sl.reset(),cc.reset()};rat.utils.inheritClassFrom(yc,rat.ui.Screen),yc.prototype.getWorldScale=function(){return this.worldView.contentScale.x},yc.prototype.onWindowResize=function(){this.clearHexTip(),this.resizeContents()},yc.prototype.screenActivate=function(){this.onWindowResize()},yc.prototype.destroy=function(){cc.reset()},yc.prototype.resizeContents=function(){var e=this;const t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;this.setSize(t,n);var r=e.civProgressPanel,i=r.getNeededHeight();this.civEventPanel.updatePlacement(),Ba.config.worldDisplay.x=0,Ba.config.worldDisplay.y=0,Ba.config.worldDisplay.w=t-Ba.config.worldDisplay.x,Ba.config.worldDisplay.h=n-Ba.config.worldDisplay.y;var o=e.worldView;o.setPos(Ba.config.worldDisplay.x,Ba.config.worldDisplay.y),o.setSize(Ba.config.worldDisplay.w,Ba.config.worldDisplay.h),o.setContentSizeFromSubElements(),"victory"!==game.state&&e.scrollToShowHero(game.playerCivIndex,1,.1),r.setPos(0,n-i),r.setSize(t,i);var s=e.resPanel.getWidth();t>n?e.resPanel.setPos((t-s)/2+150,0):e.resPanel.setPos(340,0),e.turnText.setPos(t-200,n-60),e.turnText.setSize(180,40),this.updateActionPanelSize(),e.victoryPanel&&e.victoryPanel.onWindowResize(),e.menuButton.setPos(t-Ba.game.squareButton.width,0),e.haveResized()},yc.prototype.setupActionPanel=function(){var e=new Vl;e.name="actionPanelGroup",this.appendSubElement(e),this.actionPanelGroup=e,e.setupActionButtons()},yc.prototype.updateActionPanelSize=function(){const e=rat.graphics.SCREEN_HEIGHT,t=this.civProgressPanel.getNeededHeightNoTitle();var n={x:0,y:0};n.h=e-t-n.y,this.actionPanelGroup.handleResize(n)},yc.prototype.showSearchBox=function(e){vc.showSearchBox()},yc.prototype.doPauseMenu=function(){game.hud.clearHexTip(),game.hud.worldDisplay.stopMouseTracking(),fc.make(game.playerCiv)},yc.prototype.setupMenu=function(){var e=Ba.makeIconButtonAt(Ba.game,this,gfx.getImage("menu_icon").setCentered(!1,!1),0,0);this.menuButton=e,e.setCallback((function(e,t){game.hud.doPauseMenu()}))},yc.prototype.hideActionPanel=function(){this.actionPanelGroup.setVisible(!1)},yc.prototype.getActionButtonCostPos=function(e,t){return this.actionPanelGroup.getActionButtonCostPos(e,t)},yc.prototype.getActionButtonPointsPos=function(e){return this.actionPanelGroup.getActionButtonPointsPos(e)},yc.prototype.showSubMenu=function(e){this.actionPanelGroup.showExpansionMenu()},yc.prototype.prepForWinState=function(){this.menuButton.setVisible(!1),this.hideActionPanel(),this.resPanel.prepForWinState()},yc.prototype.showVictoryPanel=function(e,t){this.victoryPanel=new Gl(this,e,t)},yc.prototype.showResultsScreen=function(e){game.revealAllCivProgress();var t=new Il(null,this.civProgressPanel);cc.make(e,game.playerCiv,t),this.setVisible(!1)},yc.prototype.returnFromResultsScreen=function(){this.setVisible(!0)},yc.prototype.updateResourcePanel=function(){this.resPanel.updateResources(),this.actionPanelGroup.updateActionButtons()},yc.prototype.resourceDisplayPos=function(e){var t=this.resPanel.getPos(),n=this.resPanel.resourceDisplayPos(e);return n.x+=t.x,n.y+=t.y,n},yc.prototype.pointsDisplayPos=function(e){var t=this.civProgressPanel.pointsDisplayPos(e);return t.y+=this.civProgressPanel.getPosY(),t},yc.prototype.updateProgressDisplay=function(e){this.civProgressPanel.updateProgressDisplay(e)},yc.prototype.showProgress=function(e){this.civProgressPanel.setVisible(e)},yc.prototype.updateTurn=function(){game.turns.turn>=1&&this.turnText.setTextValue("turn "+game.turns.turn)},yc.prototype.updateSelf=function(e){sl.update(e)},yc.prototype.drawSelfPost=function(){var e=app.ctx;sl.draw(e,"hud")};const wc=420;yc.prototype.setupHexTip=function(){var e=new rat.ui.Shape("roundRect");this.appendSubElement(e),e.setCornerRadius(20),e.setPos(0,0),e.setSize(wc,280),e.setVisible(!1),e.setColor(Ba.colors.solidPanelBackground),e.setStroke(12,Ba.colors.panelExtraLight);var t=new rat.ui.TextBox("(title replaced)");e.appendSubElement(t),t.autoSizeToParent(),t.setPos(26,20),t.setSize(368,270),Ba.applyTextProperties(t,Ba.game.hexTipTitleFont),t.setAlign(rat.ui.TextBox.alignCenter),t.setBaseline(rat.ui.TextBox.baselineTop),t.enableDefaultSpecialFormatting(),e.bodyTextBox=t;var n=new rat.ui.Shape(e,"triangle");n.setSize(40,50),n.centerFromSize(),n.setPos(450,140),n.setColor(Ba.colors.solidPanelLight),n.setStroke(8,Ba.colors.panelExtraLight),e.tail=n,e.q=e.r=-1,this.hexTip=e},yc.prototype.showHexTip=function(e,t){if(!this.hexTip||!this.hexTip.isVisible()||e.q!==this.hexTip.q||e.r!==this.hexTip.r){var n=game.world.hexGrid.getValueAt(e.q,e.r);this.hexTip.q=e.q,this.hexTip.r=e.r;var r=game.hexToPixelPos(e.q,e.r);if(!r)return console.log("hextip hex is out of view"),void this.clearHexTip();var i=app.World.terrainTypes[n.terrainType].name;if(n.name&&(i=n.name.displayName),app.settings.admin&&(i+=" ("+e.q+","+e.r+")"),n.bonus){var o=app.World.resourceTypes[n.bonus.bonusEntry.extra].name,s="["+app.World.resourceTypes[n.bonus.bonusEntry.extra].id+"_embed]";i+="\n\n"+n.bonus.bonusEntry.name+"\n(+"+n.bonus.bonusEntry.extraAmount+" "+s+o+")"}else if(n.structure){var a=app.Buildings.types[n.structure.type],l=game.civs[n.structure.civIndex],c=l.info,u="["+c.id+"_embed]",h=c.heroName+"'s";if(l.haveMet||(h="Unknown",u="[unknown_hero_w_embed]"),a.victoryType){var d=app.Buildings.getChainInfo(n.structure.type);i+="\n\n"+u+h+" project:\n"+d.chainInfo.label+" ("+(d.chainIndex+1)+"/"+d.chainLength+")"}else i+="\n\n"+u+h+" "+n.structure.name}else n.pet&&(i+="\n\n*"+n.pet.name+"*\n(your pet)");for(var p=0;p<game.civs.length;p++){var g=game.civs[p];if(g.hero.pos.q===e.q&&g.hero.pos.r===e.r){var m=game.civs[p].info;h=m.heroName,u="["+m.id+"_embed]";g.haveMet||(h="Unknown",u="[unknown_hero_w_embed]"),i+="\n\n"+u+h}}for(var f=0;f<game.creatures.length;f++){var v=game.creatures[f];v.pos.q===e.q&&v.pos.r===e.r&&(i+="\n\n^"+v.name+"^\n(monster)")}i=Ba.formatText(i),this.hexTip.bodyTextBox.setTextValue(i);var y=this.hexTip.bodyTextBox.getTextHeight()+35;this.hexTip.setHeight(y);var w={x:r.x,y:r.y};{const e=this.size.x,t=this.size.y;w.y>.3*t?(w.y=r.y-y-170,w.x=r.x-210):(w.y=r.y-100,w.x>.4*e?w.x=r.x-wc-225:w.x=r.x+225),rat.math.collision2D.limitPointToSpace(w,10,10,C,S)}var C=this.size.x-10-wc,S=this.size.y-10-y;rat.math.collision2D.limitPointToSpace(w,10,10,C,S),this.hexTip.setPos(w.x,w.y);var b={x:r.x-w.x,y:r.y-w.y},_=function(e,t){const n=18,r=t.size.x,i=t.size.y;var o,s=r/2,a=i/2;function l(e,t,n){return e<t&&(e=t),e>n&&(e=n),e}var c=(Math.atan2(e.y-a,e.x-s)+2*Math.PI)%(2*Math.PI);return c>Math.PI/4&&c<=3*Math.PI/4?(o=Math.PI/2,e.y=i+20,e.x=l(e.x,n,r-36)):c>3*Math.PI/4&&c<=5*Math.PI/4?(o=Math.PI,e.x=-20,e.y=l(e.y,n,i-36)):c>5*Math.PI/4&&c<=7*Math.PI/4?(o=3*Math.PI/2,e.y=-20,e.x=l(e.x,n,r-36)):(o=0,e.x=r+20,e.y=l(e.y,n,i-36)),o}(b,this.hexTip);this.hexTip.tail.setPos(b),this.hexTip.tail.setRotation(_),this.hexTip.setVisible(!0)}},yc.prototype.clearHexTip=function(){this.hexTip.setVisible(!1)},yc.prototype.scrollToShowHex=function(e,t,n,r,i){void 0===t&&(t=1);var o=game.world.hexGrid.vScale,s=game.world.hexGrid.hexWidth,a=t*s,l=t*s*o;if(void 0===n){var c=rat.graphics.SCREEN_HEIGHT;n=.15*(c=Math.min(c,rat.graphics.SCREEN_WIDTH))}void 0===r&&(r=1);var u=this.worldDisplay.hexToPixelPos(e.q,e.r),h=n,d=n,p=n,g=n;i&&(h+=this.actionPanelGroup.getProperWidth(),p+=this.resPanel.getHeight(),this.worldDisplay.getGlobalPos(u).x<this.civProgressPanel.getNeededWidthForProgress()+150&&(g+=this.civProgressPanel.getNeededHeightNoTitle()));var m=this.getWorldScale();return h=h/m+a,d=d/m+a,p=p/m+l,g=g/m+l,this.worldView.animateScrollToShowLimited(u,h,p,d,g,r)},yc.prototype.scrollToShowHero=function(e,t,n){var r;return r=void 0===e?game.civs[app.config.showForCiv].hero:game.civs[e].hero,this.scrollToShowHex(r.pos,t,0,n,!0)},yc.prototype.scrollToCenterHex=function(e,t){void 0===t&&(t=1);var n=this.worldDisplay.hexToPixelPos(e.q,e.r);rat.ui.animationManager.killAnimatorsForElement(this.worldView,rat.ui.Animator.scroller),this.worldView.animateScrollToCenter(n,t)},yc.prototype.snapToCenterHex=function(e){var t=this.worldDisplay.hexToPixelPos(e.q,e.r);rat.ui.animationManager.killAnimatorsForElement(this.worldView,rat.ui.Animator.scroller),this.worldView.scrollToCenter(t)},yc.prototype.snapToCenterHero=function(e,t){var n;n=void 0===t?game.civs[app.config.showForCiv].hero:game.civs[t].hero,this.snapToCenterHex(n.pos)},yc.prototype.hexIsInView=function(e,t,n){void 0===t&&(t=app.config.world.TILE_SIDE_PIXELS),void 0===n&&(n=app.config.world.TILE_SIDE_PIXELS);var r=this.worldDisplay.hexToPixelPos(e.q,e.r);return this.worldView.pointIsInView(r,t,n)},yc.prototype.scrollToShowHexList=function(e,t,n,r,i){const o=this.getWorldScale(),s=app.config.world.TILE_SIDE_PIXELS/2;for(var a,l=0,c=0,u=0,h=0;h<e.length;h++){var d=e[h];this.hexIsInView(d,s,s)&&u++;var p=this.worldDisplay.hexToPixelPos(d.q,d.r);a||(a=new rat.math.shapes.Rect(p.x,p.y,0,0)),a.expandToInclude(p);for(var g=0;g<h;g++){var m=e[g],f=this.worldDisplay.hexToPixelPos(m.q,m.r),v=Math.abs(p.x-f.x),y=Math.abs(p.y-f.y);v>l&&(l=v),y>c&&(c=y)}}var w=a.getCenter();if(u>=e.length)return;var C=this.worldView.getBounds();const S=game.world.hexGrid.hexWidth;var b=(l+2*t*S)*o,_=(c+2*t*S*game.world.hexGrid.vScale)*o,x=-1,T=-1;if(C.w<b&&(x=C.w/b*o),C.h<_&&(T=C.h/_*o),x>-1||T>-1){var k=o;x>-1&&(k=x),T>-1&&(x<=-1||T<x)&&(k=T),k<o&&(this.worldView.setContentScale(k,k),this.worldView.clampContentScale())}this.worldView.scrollToCenter(w)},yc.prototype.scrollToShowRevealed=function(e){this.scrollToShowHexList(e,1,0,0,!0)},yc.prototype.serialize=function(e){e.apg=this.actionPanelGroup.serialize()},yc.prototype.deserialize=function(e){this.actionPanelGroup.deserialize(e.apg),"r"===this.actionPanelGroup.getCodeButtonState("sciTrade")&&this.resPanel.allowTradeButtons(),fl.updateSearchCost(),this.actionPanelGroup.updateActionButtons(),this.updateResourcePanel(),this.updateTurn()},yc.prototype.mouseDown=function(e,t){game.input.mouseDown(e,t)},yc.prototype.mouseUp=function(e){},yc.prototype.mouseMove=function(e){game.input.mouseMove(e)},yc.prototype.handleKeyDown=function(e){if(this.actionPanelGroup.handleKeyDown(e))return!0;if(this.resPanel.handleKeyDown(e))return!0;if(e.which===rat.input.keys.enter){if(this.civEventPanel.tryPressingButton())return!0;if(this.victoryPanel&&this.victoryPanel.tryPressingButton())return!0;var t=game.civs[app.config.showForCiv];return game.hud.scrollToCenterHex(t.hero.pos,.5),!0}var n=game.input.isHexMoveKey(e);if(n&&n.shiftKey&&!n.ctrlKey){var r=game.world.hexGrid.axialToPixelPos(2*-n.dq,2*-n.dr);return(i=this.worldView.getTargetContentOffset()).x+=r.x,i.y+=r.y,this.worldView.clampScroll(i),this.worldView.animateScroll(i,.5),!0}var i,o=game.input.isDirKey(e);if(o&&o.shiftKey&&!o.ctrlKey)return(i=this.worldView.getTargetContentOffset()).x+=2*-o.dx*app.config.world.TILE_SIDE_PIXELS,i.y+=2*-o.dy*app.config.world.TILE_SIDE_PIXELS,this.worldView.clampScroll(i),this.worldView.animateScroll(i,.5),!0;if(o&&o.dy&&!o.dx&&e.sysEvent.ctrlKey&&!e.sysEvent.shiftKey)return this.worldView.stepZoomAnchored(-.1*o.dy),!0;if(e.which===rat.input.keys["-"]||e.which===rat.input.keys.numPadMinus)return this.worldView.stepZoomAnchored(-.1),!0;if(e.which===rat.input.keys["="]||e.which===rat.input.keys.numPadPlus)return this.worldView.stepZoomAnchored(.1),!0;if(app.settings.admin&&!e.sysEvent.ctrlKey){if(e.which===rat.input.keys.v&&!this.victoryPanel)return game.declareWinner(0),!0;if(e.which===rat.input.keys.c&&!this.victoryPanel)return game.declareWinner(1),!0;if(e.which===rat.input.keys.x)return this.showResultsScreen(game.civs[0]),!0;if(e.which===rat.input.keys.s)return this.actionPanelGroup.testUI(),!0;if(e.which===rat.input.keys.z||e.which===rat.input.keys.a){var s=rat.graphics.getDOMWindowCoordinates(rat.input.mousePos),a={pointerId:333,pointerType:"touch",type:"mousedown",pageX:s.x,pageY:s.y};return e.which===rat.input.keys.a&&(a.type="mouseup"),rat.input.mouseToRatEvent(a,a.type,!0),!0}if(e.which===rat.input.keys.o)return this.actionPanelGroup.debugUnlockExpansionMenu(),!0;if(e.which===rat.input.keys.m)return app.saver.saveToDebugSlot(0),!0;if(e.which===rat.input.keys.comma)return app.saver.restoreFromDebugSlot(0),!0;if(e.which===rat.input.keys.i)return this.civEventPanel.testMe(),!0}return game.input.handleKeyDown(e)},yc.prototype.handleKeyUp=function(e){return game.input.handleKeyUp(e)},yc.prototype.isTrackingSomething=function(){return!!(this.menuButton.flags&(rat.ui.Element.highlightedFlag|rat.ui.Element.pressedFlag|rat.ui.Element.trackingMouseDownFlag))||(!!this.actionPanelGroup.isTrackingSomething()||(!!this.civEventPanel.isTrackingSomething()||(!!this.resPanel.isTrackingSomething()||!(!this.worldView.isTrackingDrag()&&!this.worldView.isTrackingZoom()))))};var Cc=function(e,t,n){Cc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(Cc,rat.ui.Screen),Cc.prototype.buildScreen=function(e){var t=this;t.removeAllSubElements();var n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT;t.setPos(0,0),t.setSize(n,r),xa.applyToScreen(t),Ba.makeMenuTitleBox(t,"A Simple Intro Level");var i=[{text:"•    `Explore` from tile to tile",imageXPos:n/2+100,image:"intro_move",imageWidth:400,offset:{x:0,y:-100},spaceOverride:{h:200}},{text:"•    `Gather` and `build`",imageXPos:n/2-100,imageSet:[{image:"food",imageWidth:100,offset:{x:0,y:-20}},{image:"production",imageWidth:100,offset:{x:0,y:-20}},{image:"money",imageWidth:100,offset:{x:0,y:-20}},{image:"intro_arrow",imageWidth:60,offset:{x:30,y:0}},{image:"town",isCivImage:!0,imageWidth:250,offset:{x:0,y:-70}}]},{text:"•    This intro level is `simplified`."},{text:"                Later levels have more `interesting things`...",imageXPos:n/2-700,usingIconRow:!0,imageSet:[{image:"war",showBack:!0,imageWidth:100,offset:{x:0,y:30}},{image:"skull",showBack:!0,imageWidth:120,offset:{x:0,y:30}},{image:"dragon",showBack:!0,imageWidth:130,offset:{x:30,y:30}},{image:"prod3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"tech3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"money3",isCivImage:!0,showBack:!0,offset:{x:0,y:0}},{image:"intro_card",isCivImage:!1,showBack:!1,offset:{x:0,y:0},rot:.15},{image:"intro_dotdotdot",isCivImage:!1,showBack:!1,offset:{x:0,y:0}}]}];sc.makeIntroContent(this,i,{topLeftOffset:{x:.1*n,y:250}}),Ba.makeMenuBackButtonAndAction(t).setTextValue("Let's Go"),t.autoBuildInputMap()},Cc.prototype.onWindowResize=function(){this.buildScreen()},Cc.make=function(){var e=new Cc;rat.screenManager.pushScreen(e)};const Sc={world:null,turns:al,input:ml,scenario:null,state:"play",oneTimeInit:function(){rl.oneTimeInit()},init:function(e,t){const n=!t;if(t=t||{},this.state="play",this.world=e,this.config=this.scenario.gameConfig,t.civs)this.civs=t.civs;else{var r=app.civs.civInfo;this.civs=[];for(var i=[],o=1;o<r.length;o++)i.push(r[o]);rat.utils.randomizeList(i,Sc.rng);for(o=1;o<this.config.aiCivCount;o++)for(var s=o-1;s<o;s++)if(i[s].colorGroup===i[o].colorGroup){i.splice(o,1),o--;break}var a=0;for(o=0;o<this.config.aiCivCount+1;o++){var l=this.world.startPoints[a++];this.civs[o]={civIndex:o,info:0===o?r[0]:i[o-1],hero:{pos:{q:l.q,r:l.r},displayPos:{q:l.q,r:l.r},civIndex:o,animTimer:0},resources:{},stats:{resourcesTotal:0,resourcesSpent:0,resourcesSpentInWar:0,resourcesTraded:0,thingsBuilt:0,gotPet:0},harvestTrack:{},actionCounts:{sciSearch:0,town:0,city:0,expansion:0,tech1:0,tech2:0,tech3:0,money1:0,money2:0,money3:0,prod1:0,prod2:0,prod3:0,metro:0},buildings:[],isAI:0!==o,aiData:{},points:0,showPoints:0,victoryProgress:[],pointsFor:app.rules.getCleanPointsFor(),creatureHistory:[],haveMet:0===o};var c=this.civs[o];for(var u in c.resources=Sc.buildInitialResourceTable(c,Sc.config),app.World.resourceTypes)c.harvestTrack[u]={rawClaim:0,claim:0}}}this.civDrawOrder=[];for(o=0;o<this.civs.length;o++)this.civDrawOrder[o]=this.civs[o];if(this.updateCivDrawOrder(),this.playerCivIndex=0,this.playerCiv=this.civs[0],this.hero=this.civs[0].hero,this.winningCivIndex=-1,this.finalTurnCount=-1,this.postedResult=!1,gfx.prepForGame(this.civs),console.log("place creatures"),this.config.hasCreatures){this.creatures=bl.placeCreatures(t.creatures,this.config,this,this.world);for(o=0;o<this.creatures.length;o++)this.updateCreatureShowHealths(this.creatures[o])}else this.creatures=[];var h;if(n&&this.config.showExtraResources)for(o=0;o<this.civs.length;o++){var d=Sc.revealNearestResources(this.civs[o]);o===app.config.showForCiv&&(d.push({q:this.civs[o].hero.pos.q,r:this.civs[o].hero.pos.r}),h=d)}this.showCivProgress=[],Sc.turns.init(),Sc.input.init(),rl.init(),qa.init(),fl.init(),this.buildUI(),app.config.aiTest&&Sc.revealAllCivProgress(),h&&Sc.hud.scrollToShowRevealed(h),qa.fadeInWorldEffect(),za.playSound("arrive"),console.log("--- game init done.")},buildInitialResourceTable:function(e,t){var n=[],r=0;for(var i in app.settings.debug.set.resources&&(r=parseInt(app.settings.debug.set.resources)),app.World.resourceTypes){var o=t.resourceCap;if(e.isAI)o*=app.config.aiDifficultyMods[t.aiDifficulty].cap||1;n[i]={count:r,showCount:r,cap:o}}return n},updateCreatureShowHealths:function(e){e.showHealths=[];for(var t=0;t<Sc.civs.length;t++){var n=Sc.civs[t];e.health[t]<e.maxHealth&&e.showHealths.push({civIndex:t,health:e.health[t],foreColor:n.info.style,backColor:n.info.backStyle}),e.showHealths.sort((function(e,t){return e.health<t.health?1:e.health>t.health?-1:t.civIndex-e.civIndex}))}},updateCivDrawOrder:function(){Sc.hud&&Sc.hud.worldDisplay&&this.civDrawOrder.sort((function(e,t){var n=Sc.hud.worldDisplay.hexToPixelPos(e.hero.displayPos.q,e.hero.displayPos.r),r=Sc.hud.worldDisplay.hexToPixelPos(t.hero.displayPos.q,t.hero.displayPos.r);return n.y-r.y}))},exit:function(){app.popAllScreens(),qa.exit(),this.hud=null},restart:function(){var e=Sc.scenario,t=e.challengeSeed||e.rngSeed;Sc.exit(),app.gotoGame("seeded",t,e)},restartNew:function(e){var t=e||Sc.scenario;Sc.exit(),app.gotoGame(t)},serializeCivs:function(){for(var e=[],t=0;t<this.civs.length;t++){var n=this.civs[t],r={infoID:n.info.id,isAI:n.isAI,deadTimer:n.deadTimer,actionCounts:rat.utils.copyObject(n.actionCounts),creatureHistory:rat.utils.copyObject(n.creatureHistory),hero:{pos:{q:n.hero.pos.q,r:n.hero.pos.r}},points:n.points,resources:{},pointsFor:{},haveMet:n.haveMet,stats:n.stats,aiData:rl.serialize(n)};for(var i in app.World.resourceTypes)r.resources[i]=n.resources[i].count;for(var o in n.pointsFor){var s=n.pointsFor[o];(s.got||s.progress)&&(r.pointsFor[o]={got:s.got,limit:s.limit,progress:s.progress,parts:rat.utils.copyObject(s.parts,!0)})}e.push(r)}return e},deserializeCivs:function(e,t){for(var n=[],r=0;r<e.length;r++){var i=e[r],o={info:app.civs.getInfoFromID(i.infoID),isAI:i.isAI,deadTimer:i.deadTimer,actionCounts:i.actionCounts,creatureHistory:i.creatureHistory,civIndex:r,buildings:[],points:i.points,showPoints:i.points,pointsFor:app.rules.getCleanPointsFor(),haveMet:i.haveMet,stats:i.stats||{resourcesTotal:0,resourcesSpent:0,thingsBuilt:0,gotPet:0},hero:{pos:{q:i.hero.pos.q,r:i.hero.pos.r},displayPos:{q:i.hero.pos.q,r:i.hero.pos.r},civIndex:r,animTimer:0}};for(var s in rl.deserialize(o,i.aiData),o.deadTimer>0&&(o.showDeadTimer=!0,o.isDead=!0),o.resources=Sc.buildInitialResourceTable(o,t.gameConfig),i.resources)o.resources[s].count=o.resources[s].showCount=i.resources[s];for(var s in i.pointsFor){var a=i.pointsFor[s];o.pointsFor[s].got=a.got,o.pointsFor[s].limit=a.limit,o.pointsFor[s].progress=a.progress,a.parts&&(o.pointsFor[s].parts.done=a.parts.done)}n.push(o)}return n},serialize:function(){var e={};return e.rngSeed=Sc.rngSeed,e.rngState=Sc.rng.getState(),e.turn=Sc.turns.turn,e.showCivProgress=rat.utils.copyObject(Sc.showCivProgress,!0),e.ss=ul.serialize(this.scenario),e.civs=Sc.serializeCivs(),e.ws=this.world.serialize(),e.creatures=bl.serialize(this.creatures),this.hud.serialize(e),e},deserialize:function(e){this.scenario=ul.deserialize(e.ss);var t=Sc.deserializeCivs(e.civs,this.scenario),n=app.World.deserialize(e.ws,this.scenario,t);this.state="play",Sc.rngSeed=e.rngSeed||0,Sc.rng=new rat.math.rng.Simple,Sc.rng.setState(e.rngState||0);var r={civs:t,creatures:bl.deserialize(e.creatures,t)};this.init(n,r),Sc.turns.turn=e.turn;for(var i=0;i<this.civs.length;i++)app.rules.updateCivProgress(this.civs[i]);Sc.showCivProgress=e.showCivProgress;for(var o=0;o<Sc.showCivProgress.length;o++)Sc.showCivProgress[o]&&this.revealCivProgress(o);this.updateHarvestTrack(),rl.updateBuildingsForAll(),this.hud.deserialize(e)},buildUI:function(){var e=new yc;rat.screenManager.pushScreen(e),this.hud=e,"introGame"===this.scenario.key&&Cc.make()},revealMyCivProgress:function(){Sc.showCivProgress[app.config.showForCiv]=!0,Sc.hud.updateProgressDisplay(Sc.showCivProgress),Sc.hud.showProgress(!0)},revealCivProgress:function(e){Sc.showCivProgress[e]||Sc.hud.civProgressPanel.setNewMet(e),Sc.showCivProgress[e]=!0,Sc.revealMyCivProgress()},revealAllCivProgress:function(){for(var e=0;e<Sc.civs.length;e++)Sc.showCivProgress[e]=!0,Sc.civs[e].haveMet=!0;Sc.hud.updateProgressDisplay(Sc.showCivProgress),Sc.hud.showProgress(!0)},revealNearestResources:function(e){var t={};for(var n in app.World.resourceTypes)t[n]={bestDist:99999999,bestPos:null};this.world.hexGrid.forEachHex((function(n){if(n.value&&n.value.terrainType&&n.value.bonus){var r=n.value.bonus.bonusEntry.extra,i=t[r],o=Sc.world.hexGrid.distance(e.hero.pos.q,e.hero.pos.r,n.q,n.r);o<i.bestDist&&(i.bestDist=o,i.bestPos={q:n.q,r:n.r},n.value.fog[e.civIndex]<1&&(i.alreadyVisible=!0))}}));var r=[];for(var n in app.World.resourceTypes)"science"!==n&&r.push(n);(r=rat.utils.randomizeList(r,Sc.rng)).sort((function(e,n){var r=t[e],i=t[n];return r.alreadyVisible&&!i.alreadyVisible?-1:!r.alreadyVisible&&i.alreadyVisible?1:0})),r.unshift("science");for(var i=[],o=0;o<3;o++){n=r[o];var s=t[n];s.bestPos&&(this.world.removeFogFromSingle(s.bestPos.q,s.bestPos.r,e.civIndex),i.push({q:s.bestPos.q,r:s.bestPos.r}))}return i},declareWinner:function(e){if("victory"!==Sc.state){var t=Sc.civs[e];app.saver.clearSaveToSettings(),console.log("declareWinner "+e),Sc.finalTurnCount=Sc.turns.turn+1,Sc.winningCivIndex=e,t.rewards=Sc.awardRewards(t),e===Sc.playerCivIndex&&(Sc.scenario.challengeSeed&&Tl.markDailyWon(Sc.scenario.challengeSeed,!0),t.records=Sc.updateRecords(t)),t.winner=!0,t.hero.animSet.setAnimByName("win"),Sc.input.clearPending(),Sc.turns.clearTurnList(),Sc.revealAllCivProgress(),Sc.world.revealAll(),Sc.hud.prepForWinState(),Sc.hud.scrollToCenterHex(t.hero.pos,.5),e===Sc.playerCivIndex?za.playSound("success"):za.playSound("success_ai"),Sc.setState("victory"),Sc.hud.showVictoryPanel(e,t),app.telemetry.sessionLog("["+e+":victory@"+Sc.finalTurnCount+"]"),e===Sc.playerCivIndex&&Sc.scenario.challengeSeed&&app.settings.discord.autoPost&&Sc.postToDiscord(e)}},checkAndPostResults:function(){Sc.winningCivIndex===Sc.playerCivIndex&&!Sc.postedResult&&Sc.scenario.challengeSeed&&app.settings.discord.allowPost&&!app.settings.discord.autoPost&&(Sc.postedResult=!0,Sc.postToDiscord(Sc.playerCivIndex))},postToDiscord:function(e){var t=Sc.civs[e],n={},r="",i=null;Sc.scenario.challengeSeed?(i=Sc.scenario.name,n.messageAction="beat"):"custom"===Sc.scenario.key?(i=Sc.scenario.name,n.messageAction="won a"):(i=Sc.scenario.name+" "+Sc.rngSeed,n.messageAction="won"),n.threadName=i,n.messageGame=i,r+=n.messageAction+" "+i;const o=Sc.finalTurnCount;if(n.messageTurns=o,r+=" on turn "+o,t.stats.gotPet){var s=app.cards.getCard(t.stats.gotPet);s&&(r+=", with pet "+s.name),n.messagePet=s.name,n.messagePetCategory=s.category}n.message=r,Ul.postToDiscord(n)},checkAndPostMilestone:function(e,t){if(!app.settings.discord.autoPost)return;var n=app.records.getStatsByCat(e);if(n&&n.totals){const i=n.totals[t];if(i%100==0){var r={type:"milestone",catID:e,catName:app.records.trackedCatsByID[e].name,statName:t,value:i};Ul.postToMilestones(r)}}},awardRewards:function(e){var t=[],n=Sc.scenario.gameConfig.baseRewardCards,r=Sc.scenario.gameConfig.rareRewardCards;function i(e,n){var r=app.cards.giveCardReward(n);r.cardCategory=e,t.push(r)}if(e.isAI&&(n=Sc.scenario.gameConfig.lossRewardCards,r=0),!e.isAI&&Sc.scenario.gameConfig.awardAICards)for(var o=0;o<Sc.civs.length;o++)if(Sc.civs[o].isAI){var s=app.cards.getCardIDFromCiv(Sc.civs[o].info.id);app.cards.haveCardFromFullID(s)||i("civ",s)}var a=Sc.scenario.challengeSeed?"daily":"",l=app.cards.getPetCategoryList(a);for(o=0;o<n;o++){var c=rat.utils.pickRandomInList(l),u=0;r>0&&(r--,u=1);var h=app.cards.getOneRarityCardIDList(u,c);i(c,s=rat.utils.pickRandomInList(h))}return t.length>0&&app.writeSettings(),t},updateRecords:function(e){var t=Sc.scenario.key;app.records.addToTotals("wins",1);for(var n=!1,r=0;r<e.creatureHistory.length;r++)3===e.creatureHistory[r].level&&(n=!0);var i,o=0,s=0;for(var a in app.World.resourceTypes){var l=e.harvestTrack[a].claimCount;s+=l,l>o&&(o=l,i=a)}var c=Sc.finalTurnCount,u={turns:c,dragons:n?1:0,pets:e.stats.gotPet?1:0,town:e.actionCounts.town,city:e.actionCounts.city,expansion:e.actionCounts.expansion,tech3:e.actionCounts.tech3,money3:e.actionCounts.money3,prod3:e.actionCounts.prod3,totalG:s,peakR:o,peakRN:i},h={wins:1,lowTurns:c,turns:c,highTurns:c,totalGL:s,totalGH:s,totalGT:s,peakR:o,peakRN:i};return app.records.addWindowedByCat(t,u),app.records.addByCat(t,h),app.writeSettings(),Sc.checkAndPostMilestone("totals","wins"),Sc.checkAndPostMilestone(Sc.scenario.key,"wins"),{}},setState:function(e){("play"!==e&&"turn"!==e||"victory"!==Sc.state)&&(Sc.state=e,"play"===Sc.state&&Sc.input.hasPending()&&Sc.input.processPending())},update:function(e){if(Sc.input.update(e),Sc.turns.update(e),app.config.aiTest&&("play"===Sc.state&&0==Sc.turns.turnParts.length&&Sc.turns.commitTurn(),Sc.winningCivIndex>=0&&"victory"===Sc.state)){var t=Sc.winningCivIndex;app.aiTestRecords.push({turns:Sc.finalTurnCount,pointsFor:rat.utils.copyObject(Sc.civs[t].pointsFor)});for(var n=["monster4","prod3","tech3","money3"],r=0;r<n.length;r++){var i=n[r];Sc.civs[t].pointsFor[i].got>0&&(app.aiTestTotals[i]=app.aiTestTotals[i]||0,app.aiTestTotals[i]+=1)}var o=0;for(r=0;r<app.aiTestRecords.length;r++)o+=app.aiTestRecords[r].turns;return console.log("*****"),console.log("Average time so far "+o/app.aiTestRecords.length),console.log("*****"),this.exit(),void app.reset()}for(var s=0;s<Sc.civs.length;s++){var a=Sc.civs[s];for(var l in a.pointsFor)a.pointsFor[l].newEffectTimer>=0&&(a.pointsFor[l].newEffectTimer-=e)}this.world.update(e),"turn"===this.state&&Sc.updateCivDrawOrder(),gfx.update(e),qa.update(e)},updateMet:function(){for(var e=Sc.civs[app.config.showForCiv],t=0;t<Sc.civs.length;t++)if(t!==app.config.showForCiv){var n=Sc.civs[t],r=this.world.hexGrid.getValueAt(n.hero.pos.q,n.hero.pos.r);(!r.fog||r.fog[app.config.showForCiv]<1)&&1===this.world.hexGrid.distance(n.hero.pos.q,n.hero.pos.r,e.hero.pos.q,e.hero.pos.r)&&(Sc.revealCivProgress(t),Sc.setHaveMet(t))}for(var i=this.world.hexGrid.getNeighbors(e.hero.pos.q,e.hero.pos.r),o=0;o<i.length;o++){var s=this.world.hexGrid.getValueAt(i[o].q,i[o].r);s.structure&&(Sc.revealCivProgress(s.structure.civIndex),Sc.setHaveMet(s.structure.civIndex))}},updateMetFromEvent:function(e){Sc.revealCivProgress(e),Sc.setHaveMet(e)},setHaveMet:function(e){var t=Sc.civs[e];t.haveMet||(t.haveMet=!0,za.playSound("civ_meet"),Sc.turns.addTurnPart({type:"effectFlashup",actor:t.hero,effectCode:"civ_notice",pos:t.hero.pos}),Sc.turns.addTurnPart({type:"effectFlashup",actor:Sc.hero,effectCode:"civ_notice",pos:Sc.hero.pos}))},updateCivConsciousness:function(){for(var e=0;e<Sc.civs.length;e++){var t=Sc.civs[e];t.isDead&&(t.deadTimer--,t.showDeadTimer=!0,t.deadTimer<=0&&(t.isDead=!1,t.showDeadTimer=!1,t.hero.animSet.setAnimByName("idle"),Sc.hud.actionPanelGroup.updateActionButtons()))}},allowMoveEntry:function(){return!0},updateHarvestTrack:function(){for(var e=0;e<Sc.civs.length;e++){var t=Sc.civs[e];for(var n in t.harvestTrack={},app.World.resourceTypes)t.harvestTrack[n]={rawClaim:0,claim:0,rawClaimCount:0,claimCount:0}}for(var r=0;r<Sc.world.usedHexList.length;r++){var i=Sc.world.usedHexList[r];if(i.value&&i.value.terrainType&&i.value.bonus){var o=i.value.bonus.bonusEntry.extra,s=Sc.makeClaimList(i.q,i.r,i.value,!1);if(!(s.length<=0)){var a=[];for(e=0;e<Sc.civs.length;e++)a[e]=0;for(var l=0;l<s.length;l++){var c=s[l],u=i.value.bonus.bonusEntry.regenTurns;(h=Sc.civs[c.civIndex].harvestTrack[o]).rawClaim+=c.harvestCount/u,h.claim+=c.harvestCount/s.length/u,h.rawClaimCount+=c.harvestCount,a[c.civIndex]+=c.harvestCount}for(e=0;e<Sc.civs.length;e++){var h;(h=Sc.civs[e].harvestTrack[o]).claimCount+=a[e]/s.length}}}}},handleResourceCollection:function(){var e=!1;this.world.hexGrid.forEachHex((function(t){if(t.value&&t.value.terrainType&&t.value.bonus&&0===t.value.bonus.regenCounter){var n=Sc.makeClaimList(t.q,t.r,t.value,!0);if(n.length){var r=n[Math.floor(Sc.rng.random()*n.length)],i=Sc.giveClaimFromHex(t.value,t.q,t.r,r,n.contested,n.potentialClaimCivCount);e=e||i}}})),e&&za.playSound("harvest",.5)},makeClaimList:function(e,t,n,r){for(var i=n.bonus.bonusEntry.extra,o=[],s=0,a=-1,l=[],c=0;c<Sc.civs.length;c++){var u=Sc.civs[c],h=!1;if(!(r&&u.resources[i].count>=u.resources[i].cap)){for(var d={harvestCount:0,building:null},p=0;p<u.buildings.length;p++){var g=u.buildings[p];if((y=app.Buildings.types[g.type].harvestCount)&&Sc.world.hexGrid.isValidNeighbor(e,t,g.pos.q,g.pos.r,!1,!0)){if(g.parentStructure){var m=Sc.world.getRootParentBuilding(g.pos.q,g.pos.r);if(m.val&&m.val.structure){var f=app.Buildings.types[m.val.structure.type];f.harvestCount&&f.harvestCount>y&&(y=f.harvestCount)}}h=!0,o.push({civIndex:c,type:g.type,pos:g.pos,building:g,harvestCount:y}),d.harvestCount<y&&(d.harvestCount=y,d.building=g)}}l[c]=d;var v=u.hero;if(r&&!u.isDead&&Sc.world.hexGrid.isValidNeighbor(e,t,v.pos.q,v.pos.r,!1,!0)){e===v.pos.q&&t===v.pos.r&&(a=c);var y=1,w=null;d.harvestCount>=y&&(y=d.harvestCount,w=d.building),h=!0,o.push({civIndex:c,type:"hero",pos:v.pos,harvestCount:y,toBuilding:w})}h&&s++}}if(r&&a>=0)for(var C=o.length-1;C>=0;C--)"hero"===o[C].type&&o[C].civIndex!==a&&o.splice(C,1);for(var S=0,b=1;b<o.length;b++)if(o[0].civIndex!==o[b].civIndex){S=1;break}o.contested=S,o.potentialClaimCivCount=s;for(b=o.length-1;b>=0;b--){var _=o[b];if("hero"===_.type)continue;var x=_.civIndex,T=_.harvestCount;const e=l[x];e&&e.harvestCount>T&&(S?(_.harvestCount=e.harvestCount,_.toBuilding=e.building):o.splice(b,1))}return o},giveClaimFromHex:function(e,t,n,r,i,o){var s=r.harvestCount,a=e.bonus.bonusEntry;e.bonus.regenCounter=a.regenTurns,this.world.dirtyHex(t,n,e,"giveClaimFromHex");var l=0;e.bonus&&r.civIndex===app.config.showForCiv&&e.fog[app.config.showForCiv]>=1&&(e.bonus.regenEffectDelay=.3,l=.3);var c=Sc.hexToWorldPos(t,n,!1),u=Sc.hexToWorldPos(r.pos.q,r.pos.r,!1),h=Sc.checkPosListVisible([{q:t,r:n},r.pos]),d=!1,p=Sc.world.hexGrid.getValueAt(r.pos.q,r.pos.r);if(h&&(e.fog[app.config.showForCiv]<1&&p.fog[app.config.showForCiv]<1||r.civIndex===app.config.showForCiv)){var g,m=r.type;if(r.toBuilding){var f=Sc.hexToWorldPos(r.toBuilding.pos.q,r.toBuilding.pos.r,!1);o<=1||r.toBuilding.pos.q===r.pos.q&&r.toBuilding.pos.r===r.pos.r?(m=r.toBuilding.type,g=[{pos:c},{pos:f}]):("hero"===m&&(m="hero_intermediate"),g=[{pos:c},{pos:u,rot:0},{pos:f}])}else g=[{pos:c},{pos:u,rot:0}];Sc.animateResourceMove(m,r.civIndex,a.extra,a.extraAmount,s,g,i,l),d=!0}return Sc.giveResource(r.civIndex,a.extra,a.extraAmount,s,!d),d},giveResourceFromTheft:function(e,t,n,r){var i=e.hero.displayPos,o=t.hero.displayPos,s=Sc.hexToWorldPos(i.q,i.r),a=Sc.hexToWorldPos(o.q,o.r),l=!1;if(Sc.checkPosListVisible([i,o])){var c=[{pos:s,rot:2*Math.PI},{pos:a}];Sc.animateResourceMove("hero",t.civIndex,n,1,1,c,r,.7),l=!0,za.playSound("theft",.7)}return Sc.giveResource(t.civIndex,n,1,1,!l),l},animateResourceMove:function(e,t,n,r,i,o,s,a){for(var l=[],c=0;c<o.length;c++)l.push(rat.utils.copyObject(o[c],!0)),l[l.length-1].layer="world";l[0].scale=2,l[1].posCode=e,s&&l.unshift({posCode:"shake",pos:l[0].pos,layer:"world",origPos:l[0].pos,scale:2.5}),l[l.length-1].endActionCode="addToHud",sl.resourceFlashup(t,n,l,r,i,a)},giveResource:function(e,t,n,r,i){var o=Sc.civs[e];o.resources[t].count+=n*r,i&&(o.resources[t].showCount+=n*r),o.stats.resourcesTotal+=n*r,o.isAI&&rl.resourceCountChanged(o,t),!o.isAI&&"science"===t&&o.resources[t].count>=2&&Sc.config.hasSearch&&Sc.hud.actionPanelGroup.unlockButton("sciSearch")},tradeResource:function(e,t,n){var r=e.civIndex===app.config.showForCiv,i={};const o=Sc.config.tradeRate;if(i[t]=o,r){var s=Sc.hud.resourceDisplayPos(n);s.y+=100,Sc.turns.addTurnPart({type:"tradeEffects",civ:e,hideInvisible:!1,doProcess:function(r,i){e.stats.resourcesTraded+=o,Sc.hud.updateResourcePanel(),sl.resourceFlashup(e.civIndex,t,[{posCode:"hud",startActionCode:"subFromHud"},{pos:s}],1,o,0);sl.resourceFlashup(e.civIndex,n,[{pos:s,scale:1},{pos:s,scale:2,endTime:.6},{posCode:"hud",endActionCode:"addToHud"}],1,1,.3)}})}Sc.addActionIconTurnPart(e,"trade_action"),Sc.turns.addTurnPart({type:"applyCost",civ:e,doProcess:function(t,o){Sc.applyCost(i,e,{applyShowCountNow:!r}),Sc.giveResource(e.civIndex,n,1,1,!r)}}),e.civIndex===Sc.playerCivIndex&&this.turns.commitTurn()},handleObjects:function(){for(var e=0;e<Sc.civs.length;e++){var t=Sc.civs[e],n=t.hero,r=this.world.hexGrid.getValueAt(n.pos.q,n.pos.r);if(r&&r.treasure){var i=r.treasure;r.treasure=null,this.world.dirtyHex(n.pos.q,n.pos.r,r,"handleObjects"),app.telemetry.sessionLog("["+e+":treas="+i.count+i.type+"@"+Sc.turns.turn+"]");for(var o=[],s=0;s<i.count;s++)o[s]={type:i.type,count:1};Sc.giveTreasure(e,r,n.pos,o)}if(r&&r.pet&&!t.isAI){var a=r.pet,l={x:0,y:-200};qa.touchPetEffect(r.pet,n.pos.q,n.pos.r,l);o=app.cards.getFavoriteTreasure(a.cardID);const i=1;Sc.giveTreasure(e,r,n.pos,o,l,i);var c=app.cards.getCardCategory(a.cardID);za.playSound("pet_"+c),t.stats.gotPet=a.cardID,t.stats.gotPetInfo={cardID:a.cardID},app.records.addToTotals("pets",1),app.writeSettings(),Sc.checkAndPostMilestone("totals","pets"),r.pet=null}}},giveTreasure:function(e,t,n,r,i,o){o=o||0;var s=Sc.hexToWorldPos(n.q,n.r,!0);if(s&&i&&(s.x+=i.x,s.y+=i.y),!s||t.fog[app.config.showForCiv]>=1)for(var a=0;a<r.length;a++){var l=r[a];Sc.giveResource(e,l.type,l.count,1,!0)}else{za.playSound("treasure",o);var c=r.length,u=2*app.config.world.TILE_SIDE_PIXELS;for(a=0;a<c;a++){var h={};h.x=s.x+u*Math.cos(2*Math.PI*a/c),h.y=s.y+u*Math.sin(2*Math.PI*a/c);l=r[a];sl.resourceFlashup(e,l.type,[{pos:s,layer:"world"},{pos:h,layer:"world",scale:2},{pos:h,layer:"world",scale:2},{posCode:"hero",layer:"world"}],1,1,o+.1*a),Sc.giveResource(e,l.type,l.count,1,!1)}}},hexToWorldPos:function(e,t,n){void 0===n&&(n=!0);var r=this.hud.worldDisplay.hexToPixelPos(e,t);return!(n&&!this.hud.worldView.pointIsInView(r,-app.config.world.TILE_SIDE_PIXELS/2,-app.config.world.TILE_SIDE_PIXELS/2))&&r},hexToPixelPos:function(e,t,n){var r=this.hexToWorldPos(e,t,n);return r?r=this.hud.worldView.getGlobalContentPos(r.x,r.y):r},checkPosListVisible:function(e){for(var t=0;t<e.length;t++){var n=e[t];if(Sc.world.hexGrid.getValueAt(n.q,n.r).fog[app.config.showForCiv]<1)if(Sc.hexToPixelPos(n.q,n.r,!0))return!0}return!1},draw:function(e){},postWorldDraw:function(e){qa.worldParticles.draw(),qa.drawFlashes(e,"world"),sl.draw(e,"world")},postDraw:function(e){qa.drawFlashes(e,"ui")},checkCost:function(e,t){for(var n in e){var r=e[n];if(t.resources[n].count<r)return!1}return!0},adjustCost:function(e,t){var n=rat.utils.copyObject(e,!0);if(t.isAI){var r=app.config.aiDifficultyMods[Sc.config.aiDifficulty].cost||1;for(var i in n)n[i]=n[i]*r|0,n[i]>t.resources[i].cap&&(n[i]=t.resources[i].cap)}return n},applyCost:function(e,t,n){n=n||{},t.civIndex;var r=0;for(var i in e){var o=e[i];t.resources[i].count-=o,r+=o,t.resources[i].count<0&&console.log("BUG: negative resources"),n.applyShowCountNow&&(t.resources[i].showCount-=o)}t.stats.resourcesSpent+=r,t.civIndex===app.config.showForCiv&&Sc.hud.updateResourcePanel()},applyCostToShowCount:function(e,t){for(var n in e){var r=e[n];t.resources[n].showCount-=r}t.civIndex===app.config.showForCiv&&Sc.hud.updateResourcePanel()},animateCost:function(e,t,n){n=n||{};var r=t.civIndex;if(r===app.config.showForCiv&&n.actionCode){for(var i in e){var o=e[i],s=n.targetPos;s||(s=Sc.hud.getActionButtonCostPos(n.actionCode,i)),sl.resourceFlashup(r,i,[{posCode:"hud",startActionCode:"subFromHud"},{pos:s,actionCode:n.actionCode}],o)}return!0}return!1},animateAndApplyCost:function(e,t,n){n=n||{},Sc.animateCost(e,t,n)||(n.applyShowCountNow=!0),Sc.applyCost(e,t,n)},awardPointsFor:function(e,t){var n=Sc.civs[t],r=0,i=n.pointsFor[e];return i&&i.limit&&(r=i.points,n.points+=r,n.showPoints+=r,i.got+=r,i.limit--),r},trackProgressFor:function(e,t,n){var r=Sc.civs[t],i=r.pointsFor,o=!1;function s(e,t,n){var r=e.pointsFor[t];Sc.turns.turn>r.lastTurn&&(r.lastTurn=Sc.turns.turn,r.lastTurnProgress=r.progress),(!r.progress||n>r.progress)&&(r.newEffectTimerMax=r.newEffectTimer=.5),r.progress=n}if("monster4"===e){if(n>=1)for(var a=0;a<Sc.civs.length;a++)Sc.civs[a].pointsFor.monster4.progress=0;n>=1&&t==Sc.playerCivIndex&&(app.records.addToTotals("dragons",1),app.writeSettings(),Sc.checkAndPostMilestone("totals","dragons")),s(r,"monster4",n),n>=.5&&Sc.revealCivProgress(r.civIndex),o=!0}else for(var l in i){var c=i[l].parts;if(c)for(var u in c)if(u===e){c[u].done=!0;var h=r.pointsFor[l].progress||0;c[u].partial>h&&(s(r,l,c[u].partial),o=!0);break}}o&&app.rules.updateCivProgress(Sc.civs[t])},canMakeBuildingHere:function(e,t,n,r){if(fl.status,!app.Buildings.checkCost(e,Sc.civs[r]))return"LACKING_RESOURCE";var i=app.Buildings.types[e];if("town"===e&&Sc.world.hasNeighborBuilding(t,n))return"TOO_NEAR_BUILDING";var o=this.world.hexGrid.getValueAt(t,n);if(o.pet)return"ON_PET";if("town"===e){if(o.structure)return"ON_BUILDING";if(o.bonus)return"ON_RESOURCE";if(!this.world.hasNeighborBonus(t,n))return"NEEDS_NEAR_RESOURCE";if(!Sc.world.terrainPassable(o.terrainType))return"NEEDS_PASSABLE"}if(i.upgradeFrom&&(!o.structure||o.structure.type!==i.upgradeFrom||o.structure.civIndex!==r))return i.upgradeProblemCode;if(i.isExpansion){if(o.structure)return"EXPANSION_ON_BUILDING";if(o.bonus)return"EXPANSION_ON_RESOURCE";if(!this.world.hasNeighborBuilding(t,n,null,r))return"NEEDS_NEAR_BUILDING";if(!Sc.world.terrainPassable(o.terrainType))return"NEEDS_PASSABLE"}return"OK"},canMakeHeroBuilding:function(e,t){return this.canMakeBuildingHere(e,t.pos.q,t.pos.r,t.civIndex)},makeHeroBuilding:function(e,t){var n=this.canMakeHeroBuilding(e,t);if("OK"!==n)return n;var r=t.pos.q,i=t.pos.r,o=Sc.civs[t.civIndex];this.world.hexGrid.getValueAt(r,i);var s=o.civIndex===app.config.showForCiv,a=app.Buildings.getCost(e,o);return Sc.applyCost(a,o,{applyShowCountNow:!s}),s&&Sc.turns.addTurnPart({hideInvisible:!1,type:"animateBuildingCost",civ:o,buildingCode:e,doProcess:function(t,n){Sc.animateCost(a,o,{actionCode:e})||Sc.applyCostToShowCount(a,o)}}),o.actionCounts[e]=o.actionCounts[e]||0,o.actionCounts[e]++,Sc.placeBuilding(o,e,{q:r,r:i}),Sc.turns.addTurnPart({type:"civBuild",civ:o,pos:{q:r,r:i},buildingCode:e}),Sc.turns.addTurnPart({type:"awardPoints",civ:o,pos:{q:r,r:i},actionCode:e}),app.telemetry.sessionLog("["+t.civIndex+":"+e+"@"+Sc.turns.turn+"]"),t.civIndex===Sc.playerCivIndex&&this.turns.commitTurn(),"OK"},removeBuilding:function(e){if(e)for(var t=0;t<Sc.civs.length;t++)for(var n=0;n<Sc.civs[t].buildings.length;n++){var r=Sc.civs[t].buildings[n];if(r.pos.q===e.pos.q&&r.pos.r===e.pos.r)return void Sc.civs[t].buildings.splice(n,1)}},showBuilding:function(e,t){var n=this.world.hexGrid.getValueAt(t.q,t.r);n&&n.structure&&(n.structure.showAs=null)},placeBuilding:function(e,t,n){var r=app.Buildings.types[t],i=n.q,o=n.r,s=this.world.hexGrid.getValueAt(i,o),a=s.structure;if(this.removeBuilding(s.structure),s.structure={type:t,name:r.name,civIndex:e.civIndex,pos:{q:i,r:o},childStructures:[],drawConnectors:{},showAs:"empty"},a&&(s.structure.showAs=a.type,a.parentStructure&&(s.structure.parentStructure=a.parentStructure),a.childStructures&&(s.structure.childStructures=a.childStructures),a.drawConnectors&&(s.structure.drawConnectors=a.drawConnectors)),!s.structure.parentStructure&&r.isExpansion){s.structure.isExpansion=!0;var l=this.world.mostDevelopedNeighborBuilding(i,o,e.civIndex);s.structure.parentStructure={q:l.q,r:l.r},l.val.structure.childStructures.push({q:i,r:o})}if(r.isExpansion){var c=s.structure.parentStructure.q,u=s.structure.parentStructure.r,h=this.world.hexGrid.getValueAt(c,u);app.World.updateDrawConnectors(i,o,s,c,u),app.World.updateDrawConnectors(c,u,h,i,o)}if(Sc.world.dirtyHex(i,o,s,"placeBuilding"),e.stats.thingsBuilt++,e.buildings.push(s.structure),Sc.updateHarvestTrack(),rl.updateBuildingsForAll(),r.victoryType){Sc.revealCivProgress(e.civIndex),s.fog&&s.fog[app.config.showForCiv];for(var d=0;d<Sc.civs.length;d++)this.world.removeFogFrom(i,o,d);app.Buildings.isFirstInChain(s.structure.type)&&e.civIndex!==app.config.showForCiv&&(Sc.hud.civEventPanel.pushEvent({eventType:"building",structure:s.structure,civIndex:e.civIndex,pos:{q:i,r:o}}),Sc.updateMetFromEvent(e.civIndex))}},scrollToEventLocation:function(e){Sc.hud.scrollToCenterHex(e,.5)},tryHeroMove:function(e,t){return this.tryHeroMoveTo(this.hero.pos.q+e,this.hero.pos.r+t)},tryHeroMoveTo:function(e,t){return Sc.turns.checkToFlushTurnList(this.playerCivIndex,"civMove"),!!this.tryCivHeroMoveTo(this.playerCiv,e,t)&&(this.turns.commitTurn(),this.world.removeFogFrom(e,t,0),!0)},tryCivHeroMoveTo:function(e,t,n){if(e.isDead)return!1;if(this.world.isBlocking(t,n))return!1;for(var r=0;r<this.civs.length;r++)if(r!==e.civIndex&&this.civs[r].hero.pos.q===t&&this.civs[r].hero.pos.r===n)return this.tryShove(e.hero,this.civs[r].hero);for(var i=this.creatures.length-1;i>=0;i--){var o=this.creatures[i];if(o.pos.q===t&&o.pos.r===n)return this.tryAttack(e.hero,o)}var s,a={type:"civMove",civ:e,info:{fromPos:{q:(s=e.hero.pos).q,r:s.r},toPos:{q:t,r:n}}};return Sc.world.hexGrid.getValueAt(t,n).treasure&&(a.useAnimName="hop_big"),Sc.turns.addTurnPart(a),Sc.setCivPos(e,t,n),!0},setCivPos:function(e,t,n){e.hero.pos.q=t,e.hero.pos.r=n,e.isAI||Sc.hud.actionPanelGroup.updateActionButtons()},hasNeighborCreature:function(e,t){for(var n=this.world.hexGrid.getNeighbors(e,t),r=0;r<n.length;r++)for(var i=n[r].q,o=n[r].r,s=this.creatures.length-1;s>=0;s--){var a=this.creatures[s];if(a.pos.q===i&&a.pos.r===o)return a}return null},tryAttack:function(e,t){var n=Sc.civs[e.civIndex];if(Sc.world.hexGrid.getValueAt(t.pos.q,t.pos.r),n.resources.war.count){Sc.turns.addTurnPart({type:"effectFlashup",effectCode:"war",pos:e.pos}),Sc.turns.addTurnPart({type:"monsterClashEffect",timeDelay:.2,actor:e,target:t,info:{fromPos:t.pos,toPos:e.pos}}),Sc.turns.addTurnPart({type:"attack",animID:"clash_attack",actor:t,target:e,info:{fromPos:t.pos,toPos:e.pos}}),Sc.turns.addTurnPart({type:"attack",animID:"clash_attack",actor:e,target:t,info:{fromPos:e.pos,toPos:t.pos},blocks:!0}),n.resources.war.count--,n.resources.war.showCount--,n.stats.resourcesSpentInWar++,Sc.hud.updateResourcePanel();var r=t.health[e.civIndex];r>=0&&(t.health[e.civIndex]--,Sc.updateCreatureShowHealths(t));var i=t.health[e.civIndex],o=Math.min(1,1-r/t.maxHealth),s=Math.min(1,1-i/t.maxHealth);if(Sc.trackProgressFor(t.code,e.civIndex,s),n.isAI&&"monster4"===t.code&&s>=.5&&o<.5){Sc.hud.civEventPanel.pushEvent({eventType:"dragon",civIndex:n.civIndex,pos:{q:t.pos.q,r:t.pos.r}});for(var a=0;a<Sc.civs.length;a++)this.world.removeFogFrom(t.pos.q,t.pos.r,a);Sc.updateMetFromEvent(n.civIndex)}if(i<=0){if(!t.isMonster)return void console.log("ERROR: this function isn't for attacking humans");t.isDead=!0,Sc.turns.addTurnPart({type:"creatureDeath",civ:n,info:t}),Sc.turns.addTurnPart({type:"awardPoints",civ:n,pos:{q:t.pos.q,r:t.pos.r},actionCode:t.code}),Sc.turns.addTurnPart({type:"creatureTreasure",civ:n,info:t}),n.creatureHistory.push({level:t.monsterLevel})}else Sc.turns.addTurnPart({type:"effectFlashup",effectCode:"health_minus",pos:t.pos}),t.lastClashTurn[e.civIndex]=Sc.turns.turn;return!0}if(0===e.civIndex&&(Sc.hero.target=t,!Ml.alreadyExists("LACKING_SWORDS"))){var l=new Ml(null,{unavailableTitle:"Can't attack without war"},"LACKING_SWORDS");rat.screenManager.pushScreen(l)}return!1},tryShove:function(e,t){if(!Sc.scenario.gameConfig.hasWar)return!1;var n=Sc.civs[e.civIndex],r=Sc.civs[t.civIndex],i={q:e.pos.q,r:e.pos.r},o={q:t.pos.q,r:t.pos.r};if(n.resources.war.count<=0){if(0===e.civIndex&&(Sc.hero.target=t,!Ml.alreadyExists("LACKING_SWORDS_SHOVE"))){var s=new Ml(null,{unavailableTitle:"Can't attack without war"},"LACKING_SWORDS_SHOVE");rat.screenManager.pushScreen(s)}return!1}if(n.resources.war.count--,n.resources.war.showCount--,n.stats.resourcesSpentInWar++,Sc.turns.addTurnPart({type:"effectFlashup",effectCode:"war",pos:i}),r.resources.war.count>=1&&!r.isDead){Sc.turns.addTurnPart({type:"effectFlashup",effectCode:"war",pos:o}),r.resources.war.count--,r.resources.war.showCount--,r.stats.resourcesSpentInWar++,Sc.turns.addTurnPart({type:"attack",actor:e,target:t,info:{fromPos:i,toPos:o},blocks:!1}),Sc.turns.addTurnPart({type:"clashEffect",timeDelay:.3,actor:e,target:t,info:{fromPos:i,toPos:o}}),Sc.turns.addTurnPart({type:"getHit",actor:t,target:e,info:{fromPos:o,toPos:i},blocks:!1}),(g=Sc.shoveIfClear(n,r,i,o)).shoved&&g.turnPart&&(g.turnPart.blocks=!0),Sc.notifyAIAboutAttack(n,r,"shove")}else{for(var a=["money","food","production","science"],l=0,c=-1,u=0;u<a.length;u++){var h=a[u],d=r.resources[h].count;d>l&&(l=d,c=h)}if(l>0){var p=r.resources[c];p.count--,p.showCount--,Sc.turns.addTurnPart({type:"stealResult",civ:n,tCiv:r,resource:c,info:{fromPos:i,toPos:o}})}Sc.turns.addTurnPart({type:"civKnockedDown",civ:t,info:{fromPos:i,toPos:o}}),Sc.turns.addTurnPart({type:"knockedDownEffect",timeDelay:.3,actor:t,info:{fromPos:i,toPos:o},opts:{color:new rat.graphics.Color(255,255,200)}}),Sc.turns.addTurnPart({type:"attack",actor:e,target:t,info:{fromPos:i,toPos:o},blocks:!1});var g=Sc.shoveIfClear(n,r,i,o);r.isDead=!0,r.deadTimer=3,Sc.notifyAIAboutAttack(n,r,"knockdown"),Sc.turns.addTurnPart({type:"civShoveKnockout",civ:r,info:{toPos:{q:g.q,r:g.r}}})}return Sc.hud.updateResourcePanel(),!0},notifyAIAboutAttack(e,t,n){for(var r=0;r<this.civs.length;r++)if(Sc.civs[r].isAI){var i=!1;if(t.civIndex===r)i=!0;else{var o=this.world.hexGrid.getValueAt(e.hero.pos.q,e.hero.pos.r);(!o.fog||o.fog[r]<1)&&(i=!0),(!(o=this.world.hexGrid.getValueAt(t.hero.pos.q,t.hero.pos.r)).fog||o.fog[r]<1)&&(i=!0)}i&&rl.civAttacked(r,e,t,n)}},turnStealResult:function(e,t,n){Sc.giveResourceFromTheft(t,e,n,!0)},shoveIfClear:function(e,t,n,r){var i=r.q-n.q,o=r.r-n.r,s=r.q+i,a=r.r+o,l=!0;if(this.world.isBlocking(s,a)||this.civIsAt(s,a)>=0||this.creatureIndexAt(s,a)>=0){l=!1;const e=rat.spaces.HexGrid;var c=e.deltaToDirection[i][o];if(void 0!==c){for(var u=e.sideDirections[c],h=[],d=0;d<u.length;d++){var p=e.neighbors[u[d]].delta;s=r.q+p.q,a=r.r+p.r,this.world.isBlocking(s,a)||this.civIsAt(s,a)>=0||this.creatureIndexAt(s,a)>=0||h.push({q:s,r:a})}if(h.length){var g=rat.utils.pickRandomInList(h,null,Sc.rng);l=!0,s=g.q,a=g.r}}}return l?(Sc.setCivPos(t,s,a),Sc.turns.addTurnPart({type:"shoveSlideEffect",timeDelay:.4,opts:{emitterLife:.5},actor:t,info:{fromPos:n,toPos:r}}),{turnPart:Sc.turns.addTurnPart({type:"civShove",civ:t,info:{fromPos:{q:r.q,r:r.r},toPos:{q:s,r:a}},timeDelay:.3}),shoved:!0,q:s,r:a}):{shoved:!1,q:r.q,r:r.r}},tryCreatureAttack:function(e,t){var n=Sc.civs[t.civIndex];if(Sc.world.hexGrid.getValueAt(t.pos.q,t.pos.r),e.lastClashTurn&&e.lastClashTurn[t.civIndex]===Sc.turns.turn)return!1;var r=!1;return n.resources.war.count?(n.resources.war.count--,n.resources.war.showCount--,n.stats.resourcesSpentInWar++,Sc.hud.updateResourcePanel(),Sc.turns.addTurnPart({type:"getHit",actor:n,info:{fromPos:e.pos,toPos:t.pos}}),Sc.turns.addTurnPart({type:"effectFlashup",effectCode:"defense_minus",pos:t.pos,timeDelay:.25})):(r=!0,Sc.turns.addTurnPart({type:"civKnockedDown",civ:n,info:{fromPos:e.pos,toPos:t.pos}})),Sc.turns.addTurnPart({type:"attack",actor:e,target:t,info:{fromPos:e.pos,toPos:t.pos},blocks:!0}),r&&(Sc.turns.addTurnPart({type:"civDeath",civ:n,info:{fromPos:e.pos,toPos:t.pos}}),t.isDead=!0,t.deadTimer=3),!0},knockCivOut:function(e,t){e.isDead=!0,e.hero.animSet.setAnimByName("dead"),e.deadTimer=t||3,e.showDeadTimer=!0,Sc.hud.actionPanelGroup.updateActionButtons()},removeCreature:function(e){var t=Sc.world.hexGrid.getValueAt(e.pos.q,e.pos.r);t.creature=null,Sc.world.dirtyHex(e.pos.q,e.pos.r,t,"removeCreature");for(var n=this.creatures.length-1;n>=0;n--){if(this.creatures[n]===e)return void this.creatures.splice(n,1)}},dropCreatureTreasure:function(e,t){var n=e.civIndex;e.hero;var r=Sc.world.hexGrid.getValueAt(t.pos.q,t.pos.r);Sc.hexToPixelPos(t.pos.q,t.pos.r);for(var i=[],o=0;o<t.treasureCount;o++)i[o]={type:t.treasureType,count:1};Sc.giveTreasure(n,r,t.pos,i)},resolveCreatureDeath:function(e){Sc.removeCreature(e)},restMove:function(){Sc.turns.checkToFlushTurnList(this.playerCivIndex,"civRest");var e=this.playerCiv.hero.pos,t=this.playerCiv.hero.pos;Sc.turns.addTurnPart({type:"civRest",civ:this.playerCiv,info:{at:{q:e.q,r:e.r},fromPos:{q:t.q,r:t.r},toPos:{q:e.q,r:e.r}}}),this.turns.commitTurn(),app.config.showForCiv!==Sc.playerCivIndex&&Sc.hud.scrollToShowHero(app.config.showForCiv,1,0)},checkNeighborAndMove:function(e,t){if(this.world.hexGrid.isValidNeighbor(e.q,e.r,t.q,t.r)){var n=t.q-e.q,r=t.r-e.r;return this.tryHeroMove(n,r)}return!1},canAffordActionForAI:function(e,t){var n=fl.list[t];if(n.cost){var r=Sc.adjustCost(n.cost,e);if(!Sc.checkCost(r,e))return!1}return!0},processActionForAI:function(e,t){var n=fl.list[t];if(n.cost){var r=Sc.adjustCost(n.cost,e);if(!Sc.checkCost(r,e))return!1;Sc.animateAndApplyCost(r,e,{actionCode:n.code})}return n.turnActionImage&&Sc.addActionIconTurnPart(e,n.turnActionImage),e.actionCounts[t]=e.actionCounts[t]||0,e.actionCounts[t]++,e.civIndex===app.config.showForCiv&&Sc.hud.updateResourcePanel(),!0},addActionIconTurnPart:function(e,t){t=t||"sci_action",Sc.turns.addTurnPart({type:"effectFlashup",effectCode:t,effectOpts:{impact:"small"},pos:e.hero.pos})},civIsAt:function(e,t){for(var n=0;n<this.civs.length;n++)if(this.civs[n].hero.pos.q===e&&this.civs[n].hero.pos.r===t)return n;return-1},creatureIndexAt:function(e,t){for(var n=this.creatures.length-1;n>=0;n--){var r=this.creatures[n];if(r.pos.q===e&&r.pos.r===t)return n}return-1},creatureAt:function(e,t){var n=this.creatureIndexAt(e,t);return this.creatures[n]},testFlashup:function(){var e=Sc.civs[0].hero,t=this.world.hexGrid.getValueAt(e.pos.q,e.pos.r),n=Sc.hexToPixelPos(e.pos.q,e.pos.r),r=app.cards.getFavoriteTreasure("dA");Sc.giveTreasure(0,t,e.pos,r,n,0)},debugTeleportTo:function(e,t){var n=Sc.civs[app.config.showForCiv];n.hero.pos.q=n.hero.displayPos.q=e,n.hero.pos.r=n.hero.displayPos.r=t}};window.game=Sc;var bc={list:[],byID:{},byCategory:{}},_c=["common","rare","epic","legendary"],xc={common:0,rare:1,epic:2,legendary:3},Tc={common:"Common",rare:"Rare",epic:"Epic",legendary:"Legendary"};const kc=[{key:"dog",metaCategory:"pet",name:"Dog",groupName:"Dogs",challenge:""},{key:"cat",metaCategory:"pet",name:"Cat",groupName:"Cats",challenge:""},{key:"elephant",metaCategory:"pet",name:"Elephant",groupName:"Elephants",challenge:""},{key:"bird",metaCategory:"pet",name:"Bird",groupName:"Birds",challenge:"daily"},{key:"civ",metaCategory:"civ",name:"Civ",groupName:"Civs",challenge:""}],Ic=268435456,Pc=65535;bc.collectionInitValue=65536,bc.collectionResetValue=65537,bc.oneTimeInit=function(){rat.data.dataCSV.read("res/data/cards.csv",bc.processCardData,{tag:"cards",leadingKey:!1}),bc.unknownCard={id:"?",name:"Unknown"}},bc.initAfterLoad=function(){bc.unknownCard.image=gfx.getImage("unknown_card");for(var e=app.civs.civInfo,t=0;t<e.length;t++)if(0!==t){var n;n=t<10?"v"+t:t<36?"v"+String.fromCharCode("a".charCodeAt(0)+t-10):"v"+String.fromCharCode("A".charCodeAt(0)+t-36);var r=e[t],i=gfx.getImageCopy(r.avatarAsset);i.setCentered(!1,!1);var o={id:n,name:r.heroName,description:r.description,metaCategory:"civ",category:"civ",rarity:"common",civ:r.id,cardAsset:r.avatarAsset,colors:[r.style],image:i};bc.list.push(o)}for(var s=0;s<bc.list.length;s++){var a=bc.list[s];a.rarityOrder=xc[a.rarity],bc.byID[a.id]=a,bc.byCategory[a.category]||(bc.byCategory[a.category]=[]),bc.byCategory[a.category].push(a)}},bc.processCardData=function(e,t,n){if(t.cards){var r;"default"===t.cards[0].id?(r=t.cards[0],t.cards.splice(0,1)):r={};for(var i=0;i<t.cards.length;i++){var o=t.cards[i];rat.utils.extendObject(o,r,!0),"pet"===o.metaCategory&&(o.animalImage=o.animalImage||o.category)}bc.list=t.cards;gfx.loadAnimalImages(["cat","dog","elephant","horse","bird","rabbit"],(function(){bc.loadedImages=!0;for(var e=0;e<bc.list.length;e++){var t=bc.list[e];if(t.colors)for(var n=0;n<t.colors.length;n++){var r=new rat.graphics.Color(t.colors[n]),i=rat.graphics.Color.getHSVFromColor(r),o=i.s+i.v;if(o>1.5){var s=1.5/o;i.s*=.6*s,i.v*=1.4*s;var a=rat.graphics.Color.HSVToRGB(i.h,i.s,i.v);r.set(a.r,a.g,a.b,1),t.colors[n]=r.toString()}}"pet"===t.metaCategory&&(t.image=gfx.colorAnimalImage(t.animalImage,t.colors))}}))}bc.checkLoadDone()},bc.checkLoadDone=function(){bc.list&&bc.list.length>0&&(bc.readDone=!0)},bc.isDoneLoading=function(){return this.readDone&&this.loadedImages},bc.validateCollection=function(e){for(var t in e)e[t]<0&&(e[t]=bc.collectionResetValue)},bc.getCard=function(e){return"?"===e?bc.unknownCard:bc.byID[e]},bc.getCardCategory=function(e){return bc.byID[e].category},bc.getCardIDFromCiv=function(e){for(var t=bc.byCategory.civ,n=0;n<t.length;n++)if(t[n].civ===e)return t[n].id},bc.drawCard=function(e,t,n){},bc.getCategoryNameList=function(){for(var e=[],t=0;t<kc.length;t++)e.push(kc[t].key);return e},bc.getPetCategoryList=function(e){e||(e="");for(var t=[],n=0;n<kc.length;n++)"pet"===kc[n].metaCategory&&kc[n].challenge===e&&t.push(kc[n].key);return t},bc.getCategoryIndex=function(e){for(var t=0;t<kc.length;t++)if(kc[t].key===e)return t;return-1},bc.getSpilloverCategoryName=function(e){var t=bc.getCategoryIndex(e);if("bird"===e)return"bird";var n=kc[t=(t+1)%kc.length].key;return"civ"===n&&(n="dog"),"bird"===n&&(n="dog"),n},bc.getCardIDList=function(){for(var e=[],t=0;t<bc.list.length;t++)e[t]=bc.list[t].id;return e},bc.getCardCategoryIDList=function(e){for(var t=bc.byCategory[e],n=[],r=0;r<t.length;r++)n[r]=t[r].id;return n},bc.getRarityDisplayString=function(e){return Tc[e]},bc.getRarityCardIDLists=function(){for(var e=[],t=0;t<_c.length;t++)e[t]=[];for(t=0;t<bc.list.length;t++){var n=bc.list[t];e[n.rarityOrder].push(n.id)}return e},bc.getOneRarityCardIDList=function(e,t){for(var n=[],r=0;r<bc.list.length;r++){var i=bc.list[r];i.rarityOrder!==e||i.category!==t&&t||n.push(i.id)}return n},bc.getName=function(e){return"?"===e?"?":bc.byID[e].name},bc.haveCardFromFullID=function(e){return!!app.settings.collection[e]},bc.cardRawCountFromFullID=function(e){return app.settings.collection[e]||0},bc.addCardFromFullID=function(e){return app.settings.records.cardsAddedCount++,app.settings.collection[e]?(app.settings.collection[e]++,!1):(app.settings.collection[e]=bc.collectionInitValue,!0)},bc.setStartingCards=function(e){},bc.pickRandomCardReward=function(e){e=e||0;var t=bc.getOneRarityCardIDList(e),n=Math.random()*t.length|0;return app.settings.records.cardsAddedCount<10&&0===n&&(console.log("no card 1 extra"),n+=2*Math.random()|0),t[n]},bc.giveRandomCardReward=function(e){var t=bc.pickRandomCardReward(e),n=!bc.haveCardFromFullID(t);return bc.addCardFromFullID(t),{cardID:t,wasNew:n,canUnlock:bc.canUseUnlock(t)}},bc.giveCardReward=function(e){return{cardID:e,wasNew:app.cards.addCardFromFullID(e),canUnlock:bc.canUseUnlock(e)}},bc.getUnlockCount=function(e,t){bc.byID[t].rarityOrder;return{have:e&Pc,need:3}},bc.allRarityCatCollected=function(e,t){for(var n=bc.getOneRarityCardIDList(e,t),r=n.length-1;r>=0;r--){var i=n[r];if(!app.settings.collection[i])return!1}return!0},bc.canUseUnlock=function(e){var t=bc.getCard(e),n=bc.cardRawCountFromFullID(e),r=bc.getUnlockCount(n,e);return!(r.have<r.need)&&("legendary"!==t.rarity||!bc.allRarityCatCollected(t.rarityOrder,t.category))},bc.useUnlock=function(e,t){var n=bc.getCard(e),r=n.rarityOrder+1;"legendary"===n.rarity&&(r=n.rarityOrder);var i=n.category,o=n.category,s=bc.getOneRarityCardIDList(r,o);if(3===r){for(var a=s.length-1;a>=0;a--){var l=s[a];app.settings.collection[l]&&s.splice(a,1)}s.length<=0&&("legendary"===n.rarity&&(o=bc.getSpilloverCategoryName(i)),s=bc.getOneRarityCardIDList(r,o))}var c=s[Math.random()*s.length|0],u=bc.addCardFromFullID(c),h=app.settings.collection[e],d=h>>16&4095,p=h&Pc;0===d&&p--;var g=-268435456&h|++d<<16|(p-=t.need);return app.settings.collection[e]=g,app.writeSettings(),{cardCategory:o,cardID:c,wasNew:u,usedCount:t.need}},bc.doAllUnlocks=function(e){var t,n={};function r(e){n[e]||(n[e]={usedCount:0,addedCount:0,wasNew:!1})}do{t=!1;for(var i=0;i<bc.list.length;i++){var o=bc.list[i];if(!e||e===o.category){var s=o.id,a=app.settings.collection[s],l=bc.getUnlockCount(a,s);if(bc.canUseUnlock(s)){var c=bc.useUnlock(s,l);r(s),r(c.cardID),n[s].usedCount+=c.usedCount,n[c.cardID].addedCount+=1,c.wasNew&&(n[c.cardID].wasNew=!0),t=!0}}}}while(t);return n},bc.unlockAllCards=function(){for(var e=app.cards.getCardIDList(),t=0;t<e.length;t++){var n=e[t];app.settings.collection[n]||app.cards.addCardFromFullID(n)}},bc.getFavorites=function(){var e=[];for(var t in app.settings.collection)app.settings.collection[t]&Ic&&e.push(t);return e},bc.getFavoriteFlag=function(e,t){return!!(e&Ic)},bc.setFavoriteFlag=function(e,t){void 0===t&&(t=!0),t?app.settings.collection[e]|=Ic:app.settings.collection[e]&=-268435457},bc.getFavoriteTreasure=function(e){var t=bc.byID[e].reward;if(!t||""===t)return null;for(var n={s:"science",m:"money",f:"food",p:"production",w:"war"},r=[],i=0;i<t.length;i++)r.push({type:n[t[i]],count:1});return r};for(var Ec={animGroups:{avatar:{source:{file:"res/images/avatars/anims/avatar_anims.json",data:null},anims:[{name:"idle",constructionOpts:{scaleTranslation:10,timeScale:1.5,loop:!0}},{name:"win",constructionOpts:{scaleTranslation:10,timeScale:1.2,loop:!0}},{name:"dead",constructionOpts:{scaleTranslation:10,loop:!0}},{name:"hop",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1}},{name:"hop_big",useDataName:"hop_tilt",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1}},{name:"build",useDataName:"stomp3",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1}},{name:"attack",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}},{name:"hit_knocked_down",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1}},{name:"got_hit",useDataName:"got_hit_monster",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}},{name:"clash_attack",useDataName:"attack",constructionOpts:{scaleTranslation:7,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}},{name:"clash_defend",useDataName:"got_hit_monster",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}}]},monster:{source:{file:"res/images/avatars/anims/avatar_anims.json",data:null},anims:[{name:"idle",useDataName:"none",constructionOpts:{scaleTranslation:10,timeScale:1.5,loop:!0}},{name:"angry",constructionOpts:{scaleTranslation:10,timeScale:1.2,loop:!0}},{name:"attack",useDataName:"monster_attack",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}},{name:"clash_attack",useDataName:"monster_attack",constructionOpts:{scaleTranslation:7,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}},{name:"got_hit",useDataName:"got_hit_monster",constructionOpts:{scaleTranslation:10,autoUpdateTime:!1,loop:!1,applySpecialXRotation:!0}}]}},oneTimeInit:function(){for(var e in Ec.targetLoadCount=0,Ec.loadedCount=0,Ec.animGroups){var t=Ec.animGroups[e];Ec.targetLoadCount++,function(e){rat.utils.loadJSONObjectAsync(e.source.file,(function(t,n,r){t&&(e.source.data=n,Ec.loadedCount++,Ec.loadedCount>=Ec.targetLoadCount&&Ec.finishLoading())}))}(t)}},finishLoading:function(){Ec.doneLoading=!0},isDoneLoading:function(){return Ec.doneLoading},makeAnimSet:function(e){var t=Ec.animGroups[e];return t?new rat.graphics.KeyAnimSet(t):(rat.console.logError("Can't find animation data for "+e),null)}},Ac={windowSize:20,trackedCats:[{id:"totals",name:"Overall"},{id:"normalGame"},{id:"advancedGame"},{id:"difficultGame"},{id:"veryDifficultGame"},{id:"extraDifficultGame"},{id:"custom"},{id:"daily"}],statTypes:{wins:{type:"sum"},pets:{type:"sum",inWind:!0},dragons:{type:"sum",inWind:!0},turns:{type:"sum",inWind:!0},lowTurns:{type:"lower",useValue:"turns"},aveTurns:{type:"average",useValue:"turns"},highTurns:{type:"higher",useValue:"turns"},town:{type:"sum",inWind:!0},city:{type:"sum",inWind:!0},aveTown:{type:"average",useValue:"town"},aveCity:{type:"average",useValue:"city"},expansion:{type:"sum",inWind:!0},tech3:{type:"sum",inWind:!0},money3:{type:"sum",inWind:!0},prod3:{type:"sum",inWind:!0},totalG:{type:"sum",inWind:!0},lowGen:{type:"lower",useValue:"totalG"},aveGen:{type:"average",useValue:"totalG"},highGen:{type:"higher",useValue:"totalG"},peakR:{type:"higher",inWind:!0},peakRN:{type:"higher",compareValue:"peakR",inWind:!0},totalGL:{type:"lower"},totalGH:{type:"higher"},totalGT:{type:"sum"},default:{type:"sum"}},calculated:{},postLoadSettings:function(e){Ac.convertOldFormats(e),e.records.v=2,Ac.recalcAllSummaries()},convertOldFormats:function(e){for(var t=0,n=0;n<Ac.trackedCats.length;n++){var r=Ac.trackedCats[n].id,i=e.records.byCat[r];if(i&&i.wind&&i.wind.list&&!(i.wind.list.length<=0)){for(var o=i.wind.list.length,s={},a=0;a<Ac.inWindStats.length;a++){var l=Ac.inWindStats[a];s[l]=[];for(var c=0;c<o;c++){var u=i.wind.list[c];void 0!==u[l]?s[l][c]=u[l]:s[l][c]=null}}i.wind=s,t++}}t&&console.log("converted "+t+" records from old format")},recalcAllSummaries:function(){for(var e=0;e<Ac.trackedCats.length;e++){var t=Ac.trackedCats[e];Ac.recalcSummary(t.id)}},getOrCreateByCat:function(e){var t=app.settings.records.byCat[e];if(t)return t;for(var n=!1,r=0;r<Ac.trackedCats.length;r++)if(Ac.trackedCats[r].id===e){n=!0;break}return n?t=app.settings.records.byCat[e]={wind:{}}:null},addSingleByCat:function(e,t,n,r,i){var o=Ac.getOrCreateByCat(e);if(o){var s=Ac.statTypes[n]||Ac.statTypes.default,a=o[n],l=o[t];"sum"===s.type?a=(a||0)+i:"lower"===s.type?(void 0===a||void 0===l||r<=l)&&(a=i):"higher"===s.type&&(void 0===a||void 0===l||r>=l)&&(a=i),o[n]=a}},addToTotals:function(e,t){Ac.addSingleByCat("totals",e,e,t,t)},addByCat:function(e,t){for(var n in t){var r=Ac.statTypes[n]||Ac.statTypes.default,i=t[n],o=n;r.compareValue&&(i=t[r.compareValue],o=r.compareValue);var s=t[n];Ac.addSingleByCat(e,o,n,i,s)}},addWindowedByCat:function(e,t){var n=Ac.getOrCreateByCat(e);if(n){for(var r in t)n.wind[r]||(n.wind[r]=[]),n.wind[r].push(t[r]),n.wind[r].length>Ac.windowSize&&n.wind[r].shift();Ac.recalcSummary(e)}},recalcSummary:function(e){var t=app.settings.records.byCat[e];if(t&&t.wind){var n={length:0};for(var r in Ac.statTypes){var i=Ac.statTypes[r],o=i.useValue||r,s=i.compareValue||o,a=t.wind[o],l=t.wind[s];if(!(!a||!l||a.length<=0||l.length<=0))if(a.length>n.length&&(n.length=a.length),"sum"===i.type){n[r]=0;for(var c=0;c<a.length;c++)void 0!==a[c]&&(n[r]+=a[c])}else if("lower"===i.type){var u=999999999999,h=null;for(c=0;c<a.length;c++)void 0!==a[c]&&void 0!==l[c]&&l[c]<=u&&(u=l[c],h=a[c]);n[r]=h}else if("higher"===i.type){var d=-999999999999,p=null;for(c=0;c<a.length;c++)void 0!==a[c]&&void 0!==l[c]&&l[c]>=d&&(d=l[c],p=a[c]);n[r]=p}else if("average"===i.type){var g=0;n[r]=0;for(c=0;c<a.length;c++)void 0!==a[c]&&(n[r]+=a[c],g++);n[r]/=g}}return Ac.calculated[e]=n,n}},getStatsByCat:function(e){var t=app.settings.records.byCat[e];return t?{totals:t,summary:Ac.calculated[e]}:null},getOneStatByCat:function(e,t){return app.settings.records.byCat[e][t]||0},trackedCatsByID:{}},Dc=0;Dc<Ac.trackedCats.length;Dc++){var Bc=Ac.trackedCats[Dc];!Bc.name&&ul.templates[Bc.id]&&(Bc.name=ul.templates[Bc.id].shortName),Ac.trackedCatsByID[Bc.id]=Bc}for(var Rc in Ac.inWindStats=[],Ac.statTypes){Ac.statTypes[Rc].inWind&&Ac.inWindStats.push(Rc)}const Fc=300;var Nc=function(e,t){Nc.prototype.parentConstructor.call(this,e),this.makeButton=t,this.buildMe(),this.listen(),this.updateSignInState()};rat.utils.inheritClassFrom(Nc,rat.ui.Element),Nc.makeStandard=function(e,t){const n=new Nc(e,t),r=e.getSize().w-Fc-40;return n.setPos(r,40),n.setSize(Fc,60),n},Nc.prototype.destroy=function(){this.stopListening()},Nc.prototype.listen=function(){this.accountListenerFunction=Nc.handleSignInChange.bind(this),ba.on("signed_in",this.accountListenerFunction),ba.on("signed_out",this.accountListenerFunction)},Nc.prototype.stopListening=function(){ba.off("signed_in",this.accountListenerFunction),ba.off("signed_out",this.accountListenerFunction),this.accountListenerFunction=null},Nc.handleSignInChange=function(e){this.updateSignInState()},Nc.prototype.buildMe=function(){const e=this;var t=Ba.makeText(e,"(not signed in)",{x:0,y:0,w:Fc,h:60});if(t.setAlignment("right"),t.enableDefaultSpecialFormatting(),e.signedInTextBox=t,this.makeButton){var n=this.button=Ba.makeButtonAt(e,"",0,0);n.applyInvisibleColorStates(),n.setBounds(0,-60,Fc,180),n.setFlagsChangedCallback((function(t,n){this.isHighlighted()?e.buttonHighlighted=!0:e.buttonHighlighted=!1,e.updateSignInState()}))}},Nc.prototype.updateSignInState=function(){const e=this.signedInTextBox;var t;if("signed_in"==ba.signInState){const n=Ba.formatText(ba.getDisplayName()+"[menu_account_embed]");e.setTextValue(n),t=.5}else"signed_out"==ba.signInState?(e.setTextValue(Ba.formatText("(not signed in) [menu_account_embed]")),t=.25):(e.setTextValue(Ba.formatText("• • • [menu_account_embed]")),t=.25);this.buttonHighlighted&&(t=1),e.setOpacity(t)};var Mc=function(e,t,n){Mc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen(),this.doorCounts={bl:0,br:0}};rat.utils.inheritClassFrom(Mc,rat.ui.Screen),Mc.prototype.destroy=function(){this.signInPanel&&this.signInPanel.destroy()},Mc.prototype.buildScreen=function(){var e=this;this.signInPanel&&this.signInPanel.destroy(),e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r=new rat.ui.Sprite("res/images/ui/logos/title.png");if(r.autoCenter(),r.setPos(t/2,380),e.appendSubElement(r),window.BUILD_INFO&&window.BUILD_INFO.version){var i,o=window.BUILD_INFO.version;(i=Ba.makeMenuText(e,"v. "+o.version+o.localMods,20,n-100)).leftAlignText(),i.setPosX(20),(i=Ba.makeMenuText(e,""+o.date,20,n-50)).leftAlignText(),i.setPosX(20)}this.signInPanel=Nc.makeStandard(e,!0),this.signInPanel.button.setCallback((function(e){app.gotoScreen("account")}));var s=850;n>1.3*t&&(s=.6*n-400);var a=t/3,l=t/2,c=2*t/3,u=Ba.menuIconButtonSpacing.y*Ba.menuButtonScale;Ba.forMobile&&(a-=Ba.menus.squareButton.width*(Ba.menuButtonScale-1)/2,c-=Ba.menus.squareButton.width*(Ba.menuButtonScale-1)/2);var h=c+200;const d=s+u,p=s+2*u,g=[{icon:"menu_play",label:"play",tip:"Play a scenario",action:Lc,x:a,y:s},{icon:"menu_cards",label:"cards",tip:"Look at your collected cards",screenID:"cardlist",x:c,y:s},{icon:"menu_options",label:"options",tip:"Change options",screenID:"options",x:a,y:d},{icon:"menu_records",label:"records",tip:"Look at your records and stats",screenID:"records",x:c,y:d},{icon:"menu_help",label:"help",tip:"See the help screen",screenID:"help",x:a,y:p},{icon:"menu_account",label:"account",tip:"See the account screen",screenID:"account",x:l,y:p},{icon:"menu_about",label:"about",tip:"See more info about this game",screenID:"about",x:c,y:p}];app.settings.admin&&g.push({icon:"menu_empty",label:"debug",tip:"Debug",screenID:"debug",x:h,y:d});for(let t=0;t<g.length;t++){const n=g[t];var m=Ba.makeIconButtonAt(Ba.menus,e,n.icon,n.x,n.y);n.button=m,m.setScale(Ba.menuButtonScale),Ba.setIconButtonLabel(m,n.label),m.setCallback((function(e,t){t.action?t.action(t):app.gotoScreen(t.screenID)}),n)}const f=g[0].button;e.autoBuildInputMap({defaultFocusTo:f,restoreFocus:!0}),e.haveResized()};const Lc=function(e){if(app.settings.discord.autoPost&&!ba.isSignedIn()){const e=Ba.formatText("You have `auto-post` to discord enabled, but aren't signed in.\n\nDiscord posts won't happen unless you're `signed in` to discord.");var t=mc.make({title:"Sign In?",message:e,yesButton:{label:"account",tooltipText:"go to account screen where you can\nsign in or uncheck auto-posts",go:function(e){t.doClose(),app.gotoScreen("account")}},noButton:{label:"skip",tooltipText:"play without signing in",go:function(e){t.doClose(),app.gotoScreen("play")}},addDimmer:!0,onClose:function(e,t){}});t.updateSelf=function(e){ba.isSignedIn()&&(t.doClose(),app.gotoScreen("play"))}}else app.gotoScreen("play")};Mc.prototype.postDraw=function(e,t){this.testImage&&t.drawImage(this.testImage,0,0,2e3,2e3)},Mc.prototype.onWindowResize=function(){this.buildScreen()},Mc.prototype.screenActivate=function(){this.buildScreen()},Mc.prototype.handleKeyDown=function(e){return!1},Mc.prototype.mouseDown=function(e,t){const n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT,i=350;return e.x<i&&e.y>r-i?this.doorCounts.bl++:e.x>n-i&&e.y>r-i?this.doorCounts.br++:this.doorCounts={bl:0,br:0},4===this.doorCounts.bl&&4===this.doorCounts.br&&(app.setAdmin(!app.settings.admin),this.buildScreen(),!0)};var Oc=function(e,t,n){Oc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(Oc,rat.ui.Screen),Oc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT,r=[.3*t,.7*t];e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Choose a Difficulty");for(var i=[{label:"Intro",go:ul.templates.introGame,useColor:Ba.colors.helpButtonColor,useFontColor:Ba.colors.customButtonFontColor,tooltipText:"An easy intro to the game"},{},{label:"Warlord",go:ul.templates.normalGame,tooltipText:"A basic game against easy opponents"},{label:"Prince",go:ul.templates.advancedGame,tooltipText:"A game against normal opponents"},{label:"King",go:ul.templates.difficultGame,tooltipText:"A game against advanced opponents"},{label:"Emperor",go:ul.templates.veryDifficultGame,tooltipText:"A difficult game against more advanced opponents"},{label:"Custom...",go:function(){app.screenList.pushScreen("custom")},useColor:Ba.colors.customButtonColor,useFontColor:Ba.colors.customButtonFontColor,tooltipText:"Set up your own game parameters"},{label:"Daily...",go:function(){app.screenList.pushScreen("daily")},useColor:Ba.colors.customButtonColor,useFontColor:Ba.colors.customButtonFontColor,tooltipText:"Play a set daily challenge"}],o=0,s=0;s<i.length;s++){var a=i[s];if(a.label){var l=r[o%2],c=400+(o/2|0)*Ba.menuButtonSpacing.y,u=Ba.makeMenuButtonAt(e,a.label,l,c);a.useColor&&(u.applyStandardColorStates(a.useColor),Ba.fixButtonColorStates(u,a.useColor),u.setTextColors(a.useFontColor,a.useFontColor,a.useFontColor));var h=a.go;h&&("function"!=typeof h&&(h=function(e,t){app.gotoGame(t.go)}),u.setCallback(h,a)),a.tooltipText&&Ba.setTooltip(u,a.tooltipText),o++}else o++}Ba.makeMenuBackButtonAndAction(e),e.autoBuildInputMap(!1,!1),e.haveResized()},Oc.prototype.onWindowResize=function(){this.buildScreen()},Oc.prototype.screenActivate=function(){this.buildScreen()};var Hc=function(e,t,n){Hc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1);var r=[{civIndex:0,info:Ja.civInfo[0],isAI:!1}];_a.prepForGame(r),this.buildScreen()};rat.utils.inheritClassFrom(Hc,rat.ui.Screen),Hc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"How To Play");var r=Ba.makeMenuTitleBox(e,"(the basics)");r.setPosY(r.getPosY()+100),r.setFontSize(60);var i=_a.getImageCopy("player");i.setCentered(!1,!1);var o=[{text:"CivHero is a civilization building game.",civImage:"city"},{text:"Move your hero `turn by turn`, exploring the world and finding resources.",iconResource:i},{text:"Collect `resources` to build things.",iconResource:"res/images/resources/production.png"},{text:"Towns and Cities `harvest` resources automatically.",civImage:"town"},{text:"Build your civilization to earn `victory points`.",civImage:"tech3"},{text:"Get enough victory points to win before the other civilizations do.",iconResource:"res/images/resources/point_med.png"}],s=400,a=t-100;a>1300&&(a=1300);for(var l=(t-a)/2,c=0;c<o.length;c++){var u=o[c],h=Ba.makeMenuText(e,Ba.formatText(u.text),t/2,s);h.enableDefaultSpecialFormatting(),h.setBaseline("top"),h.setHeight(500),h.setAutoWrap(!0),h.setWidth(a),h.setPosX(l);var d=(c+1)%2*50;if(u.iconResource)(p=new rat.ui.Sprite(u.iconResource)).setFlag(rat.ui.Element.autoScaleAfterLoadFlag),h.appendSubElement(p),p.setPos(-120+d,-30),p.setSize(120,120),p.scaleImageToSize();else if(u.civImage){var p,g=_a.getCivImage(0,u.civImage).copy();g.setCentered(!1,!1),(p=new rat.ui.Sprite(h)).useImageRef(g),p.setPos(-140+d,-30),p.setSize(160,160),p.scaleImageToSize()}s+=h.getTextHeight()+60}Ba.makeMenuBackButtonAndAction(e),e.autoBuildInputMap(!1,!1)},Hc.prototype.onWindowResize=function(){this.buildScreen()};var zc=function(e,t,n){zc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(zc,rat.ui.Screen),zc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Keyboard"),Ba.makeMenuBackButtonAndAction(e),e.autoBuildInputMap(!1,!1)},zc.prototype.onWindowResize=function(){this.buildScreen()};var qc=function(e,t,n){qc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(qc,rat.ui.Screen),qc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r=[{text:"CivHero is a short-session mini civilization game."},{text:"The idea is to experience the essense of a 4X game in just a few minutes."},{text:"If you like this, please get in touch and let me know, to help me keep working on it.  :)"},{image:"wb_logo_small",width:300,height:300,adjust:{y:-20}},{text:"contact us",link:"http://www.whalebunny.com/contact",adjust:{y:-20},buttonAdjust:{y:-300,h:300}},{text:"Copyright 2017-2024 WhaleBunny and Steven H. Taylor.  All Rights Reserved.  Do not redistribute or host without permission.",adjust:{y:10},fontSize:40}],i=200,o=t-100;o>1300&&(o=1300);for(var s=(t-o)/2,a=0;a<r.length;a++){var l,c=0,u=r[a],h=rat.utils.extendObject(u.adjust,{y:0,x:0,w:0,h:0});if(i+=h.y,u.iconLink){var d=Ba.makeMenuButtonAt(e,"",s+140,i-15);d.setWidth(140),d.setCallback((function(e,t){window.open(u.iconLink,"_blank")}))}if(u.text)(l=u.tbox=Ba.makeMenuText(e,u.text,t/2,i)).setBaseline("top"),l.setHeight(500),l.setAutoWrap(!0),l.setWidth(o),l.setPosX(s),u.fontSize&&l.setFontSize(u.fontSize),c=l.getTextHeight();else if(u.image){var p=new rat.ui.Sprite(e,gfx.getImage(u.image));p.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),p.setSize(u.width,u.height),p.setPos(t/2-u.width/2,i),p.scaleImageToSize(),c=u.height}if(c+=h.h,u.iconResource){var g=new rat.ui.Sprite(u.iconResource);g.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),l.appendSubElement(g),g.setPos(-100,-10),g.setSize(100,100),g.scaleImageToSize()}if(u.link){l.setColor(Ba.colors.textBoldColor);var m=new rat.ui.Button(e,rat.ui.Button.cheapType),f=rat.utils.extendObject(u.buttonAdjust,{y:0,x:0,w:0,h:0});m.setPos(0+f.x,l.place.pos.y+f.y),m.setSize(t+f.w,c+f.h),m.setCallback((function(e,t){window.open(t.link,"_blank")}),u),m.setFlagsChangedCallback((function(e,t){this.isHighlighted()?t.tbox.setColor(Ba.colors.textHighColor):t.tbox.setColor(Ba.colors.textBoldColor)}))}i+=c+40}var v=Ba.makeMenuBackButtonAndAction(e),y=v.getPos();v.setPosX(.3*e.getWidth()-Ba.menus.buttonWidth/2);var w=.7*e.getWidth();Ba.makeMenuButtonAt(e,"credits",w,y.y+Ba.menus.buttonHeight/2).callback=function(e,t){app.gotoScreen("credits")},e.autoBuildInputMap({defaultFocusTo:v})},qc.prototype.onWindowResize=function(){this.buildScreen()};var Vc=function(e,t,n){Vc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(Vc,rat.ui.Screen),Vc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r=[{text:"game design and programming",font:Ba.menus.creditsHeadingFont},{text:"Steve Taylor"},{},{text:"art",font:Ba.menus.creditsHeadingFont},{text:"Abbey Ash"},{text:"Steve"},{text:"  and other sources"},{},{text:"playtesting and feedback",font:Ba.menus.creditsHeadingFont},{text:"Justin,  Derek,  Woody,  Jared"},{text:"Tony,  puf"},{text:"and some itch.io friends"}],i=110,o=t-300;o>1800&&(o=1800);for(var s=(t-o)/2,a=0;a<r.length;a++){var l,c=0,u=r[a],h=rat.utils.extendObject(u.adjust,{y:0,x:0,w:0,h:0});if(i+=h.y,u.iconLink){var d=Ba.makeMenuButtonAt(e,"",s+140,i-15);d.setWidth(140),d.setCallback((function(e,t){window.open(u.iconLink,"_blank")}))}if(u.text){var p=u.font||Ba.menus.mainFont;(l=u.tbox=Ba.makeText(e,u.text,{centerX:t/2,centerY:i,useFont:p})).setBaseline("top"),l.setHeight(500),l.setAutoWrap(!0),l.setWidth(o),l.setPosX(s),c=l.getTextHeight()}else if(u.image){var g=new rat.ui.Sprite(e,gfx.getImage(u.image));g.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),g.setSize(u.width,u.height),g.setPos(t/2-u.width/2,i),g.scaleImageToSize(),c=u.height}if(c+=h.h,u.iconResource){var m=new rat.ui.Sprite(u.iconResource);m.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),l.appendSubElement(m),m.setPos(-100,-10),m.setSize(100,100),m.scaleImageToSize()}if(u.link){l.setColor(Ba.colors.textBoldColor);var f=new rat.ui.Button(e,rat.ui.Button.cheapType),v=rat.utils.extendObject(u.buttonAdjust,{y:0,x:0,w:0,h:0});f.setPos(0+v.x,l.place.pos.y+v.y),f.setSize(t+v.w,c+v.h),f.setCallback((function(e,t){window.open(t.link,"_blank")}),u),f.setFlagsChangedCallback((function(e,t){this.isHighlighted()?t.tbox.setColor(Ba.colors.textHighColor):t.tbox.setColor(Ba.colors.textBoldColor)}))}i+=c+40}var y=Ba.makeMenuBackButtonAndAction(e);e.autoBuildInputMap({defaultFocusTo:y})},Vc.prototype.onWindowResize=function(){this.buildScreen()};var Wc=function(){Wc.prototype.parentConstructor.call(this),this.rebuildUI(),this.setModal(!0),this.setOverlay(!1),Wc.initialRecOffY=app.settings.display.recOffY};rat.utils.inheritClassFrom(Wc,rat.ui.Screen),Wc.initialRecOffY=0,Wc.popInEffect=function(e,t,n){e.setVisible(!1);var r=new rat.ui.Animator(rat.ui.Animator.visible,e);r.setTimer(.01),r.setDelay(t),r.setStartEnd(0,1),n&&r.setDoneCallback((function(){za.playSound(n)}))};var Gc=Wc.popInEffect;Wc.makeStatsBox=function(e,t,n){void 0===n&&(n=!0);var r=e.statWidth;r||(r=30*e.statText.length,r=rat.math.clamp(r,120,200));var i=Ba.menus.statsMainLabelFont,o=Ba.menus.statsMainFont,s=e.x-400-10,a=e.y,l=e.x,c=e.y,u=e.x,h=e.y,d=g=new rat.ui.TextBox(t,e.label);g.setPos(s,a),g.setSize(400,60),g.setAlign("right"),Ba.applyTextProperties(g,i);var p=e.isBest?"good_stat":"show_stat";n&&Gc(g,e.delayTime,p);var g=new rat.ui.TextBox(t,e.statText);if(g.setPos(l,c),g.setSize(r,60),g.setAlign("right"),Ba.applyTextProperties(g,o),n&&Gc(g,e.delayTime,"show_stat"),e.addIcon){var m=new rat.ui.Sprite(t);if(m.setPos(u,h),m.clearFlag(rat.ui.Element.autoSizeAfterLoadFlag),m.setFlag(rat.ui.Element.autoScaleAfterLoadFlag),m.setSize(64,64),m.autoCenter(),m.useImageRef(gfx.getImage(e.addIcon)),n&&Gc(m,e.delayTime+.2),e.spinIcon){var f=new rat.ui.Animator(rat.ui.Animator.rotator,m);f.setTimer(.5),n&&f.setDelay(e.delayTime+.2),f.setStartEnd(0,2*Math.PI)}}return{label:d,value:g}},Wc.prototype.rebuildUI=function(){var e=this;e.removeAllSubElements(),e.catPositions={};var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Records");var r=220,i=t-100,o=n-r-330,s=new rat.ui.ScrollView(e);s.setPos(50,r),s.setSize(i,o);var a=Ba.colors.scrollBoxBorderColor.copy();a.a=.5,s.setFrame(8,a),s.frameOutset=4,e.statsBox=e.scrollView=s,s.wheelSensitivity=100,s.setDragOpts({flingMaxVel:5e3}),s.viewChanged=function(){app.settings.display.recOffY=0|s.contentOffset.y,e.updateContentIndicators()};var l=app.settings.display.recOffY||0;s.contentOffset.y=l,s.clampScroll();var c=new rat.ui.Sprite(e);c.setPos(50+.98*i,250),c.useImageRef(gfx.getImage("content_indicator_up")),c.setScale(2,2),c.setOpacity(.2),e.upSprite=c;var u=new rat.ui.Sprite(e);u.setPos(50+.98*i,r+o-30),u.useImageRef(gfx.getImage("content_indicator_down")),u.setScale(2,2),u.setOpacity(.2),e.downSprite=u;for(var h=i/3-100,d=2*i/3+200,p=i/2,g=40,m=!1,f=[app.records.trackedCatsByID.totals,app.records.trackedCatsByID.custom,app.records.trackedCatsByID.daily,app.records.trackedCatsByID.extraDifficultGame,app.records.trackedCatsByID.veryDifficultGame,app.records.trackedCatsByID.difficultGame,app.records.trackedCatsByID.advancedGame,app.records.trackedCatsByID.normalGame],v=0;v<f.length;v++){var y=f[v],w=app.records.getStatsByCat(y.id);if(!w||!w.totals)continue;var C=w.totals,S=w.summary;m=!0;const t=e.catPositions[y.id]={};t.yPos=g;var b=i;(E=new rat.ui.Shape(s,"rect")).setColor(Ba.colors.statsCategoryBackground),E.setSize(b,70),E.setPos(0,g-35);var _,x=Ba.makeTitleBox(s,y.name);Ba.applyTextProperties(x,Ba.menus.statsMainCategoryFont),x.setSize(1500,40),x.centerAt(p,g),g+=40,"totals"===y.id&&void 0===C.wins&&(C.wins=0),_={x:p,y:g,label:"wins",statText:""+C.wins},Wc.makeStatsBox(_,s,!1),g+=80;var T=!1;if("totals"===y.id&&void 0===C.pets&&(C.pets=0),void 0!==C.pets&&(_={x:h,y:g,label:"pets rescued:",statText:""+C.pets},Wc.makeStatsBox(_,s,!1),T=!0),"totals"===y.id&&void 0===C.dragons&&(C.dragons=0),void 0!==C.dragons&&(_={x:d,y:g,label:"dragons defeated:",statText:""+C.dragons},Wc.makeStatsBox(_,s,!1),T=!0),T&&(g+=70),"totals"!==y.id){if(T=!1,void 0!==C.totalGL)_={x:h,y:g,label:"lowest harvest:",statText:""+Uc(C.totalGL)},Wc.makeStatsBox(_,s,!1),T=!0;if(C.peakR){var k=Uc(C.peakR),I="["+C.peakRN+"_embed]";_={x:d,y:g,label:"peak resource:",statText:""+(""+k+(I=Ba.formatText(I)))},Wc.makeStatsBox(_,s,!1).value.enableDefaultSpecialFormatting(),T=!0}if(T&&(g+=70),T=!1,C.totalGH)_={x:h,y:g,label:"highest harvest:",statText:""+Uc(C.totalGH)},Wc.makeStatsBox(_,s,!1),T=!0;T&&(g+=70)}if(S&&S.length>0){var P=S;g+=50;var E;b=i;(E=new rat.ui.Shape(s,"rect")).setColor(Ba.colors.statsSubCategoryBackground),E.setSize(800,70),E.setPos(b/2-400,g-35);var A="Last "+P.length+" "+y.name+" Wins";1===P.length&&(A="Last "+y.name+" Win");x=Ba.makeTitleBox(s,A);Ba.applyTextProperties(x,Ba.menus.statsMainSubCategoryFont),x.setSize(1500,40),x.centerAt(p,g),_={x:h,y:g+=50,label:"fewest turns:",statText:""+P.lowTurns},Wc.makeStatsBox(_,s,!1),_={x:d,y:g,label:"mars landers:",statText:""+P.tech3},Wc.makeStatsBox(_,s,!1),_={x:h,y:g+=70,label:"avg. turns:",statText:""+(0|P.aveTurns)},Wc.makeStatsBox(_,s,!1),_={x:d,y:g,label:"world banks:",statText:""+P.money3},Wc.makeStatsBox(_,s,!1),_={x:h,y:g+=70,label:"most turns:",statText:""+P.highTurns},Wc.makeStatsBox(_,s,!1),_={x:d,y:g,label:"monuments:",statText:""+P.prod3},Wc.makeStatsBox(_,s,!1),_={x:h,y:g+=70,label:"avg. towns:",statText:""+Uc(P.aveTown)},Wc.makeStatsBox(_,s,!1),_={x:d,y:g,label:"dragons defeated:",statText:""+P.dragons},Wc.makeStatsBox(_,s,!1),_={x:h,y:g+=70,label:"avg. cities:",statText:""+Uc(P.aveCity)},Wc.makeStatsBox(_,s,!1),_={x:d,y:g,label:"avg. harvest:",statText:""+Uc(P.aveGen)},Wc.makeStatsBox(_,s,!1),g+=70}t.yEnd=g,g+=70}s.setContentSize(i,g),e.updateContentIndicators(),m||Ba.makeText(s,"Records from games you play will show up here.",{useFont:Ba.menus.mainFont,centerX:i/2,y:200}),this.backButton=Ba.makeMenuBackButtonAndAction(e);var D=this.backButton.callback;this.backButton.callback=function(t,n){e.handleClose(),D(t,n)},e.setUserCloseCallback((function(){e.handleClose()})),e.autoBuildInputMap(!1,!1)},Wc.prototype.updateContentIndicators=function(e){const t=this;var n=t.scrollView.getHeight(),r=t.scrollView.getContentOffset(),i=t.scrollView.getContentSize();r.y<-50?t.upSprite.setVisible(!0):t.upSprite.setVisible(!1),i.y-n+r.y>50?t.downSprite.setVisible(!0):t.downSprite.setVisible(!1)},Wc.prototype.scrollToShowCategory=function(e){const t=this.catPositions[e];if(!t)return;const n=t.yEnd-t.yPos,r=t.yPos+n/2;this.scrollView.scrollToShow({x:0,y:r},0,n)},Wc.prototype.handleUIInput=function(e){console.log("Records UI Input");var t=0;if("up"===e.which?t=-1:"down"===e.which&&(t=1),!this.backButton.isHighlighted()||0===t)return Wc.prototype.parentPrototype.handleUIInput.call(this,e);var n=this.scrollView.contentOffset.copy();n.y+=500*-t,this.scrollView.clampScroll(n),this.scrollView.animateScroll(n,.2)},Wc.prototype.myScreenActivate=function(){console.log("stats screen activate")},Wc.prototype.myScreenDeactivate=function(){console.log("stats screen deactivate")},Wc.prototype.onWindowResize=function(){this.rebuildUI()},Wc.prototype.handleClose=function(){app.settings.display.recOffY!==Wc.initialRecOffY&&app.writeSettings()},Wc.make=function(e){var t=new Wc;rat.screenManager.pushScreen(t)};const Uc=function(e){return(10*e|0)/10};var jc=function(e,t,n){jc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(jc,rat.ui.Screen),jc.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r=600,i=t/3,o=2*t/3;Ba.makeButtonAt(e,"allcards",i,r).callback=function(e,t){rat.console.parseCommand("allcards"),rat.console.parseCommand("write")},Ba.makeButtonAt(e,"nocards",o,r).callback=function(e,t){rat.console.parseCommand("nocards"),rat.console.parseCommand("write")},r+=Ba.menuIconButtonSpacing.y,Ba.makeButtonAt(e,"anims",i,r).callback=function(e,t){app.gotoScreen("anim")},Ba.makeButtonAt(e,"audio",o,r).callback=function(e,t){app.gotoScreen("audio")},r+=Ba.menuIconButtonSpacing.y,Ba.makeButtonAt(e,"console",i,r).callback=function(e,t){rat.console.parseCommand("showconsole")},Ba.makeButtonAt(e,"!admin",o,r).callback=function(e,t){app.setAdmin(!1),app.screenList.goBackScreen(e,t)};var s=Ba.makeMenuBackButtonAndAction(e);e.autoBuildInputMap({defaultFocusTo:s})},jc.prototype.onWindowResize=function(){this.buildScreen()};var Kc=function(e,t,n){Kc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1);var r=rat.graphics.layerDiv.make(app.canvasElement);this.editDiv=r,this.scenarioName="custom",this.buildScreen()};rat.utils.inheritClassFrom(Kc,rat.ui.Screen),Kc.prototype.destroy=function(){app.canvasElement.focus(),this.editDiv&&(this.editDiv.parentNode.removeChild(this.editDiv),this.editDiv=null)},Kc.prototype.enableEditDiv=function(e){this.editDiv&&(this.editDiv.style.display=e?"block":"none")},Kc.prototype.buildScreen=function(){var e=this;for(e.removeAllSubElements(),rat.graphics.layerDiv.updateScale(this.editDiv,app.canvasElement);this.editDiv.firstChild;)this.editDiv.removeChild(this.editDiv.lastChild);var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r={x:50,y:150,h:(n-150-350-200)/2,w:t-100},i=this.inBox=this.makeTextBox(r);i.domEditBox.focus(),i.domEditBox.select();var o=Ba.makeHeading(e,"Seed",50,100);o.setAlignment("left"),o.setPosX(50),Ba.makeButtonAt(e,"Emperor",t/2,n-700).callback=function(t,n){e.scenarioName="emperor",e.runFromSeed()},Ba.makeButtonAt(e,"Custom",t/2,n-500).callback=function(t,n){e.scenarioName="custom",e.runFromSeed()};var s=Ba.makeMenuBackButtonAndAction(e);e.autoBuildInputMap({defaultFocusTo:s})},Kc.prototype.runFromSeed=function(){var e=this.inBox.domEditBox.value,t=parseInt(e);t&&(console.log("Starting "+this.scenarioName+" game from seed "+t),app.gotoGame(this.scenarioName,t))},Kc.prototype.makeTextBox=function(e){var t=new rat.ui.DOMEditText(this,this.editDiv,{class:"textarea"});return t.setBounds(e),Ba.applyTextProperties(t,Ba.menus.editTextFont),t.domEditBox.style.font=t.fontDescriptor,t.domEditBox.style.background="rgba(0,0,0,0)",t.domEditBox.style.color=t.getColor().toString(),t.domEditBox.style.border="2px solid gray",t.domEditBox.style["outline-color"]=Ba.colors.textHighColor.toString(),t},Kc.prototype.onWindowResize=function(){this.buildScreen()};var Yc=function(e){Yc.prototype.parentConstructor.call(this,e)};rat.utils.inheritClassFrom(Yc,rat.ui.ScrollView),Yc.prototype.buildFromOptions=function(e,t){var n=this;this.removeAllSubElements();var r=this.getWidth(),i=.7*Ba.menuIconButtonSpacing.y,o=i/2,s=0;for(var a=[.28*r,r/2,.72*r],l=0;l<e.length;l++){var c=e[l],u=a[c.col],h=o+i*c.row;if(c.readObject||(c.readObject=c.setObject),c.valueLabels||(c.valueLabels=c.values),!c.onlyFromMode||c.onlyFromMode===t){if("check"===c.type){const e=560;var d=Ba.makeCheckBoxAt(n,c.label,u,h,e);c.tooltip&&Ba.setTooltip(d,c.tooltip),d.setToggles(!0);var p=rat.utils.get(c.readObject,c.setField);d.setToggled(!!p),d.setCallback((function(e,t){var n=!rat.utils.get(t.readObject,t.setField);rat.utils.set(t.setObject,t.setField,n),t.onChange&&t.onChange(n,n)}),c)}else if("clicker"===c.type||"range"===c.type)n.makeClickerLine(u,h,c);else if("button"===c.type){d=Ba.makeButtonAt(n,c.label,r/2,h,null,Ba.game);c.tooltip&&Ba.setTooltip(d,c.tooltip),d.callback=c.onClick}else rat.console.logWarning("options_panel: unknown option type "+c.type);s=h+i/2}}var g=s;this.setContentSize(r,g)},Yc.prototype.makeClickerLine=function(e,t,n){const r=n.label;n.tooltip;const i=n.onChange,o=n.values;for(var s=rat.utils.get(n.setObject,n.setField),a=0,l=0;l<o.length;l++)o[l]===s&&(a=l);var c={index:a};e-=200,t+=10;const u=this,h=.65,d=Ba.menus.squareButton.width*h,p=d,g=n.valueWidth||90;var m=t-p/2,f=Ba.makeText(u,"[x]",{x:e-g/2,y:m,w:g,h:d,useFont:Ba.menus.smallButtonFont});f.setFontSize(60),f.setAlignment("center"),f.setBaseline("middle"),f.setTextValue(""+n.valueLabels[a]),c.valueBox=f;var v=e-12-g/2-d/2,y=Ba.makeIconButtonAt(Ba.menus,u,"menu_left",v,t);y.autoCenter(!0,!0),c.leftBut=y,y.setScale(h);v=e+12+g/2+d/2;var w=Ba.makeIconButtonAt(Ba.menus,u,"menu_right",v,t);w.autoCenter(!0,!0),c.rightBut=w,w.setScale(h);v=e+(n.labelOffset||250);var C=Ba.makeText(u,r,{x:v,y:m,w:320,h:d,useFont:Ba.menus.smallButtonFont});function S(){var e=n.values[c.index];rat.utils.set(n.setObject,n.setField,e),i&&i(c.index,e),f.setTextValue(""+n.valueLabels[c.index]),b()}function b(){y.setEnabled(c.index>0),w.setEnabled(c.index<n.values.length-1)}return C.setAlignment("left"),c.label=C,y.setCallback((function(e,t){return c.index>0&&(c.index--,S(),!0)})),w.setCallback((function(e,t){return c.index<n.values.length-1&&(c.index++,S(),!0)})),b(),c};var Xc=function(e){Xc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.fromWhence=e,this.buildScreen()};rat.utils.inheritClassFrom(Xc,rat.ui.Screen),Xc.prototype.buildScreen=function(){const e=this.fromWhence||"menus";var t=this;t.removeAllSubElements();var n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT;t.setPos(0,0),t.setSize(n,r),xa.applyToScreen(t),Ba.makeMenuTitleBox(t,"Options");var i=new Yc(this);i.setSize(n,r-250-350),i.setPos(0,250);var o=[{type:"check",label:"show hex borders",tooltip:"show borders around all hexes",col:0,row:0,setObject:app.settings.display,setField:"showHexBorders",onChange:function(){app.writeSettings()}},{type:"check",label:"show civ borders",tooltip:"show colored borders on hexes with buildings",col:2,row:0,setObject:app.settings.display,setField:"showCivBorders",onChange:function(){app.writeSettings()}},{type:"check",label:"auto-save after turn",col:0,row:1,setObject:app.settings,setField:"autoSaveEachTurn",onChange:function(){app.writeSettings()}},{type:"check",label:"low power",tooltip:"use less GPU / CPU power",col:2,row:1,setObject:app.settings,setField:"lowPower",onChange:function(){app.setLowPower(app.settings.lowPower),app.writeSettings()}},{type:"clicker",label:"sound volume",col:1,row:3,setObject:app.settings,setField:"soundVolume",values:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1],valueLabels:[0,1,2,3,4,5,6,7,8,9,10],onChange:function(e){var t=e/10;app.settings.soundVolume=t,za.setSoundVolume(t),app.writeSettings()}},{type:"clicker",label:"music volume",col:1,row:4,setObject:app.settings,setField:"musicVolume",values:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1],valueLabels:[0,1,2,3,4,5,6,7,8,9,10],onChange:function(e){var t=e/10;app.settings.musicVolume=t,za.setMusicVolume(t),app.writeSettings()}},{type:"button",label:"progress in/out",col:2,row:5,tooltip:"export or import progress and stats",onlyFromMode:"menus",onClick:function(e,t){app.screenList.pushScreen("export")}}];i.buildFromOptions(o,e);var s=Ba.makeMenuBackButtonAndAction(t);t.autoBuildInputMap({defaultFocusTo:s})},Xc.prototype.onWindowResize=function(){this.buildScreen()};var $c=function(e,t,n){$c.prototype.parentConstructor.call(this),this.setModal(!0),this.buildScreen(),this.setModal(!0),this.setOverlay(!1)};rat.utils.inheritClassFrom($c,rat.ui.Screen),$c.prototype.buildScreen=function(){var e=this;app.settings.customScenario=app.settings.customScenario||{};var t=app.settings.customScenario;e.removeAllSubElements();var n=rat.graphics.SCREEN_WIDTH,r=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(n,r),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Custom Game");for(var i=n-100,o=r-220-330,s=[{label:"ai civ count",type:"range",values:[0,1,2,3,4,5],row:0,col:1,setObject:t,setField:"gameConfig.aiCivCount",valueWidth:240,labelOffset:300,onChange:function(e){app.writeSettings()}},{label:"ai difficulty",type:"range",values:[1,2,3,4,5,6],valueLabels:["Intro","Warlord","Prince","King","Emperor","Deity"],row:1,col:1,setObject:t,setField:"gameConfig.aiDifficulty",valueWidth:240,labelOffset:300,onChange:function(e){app.writeSettings()}},{label:"victory points",type:"range",values:[3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20],row:2,col:1,setObject:t,setField:"gameConfig.pointsToWin",valueWidth:240,labelOffset:300,onChange:function(e){app.writeSettings()}},{label:"map size",type:"range",values:["normal","large","xlarge"],valueLabels:["Normal","Large","X-Large"],row:3,col:1,setObject:t,setField:"landConfig.targetSize",valueWidth:240,labelOffset:300,onChange:function(e){app.writeSettings()}},{type:"check",label:"show more start resources",tooltip:"show a few extra resources at the start of the game",row:4,col:1,setObject:t,setField:"gameConfig.showExtraResources",onChange:function(){app.writeSettings()}}],a=0;a<s.length;a++){var l=s[a];if(l.setObject===t&&l.setField)if(void 0===rat.utils.get(t,l.setField)){var c=rat.utils.get(ul.templates.custom,l.setField);rat.utils.set(t,l.setField,c)}}var u=new Yc(this);u.setPos(50,220),u.setSize(i,o);var h=Ba.colors.scrollBoxBorderColor.copy();h.a=.5,u.setFrame(8,h),u.frameOutset=4,e.optionsPanel=u,u.buildFromOptions(s),Ba.makeMenuBackButtonAndAction(e).centerAt(.3*n,r-Ba.menus.backButtonOffset);var d=Ba.makeMenuButtonAt(e,"play",0,0);d.centerAt(.7*n,r-Ba.menus.backButtonOffset),d.setCallback((function(e,t){var n=rat.utils.copyObject(app.settings.customScenario,!0);ul.prepCustomScenario(n),app.gotoGame(n)})),e.autoBuildInputMap({defaultFocusTo:d}),e.haveResized()},$c.prototype.onWindowResize=function(){this.buildScreen()},$c.prototype.screenActivate=function(){this.buildScreen()};var Jc=function(){Jc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1);var e=rat.graphics.layerDiv.make(app.canvasElement);this.editDiv=e,this.buildScreen()};rat.utils.inheritClassFrom(Jc,rat.ui.Screen),Jc.prototype.destroy=function(){app.canvasElement.focus(),this.editDiv&&(this.editDiv.parentNode.removeChild(this.editDiv),this.editDiv=null)},Jc.prototype.enableEditDiv=function(e){this.editDiv&&(this.editDiv.style.display=e?"block":"none")},Jc.prototype.buildScreen=function(){var e=this,t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;for(e.removeAllSubElements(),rat.graphics.layerDiv.updateScale(this.editDiv,app.canvasElement);this.editDiv.firstChild;)this.editDiv.removeChild(this.editDiv.lastChild);e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);var r=50,i=150,o={x:r,y:i,w:t-100,h:(n-i-350-200)/2};const s=i+o.h+200,a=.5*t-Ba.menus.buttonWidth/2,l=n-Ba.menus.backButtonOffset+20,c=o.x+o.w-Ba.game.buttonWidth/2,u=s+o.h+Ba.menus.buttonHeight/2+10,h=Ba.formatText("`Export`: Copy this text and paste it elsewhere to save it");var d=Ba.makeHeading(e,h,r,100);d.enableDefaultSpecialFormatting(),d.setAlignment("left"),d.setPosX(r);var p=this.outBox=this.makeTextBox(o),g=this.getExportString();p.setTextValue(g),p.domEditBox.setAttribute("readonly",!0),p.domEditBox.focus(),p.domEditBox.select();p.domEditBox.onmouseup=function(){setTimeout((function(){p.domEditBox.select()}),1)},o.y=s;const m=Ba.formatText("`Import`: Paste text here and click Import.  Importing will replace your cards and records!");var f=Ba.makeHeading(e,m,r,o.y-125);f.enableDefaultSpecialFormatting(),f.setAlignment("left"),f.setPosX(r),f.setHeight(150),f.setAutoWrap(!0),this.inBox=this.makeTextBox(o);var v=Ba.makeButtonAt(this,"import",c,u,null,Ba.game);Ba.setTooltip(v,"import this text, if valid, as your new records and progress"),v.setCallback((function(t,n){var r,i,o=e.inBox.domEditBox.value,s=e.importFromString(o),a=e.getExportString();p.setTextValue(a),s?(r="Success",i="Your records and progress were imported"):(r="Error Importing",i="There was something wrong with the import string - it couldn't be imported"),e.enableEditDiv(!1),mc.make({title:r,message:i,yesButton:{label:"OK",tooltipText:"Close message",dismissPopup:!0},addDimmer:!0,easyDismiss:!1,onClose:function(t,n){e.enableEditDiv(!0)}})}));var y=Ba.makeMenuBackButtonAndAction(e);y.setPos(a,l),e.autoBuildInputMap({defaultFocusTo:y})},Jc.prototype.makeTextBox=function(e){var t=new rat.ui.DOMEditText(this,this.editDiv,{class:"textarea"});return t.setBounds(e),Ba.applyTextProperties(t,Ba.menus.editTextFont),t.domEditBox.style.font=t.fontDescriptor,t.domEditBox.style.background="rgba(0,0,0,0)",t.domEditBox.style.color=t.getColor().toString(),t.domEditBox.style.border="2px solid gray",t.domEditBox.style["outline-color"]=Ba.colors.textHighColor.toString(),t},Jc.prototype.onWindowResize=function(){this.getWidth()===rat.graphics.SCREEN_WIDTH&&this.getHeight()===rat.graphics.SCREEN_HEIGHT||this.buildScreen()};Jc.prototype.getExportString=function(){var e={version:1,sig:"CH"};e.records=app.settings.records||{},e.collection=app.settings.collection,e.dailies=Tl.dailies.serialize();var t=JSON.stringify(e);return t="["+(t=LZString.compressToBase64(t))+"]"},Jc.prototype.importFromString=function(e){if(!e||e.length<2)return!1;var t,n=e.indexOf("[");if(n<0)return!1;if(n>0&&(e=e.substring(n)),(n=e.lastIndexOf("]"))<0)return!1;if(n<e.length-1&&(e=e.substring(0,n)),!(e=LZString.decompressFromBase64(e)))return!1;try{t=JSON.parse(e)}catch(e){return!1}return!(!t||!t.sig||"CH"!==t.sig||1!==t.version)&&(t.records?app.settings.records=t.records:t.stats&&t.stats.cardsAddedCount&&(app.settings.records.cardsAddedCount=t.stats.cardsAddedCount),app.settings.collection=t.collection,t.dailies&&(app.settings.dailies=t.dailies,Tl.dailies.deserialize(app.settings.dailies)),app.writeSettings(),app.records.recalcAllSummaries(),!0)};var Qc=function(){Qc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1);var e=rat.graphics.layerDiv.make(app.canvasElement);this.editDiv=e,this.buildScreen()};rat.utils.inheritClassFrom(Qc,rat.ui.Screen),Qc.prototype.destroy=function(){var e=this.usernameBox.domEditBox.value;e=e.replace(/[^a-zA-Z0-9_ ]/g,""),app.settings.discord.username=e,Ul.setUsername(e),app.writeSettings(),app.canvasElement.focus(),this.editDiv&&(this.editDiv.parentNode.removeChild(this.editDiv),this.editDiv=null)},Qc.prototype.enableEditDiv=function(e){this.editDiv&&(this.editDiv.style.display=e?"block":"none")},Qc.prototype.buildScreen=function(){var e=this,t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;for(e.removeAllSubElements(),rat.graphics.layerDiv.updateScale(this.editDiv,app.canvasElement);this.editDiv.firstChild;)this.editDiv.removeChild(this.editDiv.lastChild);e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Discord");var r=Ba.makeText(e,"An experimental feature.  When you win certain games, like daily challenges, some details will be posted to the WhaleBunny discord server.",{centerX:t/2,y:300,h:400});r.setAutoWrap(!0),r.setAlignment("left"),r.setBaseline("top");var i={x:50,y:650,h:80,w:t-100},o=Ba.makeHeading(e,"post as name",50,600);o.setAlignment("left"),o.setPosX(50);var s=this.usernameBox=this.makeTextBox(i),a=app.settings.discord.username||"";s.setTextValue(a),s.domEditBox.focus(),s.domEditBox.select(),s.setAutoWrap(!0);var l=Ba.makeMenuBackButtonAndAction(e);l.setTextValue("ok");var c=e.getWidth(),u=l.getPos();l.setPosX(.3*c-Ba.menus.buttonWidth/2),Ba.makeMenuButtonAt(e,"join discord",.7*c,u.y+Ba.menus.buttonHeight/2).setCallback((function(e,t){window.open(Ul.inviteURL,"_blank")})),e.autoBuildInputMap({defaultFocusTo:l})},Qc.prototype.makeTextBox=function(e){var t=new rat.ui.DOMEditText(this,this.editDiv,{class:"textarea"});t.setBounds(e),Ba.applyTextProperties(t,Ba.menus.editTextFont),t.domEditBox.style.font=t.fontDescriptor,t.domEditBox.style.background="rgba(0,0,0,0)",t.domEditBox.style.color=t.getColor().toString(),t.domEditBox.style.border="2px solid gray",t.domEditBox.style["outline-color"]=Ba.colors.textHighColor.toString();var n=rat.input.keys;return t.domEditBox.addEventListener("keydown",(function(e){e.keyCode===n.enter&&e.preventDefault()})),t},Qc.prototype.onWindowResize=function(){this.getWidth()===rat.graphics.SCREEN_WIDTH&&this.getHeight()===rat.graphics.SCREEN_HEIGHT||this.buildScreen()};var Zc=function(){Zc.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen(),this.listen()};rat.utils.inheritClassFrom(Zc,rat.ui.Screen),Zc.prototype.destroy=function(){this.signInPanel&&this.signInPanel.destroy(),this.stopListening()},Zc.prototype.listen=function(){this.accountListenerFunction=Zc.handleSignInChange.bind(this),ba.on("signed_in",this.accountListenerFunction),ba.on("signed_out",this.accountListenerFunction)},Zc.prototype.stopListening=function(){ba.off("signed_in",this.accountListenerFunction),ba.off("signed_out",this.accountListenerFunction),this.accountListenerFunction=null},Zc.handleSignInChange=function(){this.updateSignInState()},Zc.prototype.buildScreen=function(){var e=this,t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;this.signInPanel&&this.signInPanel.destroy(),e.removeAllSubElements(),e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e),Ba.makeMenuTitleBox(e,"Discord Account");var r=Ba.makeText(e,"Signing in to Discord is optional.\nIt lets you post to the daily challenge wins thread.\n\n",{centerX:t/2,y:250,h:400});r.setAutoWrap(!0),r.setBaseline("top"),Ba.makeMenuBackButtonAndAction(e),this.signInPanel=Nc.makeStandard(e,!1);var i=600,o=Ba.makeMenuButtonAt(e,"sign in",.5*t,i);o.setCallback((function(e,t){"signed_in"==ba.signInState?(ba.signOut(),La.signOut()):La.signIn()})),e.signInButton=o,e.updateSignInState(),i+=250,Ba.makeMenuButtonAt(e,"join discord",.5*t,i).setCallback((function(e,t){window.open(Ul.inviteURL,"_blank")})),i+=200;var s=Ba.makeCheckBoxAt(e,"autopost dailies to discord",.5*t,i,800);e.discordCheck=s;var a=app.settings.discord.autoPost;s.setToggled(!!a),s.setCallback((function(e,t){var n=s.isToggled();app.settings.discord.autoPost=n,app.writeSettings()})),Ba.setTooltip(s,"autopost daily challenge results to the relevant Discord thread"),s.setPosX(.3*t),e.autoBuildInputMap(!1,!1),e.haveResized()},Zc.prototype.updateSignInState=function(){const e=this.signInButton;"signed_in"==ba.signInState?e.setTextValue("sign out"):e.setTextValue("sign in")},Zc.prototype.onWindowResize=function(){this.getWidth()===rat.graphics.SCREEN_WIDTH&&this.getHeight()===rat.graphics.SCREEN_HEIGHT||this.buildScreen()},Zc.prototype.screenActivate=function(){this.buildScreen()};var eu=function(e,t,n){eu.prototype.parentConstructor.call(this),this.setModal(!0),this.setOverlay(!1),this.buildScreen()};rat.utils.inheritClassFrom(eu,rat.ui.Screen),eu.prototype.buildScreen=function(){var e=this;e.removeAllSubElements();var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setPos(0,0),e.setSize(t,n),xa.applyToScreen(e);for(var r=Ba.makeText(e,"This just shows the list of civs for now...",{centerX:t/2,centerY:100}),i=200,o=200,s=0;s<app.civs.civInfo.length;s++){var a=app.civs.civInfo[s],l=new rat.ui.Sprite(e);l.loadImage(a.avatarAsset),l.setPos(i,o),(r=Ba.makeText(e,a.heroName,{centerX:i,centerY:o})).setPos(i,o+170),r.setWidth(168),r.centerText(!0),(r=Ba.makeText(e,a.name,{centerX:i,centerY:o})).setPos(i,o+230),r.setWidth(168),r.centerText(!0),(i+=200)>t-400&&(i=200,o+=300)}Ba.makeMenuBackButtonAndAction(e),e.autoBuildInputMap(!1,!1)},eu.prototype.onWindowResize=function(){this.buildScreen()};var tu=function(){tu.prototype.parentConstructor.call(this),this.rebuildUI(),this.setModal(!0),this.setOverlay(!1),Ba.setMenuBackAction(this)};rat.utils.inheritClassFrom(tu,rat.ui.Screen),tu.prototype.rebuildUI=function(){var e=this,t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.setSize(t,n),e.removeAllSubElements(),xa.applyToScreen(this),Ba.makeMenuTitleBox(e,"Daily Challenges");var r=new rat.ui.PageSlider(e);e.pager=r;const i={x:.05*t,y:240,w:.9*t,h:n-240-320,buttonInset:{top:160,bottom:80,left:50,right:50}};r.setPos(i.x,i.y),r.setSize(i.w,i.h),r.setOrientation("horizontal"),r.setAnimTime(.25),r.setFrame(3,Ba.colors.scrollBoxBorderColor),r.setHandleAllMouseInMe();const o=Ba.menus.squareButtonBottomOffset;var s=Ba.makeIconButtonAt(Ba.menus,e,"menu_left",.15*t,n-o);e.leftButton=s;var a=Ba.makeIconButtonAt(Ba.menus,e,"menu_right",.85*t,n-o);e.rightButton=a,r.attachButtons(s,a);var l=Ba.makeIconButtonAt(Ba.menus,e,"menu_back",.5*t,n-o);e.backButton=l,Ba.setIconButtonLabel(l,"back"),Ba.setTooltip(l,"back one screen"),l.callback=app.screenList.goBackScreen,Ba.setMenuBackAction(e);var c=new Date,u=c.getFullYear(),h=c.getMonth(),d=c.getDate(),p=12*(u-2022)+(h+1-0);p-=9;const g=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];r.setCreatePage((function(e,t,n){var r=new rat.ui.Element;r.setSize(i.w,i.h);var o=2022+((e+9)/12|0),s=(e+9)%12,a=o+"  "+g[s],l=Ba.makeHeading(r,a,i.w/2,80,Ba.menus);Ba.applyTextProperties(l,Ba.menus.dailyHeadingFont);for(var c=function(e,t){return new Date(e,t+1,0).getDate()}(o,s),p=32*(12*(o-2e3)+s),m=170,f=i.w-(i.buttonInset.left+i.buttonInset.right),v=i.h-(i.buttonInset.top+i.buttonInset.bottom),y=f/m|0,w=Math.ceil(c/y),C=(f-y*m)/y,S=(v-w*m)/w,b=0;b<c;b++){var _=p+b,x=Tl.dailies.getBit(_),T=b/y|0,k=b%y,I=i.buttonInset.left+k*(m+C)+85+C/2,P=i.buttonInset.top+T*(m+S)+85+S/2;const e=x?"checkmark_small":"menu_checkmark_empty_box";var E=Ba.makeIconButtonAt(Ba.menus,r,e,I,P);Ba.setIconButtonLabel(E,""+(b+1)),o===u&&s===h&&b>=d&&(E.setEnabled(!1),E.icon.setVisible(!1)),E.seed=_,E.dayIndex=b,E.setCallback((function(e,t){app.settings.display.dailyButIndex=e.dayIndex;var n=Tl.generateForDaily(e.seed,e.dayIndex,s,o);app.gotoGame("seeded",e.seed,n)}))}return r})),r.setPageCount(p);var m=app.settings.display.dailyPage;(void 0===m||m<0||m>=p)&&(m=p-1),r.setPageIndex(m,!1),r.setVisiblePageChanged((function(t,n,i){if(za.playSound("page_flip"),e.inputMap){var o=e.inputMap.getTarget();r.snapPageAnimationTemp(),e.autoBuildInputMap(),r.restorePageAnimationTemp(),"mouse"!==rat.input.lastUIInputType&&"touch"!==rat.input.lastUIInputType&&(o&&o.isVisible()&&o.isEnabled()&&(o===s||o===a)?e.inputMap.focusByButton(o):s.isVisible()&&s.isEnabled?e.inputMap.focusByButton(s):e.inputMap.focusByButton(a)),app.settings.display.dailyPage=t}})),e.autoBuildInputMap();var f=app.settings.display.dailyButIndex;void 0!==f&&((l=e.inputMap.getButton(f))&&l.seed&&e.inputMap.focusButton(f))},tu.prototype.myScreenActivate=function(){console.log("daily challenge screen activate")},tu.prototype.myScreenDeactivate=function(){console.log("daily challenge screen deactivate")},tu.prototype.onWindowResize=function(){this.rebuildUI()},tu.prototype.handleKeyDown=function(e){return!1},tu.prototype.updateSelf=function(e){},tu.make=function(){var e=new tu;rat.screenManager.pushScreen(e)};const nu={};const ru={main:{screenConstructor:Mc},play:{screenConstructor:Oc},help:{screenConstructor:Hc},keyboard:{screenConstructor:zc},about:{screenConstructor:qc},credits:{screenConstructor:Vc},records:{screenConstructor:Wc},debug:{screenConstructor:jc},playseed:{screenConstructor:Kc},options:{screenConstructor:Xc},export:{screenConstructor:Jc},custom:{screenConstructor:$c},civlist:{screenConstructor:eu},cardlist:{screenConstructor:ic},daily:{screenConstructor:tu},discord:{screenConstructor:Qc},account:{screenConstructor:Zc},anim:{maker:Ta.makeAnimAuditionScreen},audio:{maker:function(e,t){var n={uiScale:2,onKilled:function(e){app.gotoScreen("main")}};return rat.auditions.audioAudition.makeScreen(n,!0),screen}}};function iu(e){return ru[e]}nu.setCurScreenID=function(e){nu.curScreenID=e},nu.setCurScreenIDFromScreen=function(e){e&&(nu.curScreenID=e.id)},nu.gotoScreen=function(e,t,n){if("game"===e)return app.gotoGame(t,n);if(e===nu.curScreenID)return rat.screenManager.getScreenByID(e);nu.curScreenID=e;var r,i=iu(e);return i&&(i.screenConstructor||i.maker)?i.screenConstructor?((r=new i.screenConstructor(t,n)).id=e,rat.screenManager.pushScreen(r),r):i.maker?((r=i.maker(t,n)).id=e,r):(console.log("Error: no couldn't make screen: "+e),null):(console.log("Error: no valid screen: "+e),null)},nu.pushScreen=function(e,t,n){var r=iu(e);if(!r||!r.screenConstructor)return console.log("Error: no screen to push: "+e),null;var i=new r.screenConstructor(t,n);i.id=e,rat.screenManager.pushScreen(i)},nu.removeScreen=function(e){rat.screenManager.removeScreen(e);var t=rat.screenManager.getTopScreen();t?nu.curScreenID=t.id:this.gotoScreen("main")},nu.goBackScreen=function(e,t){rat.screenManager.popScreen();var n=rat.screenManager.getTopScreen();n?nu.curScreenID=n.id:app.gotoScreen("main")},rat.console.registerCommand("screenlist",(function(e,t){for(var n in rat.console.log("--- screens we know about:"),ru)rat.console.log(n)}),["screens"]);const ou={save:function(){var e=game.serialize();e.version=1;var t=JSON.stringify(e);return t.length,(t=LZString.compressToUTF16(t)).length,t},restore:function(e){try{e=LZString.decompressFromUTF16(e);var t=JSON.parse(e);return t?1!==t.version?(rat.console.logError("saver.restore: can't read version "+t.version),!1):(rat.console.log("deserialize game state"),app.prepStateForEnteringGame("play"),game.deserialize(t),!0):(rat.console.logError("saver.restore: error reading save file!"),!1)}catch(e){return rat.console.logError("ERROR in saver.restore: "+e.toString()),app.popAllScreens(),game.exit(),app.prepStateForLeavingGame(),app.gotoScreen("main"),!1}},saveToSettings:function(){var e=ou.save();app.settings.savedGame=e,app.settings.savedGameVersion=1,delete app.settings.restoreInProgress,app.writeSettings(0)},restoreFromSettings:function(){if(!app.settings.savedGame||1!==app.settings.savedGameVersion)return!1;if(app.settings.restoreInProgress)return rat.console.logError("saver: restore from save failed! clearing save."),ou.clearSaveToSettings(),!1;if(app.settings.restoreInProgress=!0,app.writeSettings(0),ou.restore(app.settings.savedGame))return delete app.settings.restoreInProgress,app.writeSettings(0),!0;delete app.settings.restoreInProgress,rat.console.logError("saver: restore from save failed! clearing save."),ou.clearSaveToSettings();var e=mc.make({title:"Error",message:"There was an error restoring your saved game.",yesButton:{label:"OK",tooltipText:"Close message",go:function(t){e.doClose()}},addDimmer:!0,easyDismiss:!1});return!1},clearSaveToSettings:function(){delete app.settings.savedGame,delete app.settings.savedGameVersion,delete app.settings.restoreInProgress,app.writeSettings(0)},hasSavedGameInSettings:function(){return!(!app.settings.savedGame||1!==app.settings.savedGameVersion)&&!app.settings.restoreInProgress},saveToDebugSlot:function(e){var t=rat.storage.getStorage(rat.storage.permanentLocal);if(t){var n=t.getPrefix();t.setPrefix("");var r=ou.save();rat.console.log("debug save of serialized game"),t.setItemAsync("miniciv_debugSave",r).then((function(){rat.console.log("debug save complete.")})),t.setPrefix(n)}else rat.console.logError("can't save to debug slot")},restoreFromDebugSlot:function(e){var t=rat.storage.getStorage(rat.storage.permanentLocal);if(t){var n=t.getPrefix();t.setPrefix("");var r=t.getItemAsync("miniciv_debugSave");return t.setPrefix(n),r.then((function(e){return rat.console.log("starting saver restore of debug save"),!!ou.restore(e)||(rat.console.logError("couldn't restore from debug slot (restore error)"),!1)})).catch((function(e){rat.console.logError("got error reading debug save"),rat.console.logError(e)})),!0}return rat.console.logError("couldn't restore from debug slot"),!1}};var su={list:[],nextStartupMessage:function(){var e=su.list.shift();e?e.start():app.gotoScreen("main")},start:function(){su.list=[];void 0!==app.settings.whatIsNewVersion&&9!==app.settings.whatIsNewVersion&&su.list.push({start:function(){var e=mc.make({title:Ba.formatText("What's New (`December 2024`)?"),message:Ba.formatText("🠶 can post `Daily Challenge` results to `Discord`\n🠶 various other small improvements"),yesButton:{label:"OK",tooltipText:"Close message",go:function(t){e.doClose()}},addDimmer:!0,easyDismiss:!1,onClose:function(e,t){app.settings.whatIsNewVersion=9,app.writeSettings(),su.nextStartupMessage()}});e.messageTextBox.setAlignment("left")}}),void 0===app.settings.whatIsNewVersion&&(app.settings.whatIsNewVersion=9,app.writeSettings()),ou.hasSavedGameInSettings()&&su.list.push({start:function(){var e=mc.make({title:"Continue Saved Game?",message:'You have a saved game in progress.\nWould you like to continue it?\n\n(choosing "discard" will delete the saved game.)',yesButton:{label:"continue",tooltipText:"continue saved game from where you left off",go:function(e){ou.restoreFromSettings()||su.nextStartupMessage()}},noButton:{label:"discard",tooltipText:"discard saved game",go:function(t){e.doClose()}},addDimmer:!0,onClose:function(e,t){ou.clearSaveToSettings(),su.nextStartupMessage()}});e.setAllowClickAway(!1),e.setAllowClickBodyClose(!1)}}),su.nextStartupMessage()}},au={release:!1,version:1,defaultSettings:{version:1,soundVolume:1,musicVolume:1,autoSaveEachTurn:!0,debug:{show:{},set:{}},display:{showHexBorders:!1,showCivBorders:!0,zoomScaleMin:.8},customScenario:{},collection:{},records:{byCat:{},cardsAddedCount:0},dailies:"",discord:{},unlockedList:[]},settings:{},settingsLazyDelay:0,aiTestRecords:[],aiTestTotals:[],ctx:null,worldGen:null,state:"loading"};window.app=au,au.World=Ua,au.Buildings=$a,au.rules=Qa,au.civs=Ja,au.cards=bc,au.records=Ac,au.animations=Ec,au.screenList=nu,au.saver=ou,au.config=e,au.discord=Ul,au.services=os,au.account=ba,au.init=function(){console.log("--- app.init"),window.BUILD_INFO&&window.BUILD_INFO.version&&(rat.system.pathConfig.applyVersion=window.BUILD_INFO.version.version);var e=document.getElementById("canvas");au.canvasElement=e,au.ctx=e.getContext("2d"),rat.init(),au.setupDebugging(),os.oneTimeInit(),ba.oneTimeInit(),La.oneTimeInit(),rat.howlerAudio.enable(),za.init(),Ba.init(),au.setupGraphics(),rat.setDraw(au.draw),rat.system.setPostUIDraw(au.postDraw),rat.setUpdate(au.update),rat.addEventListener(window,"resize",au.resizeHandler),rat.addEventListener("animationCycleSuspended",au.animationCycleSuspended),rat.addEventListener("animationCycleResumed",au.animationCycleResumed),au.setupInput(),rat.ui.TOOL_TIP_TIME=au.config.buttonTipTime,rat.graphics.imageCache.preLoadImages([]),_a.oneTimeInit(),qa.oneTimeInit(),ul.oneTimeInit(),au.civs.oneTimeInit(),au.cards.oneTimeInit(),au.animations.oneTimeInit(),Sc.oneTimeInit(),au.setupStorage(),au.ctx.fillStyle="#000000",au.ctx.fillRect(0,0,au.canvasElement.width,au.canvasElement.height),au.state="loading",console.log("--- app.init done")},au.initAfterLoad=function(){_a.initAfterLoad(),au.civs.initAfterLoad(),au.cards.initAfterLoad();var e,t,n="main";au.settings.debug.skipTo&&(n=au.settings.debug.skipTo),"gen"===n&&(n="game"),au.settings.debug.skipTo&&(e=au.settings.debug.skipToArg,t=au.settings.debug.skipToSeed),"saved"===au.settings.debug.skipTo&&ou.restoreFromSettings()||"debug"===au.settings.debug.skipTo&&ou.restoreFromDebugSlot(0)||(au.state="menus",au.gotoScreen(n,e,t),"menus"===au.state&&"main"===n&&su.start())},au.initTelemetry=function(){au.telemetry={sessionLog:function(){}}},au.setupGraphics=function(){rat.graphics.setAutoScaleFromIdeal(1600,1600,{autoResizeCanvas:!0,allowAutoUpscale:!0,resizeCanvasPixelLimit:0,autoFillOnResize:!0,autoScaleWithDevicePixelRatio:!0}),rat.graphics.setAutoClear(!0,"#000000"),au.resizeHandler()},au.setupDebugging=function(){rat.console.copyToSystem=!0,rat.console.allow(!0),rat.console.setTextSize(40,45),rat.console.registerCommand("clearsettings",(function(e,t){au.clearSettings()}),["reset","resetsettings"]),rat.console.registerCommand("writesettings",(function(e,t){au.writeSettings(0)}),["savesettings"]),rat.console.registerCommand("showconsole",(function(e,t){rat.console.activate(!rat.console.state.consoleActive)}),["showlog"]),rat.console.registerCommand("skipto",(function(e,t){var n=t[0];if(!n)return delete au.settings.debug.skipTo,delete au.settings.debug.skipToArg,delete au.settings.debug.skipToSeed,au.writeSettings(0),void rat.console.log("cleared all skipto");"'"===n.charAt(0)&&(n=n.substring(1,n.length-1));var r=au.settings.debug.skipToArg,i=au.settings.debug.skipToSeed;t.length<=2&&"same"===t[1]&&t.push("same");for(var o=1;o<t.length;o++)"same"===t[o]&&(t[o]=1===o?Sc.templateID:""+Sc.seed),isNaN(t[o])?r=t[o]:i=parseInt(t[o]);au.skipTo(n,r,i)})),rat.console.registerCommand("whatsnew",(function(e,t){au.settings.whatIsNewVersion=1,su.start()}),["whatisnew","startupmessages"])},au.setupAdminCommands=function(){rat.console.registerCommand("revealAll",(function(e,t){au.settings.debug.revealAll=!au.settings.debug.revealAll,au.writeSettings(),au.settings.debug.revealAll?Sc.world.revealAll():Sc.world.fogAll()}),["reveal"]),rat.console.registerCommand("fogAll",(function(e,t){Sc.world.fogAll()}),["fog"]),rat.console.registerCommand("teleport",(function(e,t){var n=t[0],r=t[1];void 0!==n&&void 0!==r?(n=parseInt(n),r=parseInt(r),Sc.debugTeleportTo(n,r)):rat.console.log("usage: teleport q r")})),rat.console.registerCommand("progress",(function(e,t){Sc.revealAllCivProgress()}),["prog","meetall","meet"]),rat.console.registerCommand("win",(function(e,t){Sc.declareWinner(0)})),rat.console.registerCommand("lose",(function(e,t){Sc.declareWinner(1)})),rat.console.registerCommand("give",(function(e,t){function n(){rat.console.log("usage: give <thing> <quantity>")}var r=t[0],i=t[1];if(void 0!==r){for(var o in au.World.resourceTypes)if(r===o){if(void 0===i)return void n();var s=parseInt(i);s|=0,rat.console.log("giving resource "+o+" "+s);for(var a=0;a<Sc.civs.length;a++){var l=Sc.civs[a];l.resources[r].count=l.resources[r].showCount+=s}return}}else n()})),rat.console.registerCommand("unlockcards",(function(e,t){au.cards.unlockAllCards(au.settings)}),["allcards","unlockall"]),rat.console.registerCommand("lockcards",(function(e,t){au.settings.collection={},au.settings.facesEarnedCount=0,au.settings.facesAddedCount=0,au.cards.setStartingCards(au.settings)}),["nocards","lockall"]),rat.console.registerCommand("unlockcard",(function(e,t){var n=t[0];if(n)if(au.cards.byID[n]){var r=au.cards.addCardFromFullID(n),i=au.cards.getCardCategory(n);r&&ic.addToNewList(i,n)}else rat.console.log("no such card id "+n)}),["card","addcard"]),rat.console.registerCommand("dounlocks",(function(e,t){au.cards.doAllUnlocks()})),rat.console.registerCommand("aitest",(function(t,n){e.aiTest=!e.aiTest})),rat.console.registerCommand("discord",(function(e,t){rat.console.log("test posting to discord..."),Ul.postTestToDiscord()})),rat.console.registerCommand("write",(function(e,t){au.writeSettings(0)}),["writesettings"])},au.setAdmin=function(e){void 0===e&&(e=!0),au.settings.admin=e,au.writeSettings(0),console.log("admin "+au.settings.admin+". wrote settings.")},au.setupInput=function(){rat.input.useLastUIInputType=!0,rat.input.useLastInputType=!0,rat.input.customUIEventTranslations=[{which:rat.input.keys.k,result:"up"},{which:rat.input.keys.h,result:"left"},{which:rat.input.keys.j,result:"down"},{which:rat.input.keys.l,result:"right"},{which:rat.input.keys.space,result:"enter"},{which:rat.input.keys.numPad8,result:"up"},{which:rat.input.keys.numPad4,result:"left"},{which:rat.input.keys.numPad2,result:"down"},{which:rat.input.keys.numPad6,result:"right"},{which:rat.input.keys.numPad0,result:"enter"}]},au.resizeHandler=function(){Ba.resizeHandler()},au.reset=function(){au.gotoGame()},au.gotoScreen=function(e,t,n){return"game"===e?au.gotoGame(t,n):nu.gotoScreen(e,t,n)},au.prepStateForEnteringGame=function(e){Sc.exit(),au.popAllScreens(),Ba.menuBack.release(),au.state=e},au.prepStateForLeavingGame=function(){au.state="menus"},au.popAllScreens=function(){nu.setCurScreenID(null),rat.screenManager.popAllScreens()},au.gotoGame=function(e,t,n){if(au.prepStateForEnteringGame("generate"),au.popAllScreens(),Ba.menuBack.release(),nu.setCurScreenID("game"),e&&"custom"!==e&&"seeded"!==e){if("string"==typeof e){var r=e;if(!(e=ul.getScenarioByName(r)))return rat.console.logError("Error trying to go to scenario "+r),void(au.state="menus")}}else e=n?rat.utils.copyObject(n,!0):rat.utils.copyObject(au.settings.customScenario,!0),ul.prepCustomScenario(e);e=ul.readyScenario(e),Sc.scenario=e,au.state="generate",au.worldGen=Wa;var i=rat.utils.copyObject(e.landConfig,!0);return i.rng=new rat.math.rng.Simple,t&&i.rng.setSeed(t),Sc.rngSeed=i.rng.getSeed(),e.rngSeed=Sc.rngSeed,Sc.rng=new rat.math.rng.Simple,Sc.rng.setSeed(Sc.rngSeed),au.worldGen.init(au.config.world,e.gameConfig,i),au.worldGen.buildWorld(),!0},au.update=function(e){if("loading"===au.state)_a.isDoneLoading()&&rat.audio.isCacheLoaded()&&au.cards.isDoneLoading()&&au.civs.isDoneLoading()&&au.animations.isDoneLoading()&&au.doneReadingSettings&&(console.log("initial shell load done."),au.initAfterLoad());else if("generate"===au.state){if(au.worldGen.update(e),au.worldGen.done)if("gen"===au.settings.debug.skipTo){var t=new rat.ui.Screen;rat.screenManager.pushScreen(t),t.handleKeyDown=function(e){if(e.which===rat.input.keys.enter)return rat.screenManager.popScreen(),au.enterPlayStateAfterGenerate(),!0}}else au.enterPlayStateAfterGenerate()}else"play"===au.state&&Sc.update(e);"loading"!==au.state&&au.updateSettingsLazyDelay(e)},au.enterPlayStateAfterGenerate=function(){au.state="play",Sc.init(au.worldGen.world),au.worldGen=null},au.drawLoading=function(e){var t=rat.graphics.SCREEN_WIDTH,n=rat.graphics.SCREEN_HEIGHT;e.font="76px "+Ba.mainFont,e.textAlign="left",e.fillStyle="#FFFFFF";for(var r,i=rat.system.runningTimeMS/1e3*2%4|0,o="Loading",s=0;s<i;s++)o+=".";e.fillText(o,.4*t,.5*n,900),!au.cards.isDoneLoading()&&au.civs.isDoneLoading()?r="Loading Data":_a.isDoneLoading()?au.doneReadingSettings||(r="Reading Settings/Progress"):r="Loading Graphics",r&&(e.font="36px "+Ba.menus.mainFont.font,e.fillStyle="#A0A0A0",e.fillText(r,.4*t,.55*n,900))},au.draw=function(){var e=au.ctx;"loading"===au.state?au.drawLoading(e):"generate"===au.state?"gen"===au.settings.debug.skipTo&&au.worldGen.drawWorld(e):Sc.draw(e)},au.postDraw=function(){"loading"===au.state||"generate"===au.state||(Sc.postDraw(au.ctx),qa.uiParticles.draw()),rat.system.isAnimationActive()||(au.ctx.globalAlpha=1,au.ctx.globalCompositeOperation="hue",au.ctx.fillStyle="#FFFFFF",au.ctx.fillRect(0,0,rat.graphics.SCREEN_WIDTH,rat.graphics.SCREEN_HEIGHT),au.ctx.globalCompositeOperation="source-over",au.ctx.globalAlpha=1)},au.skipTo=function(e,t,n){au.settings.admin&&(au.settings.debug.skipTo=e,au.settings.debug.skipToArg=t,au.settings.debug.skipToSeed=n,au.writeSettings(0),rat.console.log("set skipTo to "+e+", arg="+t+", seed="+n))},au.setupStorage=function(){au.storage=rat.storage.getStorage(rat.storage.permanentLocal),au.storage?(au.storage.setPrefix("miniciv_"),au.readSettings()):rat.console.logError("no app.storage to read from")},au.writeSettings=function(e){return null==e&&(e=.2),e&&!0===e&&(e=1),au.settings.dailies=Tl.dailies.serialize(),e>0?(au.settingsLazyDelay=e,Promise.resolve()):(au.settingsLazyDelay=0,au.writeSettingsObject())},au.writeSettingsObject=function(){if(au.storage)return au.storage.setObjectAsync("settings",au.settings).then((function(){}));rat.console.logError("no app.storage to write to")},au.updateSettingsLazyDelay=function(e){au.settingsLazyDelay>0&&(au.settingsLazyDelay-=e,au.settingsLazyDelay<=0&&(au.settingsLazyDelay=0,au.writeSettingsObject()))},au.readSettings=function(){var e=.5;rat.system.has.mobile&&(e=.9),au.defaultSettings.soundVolume=au.defaultSettings.musicVolume=e,au.cards.setStartingCards(au.defaultSettings),au.settings=rat.utils.copyObject(au.defaultSettings,!0),rat.console.log("read settings"),au.storage.getObjectAsync("settings").then((function(e){var t=!1;e?au.settings=e:(rat.console.log("no existing settings"),t=!0),void 0===au.settings.userID&&(au.settings.userID=rat.utils.makeUserID(),rat.console.log("new user id "+au.settings.userID),t=!0),rat.utils.extendObject(au.settings,au.defaultSettings,!0),au.cards.validateCollection(au.settings.collection),au.records.postLoadSettings(au.settings),Tl.dailies.deserialize(au.settings.dailies),au.settings.cardsAddedCount&&(au.settings.records.cardsAddedCount=au.settings.cardsAddedCount),t&&au.writeSettings(),za.setSoundVolume(au.settings.soundVolume),za.setMusicVolume(au.settings.musicVolume),au.setLowPower(au.settings.lowPower),au.setPostToDiscord(au.settings.discord),au.initTelemetry(),rat.console.allow(!!au.settings.admin),au.settings.admin&&au.setupAdminCommands(),rat.debug.showSet.configure(au.settings.debug,au.writeSettings),au.doneReadingSettings=!0})).catch((function(e){rat.console.logError("got error reading settings"),rat.console.logError(e),au.doneReadingSettings=!0}))},au.setPostToDiscord=function(e){Ul.setUsername(au.settings.discord.username)},au.setLowPower=function(e){e?rat.system.setFrameIntervalLimit(.03):rat.system.setFrameIntervalLimit(0),e&&!rat.system.has.mobile?rat.system.suspendAnimationOnBlur=!0:rat.system.suspendAnimationOnBlur=!1},au.suspendedPopup=null,au.animationCycleSuspended=function(){if(!au.suspendedPopup){var e=au.suspendedPopup=mc.make({title:Ba.formatText("Suspended"),message:Ba.formatText("Tap to continue"),addDimmer:!0,slideInFrom:null,slideInSound:null,easyDismiss:!0,onClose:function(e,t){au.suspendedPopup=null,au.suspendedPopupTimer&&clearTimeout(au.suspendedPopupTimer),t&&"mousedown"===t.eventType&&za.playSound("click")}});e.setHeight(e.getHeight()-400),e.centerInDisplayByFraction(.5,.15)}},au.animationCycleResumed=function(){au.suspendedPopup&&(au.suspendedPopupTimer=setTimeout((function(){au.suspendedPopupTimer=null,au.suspendedPopup.doClose()}),50))},au.clearSettings=function(){au.storage.removeAsync("settings").then((function(){rat.console.log("cleared settings"),rat.system.url.reloadLocation()}))},au.init()}();
